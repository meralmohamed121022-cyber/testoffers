
 <!DOCTYPE html>
<html lang="en" dir="ltr" data-theme="light">
<head>
<meta charset="UTF-8" />
<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

<meta name="viewport" content="width=900, initial-scale=0.4, maximum-scale=4.0, user-scalable=yes">
<title>ALDAWAA OFFERS-MONO</title>
<link rel="icon" href="https://raw.githubusercontent.com/meralmohamed121022-cyber/Drug-Monograph/858ba78ce2719a0e7069fd4807b725e0002a17d8/6_20251129_184528_0005.png">
<link rel="apple-touch-icon" href="https://raw.githubusercontent.com/meralmohamed121022-cyber/Drug-Monograph/858ba78ce2719a0e7069fd4807b725e0002a17d8/6_20251129_184528_0005.png">

<!-- ====== üîí SECURITY HEADERS ====== -->
<meta http-equiv="X-Content-Type-Options" content="nosniff">
<meta http-equiv="X-Frame-Options" content="SAMEORIGIN">
<meta http-equiv="X-XSS-Protection" content="1; mode=block">
<meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
<meta http-equiv="Permissions-Policy" content="geolocation=(), microphone=(), camera=()"></head>

<!-- Content Security Policy -->
<meta http-equiv="Content-Security-Policy" content="
  default-src 'self';
  script-src 'self' 'unsafe-inline' 'unsafe-eval' https://dry-rain-899d.meralmohamed121022.workers.dev;
  style-src 'self' 'unsafe-inline';
  img-src 'self' data: https: blob:;
  font-src 'self' data:;
  connect-src 'self' https://dry-rain-899d.meralmohamed121022.workers.dev https://www.al-dawaa.com;
  frame-ancestors 'self';
  base-uri 'self';
  form-action 'self';
">

<title>Pharmacy Premium Offers</title>
<style>

/* ====== üçé IPHONE FIXES ====== */
* {
  -webkit-tap-highlight-color: transparent;
  -webkit-touch-callout: none;
}

body {
  -webkit-text-size-adjust: 100%;
  -moz-text-size-adjust: 100%;
  -ms-text-size-adjust: 100%;
}

input, select, button, textarea {
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
}

.countdown-timer {
  will-change: transform;
  transform: translateZ(0);
  -webkit-transform: translateZ(0);
}

.countdown-item .number {
  font-variant-numeric: tabular-nums;
  -webkit-font-smoothing: antialiased;
}

.ios-device .custom-select-trigger {
  -webkit-user-select: none;
  user-select: none;
}

.ios-device input[type="checkbox"] {
  width: 22px !important;
  height: 22px !important;
}

  /* ========== VARIABLES & THEMES ========== */
  :root {
    --bg-body: #f0f2f5;
    --bg-container: #ffffff;
    --text-main: #333333;
    --text-secondary: #666666;
    --card-bg: #ffffff;
    --card-shadow: rgba(0,0,0,0.1);
    --filter-bg: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    --input-bg: #ffffff;
    --input-border: #ddd;
    --header-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --cat-b-bg: linear-gradient(to right, #e0eafc, #cfdef3); 
    --cat-b-text: #333;
    --brand-border: rgba(0,0,0,0.05);
    --offer-group-bg: #ffffff;
    --offer-group-border: #e9ecef;
  }

  [data-theme="dark"] {
    --bg-body: #121212;
    --bg-container: #1e1e1e;
    --text-main: #e0e0e0;
    --text-secondary: #aaaaaa;
    --card-bg: #2d2d2d;
    --card-shadow: rgba(0,0,0,0.5);
    --filter-bg: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
    --input-bg: #333333;
    --input-border: #444;
    --header-gradient: linear-gradient(135deg, #3a1c71 0%, #d76d77 100%);
    --cat-b-bg: linear-gradient(135deg, #434343 0%, #2b2b2b 100%);
    --cat-b-text: #fff;
    --brand-border: rgba(255,255,255,0.2);
    --offer-group-bg: #252525;
    --offer-group-border: #333;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }
  
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: var(--bg-body);
    color: var(--text-main);
    min-height: 100vh; padding: 10px;
    transition: background 0.3s, color 0.3s;
  }

  /* ===== RIYAL SYMBOL STYLING ===== */
  .riyal-symbol {
      display: inline-block;
      width: 1.2em;
      height: 1.2em;
      background-image: url("https://www.sama.gov.sa/ar-sa/Currency/Documents/Saudi_Riyal_Symbol-2.svg");
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      vertical-align: middle;
      margin-left: 0.3em;
      filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.3));
      transition: all 0.3s ease;
  }

  [data-theme="dark"] .riyal-symbol {
      filter: invert(1) drop-shadow(0 1px 2px rgba(0, 0, 0, 0.5));
  }

  /* ========== PRINT STYLES ========== */
  .print-container { display: none; }
  
  /* Loading Overlay for Print */
  #printLoader {
    display: none; position: fixed; top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.8); z-index: 9999; color: white;
    flex-direction: column; align-items: center; justify-content: center;
  }

  @media print {
    body * { visibility: hidden; }
    .container, .theme-switch-wrapper, .print-button-wrapper, #printLoader { display: none !important; }
    
    .print-container, .print-container * {
      visibility: visible;
      display: block;
    }
    .print-container {
      position: absolute; left: 0; top: 0; width: 100%;
      background: white; color: black;
    }

    @page { size: A4; margin: 0; }
    
      .print-page {
      width: 210mm; 
      height: 297mm;
      background: white;
      padding-top: 75mm; 
      padding-right: 1mm;
      padding-left: 1mm;
      padding-bottom: 10mm;
      page-break-after: always;
      display: flex; 
      flex-direction: column;
      box-sizing: border-box;
    }

    .print-page:last-child { page-break-after: auto; }

    .print-row {
      display: flex; 
      justify-content: space-between; 
      width: 100%;
    }

    .print-spacer { flex-grow: 1; }

    .print-card {
      border: none; 
      width: 30%;
      text-align: center;
      display: flex; flex-direction: column;
      justify-content: flex-start; align-items: center;
    }

    .print-offer-title {
      font-size: 24pt; font-weight: 900; margin-bottom: 5mm;
      text-transform: uppercase; line-height: 1.1; color: #000;
    }

    .print-offer-date {
      font-size: 11pt; font-weight: bold; margin-bottom: 8mm; color: #000;
    }

    .print-product-desc {
      font-size: 12pt; font-weight: bold; margin-bottom: 4mm; line-height: 1.3; color: #000;
    }

    .print-product-meta { font-size: 10pt; color: #000; }
  }

  /* ========== SCREEN STYLES ========== */
  .container {
    max-width: 100%; margin: 0 auto; 
    background: var(--bg-container);
    border-radius: 15px; box-shadow: 0 15px 45px rgba(0,0,0,0.2);
    overflow: hidden; transition: background 0.3s;
  }

  /* Floating Print Button */
  .print-button-wrapper {
    position: fixed; right: 20px; bottom: 20px; z-index: 1000;
  }
  .print-fab {
    background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
    color: white; width: 60px; height: 60px; border-radius: 50%;
    border: none; box-shadow: 0 5px 15px rgba(255, 75, 43, 0.4);
    cursor: pointer; font-size: 24px;
    display: flex; align-items: center; justify-content: center;
    transition: transform 0.2s;
  }
  .print-fab:hover { transform: scale(1.1); }

  /* Hero */
  .hero-banner {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    padding: 40px 15px 25px 15px; text-align: center; position: relative; overflow: hidden;
  }
  .hero-banner h1 {
    color: white; font-size: 1.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
  }
  .offer-badge {
    display: inline-block; background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
    color: #1a1a1a; padding: 10px 25px; border-radius: 30px;
    font-size: 1.2em; font-weight: 900; margin: 10px 0;
    box-shadow: 0 8px 20px rgba(255,165,0,0.5); border: 2px solid rgba(255,255,255,0.5);
  }

  /* Date & Countdown */
  .offer-dates-container { display: flex; justify-content: center; gap: 10px; margin: 15px 0; flex-wrap: wrap; }
  .date-box {
    background: rgba(255,255,255,0.95); padding: 10px 15px; border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2); border: 2px solid #FFD700; color: #333;
  }
  .date-box .label { font-size: 0.7em; color: #666; font-weight: 600; display: block; margin-bottom: 3px; }
  .date-box .date-value { font-size: 0.85em; color: #f5576c; font-weight: bold; }

  .countdown-timer { display: flex; justify-content: center; gap: 8px; margin-top: 15px; }
  .countdown-item {
    background: rgba(255,255,255,0.95); padding: 10px 15px; border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2); border: 2px solid rgba(245,87,108,0.3); color: #333;
  }
  .countdown-item .number {
    display: block; font-size: 1.5em; font-weight: 900;
    background: linear-gradient(135deg, #f5576c 0%, #764ba2 100%);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
  }
  .countdown-item .label { font-size: 0.65em; color: #555; margin-top: 3px; font-weight: 600; text-transform: uppercase; display: block; }

  /* Search & Filter */
  .global-search-wrapper {
    padding: 10px 15px 0 15px; background: var(--filter-bg); transition: background 0.3s;
  }
  .global-search-box {
    width: 100%; padding: 10px 14px; border-radius: 12px; border: 2px solid var(--input-border);
    background: var(--input-bg); color: var(--text-main); font-size: 0.9em; font-weight: 600; outline: none;
  }
  .filter-section {
    background: var(--filter-bg); padding: 10px 15px 20px 15px; border-bottom: 3px solid #667eea;
    transition: background 0.3s;
  }
  .filter-title {
    font-size: 1.3em; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
    margin-bottom: 15px; text-align: center; font-weight: 900;
  }
  
  /* RESPONSIVE FILTER GRID */
  .filters-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
  @media (max-width: 768px) { .filters-container { grid-template-columns: repeat(2, 1fr); } }
  @media (max-width: 480px) { .filters-container { grid-template-columns: 1fr; } }

  .filter-group label {
    display: flex; align-items: center; gap: 5px; margin-bottom: 8px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
    font-weight: 700; font-size: 0.75em; text-transform: uppercase;
  }
  
  /* Custom Select */
  .custom-select { position: relative; width: 100%; }
  .custom-select-trigger {
    width: 100%; padding: 12px 35px 12px 15px; border: 2px solid var(--input-border);
    border-radius: 12px; font-size: 0.85em; background: var(--input-bg); color: var(--text-main);
    cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: space-between;
  }
  .custom-select.open .custom-select-trigger { border-color:#667eea; }
  .custom-select-options {
    position: absolute; top: calc(100% + 5px); left: 0; width: 100%;
    background: var(--input-bg); border: 2px solid #667eea; border-radius: 12px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15); max-height: 280px; overflow: hidden; z-index: 1000;
    display: none; flex-direction: column;
  }
  .custom-select.open .custom-select-options { display:flex; }
  .custom-select-search {
    padding: 10px 12px; border: none; border-bottom: 2px solid var(--input-border);
    font-size: 0.85em; font-weight: 600; outline: none; background: var(--input-bg); color: var(--text-main);
  }
  .custom-options-list { overflow-y:auto; flex:1; }
  .custom-option {
    padding: 10px 15px; cursor: pointer; display: flex; align-items: center; gap: 10px;
    font-size: 0.85em; font-weight: 600; color: var(--text-main);
  }
  .custom-option:hover { background: linear-gradient(135deg, #eef4ff 0%, #d9e4ff 100%); }
  [data-theme="dark"] .custom-option:hover { background: #444; }
  .custom-option.hidden { display:none; }
  .selected-count {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;
    padding: 2px 8px; border-radius: 12px; font-size: 0.75em; font-weight: 700; margin-left: 5px;
  }

  /* Products Section */
  .products-section { padding: 15px; background: var(--bg-body); transition: background 0.3s; min-height: 200px; }
  
  /* Category Headers & Styles */
  .category-a-header {
    background: var(--header-gradient); padding: 15px 20px; border-radius: 15px; margin-bottom: 20px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.2); text-align: center;
  }
  .category-a-header h2 { color: white; font-size: 1.8em; font-weight: 900; letter-spacing: 1px; }
  
  .cat-b-container { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
  .category-b-header {
    background: var(--cat-b-bg); color: var(--cat-b-text); padding: 12px 20px; border-radius: 12px; 
    margin-bottom: 0; border-left: 6px solid #667eea; display: inline-flex; align-items: center; 
    gap: 15px; min-width: 220px; box-shadow: 0 4px 10px rgba(0,0,0,0.15);
  }
  .category-b-header h3 { font-size: 1.2em; font-weight: 800; margin: 0; text-transform: uppercase; }
  .cat-b-icon { height: 45px; width: auto; object-fit: contain; display: block; background: transparent; border: none; }
  .cat-b-hero { height: 75px; width: auto; object-fit: contain; display: block; background: transparent; border: none; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2)); }

  /* Offer Group Section */
  .offer-group-container { background: var(--offer-group-bg); border: 1px solid var(--offer-group-border); border-radius: 12px; padding: 15px; margin-bottom: 25px; }
  .offer-group-header { display: flex; align-items: center; justify-content: center; margin-bottom: 15px; }
  .premium-offer-badge { margin: 0; max-width: 350px; border-radius: 20px; padding: 10px 20px; text-align: center; min-height: auto; display: inline-flex; align-items: center; justify-content: center; }
  .premium-offer-badge .main-text { font-size: 1.5em; font-weight: 900; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }

  /* Offer Styles (Kept same) */
  .offer-5-direct, .offer-10-direct { background: linear-gradient(135deg, #667eea 0%, #4facfe 100%); border: 5px solid #2196F3; }
  .offer-15-direct, .offer-20-direct { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); border: 5px solid #00b894; }
  .offer-25-direct, .offer-30-direct { background: linear-gradient(135deg, #a8c0ff 0%, #667eea 100%); border: 5px solid #5f27cd; }
  .offer-35-direct, .offer-40-direct { background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%); border: 5px solid #e17055; }
  .offer-45-direct, .offer-50-direct { background: linear-gradient(135deg, #FFD700 0%, #FF8C00 100%); border: 5px solid #B8860B; }
  .offer-55-direct, .offer-60-direct { background: linear-gradient(135deg, #00d2ff 0%, #3a7bd5 100%); border: 5px solid #0984e3; }
  .offer-65-direct, .offer-70-direct { background: linear-gradient(135deg, #a8e063 0%, #56ab2f 100%); border: 5px solid #27ae60; }
  .offer-75-direct, .offer-80-direct { background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%); border: 5px solid #e84393; }
  .offer-85-direct, .offer-90-direct { background: linear-gradient(135deg, #004e92 0%, #000428 100%); border: 5px solid #00F0FF; }
  .offer-95-direct, .offer-99-direct { background: linear-gradient(135deg, #0f0c29 0%, #302b63 0%, #24243e 100%); border: 5px solid #FFD700; }
  .offer-1plus1-5disc { background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%); border: 5px solid #e17055; }
  .offer-2plus1-free { background: linear-gradient(135deg, #ee5a6f 0%, #c44569 100%); border: 5px solid #d63031; }
  .offer-2plus2-free { background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%); border: 5px solid #5f27cd; }
  
  /* Product Grid */
  .products-grid { display: grid; gap: 8px; grid-template-columns: repeat(4, 1fr); }
  @media (max-width: 992px) { .products-grid { grid-template-columns: repeat(3, 1fr); } }
  @media (max-width: 600px) {
    .products-grid { display: grid; grid-template-columns: repeat(3, minmax(105px, 1fr)); gap: 4px; overflow-x: auto; padding-bottom: 5px; }
    .product-card { padding: 4px !important; border-radius: 6px; min-width: 105px; }
    .product-code { font-size: 0.4em !important; padding: 1px 4px; margin-bottom: 3px; }
    .product-name { font-size: 0.55em !important; -webkit-line-clamp: 3; line-height: 1.1; margin-bottom: 3px; min-height: 22px; }
    .product-offer-badge { font-size: 0.45em !important; padding: 1px 4px; margin-bottom: 3px; }
    .product-price { gap: 1px; margin-bottom: 4px; }
    .original-price { font-size: 0.65em !important; }
    .offer-price { font-size: 0.85em !important; }
    .brand-box { font-size: 0.55em !important; padding: 2px 4px; margin-top: 2px; }
    .riyal-symbol { width: 0.8em; height: 0.8em; }
  }
  
  .product-card {
    background: var(--card-bg); border-radius:10px; padding:8px;
    box-shadow:0 4px 15px var(--card-shadow); transition:all 0.3s ease; border:2px solid transparent;
    display: flex; flex-direction: column;
  }
  .product-card:hover { transform: translateY(-5px); }
  
  .product-code { display:inline-block; background:linear-gradient(135deg,#e3f2fd 0%,#bbdefb 100%); color:#1976d2; padding:3px 8px; border-radius:12px; font-size:0.55em; font-weight:700; margin-bottom:6px; }
  .product-name { font-size:0.65em; color: var(--text-main); margin-bottom:6px; font-weight:700; line-height:1.2; min-height:28px; overflow:hidden; text-overflow:ellipsis; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; }
  .product-offer-badge { display:inline-block; padding:4px 10px; border-radius:8px; font-size:0.6em; font-weight:900; letter-spacing:1px; margin-bottom:6px; color: white; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: 2px solid #5f27cd; }
  .product-price { display:flex; flex-direction:column; gap:4px; margin-bottom:8px; }
  .original-price { font-size:0.7em; color: var(--text-secondary); text-decoration:line-through; font-weight:600; }
  .product-price.no-discount .original-price { text-decoration: none; font-size: 1em; font-weight: 900; background: linear-gradient(135deg,#f5576c 0%,#764ba2 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; color: var(--text-main); }
  .product-price.no-discount .offer-price { display: none; }
  .offer-price { font-size:1em; background:linear-gradient(135deg,#f5576c 0%,#764ba2 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; font-weight:900; }
  .brand-box { font-weight: 700; font-size: 0.9em; color: white !important; padding: 5px 10px; border-radius: 6px; text-align: center; margin-top: auto; box-shadow: 0 2px 4px rgba(0,0,0,0.4); text-shadow: 0 1px 3px rgba(0,0,0,0.5); border: 1px solid var(--brand-border); transition: transform 0.2s ease; }
  .brand-box:hover { transform: scale(1.05); }

  /* Theme Switch */
  .theme-switch-wrapper { position: absolute; top: 15px; right: 15px; z-index: 100; display: flex; align-items: center; }
  .theme-switch { display: inline-block; height: 34px; position: relative; width: 60px; }
  .theme-switch input { display:none; }
  .slider { background-color: #ccc; bottom: 0; cursor: pointer; left: 0; position: absolute; right: 0; top: 0; transition: .4s; border-radius: 34px; box-shadow: inset 0 0 5px rgba(0,0,0,0.2); }
  .slider:before { background-color: white; bottom: 4px; content: ""; height: 26px; left: 4px; position: absolute; transition: .4s; width: 26px; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
  input:checked + .slider { background-color: #667eea; }
  input:checked + .slider:before { transform: translateX(26px); }
  .slider .icon { color: #f39c12; position: absolute; top: 50%; transform: translateY(-50%); font-size: 14px; transition: opacity 0.3s; }
  .slider .sun { left: 8px; opacity: 1; }
  .slider .moon { right: 8px; opacity: 0; color: #f1c40f; }
  input:checked + .slider .sun { opacity: 0; }
  input:checked + .slider .moon { opacity: 1; }

  /* Spinner */
  .spinner { border: 4px solid rgba(0,0,0,0.1); width: 50px; height: 50px; border-radius: 50%; border-left-color: #09f; animation: spin 1s ease infinite; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  /* Offer Boxes Styles */
.offer-boxes-container {
  display: flex;
  gap: 20px;
  justify-content: center;
  margin: 30px auto;
  padding: 0 20px;
  max-width: 800px;
}

.offer-box {
  flex: 1;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 15px;
  padding: 25px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 8px 20px rgba(0,0,0,0.15);
  position: relative;
  overflow: hidden;
}

.offer-box:hover {
  transform: translateY(-5px);
  box-shadow: 0 12px 30px rgba(0,0,0,0.25);
}

.offer-box.online {
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.offer-box.special {
  background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

.offer-box::before {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: rgba(255,255,255,0.1);
  transform: rotate(45deg);
  transition: all 0.5s ease;
}

.offer-box:hover::before {
  left: 100%;
}

.offer-box-title {
  font-size: 24px;
  font-weight: bold;
  color: white;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
  letter-spacing: 2px;
  margin: 0;
  position: relative;
  z-index: 1;
}

@media (max-width: 768px) {
  .offer-boxes-container {
    flex-direction: column;
    gap: 15px;
  }
  
  .offer-box {
    padding: 20px;
  }
  
  .offer-box-title {
    font-size: 20px;
  }
}
/* ========== HERO BANNER ========== */
.hero-banner {
  background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
  padding: 40px 20px;
  text-align: center;
  color: white;
  border-radius: 20px;
  margin: 20px;
  box-shadow: 0 10px 40px rgba(30, 60, 114, 0.4);
}

.hero-content h1 {
  font-size: 42px;
  margin: 0 0 15px 0;
  text-shadow: 2px 2px 8px rgba(0,0,0,0.3);
  animation: glow 2s ease-in-out infinite alternate;
}

@keyframes glow {
  from { text-shadow: 2px 2px 8px rgba(0,0,0,0.3), 0 0 10px rgba(255,255,255,0.3); }
  to { text-shadow: 2px 2px 8px rgba(0,0,0,0.3), 0 0 20px rgba(255,255,255,0.6); }
}

.offer-badge {
  display: inline-block;
  background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
  color: #000;
  padding: 10px 30px;
  border-radius: 50px;
  font-size: 24px;
  font-weight: bold;
  margin-bottom: 20px;
  box-shadow: 0 5px 15px rgba(255, 215, 0, 0.5);
  animation: bounce 2s infinite;
}

@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}

/* ========== ÿ™Ÿàÿßÿ±ŸäÿÆ ÿßŸÑÿπÿ±Ÿàÿ∂ ========== */
.offer-dates-container {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin: 25px 0;
  flex-wrap: wrap;
}

.date-box {
  background: rgba(255,255,255,0.2);
  backdrop-filter: blur(10px);
  padding: 15px 30px;
  border-radius: 15px;
  border: 2px solid rgba(255,255,255,0.4);
  transition: all 0.3s ease;
}

.date-box:hover {
  background: rgba(255,255,255,0.3);
  transform: translateY(-3px);
  box-shadow: 0 8px 20px rgba(0,0,0,0.2);
}

.date-box .label {
  display: block;
  font-size: 14px;
  opacity: 0.9;
  margin-bottom: 5px;
  font-weight: 600;
}

.date-box .date-value {
  display: block;
  font-size: 20px;
  font-weight: bold;
  color: #ffd700;
}

/* ========== COUNTDOWN ========== */
.countdown-container {
  background: rgba(255,255,255,0.15);
  backdrop-filter: blur(10px);
  border-radius: 20px;
  padding: 25px;
  margin: 25px auto;
  max-width: 700px;
  border: 2px solid rgba(255,255,255,0.3);
}

.countdown-header {
  margin-bottom: 20px;
}

.countdown-header h2 {
  font-size: 24px;
  margin: 0;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.countdown-timer {
  display: flex;
  justify-content: center;
  gap: 20px;
  flex-wrap: wrap;
}

.countdown-item {
  background: rgba(255,255,255,0.9);
  backdrop-filter: blur(10px);
  padding: 20px 25px;
  border-radius: 15px;
  min-width: 100px;
  border: 2px solid rgba(42, 82, 152, 0.3);
  transition: all 0.3s ease;
  color: #1e3c72;
}

.countdown-item:hover {
  background: rgba(255,255,255,1);
  transform: scale(1.05);
  box-shadow: 0 5px 20px rgba(30, 60, 114, 0.3);
}

.countdown-item .number {
  display: block;
  font-size: 42px;
  font-weight: bold;
  line-height: 1;
  margin-bottom: 8px;
  text-shadow: 2px 2px 4px rgba(30, 60, 114, 0.2);
  color: #1e3c72;
}

.countdown-item .label {
  display: block;
  font-size: 14px;
  text-transform: uppercase;
  opacity: 0.8;
  letter-spacing: 1px;
  color: #2a5298;
}

/* ========== üî• NEXT OFFERS BOX ========== */
.next-offers-box {
  max-width: 650px;
  margin: 30px auto 0;
  background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
  border-radius: 20px;
  padding: 25px 30px;
  cursor: pointer;
  transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  box-shadow: 0 10px 30px rgba(255, 215, 0, 0.4);
  position: relative;
  overflow: hidden;
  border: 3px solid rgba(255,255,255,0.5);
}

.next-offers-box::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
  transition: left 0.6s;
}

.next-offers-box:hover::before {
  left: 100%;
}

.next-offers-box:hover {
  transform: translateY(-5px) scale(1.02);
  box-shadow: 0 15px 40px rgba(255, 215, 0, 0.6);
  border-color: rgba(255,255,255,0.8);
}

.next-offers-content {
  display: flex;
  align-items: center;
  gap: 25px;
  color: #000;
  position: relative;
  z-index: 1;
}

.next-offers-icon {
  font-size: 56px;
  animation: pulse 2s infinite;
  filter: drop-shadow(0 0 15px rgba(30, 60, 114, 0.6));
}

@keyframes pulse {
  0%, 100% { 
    transform: scale(1); 
    filter: drop-shadow(0 0 15px rgba(30, 60, 114, 0.6));
  }
  50% { 
    transform: scale(1.15); 
    filter: drop-shadow(0 0 25px rgba(30, 60, 114, 0.9));
  }
}

.next-offers-text {
  flex: 1;
  text-align: left;
}

.next-offers-text h3 {
  margin: 0 0 8px 0;
  font-size: 28px;
  font-weight: 800;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
  letter-spacing: 0.5px;
  color: #000;
}

.next-offers-text p {
  margin: 0;
  font-size: 18px;
  opacity: 0.9;
  font-weight: 500;
  color: #333;
}

.next-offers-arrow {
  color: #1e3c72;
  filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
}

.next-offers-arrow svg {
  display: block;
  animation: slideRight 1.5s infinite;
}

@keyframes slideRight {
  0%, 100% { 
    transform: translateX(0);
    opacity: 1;
  }
  50% { 
    transform: translateX(12px);
    opacity: 0.7;
  }
}

/* ========== RESPONSIVE ========== */
@media (max-width: 768px) {
  .hero-content h1 {
    font-size: 28px;
  }
  
  .offer-badge {
    font-size: 18px;
    padding: 8px 20px;
  }
  
  .date-box {
    padding: 12px 20px;
  }
  
  .date-box .date-value {
    font-size: 18px;
  }
  
  .countdown-container {
    padding: 20px;
  }
  
  .countdown-header h2 {
    font-size: 18px;
  }
  
  .countdown-item {
    min-width: 80px;
    padding: 15px 20px;
  }
  
  .countdown-item .number {
    font-size: 32px;
  }
  
  .next-offers-box {
    padding: 20px 25px;
    margin-top: 25px;
  }
  
  .next-offers-content {
    gap: 15px;
  }
  
  .next-offers-icon {
    font-size: 42px;
  }
  
  .next-offers-text h3 {
    font-size: 22px;
  }
  
  .next-offers-text p {
    font-size: 15px;
  }
  
  .next-offers-arrow svg {
    width: 32px;
    height: 32px;
  }
}

@media (max-width: 480px) {
  .hero-content h1 {
    font-size: 24px;
  }
  
  .offer-badge {
    font-size: 16px;
    padding: 6px 15px;
  }
  
  .countdown-item {
    min-width: 70px;
    padding: 12px 15px;
  }
  
  .countdown-item .number {
    font-size: 28px;
  }
  
  .next-offers-text h3 {
    font-size: 18px;
  }
  
  .next-offers-text p {
    font-size: 13px;
  }
}
/* ========== ÿ™Ÿàÿßÿ±ŸäÿÆ ÿßŸÑÿπÿ±Ÿàÿ∂ ========== */
.offer-dates-container {
  display: flex;
  justify-content: center;
  gap: 20px;
  margin: 25px 0;
  flex-wrap: wrap;
}

.date-box {
  background: rgba(255,255,255,0.2);
  backdrop-filter: blur(10px);
  padding: 15px 30px;
  border-radius: 15px;
  border: 2px solid rgba(255,255,255,0.4);
  transition: all 0.3s ease;
}

.date-box:hover {
  background: rgba(255,255,255,0.3);
  transform: translateY(-3px);
  box-shadow: 0 8px 20px rgba(0,0,0,0.2);
}

.date-box .label {
  display: block;
  font-size: 16px;
  opacity: 1;
  margin-bottom: 8px;
  font-weight: 700;
  color: #ffffff;
  text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
  letter-spacing: 1px;
}

.date-box .date-value {
  display: block;
  font-size: 22px;
  font-weight: bold;
  color: #ffd700;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}
/* ====== üîº MODERN MINIMAL STYLE ====== */
.back-to-top-btn {
  position: fixed;
  bottom: 30px;
  left: 30px;
  width: 55px;
  height: 55px;
  background: #1a1a2e;
  border: 2px solid #0f3460;
  border-radius: 12px;
  cursor: pointer;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
  z-index: 10000;
  display: none;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  opacity: 0;
  transform: translateY(50px);
}

.back-to-top-btn.show {
  display: flex;
  opacity: 1;
  transform: translateY(0);
}

.back-to-top-btn:hover {
  background: #16213e;
  transform: translateY(-5px);
  box-shadow: 0 8px 20px rgba(15, 52, 96, 0.5);
}

.arrow-up {
  width: 20px;
  height: 20px;
  border-top: 3px solid #00d4ff;
  border-right: 3px solid #00d4ff;
  transform: rotate(-45deg);
}

@media (max-width: 768px) {
  .back-to-top-btn {
    width: 50px;
    height: 50px;
  }
  .arrow-up {
    width: 16px;
    height: 16px;
    border-width: 2px;
  }
}
/* Reset Filter Buttons */
.reset-filter-btn {
  margin-top: 8px;
  padding: 8px 14px;
  background: linear-gradient(135deg, #e74c3c, #c0392b);
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 12px;
  font-weight: 600;
  width: 100%;
  transition: all 0.3s ease;
  box-shadow: 0 2px 6px rgba(231, 76, 60, 0.3);
}

.reset-filter-btn:hover {
  background: linear-gradient(135deg, #c0392b, #e74c3c);
  transform: translateY(-2px);
  box-shadow: 0 4px 10px rgba(231, 76, 60, 0.5);
}

.reset-filter-btn:active {
  transform: translateY(0);
}

@media (max-width: 768px) {
  .reset-filter-btn {
    padding: 6px 10px;
    font-size: 11px;
  }
}
/* ====== ‚úÖ FILTER CHECKBOX STYLING - ENHANCED ====== */
.custom-option {
  display: flex !important;
  align-items: center !important;
  gap: 10px !important;
  padding: 10px 12px !important;
  cursor: pointer !important;
  transition: all 0.2s ease !important;
  border-radius: 6px !important;
  margin: 3px 0 !important;
}

.custom-option:hover {
  background: rgba(102, 126, 234, 0.15) !important;
  transform: translateX(3px) !important;
}

.custom-options-list .custom-option input[type="checkbox"],
.custom-option input[type="checkbox"] {
  /* Reset ALL browser defaults */
  all: unset;
  
  /* Force Custom Appearance */
  -webkit-appearance: none !important;
  -moz-appearance: none !important;
  appearance: none !important;
  
  /* Size - Fixed & Visible */
  width: 20px !important;
  height: 20px !important;
  min-width: 20px !important;
  min-height: 20px !important;
  max-width: 20px !important;
  max-height: 20px !important;
  
  /* Display */
  display: inline-block !important;
  flex-shrink: 0 !important;
  
  /* Border - STRONGER for Light Mode */
  border: 3px solid #667eea !important;
  border-radius: 5px !important;
  
  /* Background - Dynamic based on theme */
  background: #f8f9fa !important;
  
  /* Positioning */
  position: relative !important;
  cursor: pointer !important;
  vertical-align: middle !important;
  
  /* Shadow - More visible */
  box-shadow: 
    0 2px 8px rgba(102, 126, 234, 0.35),
    inset 0 1px 3px rgba(0, 0, 0, 0.1) !important;
  
  /* Transition */
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
}

/* Hover State - More Visible */
.custom-options-list .custom-option input[type="checkbox"]:hover,
.custom-option input[type="checkbox"]:hover {
  border-color: #11998e !important;
  border-width: 3px !important;
  transform: scale(1.15) !important;
  box-shadow: 
    0 3px 12px rgba(17, 153, 142, 0.5),
    inset 0 1px 3px rgba(0, 0, 0, 0.15) !important;
  background: #ffffff !important;
}

/* Checked State - VISIBLE in ALL modes */
.custom-options-list .custom-option input[type="checkbox"]:checked,
.custom-option input[type="checkbox"]:checked {
  background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%) !important;
  border-color: #11998e !important;
  border-width: 3px !important;
  box-shadow: 
    0 4px 16px rgba(17, 153, 142, 0.7),
    inset 0 1px 5px rgba(255, 255, 255, 0.3) !important;
}

/* Checkmark - BOLD & VISIBLE */
.custom-options-list .custom-option input[type="checkbox"]:checked::after,
.custom-option input[type="checkbox"]:checked::after {
  content: '‚úì' !important;
  position: absolute !important;
  top: 50% !important;
  left: 50% !important;
  transform: translate(-50%, -50%) !important;
  color: #ffffff !important;
  font-size: 16px !important;
  font-weight: 900 !important;
  text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3) !important;
  line-height: 1 !important;
  animation: checkPop 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55) !important;
}

/* Animation */
@keyframes checkPop {
  0% { 
    transform: translate(-50%, -50%) scale(0) rotate(-45deg);
    opacity: 0;
  }
  50% { 
    transform: translate(-50%, -50%) scale(1.3) rotate(0deg);
    opacity: 1;
  }
  100% { 
    transform: translate(-50%, -50%) scale(1) rotate(0deg);
    opacity: 1;
  }
}

/* Label Text */
.custom-option span {
  flex: 1 !important;
  color: var(--text-primary, #333) !important;
  font-size: 14px !important;
  font-weight: 500 !important;
  user-select: none !important;
  line-height: 1.4 !important;
  cursor: pointer !important;
}

/* Focus State - Accessibility */
.custom-options-list .custom-option input[type="checkbox"]:focus,
.custom-option input[type="checkbox"]:focus {
  outline: none !important;
  border-color: #ffd700 !important;
  box-shadow: 
    0 0 0 4px rgba(255, 215, 0, 0.4),
    0 3px 12px rgba(255, 215, 0, 0.5) !important;
}

/* ====== DARK THEME ====== */
body[data-theme="dark"] .custom-option input[type="checkbox"],
[data-theme="dark"] .custom-option input[type="checkbox"],
.dark-mode .custom-option input[type="checkbox"] {
  background: rgba(42, 42, 42, 0.95) !important;
  border-color: #667eea !important;
  box-shadow: 
    0 2px 8px rgba(102, 126, 234, 0.4),
    inset 0 1px 3px rgba(255, 255, 255, 0.05) !important;
}

body[data-theme="dark"] .custom-option input[type="checkbox"]:hover,
[data-theme="dark"] .custom-option input[type="checkbox"]:hover,
.dark-mode .custom-option input[type="checkbox"]:hover {
  background: rgba(60, 60, 60, 0.95) !important;
  border-color: #11998e !important;
}

body[data-theme="dark"] .custom-option input[type="checkbox"]:checked,
[data-theme="dark"] .custom-option input[type="checkbox"]:checked,
.dark-mode .custom-option input[type="checkbox"]:checked {
  background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%) !important;
  border-color: #11998e !important;
}

body[data-theme="dark"] .custom-option span,
[data-theme="dark"] .custom-option span,
.dark-mode .custom-option span {
  color: #fff !important;
}

/* ====== LIGHT THEME - EXPLICIT ====== */
body[data-theme="light"] .custom-option input[type="checkbox"],
[data-theme="light"] .custom-option input[type="checkbox"],
.light-mode .custom-option input[type="checkbox"],
body:not([data-theme="dark"]) .custom-option input[type="checkbox"] {
  background: #ffffff !important;
  border-color: #5568d3 !important;
  border-width: 3px !important;
  box-shadow: 
    0 2px 10px rgba(85, 104, 211, 0.4),
    inset 0 1px 3px rgba(0, 0, 0, 0.08) !important;
}

body[data-theme="light"] .custom-option input[type="checkbox"]:hover,
[data-theme="light"] .custom-option input[type="checkbox"]:hover,
.light-mode .custom-option input[type="checkbox"]:hover,
body:not([data-theme="dark"]) .custom-option input[type="checkbox"]:hover {
  background: #f0f4ff !important;
  border-color: #11998e !important;
  box-shadow: 
    0 3px 15px rgba(17, 153, 142, 0.5),
    inset 0 1px 3px rgba(17, 153, 142, 0.1) !important;
}

body[data-theme="light"] .custom-option span,
[data-theme="light"] .custom-option span,
.light-mode .custom-option span,
body:not([data-theme="dark"]) .custom-option span {
  color: #2c3e50 !important;
}

/* ====== DISABLED STATE ====== */
.custom-option input[type="checkbox"]:disabled {
  opacity: 0.5 !important;
  cursor: not-allowed !important;
  border-color: #ccc !important;
}

.custom-option input[type="checkbox"]:disabled + span {
  opacity: 0.5 !important;
  cursor: not-allowed !important;
}

/* ====== MOBILE RESPONSIVE ====== */
@media (max-width: 768px) {
  .custom-option {
    padding: 9px 10px !important;
    gap: 8px !important;
  }
  
  .custom-option input[type="checkbox"] {
    width: 18px !important;
    height: 18px !important;
    min-width: 18px !important;
    min-height: 18px !important;
    max-width: 18px !important;
    max-height: 18px !important;
    border-width: 2.5px !important;
  }
  
  .custom-option input[type="checkbox"]:checked::after {
    font-size: 14px !important;
  }
  
  .custom-option span {
    font-size: 13px !important;
  }
}

/* ====== BROWSER-SPECIFIC FIXES ====== */
/* Safari */
@supports (-webkit-appearance: none) {
  .custom-option input[type="checkbox"] {
    -webkit-appearance: none !important;
  }
}

/* Firefox */
@-moz-document url-prefix() {
  .custom-option input[type="checkbox"] {
    -moz-appearance: none !important;
  }
}

/* Edge/IE */
.custom-option input[type="checkbox"]::-ms-check {
  display: none !important;
}

/* ====== üì∞ MAGAZINE MODE STYLES ====== */
.magazine-category-section {
  margin-bottom: 0;
  position: relative;
}

.magazine-section-header {
  padding: 20px 25px;
  color: white;
  text-align: center;
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 20px;
}

.magazine-header-health { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
.magazine-header-baby { background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%); }
.magazine-header-beauty { background: linear-gradient(135deg, #ec4899 0%, #be185d 100%); }
.magazine-header-personal { background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); }

.magazine-content-health { background: #ecfdf5; }
.magazine-content-baby { background: #eff6ff; }
.magazine-content-beauty { background: #fdf2f8; }
.magazine-content-personal { background: #fef2f2; }

.magazine-section-title {
  font-size: 32px;
  font-weight: 900;
  text-transform: uppercase;
  letter-spacing: 2px;
}

.magazine-category-icon {
  width: 50px;
  height: 50px;
  filter: drop-shadow(0 2px 8px rgba(0,0,0,0.2));
}

.magazine-category-badge {
  position: absolute;
  top: 50%;
  right: 0;
  transform: translateY(-50%);
  background: rgba(255,255,255,0.25);
  padding: 10px 30px;
  border-radius: 25px 0 0 25px;
  font-weight: 800;
  font-size: 13px;
  backdrop-filter: blur(10px);
  border: 2px solid rgba(255,255,255,0.3);
}

.magazine-section-content {
  padding: 40px 20px;
}

.magazine-products-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 30px;
  padding: 0 15px;
}
/* ====== üì∞ MAGAZINE MODE - COMPLETE STYLES ====== */

/* ===== 1Ô∏è‚É£ MAGAZINE PAGINATION WRAPPER ===== */
.magazine-pagination-wrapper {
  position: relative;
  width: 100%;
  max-width: 1200px;
  margin: 0 auto;
  overflow: hidden;
  padding: 20px;
}

.magazine-pages-container {
  position: relative;
  width: 100%;
  perspective: 1500px;
  touch-action: pan-y pinch-zoom;
}
/* ===== 2Ô∏è‚É£ MAGAZINE PAGE - COLORED BACKGROUNDS ===== */
.magazine-page {
  display: none;
  width: 100%;
  min-height: 85vh;
  padding: 30px 20px;
  border-radius: 15px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.15);
  animation: fadeInPage 0.5s ease;
  transform: scale(0.85);
  transform-origin: center top;
  transition: background 0.3s ease;
}

.magazine-page.active {
  display: block;
}

@keyframes fadeInPage {
  from {
    opacity: 0;
    transform: scale(0.85) translateX(50px);
  }
  to {
    opacity: 1;
    transform: scale(0.85) translateX(0);
  }
}

/* üé® Page Backgrounds - ŸÑŸàŸÜ ÿßŸÑŸáŸäÿØÿ± ÿ®ÿØÿ±ÿ¨ÿ© ÿ£ŸÅÿ™ÿ≠ */
.magazine-page.magazine-page-health {
  background: linear-gradient(to bottom, 
    rgba(236, 253, 245, 0.98) 0%, 
    rgba(209, 250, 229, 0.92) 100%) !important;
}

.magazine-page.magazine-page-baby {
  background: linear-gradient(to bottom, 
    rgba(239, 246, 255, 0.98) 0%, 
    rgba(219, 234, 254, 0.92) 100%) !important;
}

.magazine-page.magazine-page-beauty {
  background: linear-gradient(to bottom, 
    rgba(253, 242, 248, 0.98) 0%, 
    rgba(252, 231, 243, 0.92) 100%) !important;
}

.magazine-page.magazine-page-personal {
  background: linear-gradient(to bottom, 
    rgba(254, 242, 242, 0.98) 0%, 
    rgba(254, 226, 226, 0.92) 100%) !important;
}

/* ===== 3Ô∏è‚É£ CATEGORY HEADER - STICKY ===== */
.magazine-category-header {
  position: sticky;
  top: 0;
  z-index: 100;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 20px;
  padding: 20px;
  margin-bottom: 25px;
  border-radius: 15px;
  box-shadow: 0 5px 20px rgba(0,0,0,0.2);
  backdrop-filter: blur(10px);
}

.magazine-category-header.header-health {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
}

.magazine-category-header.header-baby {
  background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
}

.magazine-category-header.header-beauty {
  background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);
}

.magazine-category-header.header-personal {
  background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
}

.magazine-category-icon-svg {
  width: 50px;
  height: 50px;
  filter: drop-shadow(0 3px 8px rgba(0,0,0,0.3));
}

.magazine-category-title-text {
  font-size: 32px;
  font-weight: 900;
  color: white;
  text-shadow: 0 3px 10px rgba(0,0,0,0.3);
  letter-spacing: 2px;
}

/* ===== 4Ô∏è‚É£ PAGE GRID ===== */
.magazine-page-grid {
  display: grid;
  gap: 15px;
  width: 100%;
}

.magazine-page-row {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 12px;
}

/* ===== 5Ô∏è‚É£ PRODUCT CARD - NO BORDERS, NO BOX ===== */
.magazine-product-card {
  position: relative !important;
  display: flex !important;
  flex-direction: column !important;
  align-items: center !important;
  padding: 0 !important;
  background: transparent !important;
  border: none !important;
  border-radius: 0 !important;
  box-shadow: none !important;
  cursor: pointer !important;
  transition: transform 0.3s ease !important;
  height: auto !important;
  min-height: auto !important;
}

.magazine-product-card:hover {
  transform: translateY(-8px) !important;
  box-shadow: none !important;
}

/* ===== 6Ô∏è‚É£ IMAGE WRAPPER - BIGGER SIZE, NO BORDERS, NO BACKGROUND ===== */
.magazine-product-card .magazine-product-image-wrapper {
  position: relative !important;
  width: 100% !important;
  height: 220px !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  padding: 10px !important;
  margin-bottom: 12px !important;
  border-radius: 0 !important;
  border: none !important;
  box-shadow: none !important;
  transition: all 0.3s ease !important;
  overflow: visible !important;
  background: transparent !important;
  backdrop-filter: none !important;
}

.magazine-product-card:hover .magazine-product-image-wrapper {
  box-shadow: none !important;
  transform: scale(1.03) !important;
}

/* ===== 7Ô∏è‚É£ IMAGE INSIDE - NO WHITE BACKGROUND + DARKEN MODE ===== */
.magazine-product-card .magazine-product-image-wrapper img,
.magazine-lazy-img {
  max-width: 110% !important;
  max-height: 110% !important;
  width: auto !important;
  height: auto !important;
  object-fit: contain !important;
  background: transparent !important;
  border: none !important;
  outline: none !important;
  box-shadow: none !important;
  opacity: 0 !important;
  transition: opacity 0.5s ease, transform 0.3s ease !important;
  mix-blend-mode: darken !important;
  filter: brightness(1) contrast(1.1) !important;
}

.magazine-product-card .magazine-product-image-wrapper img[src]:not([src=""]) {
  opacity: 1 !important;
}

.magazine-product-card:hover .magazine-product-image-wrapper img {
  transform: scale(1.05) !important;
}

/* ===== 8Ô∏è‚É£ COLORED BACKGROUNDS - ŸÅŸÇÿ∑ ÿπŸÑŸâ HOVER ===== */

/* ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿÆŸÑŸÅŸäÿßÿ™ ÿßŸÑÿ´ÿßÿ®ÿ™ÿ© ÿ™ŸÖÿßŸÖÿßŸã */
.magazine-page.magazine-page-health .magazine-product-image-wrapper,
.magazine-page.magazine-page-baby .magazine-product-image-wrapper,
.magazine-page.magazine-page-beauty .magazine-product-image-wrapper,
.magazine-page.magazine-page-personal .magazine-product-image-wrapper {
  background: transparent !important;
}

/* ÿßŸÑÿÆŸÑŸÅŸäÿ© ÿ™ÿ∏Ÿáÿ± ÿ®ÿ≥ ÿπŸÑŸâ hover */

/* HEALTH (Green) */
.magazine-page.magazine-page-health .magazine-product-card:hover .magazine-product-image-wrapper {
  background: radial-gradient(ellipse at center, 
    rgba(16, 185, 129, 0.12) 0%, 
    transparent 70%) !important;
}

/* BABY (Blue) */
.magazine-page.magazine-page-baby .magazine-product-card:hover .magazine-product-image-wrapper {
  background: radial-gradient(ellipse at center, 
    rgba(59, 130, 246, 0.12) 0%, 
    transparent 70%) !important;
}

/* BEAUTY (Pink) */
.magazine-page.magazine-page-beauty .magazine-product-card:hover .magazine-product-image-wrapper {
  background: radial-gradient(ellipse at center, 
    rgba(236, 72, 153, 0.12) 0%, 
    transparent 70%) !important;
}

/* PERSONAL (Red) */
.magazine-page.magazine-page-personal .magazine-product-card:hover .magazine-product-image-wrapper {
  background: radial-gradient(ellipse at center, 
    rgba(220, 38, 38, 0.12) 0%, 
    transparent 70%) !important;
}

/* ===== Dark Mode Support ===== */
[data-theme="dark"] .magazine-product-card .magazine-product-image-wrapper img {
  mix-blend-mode: lighten !important; 
  filter: brightness(1.15) !important;
}

/* ===== 9Ô∏è‚É£ PRODUCT INFO - NO BOX ===== */
.magazine-product-info {
  text-align: center !important;
  width: 100% !important;
  display: flex !important;
  flex-direction: column !important;
  gap: 8px !important;
  padding: 0 8px !important;
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
}

.magazine-brand-name {
  font-size: 16px !important;
  font-weight: 900 !important;
  color: #1f2937 !important;
  text-transform: uppercase !important;
  letter-spacing: 0.5px !important;
  background: rgba(100, 116, 139, 0.08) !important;
  padding: 6px 12px !important;
  border-radius: 8px !important;
  display: inline-block !important;
  border: none !important;
  box-shadow: none !important;
}
.magazine-item-name {
  font-size: 14px !important;
  color: #d97706 !important;  /* ‚≠ê ÿ®ÿ±ÿ™ŸÇÿßŸÑŸä ÿ∫ÿßŸÖŸÇ */
  line-height: 1.4 !important;
  min-height: 32px !important;
  max-height: 44px !important;
  overflow: hidden !important;
  display: -webkit-box !important;
  -webkit-line-clamp: 2 !important;
  -webkit-box-orient: vertical !important;
}


.magazine-category-d-name {
  font-size: 17px !important;
  font-weight: 800 !important;
  color: white !important;
  text-transform: uppercase !important;
  letter-spacing: 0.5px !important;
  padding: 6px 12px !important;
  border-radius: 10px !important;
  display: inline-block !important;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15) !important;
  border: none !important;
  transition: all 0.2s ease !important;
}

.magazine-category-d-name:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25) !important;
}

/* ===== üîü OFFER BADGES ===== */
.magazine-offer-circle {
  position: absolute;
  top: -5px;
  left: -5px;
  z-index: 15;
  pointer-events: none;
  transform: scale(0.55);
  transform-origin: top left;
}

.magazine-offer-circle svg {
  shape-rendering: geometricPrecision;
  image-rendering: -webkit-optimize-contrast;
  image-rendering: crisp-edges;
}

.magazine-offer-badge-complex {
  position: absolute;
  top: 1px;
  left: 50%;
  transform: translateX(-50%) scale(0.48);
  transform-origin: top center;
  z-index: 20;
  pointer-events: none;
}

.magazine-offer-badge-complex svg {
  shape-rendering: geometricPrecision;
  image-rendering: -webkit-optimize-contrast;
  image-rendering: crisp-edges;
}

.magazine-price-badge {
  transform: scale(0.58);
}

.magazine-best-seller-badge {
  position: absolute;
  top: 3px;
  right: 3px;
  background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  color: white;
  padding: 3px 8px;
  border-radius: 8px;
  font-size: 9px;
  font-weight: 900;
  box-shadow: 0 2px 6px rgba(245, 158, 11, 0.3);
  z-index: 10;
  letter-spacing: 0.5px;
  text-transform: uppercase;
}

/* Badge Colors */
.health .magazine-badge-circle-fill { fill: #10b981; }
.baby .magazine-badge-circle-fill { fill: #3b82f6; }
.beauty .magazine-badge-circle-fill { fill: #ec4899; }
.personal .magazine-badge-circle-fill { fill: #dc2626; }

/* ===== üåô DARK MODE ===== */
[data-theme="dark"] .magazine-page {
  background: #1a1a1a !important;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
}

[data-theme="dark"] .magazine-product-card .magazine-product-image-wrapper {
  box-shadow: none !important;
}

[data-theme="dark"] .magazine-product-card:hover .magazine-product-image-wrapper {
  box-shadow: none !important;
}

[data-theme="dark"] .magazine-brand-name {
  color: #e5e7eb !important;
  background: rgba(255, 255, 255, 0.05) !important;
}

[data-theme="dark"] .magazine-item-name {
  color: #9ca3af !important;
}

[data-theme="dark"] .magazine-product-card .magazine-product-image-wrapper img {
  mix-blend-mode: screen !important; /* ‚úÖ ŸÑŸÑŸÄ dark mode */
  filter: brightness(1.1) !important;
}

/* ===== üì± RESPONSIVE ===== */
@media (max-width: 768px) {
  .magazine-page {
    padding: 20px 10px;
  }
  
  .magazine-page-row {
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); /* ‚úÖ ÿ≤ŸàÿØŸÜÿßŸáÿß */
    gap: 10px;
  }
  
  .magazine-product-card .magazine-product-image-wrapper {
    height: 180px !important; /* ‚úÖ ÿ≤ŸàÿØŸÜÿßŸáÿß ŸÖŸÜ 140 ŸÑŸÄ 180 */
    padding: 8px !important;
  }
  
  .magazine-category-title-text {
    font-size: 24px;
  }
  
  .magazine-category-icon-svg {
    width: 40px;
    height: 40px;
  }
}

@media (max-width: 480px) {
  .magazine-page-row {
    grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); /* ‚úÖ ÿ≤ŸàÿØŸÜÿßŸáÿß */
  }
  
  .magazine-product-card .magazine-product-image-wrapper {
    height: 150px !important; /* ‚úÖ ÿ≤ŸàÿØŸÜÿßŸáÿß ŸÖŸÜ 120 ŸÑŸÄ 150 */
    padding: 5px !important;
  }
}


.magazine-brand-name {
  font-size: 18px;
  font-weight: 800;
  color: #1f2937;
  margin-bottom: 4px;
  text-align: center;
}

.magazine-item-name {
  font-size: 16px;
  color: #6b7280;
  margin-bottom: 6px;
  text-align: center;
  line-height: 1.3;
}

.magazine-category-d-name {
  font-size: 30px;
  font-weight: 700;
  color: white;
  padding: 4px 8px;
  border-radius: 6px;
  text-align: center;
  text-transform: uppercase;
}

/* Smaller Badges */
.magazine-offer-circle {
  position: absolute;
  top: -8px;
  left: 13px;
  z-index: 15;
  pointer-events: none;
  transform: scale(0.7);
  transform-origin: top left;
}

.magazine-offer-badge-complex {
  position: absolute;
  top: 1px;
  left: 50%;
  transform: translateX(-50%) scale(0.6);
  z-index: 20;
  pointer-events: none;
}

.magazine-best-seller-badge {
  position: absolute;
  top: 5px;
  right: 5px;
  background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  color: white;
  padding: 3px 8px;
  border-radius: 8px;
  font-size: 9px;
  font-weight: 900;
  box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4);
  z-index: 10;
}

/* Navigation - ÿ£ÿµÿ∫ÿ± Ÿàÿ£ÿ≠ÿ≥ŸÜ */
.magazine-nav-controls {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 20px;
  margin: 20px auto;
  padding: 15px;
  background: rgba(255,255,255,0.95);
  border-radius: 50px;
  box-shadow: 0 5px 20px rgba(0,0,0,0.15);
  max-width: 500px;
}

.magazine-nav-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 12px 24px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  border-radius: 25px;
  font-size: 14px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.magazine-nav-btn:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 6px 18px rgba(102, 126, 234, 0.5);
}

.magazine-nav-btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
}

.magazine-page-indicator {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 3px;
}

.magazine-page-number {
  font-size: 20px;
  font-weight: 900;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.magazine-page-total {
  font-size: 12px;
  color: #666;
  font-weight: 600;
}

/* Settings - ŸÖÿØŸÖÿ¨ÿ© ÿ£ŸÉÿ´ÿ± */
.magazine-settings {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 15px;
  margin: 15px auto;
  padding: 12px 20px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 3px 15px rgba(0,0,0,0.1);
  max-width: 700px;
  flex-wrap: wrap;
}

.magazine-setting-item {
  display: flex;
  align-items: center;
  gap: 8px;
}

.magazine-setting-item label {
  font-weight: 700;
  color: #333;
  font-size: 12px;
}

.magazine-setting-item input {
  width: 50px;
  padding: 6px 10px;
  border: 2px solid #667eea;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 700;
  text-align: center;
}

.magazine-apply-btn {
  padding: 8px 20px;
  background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
  color: white;
  border: none;
  border-radius: 8px;
  font-weight: 700;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.magazine-apply-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(17, 153, 142, 0.3);
}

/* Touch Indicator */
.magazine-swipe-hint {
  position: fixed;
  bottom: 100px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.7);
  color: white;
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.3s ease;
  z-index: 1000;
}

.magazine-swipe-hint.show {
  opacity: 1;
}

/* Responsive */
@media (max-width: 768px) {
  .magazine-page {
    transform: scale(0.95);
  }
  
  .magazine-page-row {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .magazine-category-title-text {
    font-size: 20px;
  }
  
  .magazine-category-icon-svg {
    width: 35px;
    height: 35px;
  }
}
/* ====== üåô DARK MODE FILTERS FIX - COMPLETE SOLUTION ====== */

/* Checkbox Labels - Dark Mode */
[data-theme="dark"] .checkbox-item label,
[data-theme="dark"] .filter-checkbox-label,
[data-theme="dark"] .brand-checkbox-list label,
[data-theme="dark"] .manufacture-checkbox-list label {
  color: #ffffff !important;
  font-weight: 500 !important;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8) !important;
}

/* Checkbox Item Container - Dark Mode */
[data-theme="dark"] .checkbox-item {
  background: rgba(55, 65, 81, 0.25) !important;
  border: 1px solid rgba(75, 85, 99, 0.3) !important;
}

[data-theme="dark"] .checkbox-item:hover {
  background: rgba(75, 85, 99, 0.4) !important;
  border-color: rgba(107, 114, 128, 0.5) !important;
}

/* Checkboxes Themselves - Dark Mode */
[data-theme="dark"] .checkbox-item input[type="checkbox"],
[data-theme="dark"] input[type="checkbox"] {
  background: rgba(55, 65, 81, 0.9) !important;
  border: 2px solid #667eea !important;
}

[data-theme="dark"] .checkbox-item input[type="checkbox"]:hover,
[data-theme="dark"] input[type="checkbox"]:hover {
  background: rgba(75, 85, 99, 0.9) !important;
  border-color: #11998e !important;
}

[data-theme="dark"] .checkbox-item input[type="checkbox"]:checked,
[data-theme="dark"] input[type="checkbox"]:checked {
  background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%) !important;
  border-color: #8b5cf6 !important;
}

/* Search Inputs - Dark Mode */
[data-theme="dark"] .brand-search-input,
[data-theme="dark"] .manufacture-search-input,
[data-theme="dark"] input[type="text"] {
  background: #374151 !important;
  color: #ffffff !important;
  border: 2px solid #4b5563 !important;
}

[data-theme="dark"] .brand-search-input::placeholder,
[data-theme="dark"] .manufacture-search-input::placeholder,
[data-theme="dark"] input[type="text"]::placeholder {
  color: #9ca3af !important;
  opacity: 0.9 !important;
}

/* Dropdown Lists - Dark Mode */
[data-theme="dark"] .brand-checkbox-list,
[data-theme="dark"] .manufacture-checkbox-list {
  background: #1f2937 !important;
  border: 2px solid #374151 !important;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.7) !important;
}

/* Scrollbar - Dark Mode */
[data-theme="dark"] .brand-checkbox-list::-webkit-scrollbar,
[data-theme="dark"] .manufacture-checkbox-list::-webkit-scrollbar {
  width: 10px;
  background: #111827;
}

[data-theme="dark"] .brand-checkbox-list::-webkit-scrollbar-thumb,
[data-theme="dark"] .manufacture-checkbox-list::-webkit-scrollbar-thumb {
  background: #4b5563;
  border-radius: 5px;
}

[data-theme="dark"] .brand-checkbox-list::-webkit-scrollbar-thumb:hover,
[data-theme="dark"] .manufacture-checkbox-list::-webkit-scrollbar-thumb:hover {
  background: #6b7280;
}

/* Selects - Dark Mode */
[data-theme="dark"] select {
  background: #374151 !important;
  color: #f3f4f6 !important;
  border-color: #4b5563 !important;
}

[data-theme="dark"] select option {
  background: #1f2937 !important;
  color: #f3f4f6 !important;
}
/* ====== üî• FIX BLURRY MAGAZINE MODE ====== */

/* Force crisp image rendering */
.magazine-item img,
.magazine-card img,
.product-image img {
  image-rendering: -webkit-optimize-contrast;
  image-rendering: crisp-edges;
  image-rendering: pixelated;
  image-rendering: auto;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  backface-visibility: hidden;
  -webkit-backface-visibility: hidden;
  transform: translateZ(0);
  -webkit-transform: translateZ(0);
}

/* Fix text rendering in magazine mode */
.magazine-item,
.magazine-card,
.magazine-item *,
.magazine-card * {
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  text-rendering: optimizeLegibility;
  backface-visibility: hidden;
  -webkit-backface-visibility: hidden;
}

/* Fix blurry transforms */
.magazine-item,
.magazine-card {
  transform: translateZ(0) scale(1);
  -webkit-transform: translateZ(0) scale(1);
  will-change: auto;
}

/* Remove blur from shadows */
.magazine-item,
.magazine-card {
  filter: none !important;
  -webkit-filter: none !important;
}

/* Fix brand logo rendering */
.magazine-brand-logo img,
.brand-logo img {
  image-rendering: -webkit-optimize-contrast;
  image-rendering: crisp-edges;
  transform: translateZ(0);
  backface-visibility: hidden;
}

/* Fix SVG rendering */
svg {
  shape-rendering: geometricPrecision;
  text-rendering: geometricPrecision;
}

/* Fix offer badges */
.magazine-offer-circle svg,
.magazine-offer-badge-complex svg {
  shape-rendering: geometricPrecision;
  image-rendering: -webkit-optimize-contrast;
  transform: translateZ(0);
}

/* Hardware acceleration for smooth rendering */
.magazine-container,
.magazine-items-container {
  transform: translateZ(0);
  -webkit-transform: translateZ(0);
  backface-visibility: hidden;
  -webkit-backface-visibility: hidden;
  perspective: 1000px;
  -webkit-perspective: 1000px;
}

/* Fix product names and text */
.magazine-product-name,
.magazine-brand-name,
.magazine-item h3,
.magazine-item p {
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  text-rendering: optimizeLegibility;
  font-variant-ligatures: none;
}

/* Remove any blur filters */
.magazine-item *,
.magazine-card * {
  filter: none;
  -webkit-filter: none;
}

/* Fix zoom/scale issues */
@media screen and (min-resolution: 1.5dppx) {
  .magazine-item img {
    image-rendering: -webkit-optimize-contrast;
  }
}
/* ====== üî• HIDE BRIEF MODE BUTTON ====== */
#briefModeBtn {
  display: none !important;
}

/* ====== üì∞ MAGAZINE MODE BUTTON - CURVED EDGES ====== */

#magazineModeToggle {
  position: relative !important;
  display: inline-block !important;
  padding: 18px 45px !important;
  border-radius: 50px !important; /* üî• ÿ≠ŸàÿßŸÅ ŸÖŸÜÿ≠ŸÜŸäÿ© ÿ¨ÿØÿßŸã */
  border: 3px solid rgba(255, 255, 255, 0.3) !important;
  color: white !important;
  font-weight: 900 !important;
  font-size: 17px !important;
  text-transform: uppercase !important;
  letter-spacing: 2.5px !important;
  cursor: pointer !important;
  transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55) !important;
  overflow: hidden !important;
  text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5), 0 0 20px rgba(255, 255, 255, 0.3) !important;
}

/* ‚ú® Hover Effect */
#magazineModeToggle:hover {
  transform: translateY(-6px) scale(1.08) !important;
  border-color: rgba(255, 255, 255, 0.6) !important;
}

/* üìÑ Paper Pages Effect - ŸÖŸÜÿ≠ŸÜŸä */
#magazineModeToggle::before {
  content: '';
  position: absolute;
  top: 8px;
  left: 8px;
  width: 30px;
  height: 35px;
  background: rgba(255, 255, 255, 0.25);
  border-radius: 8px; /* üî• ÿßŸÑŸàÿ±ŸÇ ŸÉŸÖÿßŸÜ ŸÖŸÜÿ≠ŸÜŸä */
  box-shadow: 
    5px 0 0 rgba(255, 255, 255, 0.2),
    10px 0 0 rgba(255, 255, 255, 0.15);
  transition: all 0.3s ease;
  z-index: 1;
}

/* üìñ Magazine Icon Animation */
#magazineModeToggle::after {
  content: 'üì∞';
  position: absolute;
  right: 15px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 26px;
  animation: bookFlip 2.5s ease-in-out infinite;
  z-index: 2;
}

@keyframes bookFlip {
  0%, 100% { 
    transform: translateY(-50%) rotateY(0deg); 
    opacity: 1;
  }
  50% { 
    transform: translateY(-50%) rotateY(180deg); 
    opacity: 0.7;
  }
}

/* üî• Active State Enhancement */
#magazineModeToggle.active::before {
  background: rgba(255, 255, 255, 0.35);
  box-shadow: 
    5px 0 0 rgba(255, 255, 255, 0.3),
    10px 0 0 rgba(255, 255, 255, 0.25);
}

/* üåä Ripple Effect on Click */
#magazineModeToggle:active {
  transform: translateY(-3px) scale(1.03) !important;
}

/* üíö Pulsing Glow for ON State */
#magazineModeToggle.active {
  animation: magazineGlow 2s ease-in-out infinite;
}

@keyframes magazineGlow {
  0%, 100% {
    box-shadow: 
      0 10px 30px rgba(17, 153, 142, 0.6),
      inset 0 2px 5px rgba(255, 255, 255, 0.3),
      0 0 25px rgba(56, 239, 125, 0.5);
  }
  50% {
    box-shadow: 
      0 10px 35px rgba(17, 153, 142, 0.8),
      inset 0 2px 8px rgba(255, 255, 255, 0.4),
      0 0 35px rgba(56, 239, 125, 0.8);
  }
}

/* üì± Mobile Responsive */
@media (max-width: 768px) {
  #magazineModeToggle {
    padding: 15px 35px !important;
    font-size: 15px !important;
    letter-spacing: 1.5px !important;
    border-radius: 40px !important; /* ŸÖŸÜÿ≠ŸÜŸä ŸÉŸÖÿßŸÜ ÿπŸÑŸâ ÿßŸÑŸÖŸàÿ®ÿßŸäŸÑ */
  }
  
  #magazineModeToggle::after {
    font-size: 22px;
    right: 120px;
  }
}
/* ====== üîº BACK TO TOP BUTTON - SIMPLE & CLEAN ====== */

.back-to-top-btn {
  position: fixed !important;
  bottom: 250px !important; /* ŸÅŸàŸÇ ÿ≤ÿ± ÿßŸÑÿ∑ÿ®ÿßÿπÿ© ÿ®ÿ¥ŸàŸäÿ© */
  right: 3px !important;
  left: auto !important;
  width: 60px !important;
  height: 60px !important;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
  border: none !important;
  border-radius: 50% !important;
  cursor: pointer !important;
  box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5) !important;
  z-index: 10000 !important;
  display: none !important;
  align-items: center !important;
  justify-content: center !important;
  transition: all 0.3s ease !important;
  opacity: 0 !important;
  transform: translateY(100px) !important;
}

/* ‚úÖ Show State */
.back-to-top-btn.show {
  display: flex !important;
  opacity: 1 !important;
  transform: translateY(0) !important;
}

/* ‚ú® Hover Effect - ÿÆŸÅŸäŸÅ */
.back-to-top-btn:hover {
  transform: translateY(-5px) !important;
  box-shadow: 0 12px 35px rgba(102, 126, 234, 0.7) !important;
}

/* üîº Arrow Design - ÿ®ÿ≥Ÿäÿ∑ */
.arrow-up {
  width: 0;
  height: 0;
  border-left: 15px solid transparent;
  border-right: 15px solid transparent;
  border-bottom: 20px solid white;
}

/* üîπ Arrow Tail */
.arrow-up::before {
  content: '';
  position: absolute;
  left: 50%;
  top: 20px;
  transform: translateX(-50%);
  width: 6px;
  height: 18px;
  background: white;
  border-radius: 3px;
}

/* üì± Mobile Responsive */
@media (max-width: 768px) {
  .back-to-top-btn {
    width: 50px !important;
    height: 50px !important;
    bottom: 200px !important;
    right: 20px !important;
  }
  
  .arrow-up {
    border-left: 12px solid transparent;
    border-right: 12px solid transparent;
    border-bottom: 16px solid white;
  }
  
  .arrow-up::before {
    width: 5px;
    height: 14px;
    top: 16px;
  }
}
/* ===== üéØ FORCE NAVIGATION TO TOP ===== */
.magazine-pagination-wrapper {
  position: relative;
  padding-bottom: 0 !important;
  margin-bottom: 0 !important;
}

.magazine-pages-container {
  padding-bottom: 0 !important;
  margin-bottom: 0 !important;
}

/* Navigation closer to content */
.magazine-nav-controls {
  margin-top: -20px !important; /* ‚úÖ Ÿäÿ∑ŸÑÿπ ŸÅŸàŸÇ ÿ£ŸÉÿ™ÿ± */
  margin-bottom: 10px !important;
}

/* Remove space after last row */
.magazine-page-row:last-of-type {
  margin-bottom: 0 !important;
  padding-bottom: 0 !important;
}
/* ===== üì¶ MAGAZINE CONTENT WRAPPER - COMPACT ===== */
.magazine-content-wrapper {
  display: flex;
  flex-direction: column;
  gap: 0 !important;
  margin: 0 !important;
  padding: 0 !important;
}

.magazine-pages-container {
  flex: 0 0 auto;
  margin-bottom: 0 !important;
  padding-bottom: 0 !important;
}

.magazine-nav-controls {
  flex: 0 0 auto;
  margin: 10px auto 15px auto !important; /* ‚úÖ ŸÖÿ≥ÿßŸÅÿ© ÿµÿ∫Ÿäÿ±ÿ© ŸÖŸÜ ŸÅŸàŸÇ */
  position: relative !important;
}
/* ===== üéØ WHEN NAVIGATION IS INSIDE PAGE ===== */
.magazine-page .magazine-nav-controls {
  margin: 10px auto 0 auto !important;
  position: relative !important;
  display: flex !important;
}

.magazine-page {
  padding-bottom: 15px !important;
}

.magazine-page-grid {
  margin-bottom: 0 !important;
}
/* ========== FIXED: MAGAZINE OFFER BADGES POSITIONING ========== */

.magazine-product-card {
  position: relative !important;
}
/* ========== üî• MAGAZINE OFFER CIRCLE BADGE - ADJUSTED INSIDE ========== */
.magazine-offer-circle {
  position: absolute !important;
  top: 1px !important;                /* ‚úÖ ÿ≤Ÿä ŸÖÿß ŸáŸà */
  left: 50% !important;               /* ‚úÖ ÿ®ÿØŸÑ 50px -> ŸÅŸä ÿßŸÑŸÜÿµ */
  z-index: 15 !important;
  pointer-events: none !important;

  /* ‚úÖ ŸÜŸÅÿ≥ ÿßŸÑÿ≠ÿ¨ŸÖ (scale 0.75) ÿ®ÿ≥ ŸÖÿπ ÿ™Ÿàÿ≥Ÿäÿ∑ */
  transform: translateX(-50%) scale(0.75) !important;
  transform-origin: top center !important;

  display: block !important;
  visibility: visible !important;
  opacity: 1 !important;
}

.magazine-offer-badge-complex {
  position: absolute !important;
  top: -12px !important;              /* ‚úÖ ÿ≤Ÿä ŸÖÿß ŸáŸà */
  left: 50% !important;
  transform: translateX(-50%) scale(0.60) !important; /* ‚úÖ ŸÜŸÅÿ≥ ÿßŸÑÿ≠ÿ¨ŸÖ ÿ≤Ÿä ŸÖÿß ŸáŸà */
  transform-origin: top center !important;
  z-index: 20 !important;
  pointer-events: none !important;
  display: block !important;
  visibility: visible !important;
  opacity: 1 !important;
}

.magazine-price-badge {
  transform: scale(0.78) !important;  /* ‚úÖ ŸÜŸÅÿ≥ ÿßŸÑÿ≠ÿ¨ŸÖ ÿ≤Ÿä ŸÖÿß ŸáŸà */
  transform-origin: top left !important;
}

/* SVG rendering fixes */
.magazine-offer-circle svg,
.magazine-offer-badge-complex svg {
  display: block !important;
  shape-rendering: geometricPrecision !important;
  image-rendering: -webkit-optimize-contrast !important;
  image-rendering: crisp-edges !important;
  transform: translateZ(0) !important;
  width: 100% !important;
  height: 100% !important;
}

/* Wrapper space for badges */
.magazine-product-image-wrapper {
  position: relative !important;
  overflow: visible !important;
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .magazine-offer-circle {
    top: 12px !important;             /* ‚úÖ ÿ≤Ÿä ŸÖÿß ŸáŸà */
    left: 50% !important;             /* ‚úÖ ŸÅŸä ÿßŸÑŸÜÿµ */
    transform: translateX(-50%) scale(0.85) !important; /* ‚úÖ ŸÜŸÅÿ≥ ÿßŸÑÿ≠ÿ¨ŸÖ ÿ®ÿ™ÿßÿπ ÿßŸÑŸÖŸàÿ®ÿßŸäŸÑ/ÿ™ÿßÿ®ŸÑÿ™ */
    transform-origin: top center !important;
  }

  .magazine-offer-badge-complex {
    top: 8px !important;              /* ‚úÖ ÿ≤Ÿä ŸÖÿß ŸáŸà */
    transform: translateX(-50%) scale(0.75) !important; /* ‚úÖ ŸÜŸÅÿ≥ ÿßŸÑÿ≠ÿ¨ŸÖ ÿ≤Ÿä ŸÖÿß ŸáŸà */
  }
}

@media (max-width: 480px) {
  .magazine-offer-circle {
    left: 50% !important;             /* ‚úÖ ÿ™ÿ£ŸÉŸäÿØ */
    transform: translateX(-50%) scale(0.9) !important;  /* ‚úÖ ŸÜŸÅÿ≥ ÿßŸÑÿ≠ÿ¨ŸÖ ÿ≤Ÿä ŸÖÿß ŸáŸà */
  }

  .magazine-offer-badge-complex {
    transform: translateX(-50%) scale(0.5) !important;  /* ‚úÖ ŸÜŸÅÿ≥ ÿßŸÑÿ≠ÿ¨ŸÖ ÿ≤Ÿä ŸÖÿß ŸáŸà */
  }
}

/* ‚úÖ Search Suggestions - ALL VISIBLE */
#searchSuggestions {
  max-width: 600px !important;
  width: 100% !important;
  max-height: 500px !important;
  overflow-y: auto !important;
  overflow-x: hidden !important;
}

#searchSuggestions > div.suggestion-item {
  display: flex !important;
  width: 100% !important;
  min-height: 65px !important;
  opacity: 1 !important;
  visibility: visible !important;
  padding: 12px 15px !important;
  box-sizing: border-box !important;
}

#searchSuggestions > div.suggestion-item:hover {
  background: rgba(102, 126, 234, 0.15) !important;
  transform: translateX(5px) !important;
}

#searchSuggestions > div:not(:first-child) {
  background: rgba(255, 255, 255, 0.03) !important;
}

#searchSuggestions > div:not(:first-child):hover {
  background: rgba(102, 126, 234, 0.2) !important;
}

.suggestion-item {
  display: flex !important;
  opacity: 1 !important;
  visibility: visible !important;
  min-height: 65px !important;
}

#searchSuggestions::-webkit-scrollbar {
  width: 8px;
}

#searchSuggestions::-webkit-scrollbar-track {
  background: rgba(0,0,0,0.2);
}

#searchSuggestions::-webkit-scrollbar-thumb {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 10px;
}

/* ‚úÖ Magazine Product Card - PERFECT BORDERS */
.magazine-product-card {
  position: relative;
  overflow: hidden !important;
  margin-bottom: 40px !important;
  padding: 15px !important;
  padding-bottom: 25px !important;
  border-bottom: 2px solid #e5e7eb;
  background: #fff;
  border-radius: 12px;
}

.magazine-product-card:last-child {
  border-bottom: none !important;
  margin-bottom: 20px !important;
}

/* ‚úÖ Offer Badge Styles */
.magazine-offer-badge {
  display: inline-block;
  padding: 6px 1px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 700;
  color: white;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  white-space: nowrap;
  text-align: center;
}

/* ‚úÖ Best Seller Badge */
.magazine-best-seller-badge {
  display: inline-block;
  background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  color: white;
  padding: 4px 10px;
  border-radius: 15px;
  font-size: 10px;
  font-weight: 700;
  box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
}

/* =========================================
   üì¶ MAGAZINE IMAGES - ÿ≠ÿØŸàÿØ ÿµÿßÿ±ŸÖÿ© ÿ®ÿØŸàŸÜ ÿ™ÿØÿßÿÆŸÑ
   ========================================= */

/* ÿßŸÑŸÉŸàŸÜÿ™ŸäŸÜÿ± ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä ŸÑŸÑÿµŸàÿ± */
.magazine-images-stack {
  display: flex !important;
  justify-content: center !important;
  align-items: center !important;
  height: 240px !important;          /* üî• ÿßÿ±ÿ™ŸÅÿßÿπ ÿ´ÿßÿ®ÿ™ */
  width: 100% !important;
  max-width: 100% !important;        /* üî• ÿπÿ±ÿ∂ ŸÖÿ≠ÿØÿØ */
  padding: 0 !important;          /* üî• padding ŸÖŸàÿ¨ÿ® */
  gap: 0px !important;               /* üî• ÿ®ÿØŸàŸÜ gap ÿ≥ÿßŸÑÿ® */
  overflow: hidden !important;       /* üî• ŸÖŸÜÿπ ÿßŸÑÿµŸàÿ± ÿ™ÿ∑ŸÑÿπ ÿ®ÿ±ÿ© */
  position: relative !important;
  background: transparent !important;
  margin: 0 auto !important;         /* üî• ÿ™Ÿàÿ≥Ÿäÿ∑ */
}

/* ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑÿµŸàÿ± */
.magazine-images-stack img {
  /* üî• ŸÉŸÑ ÿµŸàÿ±ÿ© ÿ®ÿ≠ÿ¨ŸÖ ŸÖÿ≠ÿØÿØ */
  max-width: 85% !important;
  max-height: 85% !important;
  width: auto !important;
  height: auto !important;
  
  flex-shrink: 1 !important;         /* üî• Ÿäÿµÿ∫ÿ± ŸÑŸà ŸÑÿßÿ≤ŸÖ */
  
  object-fit: contain !important;
  
  /* Reset ŸÉÿßŸÖŸÑ */
  position: static !important;
  transform: none !important;
  
  /* üî• ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿÆŸÑŸÅŸäÿ© ÿßŸÑÿ®Ÿäÿ∂ÿß */
  background: transparent !important;
  border: none !important;
  border-radius: 0 !important;
  padding: 0 !important;
  box-shadow: none !important;
  margin: 0 2px !important;          /* üî• margin ŸÖŸàÿ¨ÿ® = ŸÖÿ≥ÿßŸÅÿ© ÿ®ŸäŸÜ ÿßŸÑÿµŸàÿ± */
  
  /* ÿ∂ŸÑ ÿÆŸÅŸäŸÅ */
  filter: drop-shadow(0 2px 4px rgba(0,0,0,0.06)) !important;
  opacity: 1 !important;
  z-index: 1 !important;
}

/* ŸÑŸÖÿß ŸäŸÉŸàŸÜ ÿµŸàÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ÿ®ÿ≥ */
.magazine-images-stack img:only-child {
  margin: 0 !important;
  max-width: 90% !important;
}

/* ŸÑŸÖÿß ÿµŸàÿ±ÿ™ŸäŸÜ */
.magazine-images-stack:has(img:nth-child(2):last-child) img {
  max-width: 80% !important;
  margin: 0 3px !important;
}
/* üî• 3 ÿµŸàÿ±: ÿßŸÑÿ£ŸàŸÑŸâ ŸÉÿ®Ÿäÿ±ÿ©ÿå ÿßŸÑÿ®ÿßŸÇŸä ÿµÿ∫Ÿäÿ± ŸàŸÖÿ™ÿØÿßÿÆŸÑ */

/* ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑÿ£ŸàŸÑŸâ (ÿßŸÑŸÑŸä ÿπŸÑŸâ ÿßŸÑÿ¥ŸÖÿßŸÑ ÿπÿßÿØÿ©) */
.magazine-images-stack img:first-child:nth-last-child(3) {
  max-width: 85% !important;
  max-height: 85% !important;
  margin-right: -70px !important;
  z-index: 3 !important;
}

/* ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑÿ™ÿßŸÜŸäÿ© (ÿßŸÑŸÑŸä ŸÅŸä ÿßŸÑŸÜÿµ ‚Äì ŸÜŸÉÿ®ÿ±Ÿáÿß ÿ¥ŸàŸäÿ© Ÿàÿ™ÿ∫ÿ∑Ÿä ÿßŸÑŸÑŸä Ÿàÿ±ÿßŸáÿß) */
.magazine-images-stack img:nth-child(2):nth-last-child(2) {
  max-width: 75% !important;          /* ŸÉÿßŸÜÿ™ 65% ÿÆŸÑŸäŸÜÿßŸáÿß ÿ£ŸÉÿ®ÿ± */
  max-height: 75% !important;
  margin-right: -70px !important;
  z-index: 4 !important;              /* ÿ£ÿπŸÑŸâ Z-index ÿπÿ¥ÿßŸÜ ÿ™ÿ∫ÿ∑Ÿä ÿßŸÑŸÉŸÑ */
  filter: brightness(0.98);           /* ÿ™ŸÇÿ±Ÿäÿ®ÿßŸã ŸÜŸÅÿ≥ ÿßŸÑÿ•ÿ∂ÿßÿ°ÿ© */
}

/* ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑÿ™ÿßŸÑÿ™ÿ© (ÿßŸÑÿ£ÿÆŸäÿ±ÿ©) */
.magazine-images-stack img:nth-child(3):last-child {
  max-width: 65% !important;
  max-height: 65% !important;
  z-index: 1 !important;
  filter: brightness(0.9);
}

/* Hover Effect */
.magazine-images-stack:hover img {
  margin: 0 4px !important;
  filter: brightness(1) !important;
  transition: all 0.3s ease !important;
}

/* =========================================
   ‚ú® ÿ™ŸÅÿßÿπŸÑ ÿßŸÑŸÖÿßŸàÿ≥ (Hover Effects)
   ========================================= */

/* ÿ™ŸÉÿ®Ÿäÿ± ŸÑŸÖÿß ÿ™ŸÇŸÅ ÿπŸÑŸâ ÿßŸÑÿµŸàÿ±ÿ© */
.magazine-images-stack img:hover {
  transform: scale(1.03) !important;  /* üî• ÿ™ŸÉÿ®Ÿäÿ± ÿ£ŸÇŸÑ ÿπÿ¥ÿßŸÜ ŸÖŸäÿ∑ŸÑÿπÿ¥ ÿ®ÿ±ÿ© */
  z-index: 10 !important;
  filter: drop-shadow(0 6px 12px rgba(0,0,0,0.15)) !important;
  transition: transform 0.2s ease !important;
}

/* =========================================
   üéÆ ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ™ŸÜŸÇŸÑ (ÿ™ÿ≠ÿ™ ÿßŸÑÿµŸàÿ±)
   ========================================= */
.magazine-nav-controls {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 20px;
  margin-top: 25px; 
  margin-bottom: 20px;
  padding: 10px 30px;
  background: #fff;
  border-radius: 40px;
  box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
  width: fit-content;
  border: 1px solid #f0f0f0;
  margin-left: auto;
  margin-right: auto;
}

.magazine-nav-btn {
  padding: 10px 25px;
  background: linear-gradient(135deg, #2563eb, #1d4ed8);
  color: white;
  border: none;
  border-radius: 25px;
  font-weight: 700;
  font-size: 15px;
  cursor: pointer;
  transition: transform 0.2s;
}

.magazine-nav-btn:hover:not(:disabled) {
  transform: translateY(-2px);
  background: linear-gradient(135deg, #3b82f6, #2563eb);
}

.magazine-nav-btn:disabled {
  background: #e2e8f0;
  color: #94a3b8;
  cursor: not-allowed;
}

.magazine-page-info {
  font-family: 'Cairo', sans-serif;
  font-weight: 700;
  color: #333;
}

/* ====== ü•∑ NINJA iOS OPTIMIZATIONS ====== */

/* 1. Use content-visibility to skip rendering off-screen content */
.magazine-page, .magazine-card {
  content-visibility: auto;
  contain-intrinsic-size: 1px 1000px;
}

/* 2. Hardware Acceleration only where needed, not everywhere */
.magazine-card {
  backface-visibility: hidden;
  transform: translate3d(0,0,0);
}

/* 3. Stop layout thrashing on inputs */
input, select, textarea {
  font-size: 16px !important;
}

/* 4. Disable heavy effects on low-power mode or older devices if needed */
@media (prefers-reduced-motion: reduce) {
  * {
    animation-duration: 0.01ms !important;
    transition-duration: 0.01ms !important;
  }
}

.magazine-categories-nav {
  animation: slideDown 0.5s ease-out;
}

@keyframes slideDown {
  from { opacity: 0; transform: translateY(-20px); }
  to { opacity: 1; transform: translateY(0); }
}

.magazine-cat-btn:hover {
  transform: translateY(-3px) !important;
  box-shadow: 0 8px 25px rgba(102,126,234,0.6) !important;
}

/* Category Navigation Animation */
@keyframes slideDown {
  from { 
    opacity: 0; 
    transform: translateY(-30px) scale(0.9); 
  }
  to { 
    opacity: 1; 
    transform: translateY(0) scale(1); 
  }
}

.magazine-cat-btn:hover {
  transform: translateY(-4px) scale(1.05) !important;
  box-shadow: 0 10px 30px rgba(102,126,234,0.5) !important;
}

.magazine-cat-btn:active {
  transform: translateY(-2px) scale(1.02) !important;
}

/* Dark Mode Support */
[data-theme="dark"] .magazine-categories-nav {
  background: linear-gradient(135deg, rgba(31,41,55,0.98) 0%, rgba(17,24,39,0.95) 100%) !important;
  border-color: rgba(75,85,99,0.4) !important;
}


/* Mobile Responsive */
@media (max-width: 768px) {
  .magazine-categories-nav {
    padding: 12px 15px !important;
    gap: 8px !important;
  }
  
  .magazine-cat-btn {
    padding: 10px 18px !important;
    font-size: 11px !important;
  }
  
  .magazine-cat-btn span {
    font-size: 16px !important;
  }
}
/* üî• MAGAZINE CATEGORY NAV - FORCE DISPLAY */
#magazine-categories-nav {
  display: flex !important;
  animation: slideDown 0.5s ease-out !important;
}

@keyframes slideDown {
  from { opacity: 0; transform: translateY(-30px); }
  to { opacity: 1; transform: translateY(0); }
}

.magazine-cat-btn {
  transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55) !important;
}

.magazine-cat-btn:hover {
  transform: translateY(-4px) scale(1.05) !important;
}

[data-theme="dark"] #magazine-categories-nav {
  background: linear-gradient(135deg, #1e293b 0%, #334155 100%) !important;
}
/* IPHONE SAFARI ULTIMATE FIXES üî• */
@supports (-webkit-touch-callout: none) {
    html {
        -webkit-text-size-adjust: 100% !important;
        text-size-adjust: 100% !important;
    }
    
    /* MAGAZINE MODE - POSITION RELATIVE FIX */
    .magazine-product-card {
        position: relative !important;
        overflow: visible !important;
        contain: layout style paint !important;
    }
    
    /* IMAGES STACK - FLEX + ABSOLUTE FIX */
    .magazine-images-stack {
        position: relative !important;
        display: block !important; /* ÿ®ÿØŸÑ flex ŸÑŸÑŸÄ absolute children */
        height: 220px !important;
        overflow: visible !important;
    }
    
    .magazine-images-stack img {
        position: absolute !important;
        -webkit-transform: translateZ(0) !important;
        transform: translateZ(0) !important;
        will-change: transform !important;
        image-rendering: -webkit-optimize-contrast !important;
        backface-visibility: hidden !important;
    }
    
    /* OFFER BADGES - ABSOLUTE POSITION SAFARI FIX */
    .magazine-offer-circle,
    .magazine-offer-badge-complex,
    .magazine-best-seller-badge {
        position: absolute !important;
        -webkit-transform: translateZ(0) scale(0.75) !important;
        transform: translateZ(0) scale(0.75) !important;
        will-change: transform !important;
        contain: layout paint !important;
        z-index: 20 !important;
    }
    
    /* CONTAINER ŸÑŸÑŸÄ badges ŸÑÿßÿ≤ŸÖ relative */
    .magazine-product-image-wrapper {
        position: relative !important;
        overflow: visible !important;
    }
}
/* üéØ ÿ•ÿµŸÑÿßÿ≠ ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑÿ∑ÿ®ŸÇÿßÿ™ ÿπŸÑŸâ iOS Safari */
@supports (-webkit-touch-callout: none) {
  .magazine-images-stack {
    position: relative !important;
    isolation: isolate !important;              /* layer ŸÖÿ≥ÿ™ŸÇŸÑÿ© */
  }

  .magazine-images-stack img {
    position: relative !important;              /* ŸäÿÆŸÑŸä z-index ŸÖÿ≠ÿ™ÿ±ŸÖ */
    -webkit-backface-visibility: hidden !important;
    transform: translateZ(0);                   /* GPU fix */
  }

  /* ŸÜŸÉÿ±ÿ± ÿßŸÑŸÄ z-index ÿ®Ÿàÿ∂Ÿàÿ≠ ŸÑŸÄ iOS */
  .magazine-images-stack img:first-child:nth-last-child(3) {
    z-index: 2 !important;
  }
  .magazine-images-stack img:nth-child(2):nth-last-child(2) {
    z-index: 3 !important;  /* ÿßŸÑŸÜÿµ ÿ£ÿπŸÑŸâ Ÿàÿßÿ≠ÿØÿ© ÿØÿßŸäŸÖÿßŸã */
  }
  .magazine-images-stack img:nth-child(3):last-child {
    z-index: 1 !important;
  }
}
.magazine-page-navigation {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 20px;
  margin-top: 30px;
  padding: 20px;
  background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(249,250,251,0.9) 100%);
  border-radius: 15px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.magazine-nav-btn {
  padding: 12px 28px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  border-radius: 12px;
  font-weight: 700;
  font-size: 15px;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(102,126,234,0.4);
}

.magazine-nav-btn:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(102,126,234,0.6);
}

.magazine-nav-btn:disabled {
  background: #d1d5db;
  cursor: not-allowed;
  box-shadow: none;
}

.magazine-page-info {
  font-size: 16px;
  font-weight: 600;
  color: #374151;
  padding: 8px 16px;
  background: white;
  border-radius: 10px;
  box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
}

.magazine-page-info span {
  color: #667eea;
  font-weight: 800;
}
/* ÿµŸÅÿ≠ÿ© ÿßŸÑŸÖÿ¨ŸÑÿ© ÿ®Ÿäÿ∂ÿß */
.magazine-page {
  background: #ffffff !important;
}

/* ÿ®ŸÑŸàŸÉ ÿßŸÑŸÉÿßÿ™Ÿäÿ¨Ÿàÿ±Ÿä ŸÜŸÅÿ≥Ÿá */
.magazine-category-block {
  position: relative;
  margin: 24px 0;
  padding: 18px 14px 22px;
  overflow: hidden;
  border-radius: 32px;
}

/* ŸÅŸäŸÉÿ™Ÿàÿ± ÿÆŸÑŸÅŸäÿ© ÿÆŸÅŸäŸÅ ŸÑŸÉŸÑ ŸÉÿßÿ™Ÿäÿ¨Ÿàÿ±Ÿä ŸÅŸä ÿßŸÑÿµŸÅ */
.magazine-category-block::before {
  content: "";
  position: absolute;
  inset: 0;
  border-radius: 32px;
  background:
    radial-gradient(circle at -10% 0%, rgba(16,185,129,0.10) 0, transparent 60%),
    radial-gradient(circle at 110% 100%, rgba(59,130,246,0.12) 0, transparent 60%);
  opacity: 0.9;
  pointer-events: none;
  z-index: 0;
}

/* ŸÜÿÆŸÑŸä ÿßŸÑŸáŸäÿØÿ± ŸàÿßŸÑÿ¨ÿ±ŸäÿØ ŸÅŸàŸÇ ÿßŸÑÿÆŸÑŸÅŸäÿ© */
.magazine-category-header,
.magazine-category-products-grid {
  position: relative;
  z-index: 1;
}
/* ===== ÿ¥ÿ±Ÿäÿ∑ Category D ŸÅŸàŸÇ ŸÖÿ¨ŸÖŸàÿπÿ© ÿßŸÑŸÉÿ±Ÿàÿ™ ===== */
.magazine-catd-group {
  display: contents; /* ÿßŸÑŸÉÿ±Ÿàÿ™ ÿ™ŸÅÿ∂ŸÑ ŸÅŸä ŸÖŸÉÿßŸÜŸáÿß */
}

.magazine-catd-group-header {
  grid-column: 1 / -1; /* ŸäŸÖÿ™ÿØ ÿ®ÿπÿ±ÿ∂ ÿßŸÑÿµŸÅ */
  padding: 8px 16px;
  margin: 15px 0 8px 0;
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  border-radius: 12px;
  text-align: center;
  box-shadow: 0 3px 10px rgba(16, 185, 129, 0.3);
}

.magazine-catd-group-header span {
  font-family: 'Cairo', sans-serif;
  font-weight: 900;
  font-size: 14px;
  color: #ffffff;
  text-transform: uppercase;
  letter-spacing: 1px;
}

/* ÿÆŸÑŸÅŸäÿ© ÿÆŸÅŸäŸÅÿ© ŸÑŸÑŸÖÿ¨ŸÖŸàÿπÿ© */
.magazine-catd-group::before {
  content: "";
  grid-column: 1 / -1;
  height: 100%;
  background: linear-gradient(135deg, rgba(16,185,129,0.05) 0%, rgba(5,150,105,0.03) 100%);
  border-radius: 8px;
  margin: -10px;
  padding: 10px;
}
/* ===== ÿ¥ÿ±Ÿäÿ∑ Category D - ŸÜŸÅÿ≥ ÿ≠ÿ¨ŸÖ ÿßŸÑÿ®ŸàŸÉÿ≥ ÿßŸÑÿµÿ∫Ÿäÿ± ===== */
.magazine-catd-group-header {
  padding: 6px 12px !important;
  margin: 0 0 8px 0 !important;
  border-radius: 10px !important;
  text-align: center !important;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15) !important;
  border: none !important;
  transition: all 0.2s ease !important;
}

.magazine-catd-group-header span {
  font-family: 'Cairo', sans-serif !important;
  font-weight: 800 !important;
  font-size: 17px !important;
  color: white !important;
  text-transform: uppercase !important;
  letter-spacing: 0.5px !important;
  white-space: nowrap !important;
}

.magazine-catd-group-header:hover {
  transform: translateY(-2px) !important;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25) !important;
}

/* ÿ¥ŸäŸÑ Category D ŸÖŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑŸÉÿßÿ±ÿ™ */
.magazine-product-card .magazine-category-d-name {
  display: none !important;
}
/* ===== ÿßŸÑÿµŸÅÿ≠ÿ© ÿ®Ÿäÿ∂ÿß ===== */
.magazine-page {
  background: #ffffff !important;
}

/* ===== ÿµŸÅ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ===== */
.magazine-row-wrapper {
  display: flex;
  gap: 15px;
  margin-bottom: 20px;
  align-items: flex-start;
}

/* ===== ÿßŸÑÿ®ŸàŸÉÿ≥ ÿßŸÑÿµÿ∫Ÿäÿ± ÿ¨ŸÜÿ® ÿ®ÿπÿ∂ ===== */
.magazine-catd-inline-box {
  padding: 15px;
  border-radius: 15px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

/* ===== ŸáŸäÿØÿ± ÿßŸÑŸÖÿ¨ŸÖŸàÿπÿ© ===== */
.magazine-catd-inline-header {
  font-family: 'Cairo', sans-serif;
  font-weight: 900;
  font-size: 16px;
  color: white;
  text-align: center;
  padding: 10px 15px;
  border-radius: 10px;
  margin-bottom: 12px;
  text-transform: uppercase;
  letter-spacing: 1px;
  text-shadow: 0 2px 4px rgba(0,0,0,0.3);
  box-shadow: 0 3px 8px rgba(0,0,0,0.2);
}

/* ===== ÿßŸÑŸÉÿ±Ÿàÿ™ ÿ¨ŸàŸá ÿßŸÑÿ®ŸàŸÉÿ≥ ===== */
.magazine-catd-inline-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 12px;
}

/* ===== ÿ¥ŸäŸÑ Category D ŸÖŸÜ ÿ™ÿ≠ÿ™ ÿßŸÑŸÉÿßÿ±ÿ™ ===== */
.magazine-product-card .magazine-category-d-name {
  display: none !important;
}

/* ===== Responsive ===== */
@media (max-width: 768px) {
  .magazine-row-wrapper {
    flex-direction: column;
  }
  
  .magazine-catd-inline-box {
    flex: 1 1 100% !important;
  }
  
  .magazine-catd-inline-grid {
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  }
}
/* ===== ÿßŸÑÿµŸÅÿ≠ÿ© ===== */
.magazine-page {
  background: #ffffff !important;
}

/* ===== ÿµŸÅ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ===== */
.magazine-row-wrapper {
  display: flex;
  gap: 15px;
  margin-bottom: 20px;
  align-items: flex-start;
}

/* ===== ŸÖÿ¨ŸÖŸàÿπÿ© Category D ŸÉÿ¥ŸÉŸÑ ŸáŸÑÿßŸÖŸä ===== */
.magazine-blob-group {
  position: relative;
  padding: 25px 18px 22px 18px;
  overflow: visible;
}

/* ÿßŸÑÿÆŸÑŸÅŸäÿ© ÿßŸÑŸáŸÑÿßŸÖŸäÿ© */
.magazine-blob-bg {
  position: absolute;
  inset: -10px;
  background: rgba(0,0,0,0.03);
  opacity: 1;
  z-index: 0;
  filter: blur(0.2px);
}

/* ŸáŸäÿØÿ± ÿßŸÑŸÉÿßÿ™Ÿäÿ¨Ÿàÿ±Ÿä ÿ¨ŸàŸá ÿßŸÑŸÄ blob */
.magazine-blob-header {
  position: relative;
  z-index: 2;
  font-family: 'Cairo', sans-serif;
  font-weight: 900;
  font-size: 16px;
  color: #ffffff;
  text-align: center;
  padding: 8px 14px;
  border-radius: 999px;
  margin: 0 auto 14px auto;
  text-transform: uppercase;
  letter-spacing: 1px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.18);
}

/* ÿ¥ÿ®ŸÉÿ© ÿßŸÑŸÉÿ±Ÿàÿ™ ÿØÿßÿÆŸÑ ÿßŸÑŸÄ blob */
.magazine-blob-grid {
  position: relative;
  z-index: 2;
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 12px;
}

/* ===== ÿßŸÑŸÉÿßÿ±ÿ™ ÿ®ÿØŸàŸÜ ÿ£Ÿä ÿÆŸÑŸÅŸäÿ© ===== */
.magazine-product-card {
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
}

/* ===== ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿÆŸÑŸÅŸäÿ© ÿßŸÑÿ®Ÿäÿ∂ÿß ÿ≠ŸàÿßŸÑŸäŸÜ ÿßŸÑÿµŸàÿ± ===== */
.magazine-product-image-wrapper {
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
  padding: 0 !important;
}

.magazine-product-image-wrapper img,
.magazine-lazy-img,
.magazine-item img {
  display: block;
  max-width: 100% !important;
  height: auto !important;
  object-fit: contain !important;
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
}

/* ŸÑŸà ŸÉÿßŸÜ ÿπŸÜÿØŸÉ ŸÇÿ®ŸÑ ŸÉÿØŸá card container ÿ£ÿ®Ÿäÿ∂ */
.magazine-item,
.product-card,
.product-box {
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
}

/* ===== Responsive ===== */
@media (max-width: 768px) {
  .magazine-row-wrapper {
    flex-direction: column;
  }
  
  .magazine-blob-group {
    padding: 20px 12px;
  }
  
  .magazine-blob-grid {
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  }
}
/* ===== ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿÆŸÑŸÅŸäÿ© ÿßŸÑÿ®Ÿäÿ∂ÿß ŸÖŸÜ ÿßŸÑŸÉÿßÿ±ÿ™ ŸàÿßŸÑÿµŸàÿ± ===== */

/* ÿßŸÑŸÉÿßÿ±ÿ™ ŸÜŸÅÿ≥Ÿá */
.magazine-product-card {
  background: transparent !important;
  box-shadow: none !important;
}

/* wrapper ÿßŸÑÿµŸàÿ±ÿ© */
.magazine-product-image-wrapper,
.magazine-images-stack {
  background: transparent !important;
  padding: 0 !important;
  box-shadow: none !important;
}

/* ÿßŸÑÿµŸàÿ±ÿ© ŸÜŸÅÿ≥Ÿáÿß */
.magazine-lazy-img,
.magazine-product-card img {
  background: transparent !important;
  object-fit: contain !important;
  mix-blend-mode: multiply !important; /* ŸÑŸà ÿßŸÑÿµŸàÿ±ÿ© ŸÜŸÅÿ≥Ÿáÿß ŸÅŸäŸáÿß ÿÆŸÑŸÅŸäÿ© ÿ®Ÿäÿ∂ÿß ŸÖŸÜ ÿßŸÑŸÖŸÑŸÅ */
}

/* ŸÑŸà ŸÅŸäŸá classes ÿ™ÿßŸÜŸäÿ© ŸÑŸÑŸÉÿ±Ÿàÿ™ */
.product-card,
.product-box,
.magazine-item {
  background: transparent !important;
  box-shadow: none !important;
}

/* ÿ•ÿ≤ÿßŸÑÿ© ÿ£Ÿä border ÿ£Ÿà padding ÿ≤ÿßŸäÿØ */
.magazine-product-card,
.magazine-product-image-wrapper {
  border: none !important;
  border-radius: 0 !important;
}
/* üîª Force transparent background for every product container */
.magazine-row-wrapper,
.magazine-blob-group,
.magazine-blob-bg,
.magazine-blob-grid,
.magazine-product-card,
.magazine-product-image-wrapper,
.magazine-images-stack,
.magazine-product-card * {
  background-color: transparent !important;
  background: transparent !important;
  box-shadow: none !important;
  border: none !important;
}
/* ÿßŸÑÿ≠ÿßŸàŸäÿ© ÿßŸÑŸÑŸä ŸÅŸäŸáÿß ÿ£ŸÉÿ™ÿ± ŸÖŸÜ ÿµŸàÿ±ÿ© */
.magazine-images-stack {
  position: relative;
  display: inline-block;
  padding: 0;
  margin: 0;
  background: transparent;
}

/* ŸÉŸÑ ÿµŸàÿ±ÿ© ŸÅŸä ÿßŸÑŸÄ stack ŸÅŸàŸÇ ÿßŸÑŸÑŸä ŸÇÿ®ŸÑŸáÿß ŸÖÿπ ÿ£ŸàŸÅÿ≥ÿ™ ÿ®ÿ≥Ÿäÿ∑ ÿ£Ÿà ŸÖŸÜ ÿ∫Ÿäÿ± ÿ£ŸàŸÅÿ≥ÿ™ */
.magazine-images-stack .magazine-lazy-img {
  position: absolute;
  top: 0;
  left: 0;
  /* ŸÑŸà ÿπÿßŸäÿ≤ŸáŸÖ ŸÅŸàŸÇ ÿ®ÿπÿ∂ ÿ™ŸÖÿßŸÖŸãÿß */
  transform: none;
  border: none;
  background: transparent;
  box-shadow: none;
}

/* ŸÑŸà ÿπÿßŸäÿ≤ slight overlap ÿ®ÿ≥Ÿäÿ∑ ÿ®ÿØŸÑ ŸÖÿß ŸäŸÉŸàŸÜŸàÿß ŸÑÿßÿ≤ŸÇŸäŸÜ ÿ™ŸÖÿßŸÖŸãÿß */
.magazine-images-stack .stack-item-1 { left: 0; }
.magazine-images-stack .stack-item-2 { left: 10px; }
.magazine-images-stack .stack-item-3 { left: 20px; }

/* ÿ™ÿ£ŸÉÿØ ÿ•ŸÜ ÿßŸÑÿ≠ÿßŸàŸäÿ© ŸàÿßÿÆÿØÿ© ÿßÿ±ÿ™ŸÅÿßÿπ ÿßŸÑÿµŸàÿ±ÿ© */
.magazine-images-stack {
  height: 220px;  /* ÿ∏ÿ®ÿ∑Ÿáÿß ÿ≠ÿ≥ÿ® ÿ£ÿπŸÑŸâ ÿµŸàÿ±ÿ© ÿπŸÜÿØŸÉ */
}
/* ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑÿ¥ÿÆÿµŸäÿ© ŸÅŸä ÿßŸÑŸáŸäÿØÿ± */
.header-personal-img {
    position: absolute;
    left: 40px;        /* ÿßŸÑŸÖÿ≥ÿßŸÅÿ© ŸÖŸÜ ÿßŸÑŸäÿ≥ÿßÿ± */
    top: 40%;          /* ÿßŸÑŸÖŸàŸÇÿπ ÿßŸÑÿπŸÖŸàÿØŸä */
    transform: translateY(-50%);
    
    /* üëá ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿØÿßÿ¶ÿ±ÿ© ŸàÿßŸÑÿ≠ÿ¨ŸÖ */
    width: 140px;       
    height: 140px;      
    border-radius: 50%; /* ÿ¨ÿπŸÑ ÿßŸÑÿµŸàÿ±ÿ© ÿØÿßÿ¶ÿ±Ÿäÿ© */
    object-fit: cover;  /* ÿ∂ÿ®ÿ∑ ÿßŸÑÿµŸàÿ±ÿ© ÿØÿßÿÆŸÑ ÿßŸÑÿØÿßÿ¶ÿ±ÿ© */
    
    /* üëá Ÿáÿ∞ÿß ŸáŸà ÿßŸÑÿ≥ÿ∑ÿ± ÿßŸÑŸÖÿ≥ÿ§ŸàŸÑ ÿπŸÜ ÿßŸÑÿ≠ŸàÿßŸÅ ÿßŸÑÿ®Ÿäÿ∂ÿßÿ° */
    border: 5px solid #ffffff; 
    
    box-shadow: 0 5px 15px rgba(0,0,0,0.3); /* ÿ∏ŸÑ ŸÑÿ¨ŸÖÿßŸÑŸäÿ© ÿßŸÑÿ•ÿ∑ÿßÿ± */
    z-index: 10;
    display: block;
    background-color: white; 
}

/* ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑŸáŸäÿØÿ± ŸäŸÇÿ®ŸÑ ÿßŸÑÿ™ŸÖŸàÿ∂ÿπ ÿßŸÑŸÖÿ∑ŸÑŸÇ */
.hero-banner {
    position: relative !important; 
}

/* ÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖŸàÿ®ÿßŸäŸÑ */
@media (max-width: 768px) {
    .header-personal-img {
        display: block;
        left: 10px;
        
        /* ÿ™ÿµÿ∫Ÿäÿ± ÿßŸÑÿØÿßÿ¶ÿ±ÿ© ŸÅŸä ÿßŸÑŸÖŸàÿ®ÿßŸäŸÑ */
        width: 60px;
        height: 60px;
        max-height: 60px;
        
        /* ÿ™ÿµÿ∫Ÿäÿ± ÿ≥ŸÖŸÉ ÿßŸÑÿ•ÿ∑ÿßÿ± ÿßŸÑÿ£ÿ®Ÿäÿ∂ ŸÇŸÑŸäŸÑÿßŸã ŸÅŸä ÿßŸÑŸÖŸàÿ®ÿßŸäŸÑ ŸÑŸäŸÉŸàŸÜ ŸÖÿ™ŸÜÿßÿ≥ŸÇÿßŸã */
        border-width: 3px; 
    }
}
</style>
</head>
<body>

  <!-- Loading Overlay for Print -->
  <div id="printLoader">
    <div class="spinner"></div>
    <div style="margin-top:15px; font-size:1.2em;">Preparing Print Layout...<br>Please wait</div>
  </div>

  <!-- Export Button -->
  <div class="print-button-wrapper" style="top: 50%; right: 0; transform: translateY(-50%);">
    <button class="print-fab" onclick="startPrintProcess()" title="Export PDF">üñ®Ô∏è</button>
  </div>

  <!-- Screen Content -->
  <div class="container">
    <!-- Theme Switch -->
    <div class="theme-switch-wrapper">
      <label class="theme-switch" for="checkbox">
        <input type="checkbox" id="checkbox" />
        <div class="slider">
          <span class="icon sun">‚òÄÔ∏è</span>
          <span class="icon moon">üåô</span>
        </div>
      </label>
    </div>
<div class="hero-banner">
    <img src="https://raw.githubusercontent.com/meralmohamed121022-cyber/Drug-Monograph/858ba78ce2719a0e7069fd4807b725e0002a17d8/6_20251129_184528_0005.png" class="header-personal-img" alt="Profile">
    <div style="display: flex; align-items: center; gap: 15px; padding: 10px;">

    <div onclick="openEmail()" style="cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.2)'" onmouseout="this.style.transform='scale(1)'" title="Email">
        <svg width="30" height="30" viewBox="0 0 24 24" fill="none" style="filter: drop-shadow(0 2px 3px rgba(0,0,0,0.2));">
            <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z" fill="#ff6b6b"/>
        </svg>
    </div>

    <div onclick="openWhatsApp()" style="cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.2)'" onmouseout="this.style.transform='scale(1)'" title="WhatsApp">
        <svg width="30" height="30" viewBox="0 0 24 24" fill="none" style="filter: drop-shadow(0 2px 3px rgba(0,0,0,0.2));">
            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z" fill="#25D366"/>
        </svg>
    </div>

    <div onclick="openFacebook()" style="cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.2)'" onmouseout="this.style.transform='scale(1)'" title="Facebook">
        <svg width="30" height="30" viewBox="0 0 24 24" fill="none" style="filter: drop-shadow(0 2px 3px rgba(0,0,0,0.2));">
            <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z" fill="#1877F2"/>
        </svg>
    </div>

</div>
  <div class="hero-content">
    <h1>üî• MEGA PHARMACY OFFERS üî•</h1>
    <div class="offer-badge">  Offers</div>
    
    <!-- ÿ™Ÿàÿßÿ±ŸäÿÆ ÿßŸÑÿπÿ±Ÿàÿ∂ -->
    <div class="offer-dates-container">
      <div class="date-box">
        <span class="label">üéØ START</span>
        <span class="date-value">Dec 25, 2025</span>
      </div>
      <div class="date-box">
        <span class="label">‚è∞ END</span>
        <span class="date-value">Jan 07, 2026</span>
      </div>
    </div>
    
    <!-- Countdown Timer -->
    <div class="countdown-container">
      <div class="countdown-header">
        <h2 id="countdownTitle">‚è∞ ÿßŸÑÿπÿ±ÿ∂ ŸÑŸÖ Ÿäÿ®ÿØÿ£ ÿ®ÿπÿØ</h2>
      </div>
      <div class="countdown-timer">
        <div class="countdown-item">
          <span class="number" id="days">--</span>
          <span class="label">Days</span>
        </div>
        <div class="countdown-item">
          <span class="number" id="hours">--</span>
          <span class="label">Hours</span>
        </div>
        <div class="countdown-item">
          <span class="number" id="minutes">--</span>
          <span class="label">Min</span>
        </div>
        <div class="countdown-item">
          <span class="number" id="seconds">--</span>
          <span class="label">Sec</span>
        </div>
      </div>
    </div>
    
  </div>
</div>

    <!-- Modal ŸÑŸÑÿπÿ±ÿ∂ ÿßŸÑÿÆÿßÿµ -->
<div id="customPrintModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:10000; justify-content:center; align-items:center;">
  <div style="background:#1a1a2e; padding:30px; border-radius:15px; max-width:600px; width:90%; max-height:90vh; overflow-y:auto;">
    <h2 style="color:#fff; margin-bottom:20px;">üñ®Ô∏è Custom Offer Print</h2>
    <!-- Offer Types Multi-Select -->
<div style="margin-bottom:40px">
    <label style="color:#fff; display:block; margin-bottom:5px">üì¶ Offer Types</label>
    <div class="custom-select" data-filter="customOfferTypeFilter" id="customOfferTypeSelect">
        <div class="custom-select-trigger">
            <span class="selected-text">Select Offer Types</span>
            <span class="arrow">‚ñº</span>
        </div>
        <div class="custom-select-options">
            <input type="text" class="custom-select-search" placeholder="Search offer types...">
            <div class="custom-options-list" id="customOfferTypesList"></div>
        </div>
    </div>
    <small style="color:#888; display:block; margin-top:5px">Select multiple offer types or use custom below</small>
</div>

<!-- Custom Offer Type Input -->
<div style="margin-bottom:15px">
    <label style="color:#fff; display:block; margin-bottom:5px">‚úçÔ∏è Custom Offer Type (Optional)</label>
    <input type="text" id="customOfferTypeInput" placeholder="e.g. BUY 2 GET 3 FREE" 
           style="width:100%; padding:10px; border-radius:5px; border:none; background:#16213e; color:#fff">
    <small style="color:#888; display:block; margin-top:5px">Leave empty to use selected types above</small>
</div>

    <div style="margin-bottom:15px;">
   <label style="color:#fff; display:block; margin-bottom:5px">Product Code(s) <small style="color:#888">(Optional)</small></label>

      <input type="text" id="customCode" placeholder="213525, 213526, 213527" oninput="updateQuantityDisplay()" style="width:100%; padding:10px; border-radius:5px; border:none; background:#16213e; color:#fff;">
      <small style="color:#888; display:block; margin-top:5px;">üí° Multiple codes: separated by comma or space</small>
    </div>
    
   <div id="quantityContainer" style="margin-bottom:15px">
    <label style="color:#fff; display:block; margin-bottom:5px">üî¢ Number of Cards</label>
    <input type="number" id="customQuantity" value="6" min="1" max="100" 
           style="width:100%; padding:10px; border-radius:5px; border:none; background:#16213e; color:#fff">
    <small style="color:#888; display:block; margin-top:5px">How many cards? (Max: 100)</small>
</div>

    <div style="margin-bottom:15px;">
      <label style="color:#fff; display:block; margin-bottom:5px;">Offer Title (English)</label>
      <input type="text" id="customOfferEN" placeholder="40% OFF ON 2ND ITEM" style="width:100%; padding:10px; border-radius:5px; border:none; background:#16213e; color:#fff;">
    </div>
    
    <div style="margin-bottom:15px;">
      <label style="color:#fff; display:block; margin-bottom:5px;">Offer Title (Arabic)</label>
      <input type="text" id="customOfferAR" placeholder="ÿÆÿµŸÖ 40% ÿπŸÑŸâ ÿßŸÑÿ≠ÿ®Ÿá ÿßŸÑÿ™ÿßŸÜŸäŸá" style="width:100%; padding:10px; border-radius:5px; border:none; background:#16213e; color:#fff; direction:rtl;">
    </div>
    
    <div style="margin-bottom:15px;">
      <label style="color:#fff; display:block; margin-bottom:5px;">Date Range</label>
      <input type="text" id="customDateRange" placeholder="Dec 25 - Jan 7" style="width:100%; padding:10px; border-radius:5px; border:none; background:#16213e; color:#fff;">
    </div>
    
    <div style="margin-bottom:15px;">
      <label style="color:#fff; display:block; margin-bottom:5px;">Product Name (English)</label>
      <input type="text" id="customProductEN" placeholder="SEBAMED BABY LIP BALM" style="width:100%; padding:10px; border-radius:5px; border:none; background:#16213e; color:#fff;">
    </div>
    
    <div style="margin-bottom:15px;">
      <label style="color:#fff; display:block; margin-bottom:5px;">Product Name (Arabic)</label>
      <input type="text" id="customProductAR" placeholder="ÿ≥Ÿäÿ®ÿßŸÖŸäÿØ ŸÖÿ±ÿ∑ÿ® ÿ¥ŸÅÿßÿ© ŸÑŸÑÿßÿ∑ŸÅÿßŸÑ" style="width:100%; padding:10px; border-radius:5px; border:none; background:#16213e; color:#fff; direction:rtl;">
    </div>
    
    <div style="margin-bottom:20px;">
      <label style="color:#fff; display:block; margin-bottom:5px;">Category</label>
      <input type="text" id="customCategory" placeholder="LIP BALM-KIDS" style="width:100%; padding:10px; border-radius:5px; border:none; background:#16213e; color:#fff;">
    </div>
    
    <div style="display:flex; gap:10px;">
      <button onclick="printCustomCardsDirectly()" style="flex:1; padding:12px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:#fff; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">üñ®Ô∏è Print Now</button>
      <button onclick="closeCustomPrintModal()" style="flex:1; padding:12px; background:#333; color:#fff; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">‚ùå Cancel</button>
    </div>
  </div>
</div>

<!-- ÿ≤ÿ±ÿßÿ± Custom Offer Print ÿßŸÑŸÖŸàÿ¨ŸàÿØ -->
<button onclick="printExclusiveOffers()" style="display: inline-block; padding: 15px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4); transition: all 0.3s ease; margin: 10px;" onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(102, 126, 234, 0.6)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.4)';">
  üåü Exclusive Offers(5,10,15 SAR) Print
</button>

<!-- üìÇ Print from File - ŸÖÿπÿØŸëŸÑ -->
<div style="margin: 30px 0; text-align: center; position: relative;">
  <button onclick="document.getElementById('codesFileInput').click()" 
          style="
            padding: 24px 60px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 16px;
            font-weight: 900;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 10px 40px rgba(16, 185, 129, 0.4);
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
            min-width: 450px;
            position: relative;
          "
          onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 15px 50px rgba(16, 185, 129, 0.6)'"
          onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 10px 40px rgba(16, 185, 129, 0.4)'">
    
    <!-- Upload Icon -->
    <span style="
      position: absolute;
      top: -12px;
      right: 20px;
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      box-shadow: 0 4px 15px rgba(251, 191, 36, 0.5);
      animation: bounce 2s infinite;
    ">üì§</span>
    
    üìÇ PRINT\View FROM FILE ‚ö°
  </button>
  
  <!-- ŸÜÿµ ÿ™ÿ≠ÿ™ ÿßŸÑÿ≤ÿ±ÿßÿ± -->
  <div style="
    margin-top: 12px;
    color: #059669;
    font-weight: 700;
    font-size: 14px;
    letter-spacing: 0.5px;
  ">
    üìå ÿßÿ±ŸÅŸÇ ÿßŸÑÿ£ŸÉŸàÿßÿØ ÿßŸÑÿ≥ÿØÿßÿ≥Ÿäÿ© ŸÅŸÇÿ∑
  


  <!-- Badge - ÿ®ÿ±ÿ™ŸÇÿßŸÑŸä ŸàŸÑÿßÿ≤ŸÇ -->
  <div style="
    display: inline-block;
    margin-left: 5px;
    padding: 8px 16px;
    background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
    color: white;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 700;
    box-shadow: 0 4px 15px rgba(249, 115, 22, 0.4);
  ">
    Excel ‚Ä¢ Text ‚Ä¢ CSV
  </div>
  
  <!-- Hidden File Input -->
  <input type="file" id="codesFileInput" accept=".xlsx,.xls,.txt,.csv" style="display: none;" onchange="handleCodesFileUpload(event)">
  
  <!-- Status -->
  <div id="codesFileStatus" style="margin-top: 20px; color: #10b981; font-weight: 700; font-size: 16px;"></div>
</div>

<!-- Animation CSS -->
<style>
@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
}
</style>


  <!-- Hidden File Input -->
  <input type="file" id="codesFileInput" accept=".xlsx,.xls,.txt,.csv" style="display: none;" onchange="handleCodesFileUpload(event)">
  
  <!-- Status -->
  <div id="codesFileStatus" style="margin-top: 20px; color: #10b981; font-weight: 700; font-size: 16px;"></div>
</div>

<div class="offer-box special" onclick="window.location.href=''">
    <h3 class="offer-box-title">‚≠êMILK--RONZAC OFFERS</h3>
  </div>
  <button onclick="openCustomPrintModal()" class="btn-custom-offer">
  üñ®Ô∏è Custom Offer Print
</button>

<style>
  .btn-custom-offer{
    padding:20px 42px;  /* üìè ŸÉÿ®ÿ± padding */
    font-size:20px;     /* üìè ŸÉÿ®ÿ± ÿßŸÑÿÆÿ∑ */
    line-height:1;
    background:linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color:#fff;
    border:none;
    border-radius:16px; /* ÿ¥ŸàŸäÿ© ÿ£ŸÉÿ®ÿ± ŸÑŸÑŸÉÿ®ÿ± */
    font-weight:700;
    cursor:pointer;
    margin:10px;
    min-width:280px;    /* üìè ÿπÿ±ÿ∂ ÿ£ŸÉÿ®ÿ± */
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:12px;           /* ÿ¥ŸàŸäÿ© ŸÖÿ≥ÿßŸÅÿ© ÿ®ŸäŸÜ ÿßŸÑÿ£ŸäŸÇŸàŸÜÿ© ŸàÿßŸÑŸÜÿµ */
    box-shadow:0 4px 12px rgba(240,147,251,0.4); /* ÿ∏ŸÑ ÿ¨ŸÖŸäŸÑ */
    transition: all 0.3s ease; /* ÿ≠ÿ±ŸÉÿ© ÿ≥ŸÑÿ≥ÿ© */
  }
  
  .btn-custom-offer:hover {
    transform: translateY(-2px);
    box-shadow:0 6px 20px rgba(240,147,251,0.6);
  }

  /* ÿßŸÑÿ≠ÿßŸàŸäÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ© ŸÑŸÑŸÉÿßÿ±ÿØ */
.pro-tip-card {
    position: relative;
    background: #ffffff;
    border-radius: 20px;
    margin: 30px 0;
    direction: rtl;
    overflow: hidden;
    /* ÿ∏ŸÑ ŸÜÿßÿπŸÖ Ÿàÿ∑ŸàŸäŸÑ Ÿäÿπÿ∑Ÿä ÿπŸÖŸÇÿßŸã */
    box-shadow: 0 20px 40px rgba(111, 66, 193, 0.1); 
    border: 1px solid rgba(255, 255, 255, 0.8);
    transition: transform 0.3s ease;
}

.pro-tip-card:hover {
    transform: translateY(-5px); /* ÿ≠ÿ±ŸÉÿ© ÿ∑ŸÅŸäŸÅÿ© ÿπŸÜÿØ ÿßŸÑŸÖÿ±Ÿàÿ± */
}

/* ÿ™ÿ£ÿ´Ÿäÿ± ÿßŸÑÿ™ŸàŸáÿ¨ ÿßŸÑÿÆŸÑŸÅŸä (Gradient Glow) */
.glow-effect {
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(111,66,193,0.05) 0%, rgba(255,255,255,0) 70%);
    z-index: 0;
    pointer-events: none;
}

/* ŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑŸÉÿßÿ±ÿØ */
.card-content {
    position: relative;
    z-index: 1;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 30px;
    gap: 40px;
}

/* ŸÇÿ≥ŸÖ ÿßŸÑŸÜÿµŸàÿµ */
.text-section {
    flex: 1;
}

/* ÿßŸÑÿ¥ÿßÿ±ÿ© ÿßŸÑÿπŸÑŸàŸäÿ© (Badge) */
.tip-badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: rgba(111, 66, 193, 0.1);
    color: #6f42c1;
    padding: 6px 14px;
    border-radius: 30px;
    font-size: 13px;
    font-weight: 700;
    margin-bottom: 15px;
}

.pulse-dot {
    width: 8px;
    height: 8px;
    background-color: #6f42c1;
    border-radius: 50%;
    box-shadow: 0 0 0 rgba(111, 66, 193, 0.4);
    animation: pulse 2s infinite;
}

/* ÿßŸÑÿπŸÜŸàÿßŸÜ */
.modern-title {
    margin: 0 0 15px 0;
    font-size: 26px;
    font-weight: 800;
    color: #2d3436;
    letter-spacing: -0.5px;
}

/* ŸÜÿµ ÿßŸÑŸÅŸÇÿ±ÿ© ÿßŸÑŸÉÿßŸÖŸÑÿ© */
.description-text {
    font-size: 16px;
    line-height: 1.8;
    color: #636e72;
    margin: 0;
    font-weight: 500;
}

/* ÿßŸÑŸáÿßŸäŸÑÿßŸäÿ™ ÿßŸÑŸÖŸÖŸäÿ≤ ŸÑŸÑÿ¨ŸÖŸÑÿ© ÿßŸÑŸÖŸáŸÖÿ© */
.highlight-box {
    background: linear-gradient(120deg, #6f42c1 0%, #8e44ad 100%);
    color: #fff;
    padding: 2px 10px;
    border-radius: 6px;
    font-weight: bold;
    box-shadow: 0 4px 10px rgba(111, 66, 193, 0.3);
    white-space: nowrap; /* ŸäŸÖŸÜÿπ ŸÜÿ≤ŸàŸÑ ÿßŸÑŸÉŸÑŸÖÿ© ŸÑÿ≥ÿ∑ÿ± ÿ¨ÿØŸäÿØ Ÿàÿ≠ÿØŸáÿß */
}

/* ŸÇÿ≥ŸÖ ÿßŸÑÿµŸàÿ±ÿ© */
.media-section {
    flex: 0 0 320px; /* ÿ≠ÿ¨ŸÖ ÿ´ÿßÿ®ÿ™ ŸÑŸÑÿµŸàÿ±ÿ© */
}

.gif-wrapper {
    position: relative;
    border-radius: 16px;
    overflow: hidden;
    /* ÿ•ÿ∑ÿßÿ± ŸÖÿ≤ÿØŸàÿ¨ ŸÑÿ•ÿπÿ∑ÿßÿ° ÿ¥ŸÉŸÑ ŸÅÿÆŸÖ */
    border: 5px solid #fff;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
}

.gif-wrapper img {
    width: 100%;
    height: auto;
    display: block;
    transform: scale(1.02); /* ÿ™ŸÉÿ®Ÿäÿ± ÿ®ÿ≥Ÿäÿ∑ ŸÑÿ•ŸÑÿ∫ÿßÿ° ÿ£Ÿä ÿ≠ŸàÿßŸÅ ÿ®Ÿäÿ∂ÿßÿ° */
}

/* ÿ£ŸÜŸäŸÖŸäÿ¥ŸÜ ÿßŸÑŸÜÿ®ÿ∂ ŸÑŸÑŸÜŸÇÿ∑ÿ© */
@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(111, 66, 193, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(111, 66, 193, 0); }
    100% { box-shadow: 0 0 0 0 rgba(111, 66, 193, 0); }
}

/* ÿ™ÿ≠ÿ≥ŸäŸÜÿßÿ™ ÿßŸÑŸÖŸàÿ®ÿßŸäŸÑ */
@media (max-width: 900px) {
    .card-content {
        flex-direction: column;
        padding: 20px;
        text-align: center;
        gap: 20px;
    }
    
    .media-section {
        width: 100%;
        flex: auto;
    }
    
    .highlight-box {
        white-space: normal; /* ÿßŸÑÿ≥ŸÖÿßÿ≠ ÿ®ÿßŸÑŸÜÿ≤ŸàŸÑ ŸÑÿ≥ÿ∑ÿ± ÿ¨ÿØŸäÿØ ŸÅŸä ÿßŸÑŸÖŸàÿ®ÿßŸäŸÑ */
        display: inline;
        box-decoration-break: clone;
        -webkit-box-decoration-break: clone;
    }
}
</style>
<div class="filter-group" style="background: #e0f2fe; border: 2px solid #3b82f6; padding: 10px; border-radius: 8px; margin-bottom: 20px;">
  <label style="color: #1e40af; font-weight: 800; font-size: 14px; display:flex; align-items:center; gap:5px;">
    üìÇ ŸÖŸÑŸÅ ÿßŸÑÿπÿ±Ÿàÿ∂ ÿßŸÑŸÜÿ¥ÿ∑
  </label>
  
  <select id="offerSourceSelect" onchange="changeOfferFile(this.value)" class="global-search-box" style="width:100%; font-weight:bold; color:#000; cursor:pointer; padding: 10px; border-radius: 5px;">
    <option value="8to14feboffers.json">üìÖ ÿπÿ±Ÿàÿ∂ 8-14 ŸÅÿ®ÿ±ÿßŸäÿ±</option>
    <option value="15to24feboffers.json">üìÖ ÿπÿ±Ÿàÿ∂ 15-24 ŸÅÿ®ÿ±ÿßŸäÿ±</option>
    <option value="25febto5marsoffers.json">üìÖ ÿπÿ±Ÿàÿ∂ 25 ŸÅÿ®ÿ±ÿßŸäÿ± - 5 ŸÖÿßÿ±ÿ≥</option>
    <option value="exclusiveoffersdb.json">‚≠ê ÿßŸÑÿπÿ±Ÿàÿ∂ ÿßŸÑÿ≠ÿµÿ±Ÿäÿ©</option>
  </select>
</div>
<!-- Offer Boxes -->
<div class="offer-boxes-container"></div>
<div class="pro-tip-card">
    <div class="glow-effect"></div>

    <div class="card-content">
        <div class="text-section">
            <div class="tip-badge">
                <span class="pulse-dot"></span>
              ŸÖŸáŸÖ ÿ¨ÿØÿß
            </div>
            
            <h3 class="modern-title">ŸÉŸäŸÅ ÿ™ŸÅŸÑÿ™ÿ± ÿü</h3>
            
            <p class="description-text">
                ŸÑÿ∂ŸÖÿßŸÜ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨ ÿ®ÿ¥ŸÉŸÑ ÿµÿ≠Ÿäÿ≠ÿå Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÅŸÑÿ™ÿ± ÿ´ŸÖ 
                <span class="highlight-box">ÿßŸÑÿ∂ÿ∫ÿ∑ ÿ®ÿßŸÑŸÖÿßŸàÿ≥ ŸÅŸä ÿ£Ÿä ŸÖŸÉÿßŸÜ ŸÅÿßÿ±ÿ∫</span> 
                ÿÆÿßÿ±ÿ¨ ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ŸÑÿ•ÿ∫ŸÑÿßŸÇŸáÿß Ÿàÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ®ÿ≠ÿ´.
            </p>
        </div>

        <div class="media-section">
            <div class="gif-wrapper">
                <img src="https://raw.githubusercontent.com/meralmohamed121022-cyber/wasfatyrefill/refs/heads/main/toturial%20filters.gif" alt="ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑŸÅŸÑÿ™ÿ±ÿ©">
            </div>
        </div>
    </div>
</div>
<div class="global-search-wrapper">
  <input id="globalSearch" class="global-search-box" type="text" placeholder="üîç Search by code or name...">
</div>

<!-- FILTERS -->
<div class="filter-section">
  <h2 class="filter-title">üîç FILTER OFFERS</h2>
  <div class="filters-container">
    
    <!-- Offer Type -->
    <div class="filter-group">
      <label>Offer Type</label>
      <div class="custom-select" data-filter="offerFilter">
        <div class="custom-select-trigger">
          <span class="selected-text">All Offers</span>
          <span class="arrow">‚ñº</span>
        </div>
        <div class="custom-select-options">
          <input type="text" class="custom-select-search" placeholder="Search...">
          <div class="custom-options-list"></div>
        </div>
      </div>
      <button class="reset-filter-btn" onclick="resetFilter('offerFilter')">üîÑ Reset</button>
    </div>

    <!-- Brand -->
    <div class="filter-group">
      <label>Brand</label>
      <div class="custom-select" data-filter="brandFilter">
        <div class="custom-select-trigger">
          <span class="selected-text">All Brands</span>
          <span class="arrow">‚ñº</span>
        </div>
        <div class="custom-select-options">
          <input type="text" class="custom-select-search" placeholder="Search...">
          <div class="custom-options-list"></div>
        </div>
      </div>
      <button class="reset-filter-btn" onclick="resetFilter('brandFilter')">üîÑ Reset</button>
    </div>

    <!-- Manufacture -->
    <div class="filter-group">
      <label>üè≠ MANUFACTURE</label>
      <div class="custom-select" data-filter="manufactureFilter">
        <div class="custom-select-trigger">
          <span class="selected-text">All Manufactures</span>
          <span class="arrow">‚ñº</span>
        </div>
        <div class="custom-select-options">
          <input type="text" class="custom-select-search" placeholder="Search..." />
          <div class="custom-options-list"></div>
        </div>
      </div>
      <button class="reset-filter-btn" onclick="resetFilter('manufactureFilter')">üîÑ Reset</button>
    </div>

    <!-- Category A -->
    <div class="filter-group">
      <label>Category A</label>
      <div class="custom-select" data-filter="categoryAFilter">
        <div class="custom-select-trigger">
          <span class="selected-text">All Cat A</span>
          <span class="arrow">‚ñº</span>
        </div>
        <div class="custom-select-options">
          <input type="text" class="custom-select-search" placeholder="Search...">
          <div class="custom-options-list"></div>
        </div>
      </div>
      <button class="reset-filter-btn" onclick="resetFilter('categoryAFilter')">üîÑ Reset</button>
    </div>

    <!-- Category B -->
    <div class="filter-group">
      <label>Category B</label>
      <div class="custom-select" data-filter="categoryBFilter">
        <div class="custom-select-trigger">
          <span class="selected-text">All Cat B</span>
          <span class="arrow">‚ñº</span>
        </div>
        <div class="custom-select-options">
          <input type="text" class="custom-select-search" placeholder="Search...">
          <div class="custom-options-list"></div>
        </div>
      </div>
      <button class="reset-filter-btn" onclick="resetFilter('categoryBFilter')">üîÑ Reset</button>
    </div>

    <!-- Item Class -->
    <div class="filter-group">
      <label>Item Class</label>
      <div class="custom-select" data-filter="itemClassFilter">
        <div class="custom-select-trigger">
          <span class="selected-text">All Classes</span>
          <span class="arrow">‚ñº</span>
        </div>
        <div class="custom-select-options">
          <input type="text" class="custom-select-search" placeholder="Search...">
          <div class="custom-options-list"></div>
        </div>
      </div>
      <button class="reset-filter-btn" onclick="resetFilter('itemClassFilter')">üîÑ Reset</button>
    </div>

    <!-- Category C -->
    <div class="filter-group">
      <label>Category C</label>
      <div class="custom-select" data-filter="categoryCFilter">
        <div class="custom-select-trigger">
          <span class="selected-text">All C</span>
          <span class="arrow">‚ñº</span>
        </div>
        <div class="custom-select-options">
          <input type="text" class="custom-select-search" placeholder="Search...">
          <div class="custom-options-list"></div>
        </div>
      </div>
      <button class="reset-filter-btn" onclick="resetFilter('categoryCFilter')">üîÑ Reset</button>
    </div>

    <!-- Category D -->
    <div class="filter-group">
      <label>Category D</label>
      <div class="custom-select" data-filter="categoryDFilter">
        <div class="custom-select-trigger">
          <span class="selected-text">All D</span>
          <span class="arrow">‚ñº</span>
        </div>
        <div class="custom-select-options">
          <input type="text" class="custom-select-search" placeholder="Search...">
          <div class="custom-options-list"></div>
        </div>
      </div>
      <button class="reset-filter-btn" onclick="resetFilter('categoryDFilter')">üîÑ Reset</button>
    </div>

  </div>
</div>

<!-- ÿ≤ÿ±ÿßÿ± ÿ•ÿπÿßÿØÿ© ÿ∂ÿ®ÿ∑ ÿßŸÑŸÅŸÑÿ™ÿ±ÿßÿ™ -->
<button onclick="clearAllFilters()" style="padding:12px 24px; background:linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); color:#fff; border:none; border-radius:8px; font-weight:bold; cursor:pointer; margin:10px; box-shadow: 0 4px 15px rgba(238, 90, 111, 0.4);">
  üîÑ Reset All Filters
</button>

<div class="products-section" id="productsContainer"></div>

<div id="loadingIndicator" style="text-align:center; padding:20px; display:none;">
  <div class="spinner" style="display:inline-block;"></div>
  <div>Loading more products...</div>
</div>

<!-- Back to Top Button -->
<button id="backToTopBtn" class="back-to-top-btn" onclick="scrollToTop()">
  <div class="arrow-up"></div>
</button>

    <div class="products-section" id="productsContainer"></div>
    <div id="loadingIndicator" style="text-align:center; padding:20px; display:none;">
        <div class="spinner" style="display:inline-block;"></div>
        <div>Loading more products...</div>
    </div>
  </div>
<div class="print-container" id="printContainer"></div>

<img src="https://raw.githubusercontent.com/meralmohamed121022-cyber/Drug-Monograph/refs/heads/main/M%20(512%20x%20512%20px)_20251114_182650_0000.gif" 
     alt="img_asset_01"
     style="position: fixed; bottom: 10px; right: 10px; width: 100px; height: 100px; border-radius: 50%; border: 3px solid white; box-shadow: 0 3px 10px rgba(0,0,0,0.4); background: white; padding: 2px; animation: float 4s ease-in-out infinite; z-index: 1000; cursor: pointer;"
     id="sys_blob_img" 
     onerror="this.style.display='none'" /> 
     <div id="sys_blob_data"
     style="position: fixed; bottom: 115px; right: 10px; width: 300px;
     background: linear-gradient(135deg, #3575cf 0%, #101c33 100%);
     color: #e0f7fa; padding: 30px 26px; border-radius: 16px;
     box-shadow: 0 10px 30px rgba(30,60,130, 0.7);
     font-family: 'Segoe UI', Arial, Helvetica, sans-serif;
     display: none; z-index: 1001; transform-origin: bottom right; cursor: pointer;">
  
  <div style="font-size:2em; font-weight:900; line-height:1; letter-spacing:0.5px; color:#b8e8ff; margin-bottom:8px; margin-top:0;">
    Mohamed<br>
    <span style="color:#ffffff; font-size:1em;">Kholeif</span>
  </div>
  
  <div style="font-size:1em; font-weight:600; color:#4ec3f7; margin-bottom:16px; letter-spacing:0.5px;">
    SUPERVISOR:Dr. Ibrahim Gamea
  </div>
  
 
    </div>
  </div>
  
  
    </div>
  </div>
</div>

<style>
@keyframes fadeScaleIn {
  0% {
    opacity: 0;
    transform: scale(0.7);
  }
  100% {
    opacity: 1;
    transform: scale(1);
  }
}
@keyframes fadeScaleOut {
  0% {
    opacity: 1;
    transform: scale(1);
  }
  100% {
    opacity: 0;
    transform: scale(0.7);
  }
}

/* ‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿπÿ±ŸÅÿßÿ™ ŸÅŸä CSS ÿ•ŸÑŸâ ÿßŸÑÿ£ÿ≥ŸÖÿßÿ° ÿßŸÑÿ¨ÿØŸäÿØÿ© ÿßŸÑŸÖÿ®ŸáŸÖÿ© */
@media only screen and (max-width: 768px) {
  #sys_blob_img {
    width: 80px !important;
    height: 80px !important;
    bottom: 8px !important;
    right: 8px !important;
  }
  
  #sys_blob_data {
    width: 280px !important;
    padding: 25px 20px !important;
    bottom: 95px !important;
    right: 8px !important;
  }
  
  #sys_blob_data > div:first-child {
    font-size: 1.8em !important;
  }
}

@media only screen and (max-width: 480px) {
  #sys_blob_img {
    width: 70px !important;
    height: 70px !important;
    bottom: 6px !important;
    right: 6px !important;
  }
  
  #sys_blob_data {
    width: calc(100vw - 20px) !important;
    max-width: 250px !important;
    padding: 20px 16px !important;
    bottom: 82px !important;
    right: 6px !important;
  }
  
  #sys_blob_data > div:first-child {
    font-size: 1.6em !important;
    margin-bottom: 6px !important;
  }
  
  #sys_blob_data > div:nth-child(2) {
    margin: 15px 0 0 0 !important;
    font-size: 1.05em !important;
  }
  
  #sys_blob_data > div:nth-child(3) {
    font-size: 1.05em !important;
    margin: 14px 0 0 0 !important;
  }
}

@media only screen and (max-width: 320px) {
  #sys_blob_img {
    width: 60px !important;
    height: 60px !important;
  }
  
  #sys_blob_data {
    width: calc(100vw - 16px) !important;
    max-width: 220px !important;
    padding: 18px 14px !important;
    bottom: 72px !important;
  }
  
  #sys_blob_data > div:first-child {
    font-size: 1.4em !important;
  }
}
</style>

<script>
    
// Email Function
function openEmail() {
    const emailAddress = "Muhammedkhulif@yahoo.com";
    const mailtoUrl = `mailto:${emailAddress}`;
    window.location.href = mailtoUrl;
}

// WhatsApp Function
function openWhatsApp() {
    const whatsappUrl = "https://wa.me/966541932559";
    window.open(whatsappUrl, '_blank');
}

// Facebook Function
function openFacebook() {
    const facebookUrl = "https://www.facebook.com/share/1Ghv7eEw6A/";
    window.open(facebookUrl, '_blank');
}

// ‚úÖ ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿπÿ±ŸÅÿßÿ™ ŸÅŸä ÿßŸÑÿ¨ÿßŸÅÿßÿ≥ŸÉÿ±Ÿäÿ®ÿ™
const infoBox = document.getElementById('sys_blob_data');
const profileImage = document.getElementById('sys_blob_img');
let hideTimeout = null;

function showInfoBox() {
  if (infoBox.style.display !== 'block') {
    infoBox.style.display = 'block';
    infoBox.style.animation = 'fadeScaleIn 0.4s forwards';
  }
  if (hideTimeout) clearTimeout(hideTimeout);
  hideTimeout = setTimeout(hideInfoBox, 3000);
}

function hideInfoBox() {
  infoBox.style.animation = 'fadeScaleOut 0.3s forwards';
  infoBox.addEventListener('animationend', () => {
    infoBox.style.display = 'none';
    infoBox.style.animation = '';
  }, { once: true });
  if (hideTimeout) clearTimeout(hideTimeout);
}

// ÿ∏ŸáŸàÿ± ŸÅŸàÿ±Ÿä
showInfoBox();

setInterval(() => {
  showInfoBox();
}, 60000);

function toggleInfoBox() {
  if (infoBox.style.display === 'block') {
    hideInfoBox();
  } else {
    showInfoBox();
  }
}

profileImage.addEventListener('click', toggleInfoBox);
infoBox.addEventListener('click', toggleInfoBox);
</script>

<script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
<script src="https://unpkg.com/html2canvas@latest/dist/html2canvas.min.js"></script>
<script>   
// ====== iOS AUTO OPTIMIZER ======
const IS_IOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

if (IS_IOS) {
  // 1. Lite badges
  const origOffer = window.getMagazineOfferHTML;
  window.getMagazineOfferHTML = function(offer, product, cls) {
    if (!offer) return '';
    const pct = offer.offerType?.match(/(\d+)%/)?.[1] || '‚ú®';
    return `<div style="position:absolute;top:8px;left:8px;background:#111827;color:#fff;
            padding:6px 12px;border-radius:10px;font-weight:700;font-size:14px;
            box-shadow:0 2px 8px rgba(0,0,0,0.3);z-index:20;">
            <div style="font-size:18px;">${pct}</div>
            <div style="font-size:9px;opacity:0.85;">${offer.offerType?.slice(0,12)}</div>
            </div>`;
  };

  // 2. Image throttle
  const origImg = window.fetchProductImage;
  let imgCount = 0, imgQ = [];
  window.fetchProductImage = async (code) => {
    if (imgCount >= 3) await new Promise(r => imgQ.push(r));
    imgCount++;
    try { return await origImg(code); }
    finally { imgCount--; if (imgQ.length) imgQ.shift()(); }
  };

  // 3. Page size
  magazineSettings.rowsPerPage = 3;
  magazineSettings.itemsPerRow = 3;
  
  console.log('üçé iOS Mode: 6 cards/page + lite badges');
}

// ====== üî• FORCE LIGHT MODE - OVERRIDE EVERYTHING ======
(function() {
  // Clear theme from localStorage
  localStorage.removeItem('theme');
  
  // Force light mode
  document.documentElement.setAttribute('data-theme', 'light');
  document.body.classList.remove('dark-mode');
  
  console.log('‚òÄÔ∏è FORCED LIGHT MODE - Cache cleared!');
})();

    // ========== IMAGES DB (New Structure) ==========
const categoryImagesDB = {
    "APHRODISIAC":            { icon: "img", hero: "img" },
    "BABY DIAPERS":           { icon: "", hero: "img" },
    "BABY NURSERY":           { icon: "", hero: "" },
    "BABY NUTRITION":         { icon: "", hero: "" },
    "BABY TOILETRIES":        { icon: "", hero: "" },
    "BEAUTY ACCESSORIES":     { icon: "img", hero: "img" },
    "BEAUTY HAIR&SKIN CARE":  { icon: "img", hero: "img" },
    "BEAUTY MACHINES":        { icon: "img", hero: "img" },
    "BODY CARE":              { icon: "img", hero: "img" },
    "DEODORANTS":             { icon: "img", hero: "img" },
    "EYE&EAR":                { icon: "img", hero: "img" },
    "FEMININE CARE":          { icon: "img", hero: "img" },
    "FIRST AID":              { icon: "img", hero: "img" },
    "GERIATERIC CARE":        { icon: "img", hero: "img" },
    "GIT":                    { icon: "img", hero: "img" },
    "HAIR CARE":              { icon: "img", hero: "img" },
    "HAIR COLOR":             { icon: "img", hero: "img" },
    "HEALTHY FOOD":           { icon: "img", hero: "img" },
    "HOME CARE PRODUCTS":     { icon: "img", hero: "img" },
    "MAKE UP":                { icon: "img", hero: "img" },
    "MEDICAL DEVICE":         { icon: "img", hero: "img" },
    "MEN CARE":               { icon: "img", hero: "img" },
    "NUTRICEUTICALS":         { icon: "https://i.postimg.cc/281HFY54/8.png", hero: "https://i.postimg.cc/281HFY54/8.png" },
    "ORAL CARE":              { icon: "img", hero: "img" },
    "OTHERS":                 { icon: "img", hero: "img" },
    "PAIN MANAGEMENT":        { icon: "img", hero: "img" },
    "PERSONAL WASH":          { icon: "img", hero: "img" },
    "RESPIRATORY":            { icon: "img", hero: "img" },
    "RX-ANTI INFECTIVE":      { icon: "img", hero: "img" },
    "RX-CHEMOTHERAPY":        { icon: "img", hero: "img" },
    "RX-CNS":                 { icon: "img", hero: "img" },
    "RX-CVS":                 { icon: "img", hero: "img" },
    "RX-DERMA":               { icon: "img", hero: "img" },
    "RX-ENDOCRINE":           { icon: "img", hero: "img" },
    "RX-GIT":                 { icon: "img", hero: "img" },
    "RX-OPHTHALMOLOGY":       { icon: "img", hero: "img" },
    "RX-OTHERS":              { icon: "img", hero: "img" },
    "RX-RESPIRATORY SYSTEM":  { icon: "img", hero: "img" },
    "RX-UTI":                 { icon: "img", hero: "img" },
    "SPORTS & FITTNESS":      { icon: "img", hero: "img" },
    "TOPICAL PREPARATION":    { icon: "img", hero: "img" }
};
// 1. ÿ™ÿπÿ±ŸäŸÅ ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ (ŸÑÿ™ÿ≥ÿ™ŸÇÿ®ŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿÆÿßÿ±ÿ¨Ÿäÿ©)
let productsDB = [];
let offersDB = [];
// ÿ™Ÿàÿßÿ±ŸäÿÆ ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ© (Ÿáÿ™ÿ™ÿ∫Ÿäÿ± ÿßŸàŸÑ ŸÖÿß ÿßŸÑŸÖŸÑŸÅ Ÿäÿ≠ŸÖŸÑ)
let CURRENT_OFFER_START = new Date();
let CURRENT_OFFER_END = new Date();
let NEXT_OFFER_START = new Date();
let NEXT_OFFER_END = new Date();

// 2. ÿØÿßŸÑÿ© ÿ™ÿ∫ŸäŸäÿ± ŸÖŸÑŸÅ ÿßŸÑÿπÿ±Ÿàÿ∂ (ÿßŸÑŸÇŸÑÿ® ÿßŸÑŸÜÿßÿ®ÿ∂ ŸÑŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑÿ¨ÿØŸäÿØ)
async function changeOfferFile(fileName) {
    const loader = document.getElementById('loadingIndicator');
    if(loader) loader.style.display = 'flex'; // ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ

    try {
        console.log(`üîÑ ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ: ${fileName}`);
        
        // ÿ™ŸÅÿ±Ÿäÿ∫ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÇÿØŸäŸÖÿ©
        offersDB = [];
        if(typeof offersMap !== 'undefined') offersMap.clear();

        // ÿ¨ŸÑÿ® ŸÖŸÑŸÅ ÿßŸÑÿπÿ±Ÿàÿ∂ ÿßŸÑŸÖÿÆÿ™ÿßÿ±
        const response = await fetch(fileName);
        if (!response.ok) throw new Error(`ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑŸÖŸÑŸÅ: ${fileName}`);
        
        const data = await response.json();

        // -- ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸàÿßŸÑÿ™Ÿàÿßÿ±ŸäÿÆ --
        if (data.config) {
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ™Ÿàÿßÿ±ŸäÿÆ ŸÖŸÜ ÿØÿßÿÆŸÑ ÿßŸÑŸÖŸÑŸÅ (ÿ≤Ÿä ŸÖÿß ÿßŸÜÿ™ ÿπÿßŸäÿ≤)
            CURRENT_OFFER_START = new Date(data.config.startDate);
            CURRENT_OFFER_END = new Date(data.config.endDate);
            if(data.config.nextStartDate) NEXT_OFFER_START = new Date(data.config.nextStartDate);
            if(data.config.nextEndDate) NEXT_OFFER_END = new Date(data.config.nextEndDate);
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿπÿØÿßÿØ ŸàÿßŸÑÿ™Ÿàÿßÿ±ŸäÿÆ ŸÅŸä ÿßŸÑÿ¥ÿßÿ¥ÿ© ŸÅŸàÿ±ÿßŸã
            if(typeof updateCountdown === 'function') updateCountdown();
            if(typeof updateDatesInHTML === 'function') updateDatesInHTML();
        }

        // ÿ™ÿÆÿ≤ŸäŸÜ ÿßŸÑÿπÿ±Ÿàÿ∂
        offersDB = data.offers ? data.offers : (Array.isArray(data) ? data : []);

        console.log(`‚úÖ ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿπÿ±Ÿàÿ∂: ${offersDB.length} ÿπÿ±ÿ∂`);

        // üî• ÿÆÿ∑Ÿàÿßÿ™ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ∂ÿ±Ÿàÿ±Ÿäÿ©
        if(typeof initOffersMap === 'function') initOffersMap(); // ÿ±ÿ®ÿ∑ ÿßŸÑÿπÿ±Ÿàÿ∂
        if(typeof initializeFilters === 'function') initializeFilters(); // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÇŸàÿßÿ¶ŸÖ
        if(typeof applyFilters === 'function') applyFilters(); // ÿπÿ±ÿ∂ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™

    } catch (error) {
        console.error("‚ùå ÿÆÿ∑ÿ£:", error);
        alert(`‚ö†Ô∏è ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ŸÖŸÑŸÅ ÿßŸÑÿπÿ±Ÿàÿ∂: ${fileName}\nÿ™ÿ£ŸÉÿØ ÿ£ŸÜ ÿßŸÑŸÖŸÑŸÅ ŸÖŸàÿ¨ŸàÿØ ŸàŸÖŸÉÿ™Ÿàÿ® ÿµÿ≠.`);
    } finally {
        if(loader) loader.style.display = 'none'; // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ
    }
}

// 3. ÿØÿßŸÑÿ© ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ© (ÿ£ŸàŸÑ ŸÖÿß ÿßŸÑŸÖŸàŸÇÿπ ŸäŸÅÿ™ÿ≠)
async function initApp() {
    try {
        // ÿ£) ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ (productsdb.json)
        const prodRes = await fetch('productsdb.json');
        if (!prodRes.ok) throw new Error("productsdb.json ŸÖÿ¥ ŸÖŸàÿ¨ŸàÿØ!");
        productsDB = await prodRes.json();
        console.log(`üì¶ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™: ${productsDB.length}`);

        // ÿ®) ÿ™ÿ≠ŸÖŸäŸÑ ÿ£ŸàŸÑ ŸÖŸÑŸÅ ÿπÿ±Ÿàÿ∂ ŸÖÿÆÿ™ÿßÿ± ŸÅŸä ÿßŸÑŸÇÿßÿ¶ŸÖÿ©
        const selectBox = document.getElementById('offerSourceSelect');
        if(selectBox) {
            await changeOfferFile(selectBox.value);
        }

    } catch (error) {
        console.error("‚ùå ŸÅÿ¥ŸÑ ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ:", error);
    }
}

// ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ
document.addEventListener('DOMContentLoaded', initApp);

// ====== üñºÔ∏è WORKER API INTEGRATION ======
const WORKER_BASE = "https://dry-rain-899d.meralmohamed121022.workers.dev";
const API_ENDPOINT = `${WORKER_BASE}/api/product?code=`;
const imageCache = new Map();

console.log('üöÄ Worker API initialized:', WORKER_BASE);
// ====== üíæ SAVE CUSTOM MODAL DATA ======
const customModalData = {
  codes: '',
  quantity: 6,
  offerEN: '',
  offerAR: '',
  dateRange: '',
  productEN: '',
  productAR: '',
  category: ''
};

function saveCustomModalData() {
  const codeEl = document.getElementById('customCode');
  const quantityEl = document.getElementById('customQuantity');
  const offerENEl = document.getElementById('customOfferEN');
  const offerAREl = document.getElementById('customOfferAR');
  const dateRangeEl = document.getElementById('customDateRange');
  const productENEl = document.getElementById('customProductEN');
  const productAREl = document.getElementById('customProductAR');
  const categoryEl = document.getElementById('customCategory');
  
  if(codeEl) customModalData.codes = codeEl.value || '';
  if(quantityEl) customModalData.quantity = quantityEl.value || 1;
  if(offerENEl) customModalData.offerEN = offerENEl.value || '';
  if(offerAREl) customModalData.offerAR = offerAREl.value || '';
  if(dateRangeEl) customModalData.dateRange = dateRangeEl.value || '';
  if(productENEl) customModalData.productEN = productENEl.value || '';
  if(productAREl) customModalData.productAR = productAREl.value || '';
  if(categoryEl) customModalData.category = categoryEl.value || '';
  
  console.log('üíæ Custom modal data saved');
}

function restoreCustomModalData() {
  setTimeout(() => {
    const codeEl = document.getElementById('customCode');
    const quantityEl = document.getElementById('customQuantity');
    const offerENEl = document.getElementById('customOfferEN');
    const offerAREl = document.getElementById('customOfferAR');
    const dateRangeEl = document.getElementById('customDateRange');
    const productENEl = document.getElementById('customProductEN');
    const productAREl = document.getElementById('customProductAR');
    const categoryEl = document.getElementById('customCategory');
    
    if(codeEl) codeEl.value = customModalData.codes;
    if(quantityEl) quantityEl.value = customModalData.quantity;
    if(offerENEl) offerENEl.value = customModalData.offerEN;
    if(offerAREl) offerAREl.value = customModalData.offerAR;
    if(dateRangeEl) dateRangeEl.value = customModalData.dateRange;
    if(productENEl) productENEl.value = customModalData.productEN;
    if(productAREl) productAREl.value = customModalData.productAR;
    if(categoryEl) categoryEl.value = customModalData.category;
    
    updateQuantityDisplay();
    console.log('‚úÖ Custom modal data restored');
  }, 100);
}

// ====== IMAGE LOADING SYSTEM ======
async function fetchProductImage(code) {
  if (imageCache.has(code)) {
    return imageCache.get(code);
  }
  
  try {
    const response = await fetch(`${API_ENDPOINT}${code}`, {
      method: 'GET',
      headers: { 'Accept': 'application/json' }
    });
    
    if (!response.ok) {
      imageCache.set(code, null);
      return null;
    }
    
    const data = await response.json();
    
    if (data.success && data.image) {
      imageCache.set(code, data.image);
      return data.image;
    } else {
      imageCache.set(code, null);
      return null;
    }
    
  } catch (error) {
    console.error(`‚ùå Error fetching ${code}:`, error.message);
    imageCache.set(code, null);
    return null;
  }
}

// ====== LAZY LOADING OBSERVER ======
const imageObserver = new IntersectionObserver((entries, observer) => {
  entries.forEach(entry => {
    if (entry.isIntersecting) {
      const img = entry.target;
      const code = img.dataset.code;
      
      if (!code) return;
      
      fetchProductImage(code).then(imageUrl => {
        if (imageUrl) {
          img.src = imageUrl;
          img.onload = () => {
            img.style.opacity = '1';
            img.classList.add('loaded');
          };
          img.onerror = () => {
            img.src = createPlaceholderSVG(code);
            img.style.opacity = '1';
          };
        } else {
          img.src = createPlaceholderSVG(code);
          img.style.opacity = '1';
        }
      }).catch(() => {
        img.src = createPlaceholderSVG(code);
        img.style.opacity = '1';
      });
      
      observer.unobserve(img);
    }
  });
}, { rootMargin: '300px', threshold: 0.01 });

// ====== PLACEHOLDER SVG ======
function createPlaceholderSVG(code) {
  return `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23f5f5f5'/%3E%3Cstop offset='100%25' style='stop-color:%23e0e0e0'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect fill='url(%23g)' width='200' height='200'/%3E%3Ctext x='50%25' y='45%25' text-anchor='middle' fill='%23999' font-size='14' font-family='Arial'%3ENo Image%3C/text%3E%3Ctext x='50%25' y='58%25' text-anchor='middle' fill='%23ccc' font-size='11' font-family='monospace'%3ECODE: ${code}%3C/text%3E%3C/svg%3E`;
}

// ====== DATA OPTIMIZATION ======
const offersMap = new Map();

function initOffersMap() {
    if(typeof offersDB !== 'undefined') {
        offersDB.forEach(offer => {
            if(offer.codes) {
                offer.codes.forEach(code => offersMap.set(code.toString(), offer));
            }
        });
    }
    console.log(`‚úÖ Offers mapped: ${offersMap.size} products`);
}
initOffersMap();

function getOffer(code) { 
    return offersMap.get(code.toString()); 
}

function stringToColor(str) {
  let hash = 0; 
  for (let i = 0; i < str.length; i++) {
    hash = str.charCodeAt(i) + ((hash << 5) - hash);
  }
  const h = Math.abs(hash) % 360; 
  const s = 65 + (Math.abs(hash) % 20); 
  const l = 35 + (Math.abs(hash) % 10);
  return `hsl(${h}, ${s}%, ${l}%)`;
}
// ====== üé® CATEGORY D AUTO COLORS (30 VIBRANT COLORS) ======
const CATEGORY_D_COLORS = [
  '#10b981', '#3b82f6', '#ec4899', '#f59e0b', '#8b5cf6',
  '#06b6d4', '#ef4444', '#14b8a6', '#f97316', '#a855f7',
  '#0ea5e9', '#22c55e', '#fb923c', '#6366f1', '#84cc16',
  '#f43f5e', '#059669', '#d946ef', '#eab308', '#2563eb',
  '#dc2626', '#7c3aed', '#16a34a', '#ea580c', '#4f46e5',
  '#0d9488', '#be123c', '#65a30d', '#c026d3', '#0284c7'
];

function getCategoryDColor(categoryD) {
  if (!categoryD) return CATEGORY_D_COLORS[0];
  
  let hash = 0;
  for (let i = 0; i < categoryD.length; i++) {
    hash = categoryD.charCodeAt(i) + ((hash << 5) - hash);
    hash = hash & hash;
  }
  
  const index = Math.abs(hash) % CATEGORY_D_COLORS.length;
  return CATEGORY_D_COLORS[index];
}

// ====== üé® BRAND LOGO LOADING SYSTEM ======
function getBrandLogoUrls(brandName) {
  if (!brandName || brandName === 'GENERIC' || brandName === 'N/A') return [];
  
  const clean = brandName.toLowerCase().replace(/[^a-z0-9]/g, '');
  return [
    `https://logo.clearbit.com/${clean}.com`,
    `https://cdn.brandfetch.io/${clean}.com/fallback/icon/`,
    `https://img.logo.dev/${clean}.com?token=pk_X-NOM1TdQVaFy4SSRQoMjQ`,
    `https://t1.gstatic.com/faviconV2?client=SOCIAL&type=FAVICON&fallback_opts=TYPE,SIZE,URL&url=https://${clean}.com&size=256`,
    `https://www.google.com/s2/favicons?domain=${clean}.com&sz=256`
  ];
}

function testImageLoad(url) {
  return new Promise((resolve) => {
    const img = new Image();
    img.onload = () => resolve(true);
    img.onerror = () => resolve(false);
    img.src = url;
    setTimeout(() => resolve(false), 3000);
  });
}

async function tryLoadBrandLogo(brand, imgElement) {
  if (!brand || brand === 'GENERIC' || brand === 'N/A') {
    imgElement.src = getBrandPlaceholderSVG('NO LOGO');
    imgElement.style.maxWidth = '65%';
    imgElement.style.maxHeight = '65%';
    imgElement.style.mixBlendMode = 'normal';
    imgElement.style.opacity = '1';
    imgElement.style.filter = 'drop-shadow(0 2px 4px rgba(0,0,0,0.1))';
    return;
  }

  const logoUrls = getBrandLogoUrls(brand);
  
  for (const logoUrl of logoUrls) {
    try {
      const success = await testImageLoad(logoUrl);
      if (success) {
        imgElement.src = logoUrl;
        imgElement.style.maxWidth = '65%';
        imgElement.style.maxHeight = '65%';
        imgElement.style.mixBlendMode = 'normal';
        imgElement.style.opacity = '1';
        imgElement.style.filter = 'drop-shadow(0 2px 4px rgba(0,0,0,0.1))';
        return;
      }
    } catch (error) {
      continue;
    }
  }
  
  imgElement.src = getBrandPlaceholderSVG(brand);
  imgElement.style.maxWidth = '65%';
  imgElement.style.maxHeight = '65%';
  imgElement.style.mixBlendMode = 'normal';
  imgElement.style.opacity = '1';
  imgElement.style.filter = 'drop-shadow(0 2px 4px rgba(0,0,0,0.1))';
}

function getBrandPlaceholderSVG(brandName) {
  const colors = ['#10b981', '#3b82f6', '#ec4899', '#f59e0b', '#8b5cf6'];
  const color = colors[brandName.length % colors.length];
  const shortText = brandName.substring(0, 12).toUpperCase();
  
  return `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 400'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:${color.replace('#', '%23')};stop-opacity:0.15' /%3E%3Cstop offset='100%25' style='stop-color:${color.replace('#', '%23')};stop-opacity:0.05' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='400' height='400' fill='url(%23grad)'/%3E%3Crect x='80' y='80' width='240' height='240' rx='30' fill='white' opacity='0.9'/%3E%3Ctext x='200' y='220' font-family='Arial,sans-serif' font-size='48' font-weight='900' fill='${color.replace('#', '%23')}' text-anchor='middle' dominant-baseline='middle'%3E${encodeURIComponent(shortText)}%3C/text%3E%3C/svg%3E`;
}

// ====== üì∞ MAGAZINE MODE FUNCTIONS ======
let isMagazineMode = false;

function getMagazineCategoryIcon(catKey) {
  const icons = {
    "HEALTH & WELLNESS": `<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" class="magazine-category-icon">
      <circle cx="32" cy="32" r="30" fill="white" opacity="0.95"/>
      <path d="M32 18 L32 46 M18 32 L46 32" stroke="#10b981" stroke-width="6" stroke-linecap="round"/>
      <circle cx="32" cy="32" r="8" fill="#10b981"/>
    </svg>`,
    "BABY CARE": `<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" class="magazine-category-icon">
      <circle cx="32" cy="32" r="30" fill="white" opacity="0.95"/>
      <circle cx="32" cy="24" r="10" fill="#3b82f6"/>
      <path d="M22 34 Q22 28, 32 28 Q42 28, 42 34 L42 48 Q42 52, 38 52 L26 52 Q22 52, 22 48 Z" fill="#3b82f6"/>
      <circle cx="28" cy="22" r="2" fill="white"/>
      <circle cx="36" cy="22" r="2" fill="white"/>
    </svg>`,
    "BEAUTY CARE": `<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" class="magazine-category-icon">
      <circle cx="32" cy="32" r="30" fill="white" opacity="0.95"/>
      <ellipse cx="32" cy="36" rx="8" ry="12" fill="#ec4899"/>
      <path d="M32 24 Q28 20, 24 22 Q20 24, 22 28 Q24 32, 28 32 L32 28 Z" fill="#ec4899"/>
      <path d="M32 24 Q36 20, 40 22 Q44 24, 42 28 Q40 32, 36 32 L32 28 Z" fill="#ec4899"/>
      <rect x="30" y="48" width="4" height="8" fill="#ec4899" rx="2"/>
    </svg>`,
    "PERSONAL CARE": `<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" class="magazine-category-icon">
      <circle cx="32" cy="32" r="30" fill="white" opacity="0.95"/>
      <rect x="26" y="18" width="12" height="28" rx="6" fill="#dc2626"/>
      <rect x="24" y="14" width="16" height="6" rx="3" fill="#dc2626"/>
      <path d="M28 24 L28 40 M36 24 L36 40" stroke="white" stroke-width="2" opacity="0.5"/>
    </svg>`
  };
  return icons[catKey] || icons["HEALTH & WELLNESS"];
}

// ====== üé® MAGAZINE HELPER FUNCTIONS ======
function getMagazineCategoryClasses(catA) {
  const config = {
    "HEALTH & WELLNESS": { headerClass: 'magazine-header-health', contentClass: 'magazine-content-health', badgeClass: 'health' },
    "BABY CARE": { headerClass: 'magazine-header-baby', contentClass: 'magazine-content-baby', badgeClass: 'baby' },
    "BEAUTY CARE": { headerClass: 'magazine-header-beauty', contentClass: 'magazine-content-beauty', badgeClass: 'beauty' },
    "PERSONAL CARE": { headerClass: 'magazine-header-personal', contentClass: 'magazine-content-personal', badgeClass: 'personal' }
  };
  return config[catA] || config["HEALTH & WELLNESS"];
}

function getMagazineCategoryIcon(catKey) {
  const icons = {
    "HEALTH & WELLNESS": `<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" class="magazine-category-icon">
      <circle cx="32" cy="32" r="30" fill="white" opacity="0.95"/>
      <path d="M32 18 L32 46 M18 32 L46 32" stroke="#10b981" stroke-width="6" stroke-linecap="round"/>
      <circle cx="32" cy="32" r="8" fill="#10b981"/>
    </svg>`,
    "BABY CARE": `<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" class="magazine-category-icon">
      <circle cx="32" cy="32" r="30" fill="white" opacity="0.95"/>
      <circle cx="32" cy="24" r="10" fill="#3b82f6"/>
      <path d="M22 34 Q22 28, 32 28 Q42 28, 42 34 L42 48 Q42 52, 38 52 L26 52 Q22 52, 22 48 Z" fill="#3b82f6"/>
      <circle cx="28" cy="22" r="2" fill="white"/>
      <circle cx="36" cy="22" r="2" fill="white"/>
    </svg>`,
    "BEAUTY CARE": `<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" class="magazine-category-icon">
      <circle cx="32" cy="32" r="30" fill="white" opacity="0.95"/>
      <ellipse cx="32" cy="36" rx="8" ry="12" fill="#ec4899"/>
      <path d="M32 24 Q28 20, 24 22 Q20 24, 22 28 Q24 32, 28 32 L32 28 Z" fill="#ec4899"/>
      <path d="M32 24 Q36 20, 40 22 Q44 24, 42 28 Q40 32, 36 32 L32 28 Z" fill="#ec4899"/>
      <rect x="30" y="48" width="4" height="8" fill="#ec4899" rx="2"/>
    </svg>`,
    "PERSONAL CARE": `<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" class="magazine-category-icon">
      <circle cx="32" cy="32" r="30" fill="white" opacity="0.95"/>
      <rect x="26" y="18" width="12" height="28" rx="6" fill="#dc2626"/>
      <rect x="24" y="14" width="16" height="6" rx="3" fill="#dc2626"/>
      <path d="M28 24 L28 40 M36 24 L36 40" stroke="white" stroke-width="2" opacity="0.5"/>
    </svg>`
  };
  return icons[catKey] || icons["HEALTH & WELLNESS"];
}
// ============================================================
// üî• BADGE GENERATOR - SAME LOGIC AS PRINT (Big Numbers)
// ============================================================
function getMagazineOfferHTML(offer, product, categoryClass, productsCount = 1) {
  if (!offer) return "";

  const offerType = offer.type || offer.offerType || "";
  const code = product.Code;

  // ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑŸÜÿµ
  let cleaned = offerType.trim();
  cleaned = cleaned.replace(/-\s*SAR/gi, " SAR");
  cleaned = cleaned.replace(/\s+/g, " ");
  const cleanedLower = cleaned.toLowerCase();

  // ÿ™ÿ≠ÿØŸäÿØ ÿ£ŸÑŸàÿßŸÜ ÿßŸÑÿÆŸÑŸÅŸäÿ© ŸàÿßŸÑÿ≠ÿØŸàÿØ ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿßŸÑŸÇÿ≥ŸÖ
  const catA = product["Category Level A"] || "HEALTH & WELLNESS";
  let badgeColor = "#10b981"; // Default Green (Health)
  let gradientStart = "#10b981";
  let gradientEnd = "#34d399";

  if (catA.includes("BABY")) {
    badgeColor = "#3b82f6"; // Blue
    gradientStart = "#3b82f6";
    gradientEnd = "#60a5fa";
  } else if (catA.includes("BEAUTY")) {
    badgeColor = "#ec4899"; // Pink
    gradientStart = "#ec4899";
    gradientEnd = "#f472b6";
  } else if (catA.includes("PERSONAL")) {
    badgeColor = "#dc2626"; // Red
    gradientStart = "#dc2626";
    gradientEnd = "#f87171";
  }

  const RIYAL_SVG_URL = "https://www.sama.gov.sa/ar-sa/Currency/Documents/Saudi_Riyal_Symbol-2.svg";
  
  // üü¢ Helper: ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿ£ÿ±ŸÇÿßŸÖ
  const convertToEn = (str) => {
    return str.replace(/[Ÿ†-Ÿ©]/g, d => "0123456789"["Ÿ†Ÿ°Ÿ¢Ÿ£Ÿ§Ÿ•Ÿ¶ŸßŸ®Ÿ©".indexOf(d)]);
  };

  // üü¢ Helper: ÿ™ÿ¨ŸáŸäÿ≤ ŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿØÿßÿ¶ÿ±ÿ©
  const getBadgeContent = () => {
    const safeText = convertToEn(cleanedLower);

    // Common Styles inside foreignObject
    const centerFlex = `display:flex; flex-direction:column; justify-content:center; align-items:center; width:100%; height:100%; padding:0 10%; box-sizing:border-box; line-height:1; font-family:'Roboto', sans-serif;`;
    const rowBottom = `display:flex; align-items:flex-end; justify-content:center; width:100%;`;
    const rowBaseline = `display:flex; align-items:baseline; justify-content:center; width:100%;`;

    // 1Ô∏è‚É£ Price Match (ÿßŸÑÿ≥ÿπÿ±)
    const priceMatch = safeText.match(/(?:@|sar|rs|ÿ±ŸäÿßŸÑ)\s*(\d+(?:\.\d+)?)/i) || 
                       safeText.match(/(\d+(?:\.\d+)?)\s*(?:sar|rs|ÿ±ŸäÿßŸÑ)/i);
    
    // 2Ô∏è‚É£ Percent Match (%)
    const percentMatch = safeText.match(/(\d{1,3})\s*%/);

    // 3Ô∏è‚É£ BOGO / Free (1+1)
    const plusFreeMatch = safeText.match(/(\d+)\s*(?:pcs?|pc)?\s*(?:\+|plus)\s*(\d+)/) || 
                          safeText.match(/buy\s*(\d+)\s*get\s*(\d+)/) ||
                          safeText.includes("free");

    const isSecondPiece = safeText.includes("2nd") || safeText.includes("second") || safeText.includes("buy 1 get 1");

    // üÖ∞Ô∏è CASE: PRICE (SAR)
    if (priceMatch && !safeText.includes("%")) {
      const priceVal = priceMatch[1] || priceMatch[2];
      const price = Math.round(parseFloat(priceVal));
      const digits = price.toString().length;
      
      // Font Sizing for 125px SVG
      let fontSize = '52px';
      if (digits >= 3) fontSize = '40px';
      if (digits >= 4) fontSize = '32px';

      let subText = "";
      if (isSecondPiece) subText = "ÿßŸÑÿ≠ÿ®ÿ© ÿßŸÑÿ´ÿßŸÜŸäÿ©";
      else if (safeText.includes("2 pcs") || safeText.includes("buy 2")) subText = "ÿßŸÑÿ≠ÿ®ÿ™ŸäŸÜ";
      else subText = "ÿßŸÑÿ≠ÿ®ÿ©";

      return `
        <div style="${centerFlex}">
          <div style="${rowBottom} margin-bottom:2px;">
            <img src="${RIYAL_SVG_URL}" style="width:16px; height:16px; margin-right:4px; margin-bottom:8px; filter: brightness(0) invert(1);">
            <span style="font-size:${fontSize}; font-weight:900; color:#fff; letter-spacing:-2px;">${price}</span>
          </div>
          ${subText ? `<div style="font-family:'Cairo'; font-size:12px; font-weight:700; color:#fff; margin-top:-2px;">${subText}</div>` : ''}
        </div>
      `;
    }

    // üÖ±Ô∏è CASE: PERCENTAGE (%)
    if (percentMatch) {
      const percent = percentMatch[1];
      
      return `
        <div style="${centerFlex}">
          <div style="${rowBaseline}">
            <span style="font-size:55px; font-weight:900; color:#fff; letter-spacing:-3px;">${percent}</span>
            <span style="font-size:20px; font-weight:900; color:#fff; margin-left:2px;">%</span>
          </div>
          ${isSecondPiece ? `<div style="font-family:'Cairo'; font-size:11px; font-weight:700; color:#fff; margin-top:-5px;">ÿßŸÑÿ≠ÿ®ÿ© ÿßŸÑÿ´ÿßŸÜŸäÿ©</div>` : ''}
        </div>
      `;
    }

    // üÜé CASE: 1+1 (Big Second Number)
    if (plusFreeMatch) {
        let x = '1', y = '1';
        const pM = safeText.match(/(\d+)\s*(?:\+|plus)\s*(\d+)/);
        const bM = safeText.match(/buy\s*(\d+)\s*get\s*(\d+)/);
        const gM = safeText.match(/get\s*(\d+)/);

        if (pM) { x = pM[1]; y = pM[2]; }
        else if (bM) { x = bM[1]; y = bM[2]; }
        else if (gM) { y = gM[1]; }

        return `
        <div style="${centerFlex}">
          <div style="${rowBaseline}">
            <span style="font-size:24px; font-weight:700; color:#eee;">${x}</span>
            <span style="font-size:20px; font-weight:400; color:#ddd; margin:0 3px;">+</span>
            <span style="font-size:50px; font-weight:900; color:#fff;">${y}</span>
          </div>
          <div style="font-family:'Cairo'; font-size:14px; font-weight:700; color:#fff; margin-top:0px;">ŸÖÿ¨ÿßŸÜÿßŸã</div>
        </div>
      `;
    }

    // Fallback
    return `
      <div style="${centerFlex}">
        <div style="font-family:'Cairo'; font-size:16px; font-weight:900; color:#fff; text-align:center;">ÿπÿ±ÿ∂<br>ÿÆÿßÿµ</div>
      </div>
    `;
  };

  const contentHTML = getBadgeContent();

  // ÿ®ŸÜÿßÿ° ÿßŸÑŸÄ SVG ÿßŸÑŸÜŸáÿßÿ¶Ÿä
  return `
    <div class="magazine-offer-circle" style="width:100px; height:100px;">
      <svg width="100%" height="100%" viewBox="0 0 125 125" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <linearGradient id="grad-${code}" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:${gradientStart};stop-opacity:1" />
            <stop offset="100%" style="stop-color:${gradientEnd};stop-opacity:1" />
          </linearGradient>
          <filter id="shadow-${code}">
            <feGaussianBlur in="SourceAlpha" stdDeviation="3"/>
            <feOffset dx="0" dy="4"/>
            <feComponentTransfer><feFuncA type="linear" slope="0.3"/></feComponentTransfer>
            <feMerge><feMergeNode/><feMergeNode in="SourceGraphic"/></feMerge>
          </filter>
        </defs>
        
        <g filter="url(#shadow-${code})">
          <circle cx="62.5" cy="62.5" r="58" fill="url(#grad-${code})" stroke="#fff" stroke-width="3"/>
          
          <foreignObject x="4" y="4" width="117" height="117">
            <div xmlns="http://www.w3.org/1999/xhtml" style="width:100%; height:100%;">
              ${contentHTML}
            </div>
          </foreignObject>
        </g>
      </svg>
    </div>
  `;
}
// ========== Get Brand Offer for Magazine Mode (FIXED - WITH CATEGORY FILTER) ==========
function getMagazineBrandOffer(brand, catA) {  // ‚úÖ ÿ£ÿ∂ŸÅÿ™ catA parameter
  // ‚úÖ ŸÅŸÑÿ™ÿ± ÿ®ÿßŸÑŸÄ brand AND category
  const allBrandProducts = productsDB.filter(p => 
    p.Brand === brand && 
    (p["Category Level A"] || p["Category A"]) === catA  // ‚úÖ ŸÜŸÅÿ≥ ÿßŸÑŸÄ category ÿ®ÿ≥
  );
  
  if (!allBrandProducts.length) return null;

  // 1) find first product that has an offer
  let sampleProduct = null;
  let fullOffer = null;

  for (const p of allBrandProducts) {
    const o = getOffer(p.Code);
    if (o) {
      sampleProduct = p;
      fullOffer = o;
      break;
    }
  }

  if (!fullOffer || !sampleProduct) return null;

  // 2) collect all products in same brand AND CATEGORY that share the SAME offer object
  const offerProducts = allBrandProducts.filter(p => getOffer(p.Code) === fullOffer);

  // 3) direct detection (based on your offersDB: offer-xx-direct)
  const metaClass = `${fullOffer.styleClass || ""} ${fullOffer.badgeClass || ""}`.toLowerCase();
  const isDirect = metaClass.includes("direct");

  // 4) group detection (codes from offer + products matched in brand)
  const codesCount = Array.isArray(fullOffer.codes) ? fullOffer.codes.length : 0;
  const productsCount = offerProducts.length || 1;
  const isGroup = (productsCount > 1) || (codesCount > 1);

  // 5) newPrice only meaningful for Single + Direct (matching your rule)
  const rawNewPrice = fullOffer.offerPrice ? fullOffer.offerPrice[sampleProduct.Code] : null;
  const newPrice = (!isGroup && isDirect) ? rawNewPrice : null;

  return {
    offerType: fullOffer.offerType || fullOffer.type,
    newPrice,
    oldPrice: sampleProduct["Unit Price"],
    sampleCode: sampleProduct.Code,
    sampleProduct,
    fullOffer,                // keep full offer object
    offerProducts,            // ‚úÖ products in this brand AND category with same offer
    productsCount,            // pass this to getMagazineOfferHTML(..., productsCount)
    isDirect,
    isGroup
  };
}

// Get representative product for brand
function getMagazineBrandRepresentative(brand, catA) {
  // ‚úÖ FIX: ÿßÿ≥ÿ™ÿÆÿØŸÖ productsDB ŸÖÿ¥ database
  const allBrandProducts = productsDB.filter(p => 
    p.Brand === brand && (p["Category Level A"] || "Uncategorized") === catA
  );
  
  if (allBrandProducts.length === 0) return null;
  
  // Priority: product with offer > first product
  const productWithOffer = allBrandProducts.find(p => getOffer(p.Code) !== null); // ‚úÖ ÿßÿ≥ÿ™ÿÆÿØŸÖ getOffer
  return productWithOffer || allBrandProducts[0];
}

// Get Magazine Category Classes
function getMagazineCategoryClasses(catA) {
  const categoryMap = {
    "HEALTH & WELLNESS": {
      headerClass: "magazine-header-health",
      contentClass: "magazine-content-health",
      badgeClass: "magazine-health"
    },
    "BABY CARE": {
      headerClass: "magazine-header-baby",
      contentClass: "magazine-content-baby",
      badgeClass: "magazine-baby"
    },
    "BEAUTY CARE": {
      headerClass: "magazine-header-beauty",
      contentClass: "magazine-content-beauty",
      badgeClass: "magazine-beauty"
    },
    "PERSONAL CARE": {
      headerClass: "magazine-header-personal",
      contentClass: "magazine-content-personal",
      badgeClass: "magazine-personal"
    }
  };
  
  return categoryMap[catA] || {
    headerClass: "magazine-header-health",
    contentClass: "magazine-content-health",
    badgeClass: "magazine-health"
  };
}

// Get Magazine Category Icon
function getMagazineCategoryIcon(catA) {
  const iconMap = {
    "HEALTH & WELLNESS": `<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" class="magazine-category-icon">
      <circle cx="32" cy="32" r="30" fill="white" opacity="0.95"/>
      <path d="M32 18 L32 46 M18 32 L46 32" stroke="#10b981" stroke-width="6" stroke-linecap="round"/>
      <circle cx="32" cy="32" r="8" fill="#10b981"/>
    </svg>`,
    "BABY CARE": `<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" class="magazine-category-icon">
      <circle cx="32" cy="32" r="30" fill="white" opacity="0.95"/>
      <circle cx="32" cy="24" r="10" fill="#3b82f6"/>
      <path d="M22 34 Q22 28, 32 28 Q42 28, 42 34 L42 48 Q42 52, 38 52 L26 52 Q22 52, 22 48 Z" fill="#3b82f6"/>
      <circle cx="28" cy="22" r="2" fill="white"/>
      <circle cx="36" cy="22" r="2" fill="white"/>
    </svg>`,
    "BEAUTY CARE": `<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" class="magazine-category-icon">
      <circle cx="32" cy="32" r="30" fill="white" opacity="0.95"/>
      <ellipse cx="32" cy="36" rx="8" ry="12" fill="#ec4899"/>
      <path d="M32 24 Q28 20, 24 22 Q20 24, 22 28 Q24 32, 28 32 L32 28 Z" fill="#ec4899"/>
      <path d="M32 24 Q36 20, 40 22 Q44 24, 42 28 Q40 32, 36 32 L32 28 Z" fill="#ec4899"/>
      <rect x="30" y="48" width="4" height="8" fill="#ec4899" rx="2"/>
    </svg>`,
    "PERSONAL CARE": `<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" class="magazine-category-icon">
      <circle cx="32" cy="32" r="30" fill="white" opacity="0.95"/>
      <rect x="26" y="18" width="12" height="28" rx="6" fill="#dc2626"/>
      <rect x="24" y="14" width="16" height="6" rx="3" fill="#dc2626"/>
      <path d="M28 24 L28 40 M36 24 L36 40" stroke="white" stroke-width="2" opacity="0.5"/>
    </svg>`
  };
  
  return iconMap[catA] || iconMap["HEALTH & WELLNESS"];
}

// Initialize Magazine Lazy Loader
function initMagazineLazyLoader() {
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const img = entry.target;
        const code = img.dataset.code;
        const brand = img.dataset.brand;
        
        // Try to load product image from API
       fetch(`${WORKER_BASE}/api/product?code=${code}`) // ‚úÖ ÿßÿ≥ÿ™ÿÆÿØŸÖ WORKER_BASE ŸÖÿ¥ WORKER_API_URL

          .then(res => res.json())
          .then(data => {
            if (data.success && data.image) {
              testImageLoad(data.image).then(success => {
                if (success) {
                  img.src = data.image;
                  img.style.opacity = '1';
                } else {
                  tryLoadBrandLogo(brand, img);
                }
              });
            } else {
              tryLoadBrandLogo(brand, img);
            }
          })
          .catch(() => {
            tryLoadBrandLogo(brand, img);
          });
        
        observer.unobserve(img);
      }
    });
  }, {
    rootMargin: '50px'
  });

  document.querySelectorAll('img.magazine-lazy-img').forEach(img => {
    observer.observe(img);
  });
}

// Test if image loads successfully
function testImageLoad(url) {
  return new Promise((resolve) => {
    const img = new Image();
    img.onload = () => resolve(true);
    img.onerror = () => resolve(false);
    img.src = url;
    setTimeout(() => resolve(false), 3000);
  });
}

// Try loading brand logo with fallbacks
async function tryLoadBrandLogo(brand, imgElement) {
  if (!brand || brand === 'GENERIC') {
    imgElement.src = getPlaceholderSVG('NO LOGO');
    imgElement.style.opacity = '1';
    return;
  }

  const logoUrls = getBrandLogoUrls(brand);
  
  for (const logoUrl of logoUrls) {
    try {
      const success = await testImageLoad(logoUrl);
      if (success) {
        imgElement.src = logoUrl;
        imgElement.style.opacity = '1';
        imgElement.style.mixBlendMode = 'normal';
        return;
      }
    } catch (error) {
      continue;
    }
  }
  
  imgElement.src = getPlaceholderSVG(brand);
  imgElement.style.opacity = '1';
}

// Get brand logo URLs
function getBrandLogoUrls(brandName) {
  const clean = brandName.toLowerCase().replace(/[^a-z0-9]/g, '');
  return [
    `https://logo.clearbit.com/${clean}.com`,
    `https://cdn.brandfetch.io/${clean}.com/fallback/icon/`,
    `https://img.logo.dev/${clean}.com?token=pk_X-NOM1TdQVaFy4SSRQoMjQ`,
    `https://t1.gstatic.com/faviconV2?client=SOCIAL&type=FAVICON&fallback_opts=TYPE,SIZE,URL&url=https://${clean}.com&size=256`
  ];
}

// Get placeholder SVG
function getPlaceholderSVG(text) {
  const colors = ['#10b981', '#3b82f6', '#ec4899', '#f59e0b', '#8b5cf6'];
  const color = colors[text.length % colors.length];
  const shortText = text.substring(0, 12).toUpperCase();
  
  return `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 400'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:${color.replace('#', '%23')};stop-opacity:0.15' /%3E%3Cstop offset='100%25' style='stop-color:${color.replace('#', '%23')};stop-opacity:0.05' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='400' height='400' fill='url(%23grad)'/%3E%3Crect x='80' y='80' width='240' height='240' rx='30' fill='white' opacity='0.9'/%3E%3Ctext x='200' y='220' font-family='Arial,sans-serif' font-size='48' font-weight='900' fill='${color.replace('#', '%23')}' text-anchor='middle' dominant-baseline='middle'%3E${encodeURIComponent(shortText)}%3C/text%3E%3C/svg%3E`;
}

function initMagazineLazyLoader() {
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const img = entry.target;
        const code = img.dataset.code;
        const brand = img.dataset.brand;
        
        fetchProductImage(code).then(imageUrl => {
          if (imageUrl) {
            testImageLoad(imageUrl).then(success => {
              if (success) {
                img.src = imageUrl;
                img.onload = () => {
                  img.style.opacity = '1';
                };
              } else {
                tryLoadBrandLogo(brand, img);
              }
            });
          } else {
            tryLoadBrandLogo(brand, img);
          }
        }).catch(() => {
          tryLoadBrandLogo(brand, img);
        });
        
        observer.unobserve(img);
      }
    });
  }, { rootMargin: '300px', threshold: 0.01 });

  document.querySelectorAll('img.magazine-lazy-img').forEach(img => observer.observe(img));
}
// ====== üìñ MAGAZINE PAGINATION SETTINGS ======
let magazineSettings = {
  rowsPerPage: 4,        // ÿπÿØÿØ ÿßŸÑÿµŸÅŸàŸÅ ŸÅŸä ÿßŸÑÿµŸÅÿ≠ÿ©
  itemsPerRow: 3,        // ÿπÿØÿØ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÅŸä ÿßŸÑÿµŸÅ
  currentPage: 1,
  totalPages: 1,
  allProducts: [],
  touchStartX: 0,
  touchEndX: 0,
  touchStartY: 0,
  touchEndY: 0
};

// ====== üé® GET CATEGORY ICON SVG ======
function getMagazineCategoryIcon(catA) {
  const iconMap = {
    "HEALTH & WELLNESS": `<svg class="magazine-category-icon-svg" viewBox="0 0 24 24" fill="white"><path d="M12 2L4 5v6.09c0 5.05 3.41 9.76 8 10.91 4.59-1.15 8-5.86 8-10.91V5l-8-3zm0 18c-3.31-1.16-5.59-4.13-5.99-7.49L12 15l5.99-2.49C17.59 15.87 15.31 18.84 12 20z"/></svg>`,
    "BABY CARE": `<svg class="magazine-category-icon-svg" viewBox="0 0 24 24" fill="white"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-2-7.5c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm4 0c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1.5 4.5c-1.38 0-2.63-.56-3.54-1.47l1.06-1.06c.63.63 1.51 1.03 2.48 1.03s1.84-.39 2.48-1.03l1.06 1.06c-.91.91-2.16 1.47-3.54 1.47z"/></svg>`,
    "BEAUTY & PERSONAL CARE": `<svg class="magazine-category-icon-svg" viewBox="0 0 24 24" fill="white"><path d="M9 11c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0-6c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2zm6.39 8.56C13.71 13.7 11.53 13 9 13s-4.71.7-6.39 1.56C1.61 15.07 1 16.1 1 17.22V20h16v-2.78c0-1.12-.61-2.15-1.61-2.66z"/></svg>`,
    "PERSONAL CARE": `<svg class="magazine-category-icon-svg" viewBox="0 0 24 24" fill="white"><path d="M12.97 2.54c-.5-.5-1.31-.5-1.81 0L8 5.71 5.71 3.43c-.5-.5-1.31-.5-1.81 0-.5.5-.5 1.31 0 1.81L6.17 7.5 3.9 9.77c-.5.5-.5 1.31 0 1.81.25.25.58.38.91.38s.66-.13.91-.38L8 9.31l2.27 2.27c.25.25.58.38.91.38s.66-.13.91-.38c.5-.5.5-1.31 0-1.81L9.83 7.5l2.27-2.27c.5-.5.5-1.31 0-1.81zm-1.32 9.17L9.38 14 7.11 11.73c-.39-.39-1.02-.39-1.41 0-.39.39-.39 1.02 0 1.41L8 15.45V20c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-4.55l2.29-2.29c.39-.39.39-1.02 0-1.41-.39-.39-1.02-.39-1.41 0L14.62 14l-2.27-2.29c-.39-.39-1.02-.39-1.41 0z"/></svg>`
  };
  
  return iconMap[catA] || iconMap["HEALTH & WELLNESS"];
}

// ====== üé® GET CATEGORY CLASSES ======
function getMagazineCategoryClasses(catA) {
  if (catA.includes("BABY")) return { badgeClass: "magazine-baby", headerClass: "header-baby" };
  if (catA.includes("BEAUTY")) return { badgeClass: "magazine-beauty", headerClass: "header-beauty" };
  if (catA.includes("PERSONAL")) return { badgeClass: "magazine-personal", headerClass: "header-personal" };
  return { badgeClass: "magazine-health", headerClass: "header-health" };
}

// ====== üìÑ RENDER SINGLE PAGE (CATEGORY BLOCKS MODE) - UPDATED ======
function renderMagazinePage(pageNumber) {
  const pagesContainer = document.getElementById('magazinePagesContainer');
  if (!pagesContainer) return;
  
  const { blocksPerPage, categoryBlocks } = magazineSettings;
  const startIndex = (pageNumber - 1) * blocksPerPage;
  const endIndex = Math.min(startIndex + blocksPerPage, categoryBlocks.length);
  const pageBlocks = categoryBlocks.slice(startIndex, endIndex);
  
  if (pageBlocks.length === 0) return;
  
  const pageDiv = document.createElement('div');
  pageDiv.className = `magazine-page active`;
  pageDiv.id = `magazine-page-${pageNumber}`;
  
  let pageHTML = '';
  
  pageBlocks.forEach((block, blockIndex) => {
    const { catA, classes, products, totalProducts } = block;
    const icon = getMagazineCategoryIcon(catA);
    
    pageHTML += `
      <div class="magazine-category-block">
        <!-- Category pill one time per row -->
        <div class="magazine-category-header ${classes.headerClass}"
             style="display:flex;align-items:center;justify-content:center;margin-bottom:10px;">
          <div style="
            display:inline-flex;align-items:center;gap:6px;
            padding:6px 14px;border-radius:999px;
            background:rgba(255,255,255,0.95);
            box-shadow:0 4px 12px rgba(15,23,42,0.15);
            font-family:'Cairo',sans-serif;font-weight:800;
            color:#0f172a;font-size:13px;
          ">
            ${icon}
            <span>${catA}</span>
            <span style="color:#6b7280;font-weight:600;">(${totalProducts} ŸÖŸÜÿ™ÿ¨)</span>
          </div>
        </div>
        
        <!-- Products Grid for this Category -->
        <div class="magazine-category-products-grid">
    `;
    
    // ‚úÖ ÿπÿ±ÿ∂ ŸÉŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑÿÆÿßÿµÿ© ÿ®ÿßŸÑŸÉÿßÿ™Ÿäÿ¨Ÿàÿ±Ÿä ÿØŸä (ÿ®ÿØŸàŸÜ ÿ≠ÿØ ÿ£ŸÇÿµŸâ)
    products.forEach((item) => {
      const { product, brand, classes: itemClasses, productsCount, offerProducts } = item;
      const offer = getOffer(product.Code);
      const categoryDColor = getCategoryDColor(product["Category Level D"]);
      
      let offerBadge = '';
      if (offer) {
        const offerPrice = offer.offerPrice ? offer.offerPrice[product.Code] : null;
        offerBadge = getMagazineOfferHTML(
          {
            type: offer.offerType,
            offerType: offer.offerType,
            newPrice: offerPrice
          }, 
          product, 
          itemClasses.badgeClass,
          productsCount
        );
      }
      
      const bestSellerBadge = product.isSelected 
        ? '<div class="magazine-best-seller-badge">‚òÖ BEST</div>' 
        : '';
      
      // ‚úÖ IMAGE LOGIC: Multiple products stack (same as ÿπŸÜÿØŸÉ)
      let imageHTML = '';
      if (productsCount > 1 && offerProducts && offerProducts.length > 0) {
        let productsToShow = offerProducts.slice(0, 3);
        while (productsToShow.length < 3 && productsToShow.length > 0) {
          productsToShow.push(productsToShow[0]);
        }

        imageHTML = '<div class="magazine-images-stack magazine-product-image-wrapper">';
        productsToShow.forEach((p, idx) => {
          imageHTML += `
            <img 
              data-code="${p.Code}" 
              data-brand="${brand}" 
              class="magazine-lazy-img" 
              alt="${brand} ${idx + 1}"
            />
          `;
        });
        imageHTML += '</div>';
      } else {
        imageHTML = `
          <div class="magazine-product-image-wrapper">
            <img 
              data-code="${product.Code}" 
              data-brand="${brand}" 
              class="magazine-lazy-img" 
              alt="${brand}"
            />
          </div>
        `;
      }
      
      pageHTML += `
        <div class="magazine-product-card" 
             onclick="window.open('https://www.al-dawaa.com/en/p/${product.Code}', '_blank')">
          ${offerBadge}
          ${bestSellerBadge}
          ${imageHTML}
          <div class="magazine-product-info">
            <div class="magazine-brand-name">${brand}</div>
            <div class="magazine-item-name">
              ${productsCount > 1 ? `${productsCount} ŸÖŸÜÿ™ÿ¨ÿßÿ™` : (product["Item Description"] || '')}
            </div>
            <div class="magazine-category-d-name" 
                 style="background: linear-gradient(135deg, ${categoryDColor} 0%, ${categoryDColor}dd 100%);">
              ${product["Category Level D"] || 'CATEGORY'}
            </div>
          </div>
        </div>
      `;
    });
    
    pageHTML += `
        </div> <!-- End category products grid -->
      </div> <!-- End category block -->
    `;
  });
  
  pageDiv.innerHTML = pageHTML;
  pagesContainer.innerHTML = '';
  pagesContainer.appendChild(pageDiv);
  updateMagazineNav();
  setTimeout(() => initMagazineLazyLoader(), 100);
}

// ====== üëÜ TOUCH EVENTS FOR SWIPE ======
function initMagazineTouchEvents() {
  const container = document.getElementById('magazinePagesContainer');
  if (!container) return;
  
  container.addEventListener('touchstart', (e) => {
    magazineSettings.touchStartX = e.changedTouches[0].screenX;
    magazineSettings.touchStartY = e.changedTouches[0].screenY;
  }, { passive: true });
  
  container.addEventListener('touchend', (e) => {
    magazineSettings.touchEndX = e.changedTouches[0].screenX;
    magazineSettings.touchEndY = e.changedTouches[0].screenY;
    handleMagazineSwipe();
  }, { passive: true });
  
  console.log('‚úÖ Touch events initialized for Magazine');
}

// ====== üëâ HANDLE SWIPE GESTURE ======
function handleMagazineSwipe() {
  const threshold = 50;
  const diffX = magazineSettings.touchStartX - magazineSettings.touchEndX;
  const diffY = Math.abs(magazineSettings.touchStartY - magazineSettings.touchEndY);
  
  // Only trigger if horizontal swipe is dominant
  if (Math.abs(diffX) > threshold && Math.abs(diffX) > diffY) {
    if (diffX > 0) {
      // Swipe Left = Next Page
      magazineNextPage();
    } else {
      // Swipe Right = Previous Page
      magazinePrevPage();
    }
  }
}

// ====== üí¨ SHOW SWIPE HINT ======
function showSwipeHint() {
  const hint = document.getElementById('magazineSwipeHint');
  if (hint && magazineSettings.totalPages > 1) {
    setTimeout(() => {
      hint.classList.add('show');
      setTimeout(() => {
        hint.classList.remove('show');
      }, 3000);
    }, 1000);
  }
}

// ====== üîÑ UPDATE NAVIGATION ======
function updateMagazineNav() {
  const prevBtn = document.getElementById('magazinePrevBtn');
  const nextBtn = document.getElementById('magazineNextBtn');
  const pageNumber = document.getElementById('magazinePageNumber');
  const totalPages = document.getElementById('magazineTotalPages');
  
  if (prevBtn) prevBtn.disabled = magazineSettings.currentPage === 1;
  if (nextBtn) nextBtn.disabled = magazineSettings.currentPage === magazineSettings.totalPages;
  if (pageNumber) pageNumber.textContent = magazineSettings.currentPage;
  if (totalPages) totalPages.textContent = magazineSettings.totalPages;
}

// ====== ‚óÄ PREVIOUS PAGE ======
function magazinePrevPage() {
  if (magazineSettings.currentPage > 1) {
    magazineSettings.currentPage--;
    renderMagazinePage(magazineSettings.currentPage);
    console.log(`‚óÄ Previous page: ${magazineSettings.currentPage}`);
  }
}

// ====== ‚ñ∂ NEXT PAGE ======
function magazineNextPage() {
  if (magazineSettings.currentPage < magazineSettings.totalPages) {
    magazineSettings.currentPage++;
    renderMagazinePage(magazineSettings.currentPage);
    console.log(`‚ñ∂ Next page: ${magazineSettings.currentPage}`);
  }
}

// ====== ‚öôÔ∏è APPLY SETTINGS ======
function applyMagazineSettings() {
  const rowsInput = document.getElementById('magazineRowsPerPage');
  const itemsInput = document.getElementById('magazineItemsPerRow');
  
  if (rowsInput && itemsInput) {
    magazineSettings.rowsPerPage = parseInt(rowsInput.value) || 5;
    magazineSettings.itemsPerRow = parseInt(itemsInput.value) || 4;
    magazineSettings.currentPage = 1;
    magazineSettings.totalPages = Math.ceil(
      magazineSettings.allProducts.length / 
      (magazineSettings.rowsPerPage * magazineSettings.itemsPerRow)
    );
    
    renderMagazinePage(1);
    
    console.log(`‚úÖ Settings Applied: ${magazineSettings.rowsPerPage} rows √ó ${magazineSettings.itemsPerRow} items = ${magazineSettings.totalPages} pages`);
  }
}
// ====== üé® BUILD CATEGORY NAVIGATION BAR - FIXED ======
function buildCategoryNavigation() {
  // ÿßŸÖÿ≥ÿ≠ ÿßŸÑŸÇÿØŸäŸÖ ŸÑŸà ŸÖŸàÿ¨ŸàÿØ
  const oldNav = document.getElementById('magazine-categories-nav');
  if(oldNav) oldNav.remove();
  
  // üî• ÿßÿ¨ŸÖÿπ Categories ŸÖŸÜ productsDB ŸÖÿ®ÿßÿ¥ÿ±ÿ© (ŸÖÿ∂ŸÖŸàŸÜ 100%)
  const allCategories = new Set();
  if(typeof productsDB !== 'undefined') {
    productsDB.forEach(product => {
      if(product['Category A']) {
        allCategories.add(product['Category A']);
      }
    });
  }
  
  if(allCategories.size === 0) {
    console.log('‚ùå No categories found');
    return;
  }
  
  console.log('‚úÖ Found categories:', Array.from(allCategories));
  
  // üì¶ ÿßÿπŸÖŸÑ ÿßŸÑŸÄ Container
  const categoriesNav = document.createElement('div');
  categoriesNav.id = 'magazine-categories-nav';
  categoriesNav.className = 'magazine-categories-nav';
  categoriesNav.style.cssText = `
    display: flex !important;
    justify-content: center !important;
    align-items: center !important;
    gap: 12px !important;
    margin: 20px auto 15px auto !important;
    padding: 18px 20px !important;
    background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(249,250,251,0.95) 100%) !important;
    border-radius: 30px !important;
    box-shadow: 0 8px 30px rgba(0,0,0,0.12), inset 0 1px 0 rgba(255,255,255,0.8) !important;
    max-width: 1100px !important;
    flex-wrap: wrap !important;
    border: 2px solid rgba(102,126,234,0.2) !important;
    position: relative !important;
    z-index: 100 !important;
    animation: slideDown 0.5s ease-out !important;
  `;
  
  // üéØ ÿßÿπŸÖŸÑ Button ŸÑŸÉŸÑ Category
  Array.from(allCategories).sort().slice(0, 12).forEach((catName, index) => { // max 12 buttons
    const catBtn = document.createElement('button');
    catBtn.className = 'magazine-cat-btn';
    catBtn.innerHTML = `
      <span style="font-size: 18px; margin-right: 6px;">${getCategoryEmoji(catName)}</span>
      <strong style="font-size: 13px;">${catName}</strong>
    `;
    catBtn.dataset.cat = catName;
    
    // ÿßŸÑŸàÿßŸÜ ŸÖÿ™ŸÜŸàÿπÿ©
    const colors = [
      '#10b981', '#3b82f6', '#ec4899', '#f59e0b', '#8b5cf6', '#06b6d4',
      '#ef4444', '#14b8a6', '#f97316', '#a855f7', '#0ea5e9', '#22c55e'
    ];
    const color = colors[index % colors.length];
    
    catBtn.style.cssText = `
      padding: 12px 24px !important;
      background: linear-gradient(135deg, ${color} 0%, ${color}dd 100%) !important;
      color: white !important;
      border: none !important;
      border-radius: 22px !important;
      font-weight: 800 !important;
      cursor: pointer !important;
      transition: all 0.3s ease !important;
      box-shadow: 0 4px 15px ${color}80 !important;
      text-transform: uppercase !important;
      letter-spacing: 0.5px !important;
      display: flex !important;
      align-items: center !important;
      gap: 6px !important;
      min-width: 120px !important;
      height: 44px !important;
    `;
    
    catBtn.addEventListener('click', (e) => {
      console.log('üéØ Category clicked:', catName);
      goToCategoryPage(catName, e.currentTarget);
    });
    
    catBtn.addEventListener('mouseenter', () => {
      catBtn.style.transform = 'translateY(-3px) scale(1.05)';
      catBtn.style.boxShadow = `0 8px 25px ${color}cc !important`;
    });
    
    catBtn.addEventListener('mouseleave', () => {
      catBtn.style.transform = 'translateY(0) scale(1)';
      catBtn.style.boxShadow = `0 4px 15px ${color}80 !important`;
    });
    
    categoriesNav.appendChild(catBtn);
  });
  
  // üéØ ÿ≠ÿ∑Ÿá ŸÅŸä ÿßŸÑŸÖŸÉÿßŸÜ ÿßŸÑÿµÿ≠ **ŸÅŸàŸÇ ÿßŸÑŸÄ pagination**
  const paginationWrapper = document.querySelector('.magazine-pagination-wrapper, #magazinePaginationWrapper');
  if(paginationWrapper) {
    paginationWrapper.parentNode.insertBefore(categoriesNav, paginationWrapper);
    console.log('‚úÖ Category Nav inserted before pagination');
  } else {
    // fallback: ÿ≠ÿ∑Ÿá ŸÅŸä productsContainer
    const productsContainer = document.getElementById('productsContainer');
    if(productsContainer) {
      productsContainer.insertBefore(categoriesNav, productsContainer.firstChild);
      console.log('‚úÖ Category Nav inserted in productsContainer');
    }
  }
  
  console.log('üéâ Category Navigation Bar created successfully!');
}

// ====== üöÄ GO TO CATEGORY PAGE - SIMPLIFIED ======
function goToCategoryPage(catName, btnElement) {
  console.log('üîç Searching for category:', catName);
  
  // ÿßÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑÿµŸÅÿ≠ÿßÿ™ ÿßŸÑŸÖŸàÿ¨ŸàÿØÿ©
  const pagesContainer = document.querySelector('.magazine-pages-container, #magazinePagesContainer');
  if(!pagesContainer) {
    console.log('‚ùå No magazine pages found');
    return;
  }
  
  const allPages = pagesContainer.querySelectorAll('.magazine-page');
  let targetPageFound = false;
  
  allPages.forEach((page, pageIndex) => {
    // ÿßÿ®ÿ≠ÿ´ ÿπŸÜ category header ŸÅŸä ÿßŸÑÿµŸÅÿ≠ÿ©
    const catHeader = page.querySelector(`.magazine-category-header .magazine-category-title-text`);
    if(catHeader && catHeader.textContent.includes(catName)) {
      // ŸÅÿπŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
      page.classList.add('active');
      page.scrollIntoView({ behavior: 'smooth', block: 'start' });
      
      // ÿ≠ÿØÿ´ ÿßŸÑŸÄ currentPage
      if(window.magazineSettings) {
        window.magazineSettings.currentPage = pageIndex + 1;
        updateMagazineNav();
      }
      
      targetPageFound = true;
      console.log(`‚úÖ Found "${catName}" in page ${pageIndex + 1}`);
    } else {
      page.classList.remove('active');
    }
  });
  
  // Animate ÿßŸÑŸÄ button
  if(btnElement) {
    btnElement.style.transform = 'scale(1.1)';
    setTimeout(() => {
      btnElement.style.transform = 'scale(1)';
    }, 300);
  }
  
  if(!targetPageFound) {
    console.log(`‚ùå Category "${catName}" not found in any page`);
    alert(`Category "${catName}" not found! üîç`);
  }
}

// ====== üé® EMOJI HELPER ======
function getCategoryEmoji(catName) {
  const map = {
    'HEALTH': 'üè•', 'WELLNESS': 'üíä', 'BABY': 'üë∂', 'BEAUTY': 'üíÑ', 
    'PERSONAL': 'üß¥', 'SKIN': 'üßñ', 'UPPER ARM': 'üí™'
  };
  const key = Object.keys(map).find(k => catName.toUpperCase().includes(k));
  return map[key] || 'üè∑Ô∏è';
}

// ====== üîÑ TOGGLE MAGAZINE MODE - FIXED VERSION ======
function toggleMagazineMode() {
  isMagazineMode = !isMagazineMode;
  const btn = document.getElementById('magazineModeToggle');
  
  if(btn) {
    if(isMagazineMode) {
      // üü¢ ON State - Green Magazine Style
      btn.innerHTML = 'üì∞ MAGAZINE MODE: ON';
      btn.style.background = 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)';
      btn.style.boxShadow = '0 10px 30px rgba(17, 153, 142, 0.6), inset 0 2px 5px rgba(255, 255, 255, 0.3), 0 0 25px rgba(56, 239, 125, 0.5)';
      btn.style.borderColor = 'rgba(255, 255, 255, 0.5)';
      btn.classList.add('active');
    } else {
      // üî¥ OFF State - Red Magazine Style
      btn.innerHTML = 'üì∞ MAGAZINE MODE: OFF';
      btn.style.background = 'linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 50%, #c92a2a 100%)';
      btn.style.boxShadow = '0 10px 30px rgba(255, 107, 107, 0.5), inset 0 2px 5px rgba(255, 255, 255, 0.2), 0 0 20px rgba(255, 107, 107, 0.3)';
      btn.style.borderColor = 'rgba(255, 255, 255, 0.3)';
      btn.classList.remove('active');
      
      // üóëÔ∏è ÿßŸÖÿ≥ÿ≠ ÿßŸÑŸÄ Category Navigation
      const navBar = document.getElementById('magazine-categories-nav');
      if(navBar) navBar.remove();
    }
  }
  
  applyFilters(); // Ÿáÿ™ÿØÿπŸä renderMagazineMode ŸàŸáŸäÿ®ŸÇŸâ ŸÅŸäŸáÿß ÿßŸÑŸÄ buildCategoryNavigation
  
  console.log(`üì∞ Magazine Mode: ${isMagazineMode ? 'ON ‚úÖ' : 'OFF ‚ùå'}`);
}

// ====== üé® BUILD CATEGORY NAVIGATION BAR ======
function buildCategoryNavigation() {
  // ÿßŸÖÿ≥ÿ≠ ÿßŸÑŸÇÿØŸäŸÖ ŸÑŸà ŸÖŸàÿ¨ŸàÿØ
  const oldNav = document.getElementById('magazine-categories-nav');
  if(oldNav) oldNav.remove();
  
  // ÿßÿ¨ŸÖÿπ ŸÉŸÑ ÿßŸÑŸÄ Category A ÿßŸÑŸÖŸàÿ¨ŸàÿØÿ© ŸÅŸä ÿßŸÑÿØÿßÿ™ÿß
  const allCategories = new Set();
  currentFilteredData.forEach(item => {
    if(item['Category A']) {
      allCategories.add(item['Category A']);
    }
  });
  
  if(allCategories.size === 0) return; // ŸÑŸà ŸÖŸÅŸäÿ¥ ŸÉÿßÿ™Ÿäÿ¨Ÿàÿ±Ÿäÿ≤ÿå ŸÖÿßÿ™ÿπŸÖŸÑÿ¥ ÿ≠ÿßÿ¨ÿ©
  
  // üì¶ ÿßÿπŸÖŸÑ ÿßŸÑŸÄ Container
  const categoriesNav = document.createElement('div');
  categoriesNav.id = 'magazine-categories-nav';
  categoriesNav.className = 'magazine-categories-nav';
  categoriesNav.style.cssText = `
    display: flex; 
    justify-content: center; 
    align-items: center; 
    gap: 12px; 
    margin: 20px auto 15px auto; 
    padding: 18px 20px; 
    background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(249,250,251,0.95) 100%);
    border-radius: 30px; 
    box-shadow: 0 8px 30px rgba(0,0,0,0.12), inset 0 1px 0 rgba(255,255,255,0.8);
    max-width: 1100px; 
    flex-wrap: wrap; 
    border: 2px solid rgba(102,126,234,0.2);
    animation: slideDown 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  `;
  
  // üéØ ÿßÿπŸÖŸÑ Button ŸÑŸÉŸÑ Category
  Array.from(allCategories).sort().forEach((catName, index) => {
    const catBtn = document.createElement('button');
    catBtn.className = 'magazine-cat-btn';
    catBtn.innerHTML = `
      <span style="font-size: 18px; margin-right: 6px;">${getCategoryEmoji(catName)}</span>
      <strong>${catName}</strong>
    `;
    catBtn.dataset.cat = catName;
    
    // ÿßŸÑŸàÿßŸÜ ŸÖÿ™ŸÜŸàÿπÿ© ŸÑŸÉŸÑ button
    const colors = [
      'linear-gradient(135deg, #10b981 0%, #059669 100%)', // Green
      'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)', // Blue  
      'linear-gradient(135deg, #ec4899 0%, #db2777 100%)', // Pink
      'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)', // Orange
      'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)', // Purple
      'linear-gradient(135deg, #06b6d4 0%, #0891b2 100%)'  // Cyan
    ];
    
    catBtn.style.cssText = `
      padding: 12px 28px; 
      background: ${colors[index % colors.length]};
      color: white; 
      border: none; 
      border-radius: 22px; 
      font-weight: 800; 
      font-size: 13px;
      cursor: pointer; 
      transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55); 
      box-shadow: 0 4px 15px rgba(102,126,234,0.35);
      text-transform: uppercase; 
      letter-spacing: 1px;
      display: flex;
      align-items: center;
      gap: 6px;
    `;
    
    catBtn.addEventListener('click', (e) => {
      goToCategoryPage(catName, e.target);
    });
    
    categoriesNav.appendChild(catBtn);
  });
  
  // üéØ ÿ≠ÿ∑ ÿßŸÑŸÄ Nav Bar ŸÇÿ®ŸÑ ÿßŸÑŸÄ pagination
  const paginationWrapper = document.querySelector('.magazine-pagination-wrapper');
  if(paginationWrapper) {
    paginationWrapper.parentNode.insertBefore(categoriesNav, paginationWrapper);
  } else {
    // ŸÑŸà ÿßŸÑŸÄ pagination ŸÖÿ¥ ŸÖŸàÿ¨ŸàÿØÿ©ÿå ÿ≠ÿ∑Ÿáÿß ŸÅŸä ÿßŸÑŸÄ items container
    const itemsContainer = document.getElementById('itemsContainer');
    if(itemsContainer) {
      itemsContainer.insertBefore(categoriesNav, itemsContainer.firstChild);
    }
  }
}

// ====== üöÄ GO TO CATEGORY PAGE ======
function goToCategoryPage(catName, btnElement) {
  if(!magazineSettings || !magazineSettings.pages) {
    console.warn('‚ùå Magazine not ready yet');
    return;
  }
  
  // ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿ£ŸàŸÑ ÿµŸÅÿ≠ÿ© ŸÅŸäŸáÿß ÿßŸÑŸÄ category ÿØŸä
  let targetPage = 1;
  const pages = magazineSettings.pages;
  
  for(let pageNum = 0; pageNum < pages.length; pageNum++) {
    const pageBlocks = pages[pageNum];
    const hasCategory = pageBlocks.some(block => block.catA === catName);
    
    if(hasCategory) {
      targetPage = pageNum + 1; // ÿßŸÑÿµŸÅÿ≠ÿßÿ™ ÿ™ÿ®ÿØÿ£ ŸÖŸÜ 1
      break;
    }
  }
  
  // ÿ±Ÿàÿ≠ ŸÑŸÑÿµŸÅÿ≠ÿ©
  magazineSettings.currentPage = targetPage;
  renderMagazinePage(targetPage);
  updateMagazineNav();
  
  // ‚ú® Animate ÿßŸÑŸÄ button ÿßŸÑŸÑŸä ÿßÿ™ÿ∂ÿ∫ÿ∑
  document.querySelectorAll('.magazine-cat-btn').forEach(btn => {
    btn.style.transform = 'scale(1)';
    btn.style.boxShadow = '0 4px 15px rgba(102,126,234,0.35)';
  });
  
  if(btnElement) {
    btnElement.style.transform = 'scale(1.1)';
    btnElement.style.boxShadow = '0 8px 25px rgba(102,126,234,0.6)';
    
    // Pulse Effect
    setTimeout(() => {
      btnElement.style.transform = 'scale(1.05)';
    }, 200);
  }
  
  // Scroll ŸÑŸÑÿ£ÿπŸÑŸâ ÿ®ÿ≥ŸÑÿßÿ≥ÿ©
  window.scrollTo({ top: 0, behavior: 'smooth' });
  
  console.log(`üéØ Navigated to "${catName}" - Page ${targetPage}`);
}

// ====== üé® GET CATEGORY EMOJI ======
function getCategoryEmoji(catName) {
  const emojiMap = {
    'HEALTH & WELLNESS': 'üè•',
    'HEALTH WELLNESS': 'üè•',
    'HEALTH': 'üíä',
    'BABY CARE': 'üë∂',
    'BABY': 'üçº',
    'BEAUTY CARE': 'üíÑ',
    'BEAUTY': '‚ú®',
    'PERSONAL CARE': 'üß¥',
    'PERSONAL': 'üßº',
    'SKIN CARE': 'üßñ',
    'SKIN': 'üåü'
  };
  
  const normalized = catName.toUpperCase().trim();
  return emojiMap[normalized] || 'üè∑Ô∏è';
}


// ====== üé® CREATE MAGAZINE TOGGLE BUTTON ======
function createMagazineModeToggle() {
  const existingToggle = document.getElementById('magazineModeToggle');
  if(existingToggle) return;
  
  const toggle = document.createElement('button');
  toggle.id = 'magazineModeToggle';
  toggle.innerHTML = 'üì∞ MAGAZINE MODE: OFF';
  toggle.style.cssText = `
    position: relative;
    display: block;
    margin: 20px auto 15px auto;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 15px 35px;
    border-radius: 15px;
    border: none;
    color: white;
    font-weight: 700;
    font-size: 16px;
    cursor: pointer;
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 2px;
    width: fit-content;
    z-index: 100;
  `;
  
  toggle.addEventListener('mouseenter', function() {
    this.style.transform = 'translateY(-3px) scale(1.05)';
    this.style.boxShadow = '0 10px 30px rgba(102, 126, 234, 0.7)';
  });
  
  toggle.addEventListener('mouseleave', function() {
    this.style.transform = 'translateY(0) scale(1)';
    this.style.boxShadow = '0 8px 25px rgba(102, 126, 234, 0.5)';
  });
  
  toggle.onclick = toggleMagazineMode;
  
  const briefToggle = document.getElementById('briefModeToggle');
  if(briefToggle && briefToggle.parentElement) {
    briefToggle.parentElement.insertBefore(toggle, briefToggle);
  } else {
    const customBtn = document.querySelector('button[onclick*="openCustomPrintModal"]');
    if(customBtn && customBtn.parentElement) {
      customBtn.parentElement.insertBefore(toggle, customBtn.nextSibling);
    } else {
      document.body.appendChild(toggle);
    }
  }
  
  console.log('‚úÖ Magazine Mode Toggle Button created');
}

// ====== üé® AUTO COLOR GENERATOR FOR OFFER TYPES ======
const offerColorCache = new Map();

function generateOfferColor(offerType) {
  if (offerColorCache.has(offerType)) {
    return offerColorCache.get(offerType);
  }
  
  let hash = 0;
  for (let i = 0; i < offerType.length; i++) {
    hash = offerType.charCodeAt(i) + ((hash << 5) - hash);
    hash = hash & hash;
  }
  
  const hue1 = Math.abs(hash) % 360;
  const hue2 = (hue1 + 40 + (Math.abs(hash >> 8) % 80)) % 360;
  
  const saturation = 70 + (Math.abs(hash >> 16) % 20);
  const lightness1 = 45 + (Math.abs(hash >> 24) % 15);
  const lightness2 = lightness1 + 10;
  
  const color1 = `hsl(${hue1}, ${saturation}%, ${lightness1}%)`;
  const color2 = `hsl(${hue2}, ${saturation}%, ${lightness2}%)`;
  
  const gradient = `linear-gradient(135deg, ${color1} 0%, ${color2} 100%)`;
  
  const colorData = {
    gradient: gradient,
    color1: color1,
    color2: color2,
    shadow: `0 6px 20px hsla(${hue1}, ${saturation}%, 30%, 0.4)`
  };
  
  offerColorCache.set(offerType, colorData);
  return colorData;
}

// ====== üî¢ CONVERT TEXT NUMBERS TO DIGITS ======
function convertTextNumbersToDigits(text) {
  const replacements = {
    'ONE': '1',
    'TWO': '2',
    'THREE': '3',
    'FOUR': '4',
    'FIVE': '5',
    'SIX': '6',
    'SEVEN': '7',
    'EIGHT': '8',
    'NINE': '9',
    'TEN': '10'
  };
  
  let result = text;
  for (const [word, digit] of Object.entries(replacements)) {
    const regex = new RegExp(`\\b${word}\\b`, 'gi');
    result = result.replace(regex, digit);
  }
  
  return result;
}

// ====== üìù SHORTEN OFFER TYPE FOR OVERLAY ======
function shortenOfferType(offerType) {
  let shortened = convertTextNumbersToDigits(offerType);
  
  shortened = shortened.replace(/DISCOUNT/gi, 'OFF');
  shortened = shortened.replace(/DIRECT/gi, '');
  shortened = shortened.replace(/OFFER/gi, '');
  shortened = shortened.replace(/SPECIAL/gi, '');
  shortened = shortened.replace(/\s+/g, ' ').trim();
  
  if (shortened.length > 20) {
    shortened = shortened.substring(0, 20) + '...';
  }
  
  return shortened;
}

function getSelectedValues(filterName) {
  const customSelect = document.querySelector(`.custom-select[data-filter="${filterName}"]`);
  if(!customSelect) return null;
  const checkboxes = customSelect.querySelectorAll('input[type="checkbox"]:checked');
  const values = Array.from(checkboxes).map(cb => cb.value);
  return values.length > 0 ? values : null;
}

function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

// ====== üîç FUZZY SEARCH WITH AUTOCOMPLETE ======
let searchCache = null;
let suggestionsBox = null;
function initFuzzySearch() {
  const searchInput = document.getElementById('globalSearch');
  if (!searchInput) return;
  
  suggestionsBox = document.createElement('div');
  suggestionsBox.id = 'searchSuggestions';
  suggestionsBox.style.cssText = `
    position: absolute !important;
    background: var(--card-bg, #2a2a2a) !important;
    border: 2px solid var(--border-color, #444) !important;
    border-radius: 10px !important;
    max-height: 400px !important;
    overflow-y: auto !important;
    overflow-x: hidden !important;
    z-index: 10000 !important;
    box-shadow: 0 8px 24px rgba(0,0,0,0.4) !important;
    display: none !important;
    margin-top: 5px !important;
    width: fit-content !important;
    min-width: 450px !important;
    max-width: 750px !important;
  `;
  
  const searchContainer = searchInput.parentElement;
  searchContainer.style.position = 'relative';
  searchContainer.appendChild(suggestionsBox);
  
  buildSearchCache();
  
  searchInput.addEventListener('input', debounce(handleSearchInput, 200));
  
  searchInput.addEventListener('focus', () => {
    if (searchInput.value.trim().length > 0) {
      handleSearchInput();
    }
  });
  
  searchInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      hideSuggestions();
      applyFilters();
      console.log('üîç Search executed:', searchInput.value);
    }
    
    if (e.key === 'Escape') {
      hideSuggestions();
      searchInput.blur();
    }
  });
  
  document.addEventListener('click', (e) => {
    if (!searchContainer.contains(e.target)) {
      hideSuggestions();
    }
  });
  
  console.log('‚úÖ Fuzzy Search initialized - AUTO WIDTH üéØ');
}

function buildSearchCache() {
  if (typeof productsDB === 'undefined') return;
  
  searchCache = productsDB.filter(p => getOffer(p.Code) !== undefined).map(product => {
    const offer = getOffer(product.Code);
    return {
      code: product.Code.toString(),
      name: product["Item Description"].toLowerCase(),
      brand: (product.Brand || '').toLowerCase(),
      category: (product["Category Level D"] || '').toLowerCase(),
      offerType: offer ? offer.offerType : '',
      display: product["Item Description"],
      fullProduct: product
    };
  });
  
  console.log(`‚úÖ Search cache built: ${searchCache.length} products`);
}

function handleSearchInput() {
  const searchInput = document.getElementById('globalSearch');
  const query = searchInput.value.trim().toLowerCase();
  
  if (query.length === 0) {
    hideSuggestions();
    return;
  }
  
  const results = fuzzySearchProducts(query);
  
  if (results.length > 0) {
    showSuggestions(results.slice(0, 15), query);
  } else {
    showNoResults();
  }
}

function fuzzySearchProducts(query) {
  if (!searchCache) return [];
  
  const results = [];
  const queryLower = query.toLowerCase();
  
  searchCache.forEach(item => {
    let score = 0;
    let matchType = '';
    
    if (item.code.includes(queryLower)) {
      score = 100;
      matchType = 'code';
    }
    else if (item.name.includes(queryLower)) {
      score = 80;
      matchType = 'name';
    }
    else if (item.brand.includes(queryLower)) {
      score = 60;
      matchType = 'brand';
    }
    else if (item.category.includes(queryLower)) {
      score = 40;
      matchType = 'category';
    }
    else if (fuzzyMatch(item.name, queryLower) || fuzzyMatch(item.brand, queryLower)) {
      score = 20;
      matchType = 'fuzzy';
    }
    
    if (score > 0) {
      results.push({ ...item, score, matchType });
    }
  });
  
  return results.sort((a, b) => b.score - a.score);
}

function fuzzyMatch(text, query) {
  let queryIndex = 0;
  for (let i = 0; i < text.length && queryIndex < query.length; i++) {
    if (text[i] === query[queryIndex]) {
      queryIndex++;
    }
  }
  return queryIndex === query.length;
}
function showSuggestions(results, query) {
  if (!suggestionsBox) return;
  
  suggestionsBox.innerHTML = '';
  suggestionsBox.style.display = 'block';
  
  // Header
  const header = document.createElement('div');
  header.style.cssText = `
    padding: 6px 10px !important;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    color: white !important;
    font-weight: 600 !important;
    font-size: 10px !important;
    border-radius: 8px 8px 0 0 !important;
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    width: 100% !important;
    box-sizing: border-box !important;
  `;
  header.innerHTML = `
    <span>üí° ${results.length} ŸÜÿ™Ÿäÿ¨ÿ©</span>
    <span style="font-size: 8px; opacity: 0.8;">ÿßÿ∂ÿ∫ÿ∑ Enter ŸÑŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÉŸÑ</span>
  `;
  suggestionsBox.appendChild(header);
  
  // Items
  results.forEach((result, index) => {
    const item = document.createElement('div');
    item.className = 'suggestion-item';
    item.setAttribute('data-index', index);
    item.style.cssText = `
      padding: 7px 10px !important;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
      cursor: pointer !important;
      transition: all 0.2s ease !important;
      display: flex !important;
      flex-direction: column !important;
      width: 100% !important;
      min-height: 48px !important;
      opacity: 1 !important;
      visibility: visible !important;
      box-sizing: border-box !important;
      background: rgba(0, 0, 0, 0.05) !important;
      margin: 0 !important;
      flex-shrink: 0 !important;
      gap: 4px !important;
    `;
    
    // ÿßŸÑÿ≥ÿ∑ÿ± ÿßŸÑÿ£ŸàŸÑ - ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ™ÿ¨ ŸÅŸÇÿ∑
    const nameDiv = document.createElement('div');
    nameDiv.style.cssText = `
      font-size: 12px !important;
      font-weight: 700 !important;
      color: #1e3a8a !important;
      line-height: 1.3 !important;
      word-wrap: break-word !important;
      display: block !important;
      width: 100% !important;
    `;
    
    // ÿ®ŸÜÿßÿ° ÿßŸÑŸÄ text ŸÖÿπ ÿßŸÑŸÄ highlight
    const text = result.display || '';
    const lowerText = text.toLowerCase();
    const lowerQuery = (query || '').toLowerCase();
    const matchIndex = lowerText.indexOf(lowerQuery);
    
    if (matchIndex !== -1 && query) {
      const before = text.substring(0, matchIndex);
      const match = text.substring(matchIndex, matchIndex + query.length);
      const after = text.substring(matchIndex + query.length);
      
      if (before) {
        const beforeSpan = document.createElement('span');
        beforeSpan.textContent = before;
        beforeSpan.style.cssText = 'color: #1e3a8a !important;';
        nameDiv.appendChild(beforeSpan);
      }
      
      const matchSpan = document.createElement('mark');
      matchSpan.textContent = match;
      matchSpan.style.cssText = 'background: #fbbf24 !important; color: #1e3a8a !important; padding: 1px 2px !important; border-radius: 2px !important; font-weight: 800 !important;';
      nameDiv.appendChild(matchSpan);
      
      if (after) {
        const afterSpan = document.createElement('span');
        afterSpan.textContent = after;
        afterSpan.style.cssText = 'color: #1e3a8a !important;';
        nameDiv.appendChild(afterSpan);
      }
    } else {
      nameDiv.textContent = text;
    }
    
    // ÿßŸÑÿ≥ÿ∑ÿ± ÿßŸÑÿ´ÿßŸÜŸä - Brand + Code + Offer Badge
    const infoDiv = document.createElement('div');
    infoDiv.style.cssText = `
      display: flex !important;
      align-items: center !important;
      gap: 6px !important;
      flex-wrap: wrap !important;
      width: 100% !important;
    `;
    
    // Brand & Code
    const brandSpan = document.createElement('span');
    brandSpan.style.cssText = `
      font-size: 9px !important;
      color: #64748b !important;
      font-weight: 500 !important;
    `;
    brandSpan.textContent = `üè∑Ô∏è ${result.brand || 'N/A'} ‚Ä¢ üì¶ CODE: ${result.code || 'N/A'}`;
    
    // Offer Badge - inline
    const badgeSpan = document.createElement('span');
    badgeSpan.style.cssText = `
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
      padding: 3px 7px !important;
      border-radius: 4px !important;
      font-size: 9px !important;
      font-weight: 700 !important;
      color: white !important;
      white-space: nowrap !important;
      display: inline-block !important;
    `;
    badgeSpan.textContent = convertTextNumbersToDigits(result.offerType || '');
    
    infoDiv.appendChild(brandSpan);
    infoDiv.appendChild(badgeSpan);
    
    item.appendChild(nameDiv);
    item.appendChild(infoDiv);
    
    // Hover Effects
    item.addEventListener('mouseenter', () => {
      item.style.background = 'rgba(102, 126, 234, 0.15) !important';
      item.style.transform = 'translateX(3px)';
    });
    
    item.addEventListener('mouseleave', () => {
      item.style.background = 'rgba(0, 0, 0, 0.05) !important';
      item.style.transform = 'translateX(0)';
    });
    
    item.addEventListener('click', () => {
      selectSuggestion(result);
    });
    
    suggestionsBox.appendChild(item);
  });
  
  console.log(`‚úÖ ${results.length} suggestions - INLINE BADGE üéØüî•`);
}

// ‚úÖ Function ŸÖÿπÿØŸÑÿ© - Highlight Match
function highlightMatch(text, query) {
  if (!text) return '';
  if (!query) return `<span style="color: #ffffff !important; display: inline !important;">${text}</span>`;
  
  const index = text.toLowerCase().indexOf(query.toLowerCase());
  if (index === -1) {
    return `<span style="color: #ffffff !important; display: inline !important;">${text}</span>`;
  }
  
  const before = text.substring(0, index);
  const match = text.substring(index, index + query.length);
  const after = text.substring(index + query.length);
  
  return `<span style="color: #ffffff !important; display: inline !important;">${before}</span><span style="background: #ffd700 !important; color: #000 !important; padding: 2px 4px !important; border-radius: 3px !important; font-weight: 700 !important; display: inline !important;">${match}</span><span style="color: #ffffff !important; display: inline !important;">${after}</span>`;
}


// ‚úÖ Function ŸÖÿπÿØŸÑÿ© - Show No Results
function showNoResults() {
  if (!suggestionsBox) return;
  
  suggestionsBox.innerHTML = `
    <div style="padding: 30px !important; text-align: center !important; color: #aaaaaa !important; width: 100% !important; display: block !important;">
      <div style="font-size: 48px !important; margin-bottom: 10px !important;">üîç</div>
      <div style="font-size: 16px !important; font-weight: 600 !important; color: #ffffff !important;">No products found</div>
      <div style="font-size: 12px !important; margin-top: 5px !important; color: #aaaaaa !important;">Try a different search term</div>
    </div>
  `;
  suggestionsBox.style.display = 'block';
}

// ‚úÖ Function ŸÖÿπÿØŸÑÿ© - Hide Suggestions
function hideSuggestions() {
  if (suggestionsBox) {
    suggestionsBox.style.display = 'none';
    suggestionsBox.innerHTML = '';
  }
}

// ‚úÖ Function ŸÖÿπÿØŸÑÿ© - Select Suggestion
function selectSuggestion(result) {
  const searchInput = document.getElementById('globalSearch');
  if (searchInput) {
    searchInput.value = result.display;
  }
  hideSuggestions();
  applyFilters();
  console.log(`‚úÖ Selected: ${result.display} üéØ`);
}



// ====== ‚úÖ FILTER CONFIGS - WITH MANUFACTURE ADDED ======
const FILTER_CONFIGS = [
  { dataFilter: 'offerFilter', filterKey: 'offerType', extractor: (product) => { const offer = getOffer(product.Code); return offer ? offer.offerType : null; } },
  { dataFilter: 'brandFilter', filterKey: 'brand', extractor: (product) => product.Brand },
  { dataFilter: 'manufactureFilter', filterKey: 'manufacture', extractor: (product) => product.Manufacture },  // ‚úÖ NEW FILTER
  { dataFilter: 'categoryAFilter', filterKey: 'categoryA', extractor: (product) => product["Category Level A"] },
  { dataFilter: 'categoryBFilter', filterKey: 'categoryB', extractor: (product) => product["Category Level B"] },
  { dataFilter: 'itemClassFilter', filterKey: 'itemClass', extractor: (product) => product["Item Class"] },
  { dataFilter: 'categoryCFilter', filterKey: 'categoryC', extractor: (product) => product["Category Level C"] },
  { dataFilter: 'categoryDFilter', filterKey: 'categoryD', extractor: (product) => product["Category Level D"] }
];
function matchesFilters(product, filters) {
  const offer = getOffer(product.Code);
  if (!offer) return false;
  
  // ‚úÖ ŸÅŸÑÿ™ÿ± ÿ≠ÿ≥ÿ® ÿßŸÑÿ£ŸÉŸàÿßÿØ ÿßŸÑŸÖÿ±ŸÅŸàÿπÿ© (ŸÑŸà ŸÖŸàÿ¨ŸàÿØÿ©)
  if (uploadedCodesFilter && uploadedCodesFilter.length > 0) {
    const codeMatches = uploadedCodesFilter.includes(product.Code.toString());
    if (!codeMatches) return false; // ‚ùå ÿßŸÑŸÉŸàÿØ ŸÖÿ¥ ŸÅŸä ÿßŸÑŸÖŸÑŸÅ
  }
  
  // ÿ®ÿßŸÇŸä ÿßŸÑŸÅŸÑÿßÿ™ÿ± ÿßŸÑÿπÿßÿØŸäÿ©...
  if (filters.offerType && filters.offerType.length > 0) {
    if (!filters.offerType.includes(offer.offerType)) return false;
  }
  
  if (filters.brand && filters.brand.length > 0) {
    if (!filters.brand.includes(product.Brand)) return false;
  }
  
  if (filters.manufacture && filters.manufacture.length > 0) {
    if (!filters.manufacture.includes(product.Manufacture)) return false;
  }
  
  if (filters.categoryA && filters.categoryA.length > 0) {
    if (!filters.categoryA.includes(product["Category Level A"])) return false;
  }
  
  if (filters.itemClass && filters.itemClass.length > 0) {
    if (!filters.itemClass.includes(product["Item Class"])) return false;
  }
  
  if (filters.categoryB && filters.categoryB.length > 0) {
    if (!filters.categoryB.includes(product["Category Level B"])) return false;
  }
  
  if (filters.categoryC && filters.categoryC.length > 0) {
    if (!filters.categoryC.includes(product["Category Level C"])) return false;
  }
  
  if (filters.categoryD && filters.categoryD.length > 0) {
    if (!filters.categoryD.includes(product["Category Level D"])) return false;
  }
  
  if (filters.searchTerm) {
    const term = filters.searchTerm;
    const byCode = product.Code.toString().includes(term);
    const byName = product["Item Description"].toLowerCase().includes(term);
    const byBrand = product.Brand && product.Brand.toLowerCase().includes(term);
    if (!byCode && !byName && !byBrand) return false;
  }
  
  return true;
}

let filterUpdateTimeout;

function updateDynamicFilters(currentFilters = {}) {
  if (filterUpdateTimeout) clearTimeout(filterUpdateTimeout);
  const baseFilters = { ...currentFilters, searchTerm: null };
  let configIndex = 0;

  function processNextFilterConfig() {
    if (configIndex >= FILTER_CONFIGS.length) return;
    const cfg = FILTER_CONFIGS[configIndex];
    const customSelect = document.querySelector(`.custom-select[data-filter="${cfg.dataFilter}"]`);
    const listEl = customSelect ? customSelect.querySelector('.custom-options-list') : null;
    
    if (listEl) {
        const previouslySelected = getSelectedValues(cfg.dataFilter) || [];
        const filtersWithoutThis = { ...baseFilters, [cfg.filterKey]: null };
        const subset = productsDB.filter(p => matchesFilters(p, filtersWithoutThis));
        const values = [...new Set(subset.map(cfg.extractor).filter(Boolean))].sort();
        
        const parentContainer = customSelect ? customSelect.parentElement : null;
        
        if (values.length === 0) {
          if(parentContainer) {
            parentContainer.style.display = 'none';
          } else if(customSelect) {
            customSelect.style.display = 'none';
          }
        } else {
          if(parentContainer) {
            parentContainer.style.display = '';
          } else if(customSelect) {
            customSelect.style.display = '';
          }
        }
        
        const fragment = document.createDocumentFragment();
        values.forEach(value => {
            const optDiv = document.createElement('div');
            optDiv.className = 'custom-option';
            const isChecked = previouslySelected.includes(value);
            optDiv.innerHTML = `<input type="checkbox" value="${value}" ${isChecked ? 'checked' : ''}><span>${value}</span>`;
            fragment.appendChild(optDiv);
        });
        listEl.innerHTML = '';
        listEl.appendChild(fragment);
        activateExistingSearch(cfg.dataFilter);
    }
    configIndex++;
    filterUpdateTimeout = setTimeout(processNextFilterConfig, 0);
  }
  processNextFilterConfig();
}

function activateExistingSearch(filterName) {
  const customSelect = document.querySelector(`.custom-select[data-filter="${filterName}"]`);
  if (!customSelect) return;
  const searchInput = customSelect.querySelector('input[type="text"]') || 
                      customSelect.querySelector('.filter-search-input') ||
                      customSelect.querySelector('input[placeholder*="Search"]') ||
                      customSelect.querySelector('input[placeholder*="search"]');
  const optionsList = customSelect.querySelector('.custom-options-list');
  if (!searchInput || !optionsList) return;
  const newInput = searchInput.cloneNode(true);
  searchInput.parentNode.replaceChild(newInput, searchInput);
  newInput.addEventListener('click', e => e.stopPropagation());
  newInput.addEventListener('mousedown', e => e.stopPropagation());
newInput.addEventListener('input', function(e) {
  const searchTerm = e.target.value.toLowerCase().trim();
  const allOptions = optionsList.querySelectorAll('.custom-option');
  
  let visibleCount = 0;
  let hiddenCount = 0;
  
  allOptions.forEach(option => {
    const span = option.querySelector('span');
    if (span) {
      const text = span.textContent.toLowerCase();
      if (searchTerm === '' || text.includes(searchTerm)) {
        option.style.display = 'flex';  // ‚úÖ ÿ®ÿØŸÑ '' ÿßÿ≥ÿ™ÿÆÿØŸÖ 'flex'
        option.style.visibility = 'visible';  // ‚úÖ ÿ™ÿ£ŸÉÿØ ŸÖÿ¥ ŸÖÿÆŸÅŸä
        option.style.height = 'auto';  // ‚úÖ ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑŸÄ height
        visibleCount++;
      } else {
        option.style.display = 'none';  // ‚úÖ ÿßÿÆŸÅŸä
        hiddenCount++;
      }
    }
  });
  
  console.log(`üîç "${searchTerm}" ‚Üí Visible: ${visibleCount}, Hidden: ${hiddenCount}`);
});


  customSelect.addEventListener('filterClosed', () => {
    newInput.value = '';
    const allOptions = optionsList.querySelectorAll('.custom-option');
    allOptions.forEach(opt => opt.style.display = '');
  }, { once: false });
}

let renderingQueue = [];

// ====== üìã BRIEF MODE TOGGLE ======
let isBriefMode = false;

function toggleBriefMode() {
  isBriefMode = !isBriefMode;
  const btn = document.getElementById('briefModeToggle');
  if(btn) {
    if(isBriefMode) {
      btn.innerHTML = 'üìã BRIEF MODE: ON';
      btn.style.background = 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)';
    } else {
      btn.innerHTML = 'üìã BRIEF MODE: OFF';
      btn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
    }
  }
  
  applyFilters();
  console.log(`üìã Brief Mode: ${isBriefMode ? 'ON' : 'OFF'}`);
}

function createBriefModeToggle() {
  const existingToggle = document.getElementById('briefModeToggle');
  if(existingToggle) return;
  
  const toggle = document.createElement('button');
  toggle.id = 'briefModeToggle';
  toggle.innerHTML = 'üìã BRIEF MODE: OFF';
  toggle.style.cssText = `
    position: relative;
    display: block;
    margin: 20px auto 30px auto;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 15px 35px;
    border-radius: 15px;
    border: none;
    color: white;
    font-weight: 700;
    font-size: 16px;
    cursor: pointer;
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 2px;
    width: fit-content;
    z-index: 100;
  `;
  
  toggle.addEventListener('mouseenter', function() {
    this.style.transform = 'translateY(-3px) scale(1.05)';
    this.style.boxShadow = '0 10px 30px rgba(102, 126, 234, 0.7)';
  });
  
  toggle.addEventListener('mouseleave', function() {
    this.style.transform = 'translateY(0) scale(1)';
    this.style.boxShadow = '0 8px 25px rgba(102, 126, 234, 0.5)';
  });
  
  toggle.onclick = toggleBriefMode;
  
  const exclusiveBtn = document.querySelector('button[onclick*="printExclusiveOffers"]') ||
                       Array.from(document.querySelectorAll('button')).find(btn => 
                         btn.textContent.includes('Exclusive Offers')
                       );
  
  const customBtn = document.querySelector('button[onclick*="openCustomPrintModal"]') ||
                    Array.from(document.querySelectorAll('button')).find(btn => 
                      btn.textContent.includes('Custom Offer Print')
                    );
  
  if(customBtn && customBtn.parentElement) {
    customBtn.parentElement.insertBefore(toggle, customBtn.nextSibling);
  } else if(exclusiveBtn && exclusiveBtn.parentElement) {
    exclusiveBtn.parentElement.insertBefore(toggle, exclusiveBtn.nextSibling);
  } else {
    const countdownContainer = document.querySelector('.countdown-box') || 
                              document.querySelector('[class*="countdown"]');
    
    if(countdownContainer && countdownContainer.parentElement) {
      countdownContainer.parentElement.insertBefore(toggle, countdownContainer.nextSibling);
    } else {
      document.body.appendChild(toggle);
    }
  }
}
// ====== üíæ PRESERVE SELECTIONS ACROSS FILTERS ======
let selectedProductCodes = new Set();

function saveSelections() {
  selectedProductCodes.clear();
  document.querySelectorAll('.product-card-checkbox:checked').forEach(cb => {
    const code = cb.dataset.code;
    if (code) {
      selectedProductCodes.add(code);
    }
  });
  console.log('üíæ Saved:', selectedProductCodes.size, 'products');
}

function restoreSelections() {
  setTimeout(() => {
    let restored = 0;
    document.querySelectorAll('.product-card-checkbox').forEach(cb => {
      const code = cb.dataset.code;
      if (code && selectedProductCodes.has(code)) {
        cb.checked = true;
        restored++;
      }
    });
    updateSelectedCount();
    console.log('‚úÖ Restored:', restored, 'products');
  }, 100);
}
// ====== ‚úÖ PRINT SELECTION CONTROLS - AWAY FROM LOGO ======
function createPrintSelectionBar() {
  const existingBar = document.getElementById('printSelectionBar');
  if(existingBar) existingBar.remove();
  
  const bar = document.createElement('div');
  bar.id = 'printSelectionBar';
  bar.style.cssText = `
    position: fixed;
    bottom: 20px;
    right: 120px;
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.95) 0%, rgba(118, 75, 162, 0.95) 100%);
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    padding: 10px 15px;
    border-radius: 15px;
    z-index: 9999;
    display: inline-flex;
    gap: 12px;
    align-items: center;
    color: white;
    font-weight: 600;
    animation: slideInUp 0.5s ease;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3), 
                0 0 15px rgba(102, 126, 234, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.2);
  `;
  
  bar.innerHTML = `
    <style>
      @keyframes slideInUp {
        from { transform: translateY(100px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
      
      .product-card-checkbox {
        appearance: none;
        -webkit-appearance: none;
        width: 22px !important;
        height: 22px !important;
        border: 3px solid #667eea !important;
        border-radius: 6px !important;
        background: rgba(255,255,255,0.9) !important;
        cursor: pointer !important;
        position: relative !important;
        transition: all 0.3s ease !important;
        box-shadow: 0 3px 10px rgba(102, 126, 234, 0.4) !important;
      }
      
      .product-card-checkbox:hover {
        transform: scale(1.1) !important;
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.6) !important;
        border-color: #11998e !important;
      }
      
      .product-card-checkbox:checked {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%) !important;
        border-color: #11998e !important;
      }
      
      .product-card-checkbox:checked::after {
        content: '‚úì';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 16px;
        font-weight: bold;
      }
      
      .checkbox-container {
        position: absolute;
        top: 12px;
        right: 12px;
        z-index: 150;
        background: rgba(255,255,255,0.95);
        padding: 5px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        backdrop-filter: blur(10px);
      }
      
      #printSelectionBar button {
        padding: 8px 16px;
        border: none;
        color: white;
        font-weight: 700;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 14px;
      }
      
      #printSelectionBar button:hover {
        transform: translateY(-2px) scale(1.05);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
      }
    </style>
    <button onclick="selectAllCards()" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); box-shadow: 0 4px 15px rgba(17, 153, 142, 0.4);">
      ‚úÖ ÿßÿÆÿ™ÿ± ÿßŸÑŸÉŸÑ
    </button>
    <button onclick="deselectAllCards()" style="background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); box-shadow: 0 4px 15px rgba(235, 51, 73, 0.4);">
      ‚ùå ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑŸÉŸÑ
    </button>
    <div style="width: 1px; height: 30px; background: rgba(255,255,255,0.3); margin: 0 3px;"></div>
    <span id="selectedCount" style="font-size: 16px; font-weight: 800; color: white; text-shadow: 0 2px 6px rgba(0,0,0,0.6); padding: 0 5px;">0 ŸÖÿ≠ÿØÿØ</span>
  `;
  
  document.body.appendChild(bar);
}

function selectAllCards() {
  document.querySelectorAll('.product-card-checkbox').forEach(cb => {
    cb.checked = true;
    const code = cb.dataset.code;
    if (code) selectedProductCodes.add(code);
  });
  updateSelectedCount();
  console.log('‚úÖ All cards selected');
}

function deselectAllCards() {
  document.querySelectorAll('.product-card-checkbox').forEach(cb => {
    cb.checked = false;
    const code = cb.dataset.code;
    if (code) selectedProductCodes.delete(code);
  });
  updateSelectedCount();
  console.log('‚ùå All cards deselected');
}

function updateSelectedCount() {
  // ‚úÖ ÿßÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ≠ÿØŸäÿØ ÿßŸÑÿ≠ÿßŸÑŸä
  saveSelections();
  
  const count = selectedProductCodes.size;
  const countEl = document.getElementById('selectedCount');
  if(countEl) {
    countEl.textContent = `${count} ŸÖÿ≠ÿØÿØ`;
  }
}

// ====== ‚úÖ SELECT ALL FOR SPECIFIC OFFER ======
function selectAllInOffer(offerType, catA, catD) {
  const allCheckboxes = document.querySelectorAll('.product-card-checkbox');
  let selectedCount = 0;
  
  allCheckboxes.forEach(cb => {
    const card = cb.closest('.product-card');
    if (!card) return;
    
    const code = cb.dataset.code;
    const product = productsDB.find(p => p.Code.toString() === code);
    
    if (product) {
      const offer = getOffer(code);
      const matchesOffer = offer && offer.offerType === offerType;
      const matchesCatA = product['Category Level A'] === catA;
      const matchesCatD = product['Category Level D'] === catD;
      
      if (matchesOffer && matchesCatA && matchesCatD) {
        cb.checked = true;
        selectedProductCodes.add(code);
        selectedCount++;
      }
    }
  });
  
  updateSelectedCount();
  console.log(`‚úÖ Selected ${selectedCount} items in offer: ${offerType}`);
}

function deselectAllInOffer(offerType, catA, catD) {
  const allCheckboxes = document.querySelectorAll('.product-card-checkbox');
  let deselectedCount = 0;
  
  allCheckboxes.forEach(cb => {
    const card = cb.closest('.product-card');
    if (!card) return;
    
    const code = cb.dataset.code;
    const product = productsDB.find(p => p.Code.toString() === code);
    
    if (product) {
      const offer = getOffer(code);
      const matchesOffer = offer && offer.offerType === offerType;
      const matchesCatA = product['Category Level A'] === catA;
      const matchesCatD = product['Category Level D'] === catD;
      
      if (matchesOffer && matchesCatA && matchesCatD) {
        cb.checked = false;
        selectedProductCodes.delete(code);
        deselectedCount++;
      }
    }
  });
  
  updateSelectedCount();
  console.log(`‚ùå Deselected ${deselectedCount} items in offer: ${offerType}`);
}
// ====== üî• RENDERING PRODUCTS (30 ITEMS INITIAL + iPhone Safe) ======
function renderProducts(filters = {}) {
  // ‚úÖ ÿßÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿ≠ÿØŸäÿØ ŸÇÿ®ŸÑ ÿßŸÑŸÄ re-render
  saveSelections();
  
  const container = document.getElementById("productsContainer");
  const loader = document.getElementById("loadingIndicator");
  if(loader) loader.style.display = "block";
  
  if(filters.searchTerm) filters.searchTerm = filters.searchTerm.toLowerCase();
  
  // üî• GET FILTERED PRODUCTS
  let filteredProducts = productsDB.filter(product => {
    // ‚úÖ ÿ£ŸàŸÑ ÿ≠ÿßÿ¨ÿ©: ÿ¥ŸäŸÉ ÿπŸÑŸâ matchesFilters
    if (!matchesFilters(product, filters)) {
      return false;
    }
    
    // ‚úÖ ÿ™ÿßŸÜŸä ÿ≠ÿßÿ¨ÿ©: ÿ¥ŸäŸÉ ÿπŸÑŸâ uploadedCodesFilter
    if (uploadedCodesFilter && uploadedCodesFilter.length > 0) {
      const productCode = String(product.Code).trim();
      if (!uploadedCodesFilter.includes(productCode)) {
        return false;
      }
    }
    
    return true;
  });
  
  filteredProducts.sort((a, b) => a["Item Description"].localeCompare(b["Item Description"]));
  
  // üî• INITIAL LOAD CHECK (NO FILTERS = FIRST OPEN)
  // ‚úÖ ÿ•ÿ∂ÿßŸÅÿ© ÿ¥ŸäŸÉ ÿπŸÑŸâ uploadedCodesFilter
  const hasUploadedCodesFilter = uploadedCodesFilter && uploadedCodesFilter.length > 0;
  
  const isInitialLoad = !filters.searchTerm && 
                       !filters.offerType?.length && 
                       !filters.brand?.length && 
                       !filters.manufacture?.length && 
                       !filters.categoryA?.length && 
                       !filters.categoryB?.length && 
                       !filters.itemClass?.length && 
                       !filters.categoryC?.length && 
                       !filters.categoryD?.length &&
                       !hasUploadedCodesFilter; // ‚úÖ ÿßŸÑÿ¥ŸäŸÉ ÿßŸÑÿ¨ÿØŸäÿØ

  console.log(`üìä ${isInitialLoad ? 'üöÄ INITIAL' : '‚úÖ FILTERED'}: ${filteredProducts.length} products`);
  console.log(`   Uploaded codes filter: ${hasUploadedCodesFilter ? uploadedCodesFilter.length : 'none'}`);

  updateDynamicFilters(filters);
  
  if (filteredProducts.length === 0) {
    container.innerHTML = '<div style="padding:40px; text-align:center; color:#999;">No products found</div>';
    if(loader) loader.style.display = "none";
    return;
  }

  // ‚úÖ CHECK MAGAZINE / BRIEF MODES FIRST
  if(isMagazineMode) {
    renderMagazineMode(filteredProducts);
    window.currentFilteredProducts = filteredProducts;
    restoreSelections();
    if(loader) loader.style.display = "none";
    return;
  }

  if(isBriefMode) {
    renderBriefMode(filteredProducts);
    window.currentFilteredProducts = filteredProducts;
    createPrintSelectionBar();
    restoreSelections();
    if(loader) loader.style.display = "none";
    return;
  }
  
  // üî• ÿ≠ŸÅÿ∏ ÿßŸÑÿπÿØÿØ ÿßŸÑŸÉŸÑŸä ŸÇÿ®ŸÑ ÿßŸÑÿ™ÿ≠ÿØŸäÿØ
  window.fullProductsCount = filteredProducts.length;
  
  // üî• INITIAL LOAD: LIMIT TO 30 + Load All Button
  let showLoadAllButton = false;
  
  if (isInitialLoad && filteredProducts.length > 30) {
    showLoadAllButton = true;
    filteredProducts = filteredProducts.slice(0, 30); // 30 ÿ®ÿ≥!
    console.log(`üöÄ Initial load: limiting to 30 of ${window.fullProductsCount} products`);
  }
  
  // üî• NORMAL RENDER (ŸÖÿπ ÿßŸÑŸÄ limited products ŸÑŸà initial)
  container.innerHTML = ""; 
  renderingQueue = []; 
  
  const groupStructure = {};
  filteredProducts.forEach(product => {  // ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑŸÄ filteredProducts ÿßŸÑŸÖÿ≠ÿØŸàÿØ
    const catA = product["Category Level A"] || "Uncategorized";
    const catD = product["Category Level D"] || "Other";
    const offer = getOffer(product.Code);
    const offerType = offer ? offer.offerType : "Unknown";
    
    if (!groupStructure[catA]) groupStructure[catA] = {};
    if (!groupStructure[catA][catD]) groupStructure[catA][catD] = {};
    if (!groupStructure[catA][catD][offerType]) groupStructure[catA][catD][offerType] = [];
    
    groupStructure[catA][catD][offerType].push(product);
  });
  
  const sortedCatAs = Object.keys(groupStructure).sort((a, b) => {
    if (a === "HEALTH & WELLNESS") return -1;
    if (b === "HEALTH & WELLNESS") return 1;
    return a.localeCompare(b);
  });
  
  sortedCatAs.forEach(catA => {
      renderingQueue.push({ type: 'HEADER_A', title: catA });
      
      const catDs = groupStructure[catA];
      Object.keys(catDs).sort().forEach(catD => {
          renderingQueue.push({ 
              type: 'HEADER_D', 
              catA: catA, 
              catD: catD
          });
          
          const offerTypes = catDs[catD];
          Object.keys(offerTypes).sort().forEach(offerType => {
              renderingQueue.push({ 
                  type: 'BLOCK_OFFER', 
                  catA: catA, 
                  catD: catD,
                  offerType: offerType,
                  products: offerTypes[offerType]
              });
          });
      });
  });
  
  processRenderQueue();
  
  // üî• LOAD ALL BUTTON (ÿ®ÿπÿØ ÿßŸÑŸÄ render ÿπÿ¥ÿßŸÜ Ÿäÿ™ÿ≠ÿ∑ ŸÅŸä ÿßŸÑÿ¢ÿÆÿ±)
  if (showLoadAllButton) {
    const loadAllBtnContainer = document.createElement('div');
    loadAllBtnContainer.style.cssText = `
      grid-column: 1 / -1;
      display: flex;
      justify-content: center;
      margin: 30px 0;
    `;
    
    const loadAllBtn = document.createElement('button');
    loadAllBtn.id = 'loadAllBtn';
    loadAllBtn.innerHTML = `üî• Load All Products (${window.fullProductsCount} items)`;
    loadAllBtn.style.cssText = `
      display: block;
      padding: 16px 48px;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border: none;
      border-radius: 15px;
      font-weight: 700;
      font-size: 18px;
      cursor: pointer;
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
    `;
    
    loadAllBtn.onmouseover = () => {
      loadAllBtn.style.transform = 'translateY(-3px)';
      loadAllBtn.style.boxShadow = '0 12px 35px rgba(16, 185, 129, 0.6)';
    };
    
    loadAllBtn.onmouseout = () => {
      loadAllBtn.style.transform = 'translateY(0)';
      loadAllBtn.style.boxShadow = '0 8px 25px rgba(16, 185, 129, 0.4)';
    };
    
    loadAllBtn.onclick = () => {
      console.log('üî• Loading all products...');
      loadAllBtnContainer.remove();
      renderProducts(filters); // ÿ•ÿπÿßÿØÿ© ÿßŸÑŸÄ render ÿ®ÿØŸàŸÜ limit
    };
    
    loadAllBtnContainer.appendChild(loadAllBtn);
    container.appendChild(loadAllBtnContainer);
  }
  
  window.currentFilteredProducts = filteredProducts;
  createPrintSelectionBar();
  restoreSelections();
  
  if(loader) loader.style.display = "none";
  
  console.log(`‚úÖ Rendered ${filteredProducts.length} products`);
}

// ====== üìã BRIEF MODE RENDERING - BY OFFER TYPE FIRST ======
function renderBriefMode(filteredProducts) {
  const container = document.getElementById("productsContainer");
  const loader = document.getElementById("loadingIndicator");
  
  console.log(`üìã Rendering BRIEF MODE: ${filteredProducts.length} products`);
  
  const groupStructure = {};
  
  filteredProducts.forEach(product => {
    const offer = getOffer(product.Code);
    const offerType = offer ? offer.offerType : "Unknown";
    const catA = product["Category Level A"] || "Uncategorized";
    const catD = product["Category Level D"] || "Other";
    const brand = product.Brand || "Unknown";
    
    if (!groupStructure[offerType]) groupStructure[offerType] = {};
    if (!groupStructure[offerType][catA]) groupStructure[offerType][catA] = {};
    if (!groupStructure[offerType][catA][catD]) groupStructure[offerType][catA][catD] = {};
    if (!groupStructure[offerType][catA][catD][brand]) {
      groupStructure[offerType][catA][catD][brand] = [];
    }
    
    groupStructure[offerType][catA][catD][brand].push(product);
  });
  
  const sortedOfferTypes = Object.keys(groupStructure).sort();
  
  const fragment = document.createDocumentFragment();
  
  sortedOfferTypes.forEach(offerType => {
      const colorData = generateOfferColor(offerType);
      const displayOfferType = convertTextNumbersToDigits(offerType);
      const offerTypeWithoutWord = displayOfferType.replace(/\bOFFER\b/gi, '').trim();

      const offerHeader = document.createElement('div');
      offerHeader.style.cssText = `
        background: ${colorData.gradient};
        padding: 25px;
        margin: 25px 10px 15px 10px;
        border-radius: 15px;
        box-shadow: ${colorData.shadow};
        display: flex;
        align-items: center;
        justify-content: center;
        border: 3px solid rgba(255, 255, 255, 0.3);
        backdrop-filter: blur(10px);
      `;
      offerHeader.innerHTML = `
        <div style="
          color: white;
          font-size: 32px;
          font-weight: 900;
          text-transform: uppercase;
          letter-spacing: 3px;
          text-shadow: 0 3px 15px rgba(0,0,0,0.4);
          text-align: center;
        ">
          üéØ ${displayOfferType}
        </div>
      `;
      fragment.appendChild(offerHeader);
      
      const catAs = groupStructure[offerType];
      
      const sortedCatAs = Object.keys(catAs).sort((a, b) => {
        if (a === "HEALTH & WELLNESS") return -1;
        if (b === "HEALTH & WELLNESS") return 1;
        return a.localeCompare(b);
      });
      
      sortedCatAs.forEach(catA => {
          const headerA = document.createElement('div');
          headerA.className = "category-a-header";
          headerA.innerHTML = `<h2>üì¶ ${catA}</h2>`;
          fragment.appendChild(headerA);
          
          const catDs = catAs[catA];
          Object.keys(catDs).sort().forEach(catD => {
              const headerD = document.createElement('div');
              headerD.className = "category-b-header";
              headerD.style.cssText = `
                background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
                padding: 15px 20px;
                margin: 20px 10px 10px 10px;
                border-radius: 12px;
                border-left: 5px solid #3498db;
                box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
              `;
              headerD.innerHTML = `<h3 style="margin: 0; color: white; font-size: 20px; font-weight: 600;">üîπ ${catD}</h3>`;
              fragment.appendChild(headerD);
              
              const offerSection = document.createElement('div');
              offerSection.style.padding = "0 10px 20px 10px";
              
              const grid = document.createElement('div');
              grid.className = "products-grid";
              
              const brands = catDs[catD];
              Object.keys(brands).sort().forEach(brandName => {
                  const brandProducts = brands[brandName];
                  const firstProduct = brandProducts[0];
                  const productsCount = brandProducts.length;
                  
                  const brandCard = document.createElement("div");
                  brandCard.className = "product-card brand-card";
                  brandCard.dataset.brand = brandName;
                  brandCard.style.position = "relative";
                  
                  const brandColor = stringToColor(brandName);
                  const shortOfferType = shortenOfferType(offerType);
                  
                  brandCard.innerHTML = `
                    <div style="position: relative; width: 100%; height: 180px; background: linear-gradient(90deg, #f0f0f0 0%, #e0e0e0 50%, #f0f0f0 100%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 8px 8px 0 0; overflow: hidden; margin-bottom: 10px;">
                      <img 
                        data-code="${firstProduct.Code}" 
                        class="product-image lazy-image" 
                        style="width: 100%; height: 100%; object-fit: contain; transition: opacity 0.3s ease; opacity: 0;" 
                        alt="${brandName}"
                      />
                      
                      <div style="
                        position: absolute;
                        top: 8px;
                        left: 8px;
                        background: linear-gradient(135deg, rgba(220, 20, 60, 0.95), rgba(178, 34, 34, 0.95));
                        color: white;
                        padding: 6px 12px;
                        border-radius: 6px;
                        font-size: 11px;
                        font-weight: 800;
                        text-transform: uppercase;
                        box-shadow: 0 4px 12px rgba(220, 20, 60, 0.6);
                        letter-spacing: 0.5px;
                        border: 2px solid rgba(255, 255, 255, 0.3);
                        backdrop-filter: blur(5px);
                      ">
                        ${shortOfferType}
                      </div>
                      
                      <div style="
                        position: absolute;
                        bottom: 8px;
                        right: 8px;
                        background: linear-gradient(135deg, rgba(52, 152, 219, 0.95), rgba(41, 128, 185, 0.95));
                        color: white;
                        padding: 6px 12px;
                        border-radius: 20px;
                        font-size: 12px;
                        font-weight: 700;
                        box-shadow: 0 3px 10px rgba(52, 152, 219, 0.5);
                        border: 2px solid rgba(255,255,255,0.3);
                      ">
                        ${productsCount} Products
                      </div>
                    </div>
                    
                    <div style="
                      background: ${brandColor};
                      padding: 15px;
                      text-align: center;
                      color: white;
                      font-size: 20px;
                      font-weight: 800;
                      text-transform: uppercase;
                      letter-spacing: 1px;
                      border-radius: 0 0 8px 8px;
                      box-shadow: 0 4px 15px ${brandColor}66;
                      margin-top: -5px;
                    ">
                      ${brandName}
                    </div>
                    
                    <div style="
                      padding: 10px;
                      background: rgba(0,0,0,0.05);
                      text-align: center;
                      font-size: 11px;
                      color: #666;
                      font-weight: 600;
                    ">
                      üìä ${productsCount} item${productsCount > 1 ? 's' : ''} in this offer
                    </div>
                  `;
                  
                  grid.appendChild(brandCard);
                  
                  const img = brandCard.querySelector('.lazy-image');
                  if (img) {
                      imageObserver.observe(img);
                  }
              });
              
              offerSection.appendChild(grid);
              fragment.appendChild(offerSection);
          });
      });
  });
  
  container.appendChild(fragment);
  if(loader) loader.style.display = "none";
  console.log('‚úÖ Brief Mode rendering complete');
}
// ==========================================
// 1Ô∏è‚É£ ÿØÿßŸÑÿ© ÿßŸÑÿ±ŸäŸÜÿØÿ± ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ© (ÿ™ÿ¨ŸÖŸäÿπ ÿ®ÿ±ÿßŸÜÿØÿßÿ™ + ÿ≠ÿ≥ÿßÿ® ÿ£ÿ≥ÿπÿßÿ± ÿØŸÇŸäŸÇ + ÿ±ŸÖÿ≤ ÿßŸÑÿ±ŸäÿßŸÑ)
// ==========================================
function processRenderQueue() {
    const container = document.getElementById("productsContainer");
    const loader = document.getElementById("loadingIndicator");
    
    // ÿ±ÿßÿ®ÿ∑ ÿ±ŸÖÿ≤ ÿßŸÑÿ±ŸäÿßŸÑ ÿßŸÑÿ≥ÿπŸàÿØŸä (ŸÜŸÅÿ≥ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÅŸä ÿßŸÑÿ∑ÿ®ÿßÿπÿ©)
    const RIYAL_SVG_URL = "https://www.sama.gov.sa/ar-sa/Currency/Documents/Saudi_Riyal_Symbol-2.svg";

    // ÿπÿØÿØ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÅŸä ÿßŸÑÿµŸÅ ÿßŸÑŸàÿßÿ≠ÿØ
    const ITEMS_PER_ROW = 4;

    if (renderingQueue.length === 0) {
        if(loader) loader.style.display = "none";
        console.log('‚úÖ All products rendered');
        initSmartImageLoader(); 
        return;
    }
    
    const CHUNK_SIZE = 3;
    let processed = 0;
    
    while (processed < CHUNK_SIZE && renderingQueue.length > 0) {
        const item = renderingQueue.shift();
        
        // --- 1. ÿßŸÑÿπŸÜÿßŸàŸäŸÜ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ© ---
        if (item.type === 'HEADER_A') {
            const headerA = document.createElement('div');
            headerA.className = "category-a-header";
            headerA.innerHTML = `<h2>üì¶ ${item.title}</h2>`;
            container.appendChild(headerA);
        } 
        else if (item.type === 'HEADER_D') {
            const headerD = document.createElement('div');
            headerD.className = "category-b-header";
            headerD.style.cssText = `
              background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
              padding: 15px 20px;
              margin: 20px 10px 10px 10px;
              border-radius: 12px;
              border-left: 5px solid #3498db;
              box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
            `;
            headerD.innerHTML = `<h3 style="margin: 0; color: white; font-size: 20px; font-weight: 600;">üîπ ${item.catD}</h3>`;
            container.appendChild(headerD);
        }
        else if (item.type === 'BLOCK_OFFER') {
            // --- 2. ÿ®ŸÑŸàŸÉ ÿßŸÑÿπÿ±ÿ∂ ---
            const offerSection = document.createElement('div');
            offerSection.style.padding = "0 10px 20px 10px";
            
            const groupContainer = document.createElement('div');
            groupContainer.className = "offer-group-container";
            
            const colorData = generateOfferColor(item.offerType);
            
            // ŸáŸäÿØÿ± ŸÜŸàÿπ ÿßŸÑÿπÿ±ÿ∂
            const groupHeader = document.createElement('div');
            groupHeader.className = "offer-group-header";
            groupHeader.style.cssText = `
              background: ${colorData.gradient};
              padding: 20px;
              margin: 15px 0;
              border-radius: 15px;
              box-shadow: ${colorData.shadow};
              display: flex;
              align-items: center;
              justify-content: center;
              border: 2px solid rgba(255, 255, 255, 0.2);
              backdrop-filter: blur(10px);
            `;
            const displayOfferType = convertTextNumbersToDigits(item.offerType);
            groupHeader.innerHTML = `
              <div style="color: white; font-size: 24px; font-weight: 800; text-transform: uppercase; letter-spacing: 2px; text-shadow: 0 2px 10px rgba(0,0,0,0.3); text-align: center;">
                ${displayOfferType}
              </div>
            `;
            groupContainer.appendChild(groupHeader);

            // üî•üî•üî• ÿßŸÑŸÖŸÜÿ∑ŸÇ ÿßŸÑÿ¨ÿØŸäÿØ: ÿ™ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ÿ±ÿßŸÜÿØÿßÿ™ ŸÅŸä ŸÖÿ¨ŸÖŸàÿπÿßÿ™ (Clusters) üî•üî•üî•
            
            // ÿ£) ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ≠ÿ≥ÿ® ÿßÿ≥ŸÖ ÿßŸÑÿ®ÿ±ÿßŸÜÿØ
            const sortedProducts = [...item.products].sort((a, b) => 
                (a.Brand || '').localeCompare(b.Brand || '')
            );

            // ÿ®) ÿ™ŸÇÿ≥ŸäŸÖ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÑÿµŸÅŸàŸÅ
            for (let i = 0; i < sortedProducts.length; i += ITEMS_PER_ROW) {
                const rowProducts = sortedProducts.slice(i, i + ITEMS_PER_ROW);
                
                // ÿ¨) ÿ≠ÿßŸàŸäÿ© ÿßŸÑÿµŸÅ
                const rowWrapper = document.createElement('div');
                rowWrapper.style.cssText = `
                    display: flex;
                    width: 100%;
                    gap: 12px;
                    margin-bottom: 15px;
                `;

                // ÿØ) ÿ™ÿ¨ŸÖŸäÿπ ŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑÿµŸÅ ÿ≠ÿ≥ÿ® ÿßŸÑÿ®ÿ±ÿßŸÜÿØ
                const rowBrands = {};
                rowProducts.forEach(p => {
                    const b = p.Brand || 'Other';
                    if(!rowBrands[b]) rowBrands[b] = [];
                    rowBrands[b].push(p);
                });

                // ŸáŸÄ) ÿ±ÿ≥ŸÖ ŸÖÿ¨ŸÖŸàÿπÿßÿ™ ÿßŸÑÿ®ÿ±ÿßŸÜÿØÿßÿ™
                Object.keys(rowBrands).forEach(brandName => {
                    const productsInThisCluster = rowBrands[brandName];
                    const count = productsInThisCluster.length;
                    
                    // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿπÿ±ÿ∂ (Width)
                    const widthPercent = (count / ITEMS_PER_ROW) * 100;
                    const brandColor = stringToColor(brandName);

                    // ÿ≠ÿßŸàŸäÿ© ÿßŸÑŸÖÿ¨ŸÖŸàÿπÿ©
                    const brandCluster = document.createElement('div');
                    brandCluster.style.cssText = `
                        width: ${widthPercent}%;
                        display: flex;
                        flex-direction: column;
                        background: #f8fafc;
                        border-radius: 12px;
                        overflow: hidden;
                        border: 1px solid #e2e8f0;
                        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                    `;

                    // 1. ŸáŸäÿØÿ± ÿßŸÑÿ®ÿ±ÿßŸÜÿØ (ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸÑŸÑŸÖÿ¨ŸÖŸàÿπÿ©)
                    const clusterHeader = document.createElement('div');
                    clusterHeader.style.cssText = `
                        background: ${brandColor};
                        color: white;
                        padding: 8px;
                        font-size: 13px;
                        font-weight: 800;
                        text-align: center;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        white-space: nowrap;
                        overflow: hidden;
                        text-overflow: ellipsis;
                        border-bottom: 2px solid rgba(0,0,0,0.1);
                    `;
                    clusterHeader.innerHTML = `${brandName}`;
                    brandCluster.appendChild(clusterHeader);

                    // 2. ÿ¥ÿ®ŸÉÿ© ÿßŸÑŸÉÿ±Ÿàÿ™ ÿØÿßÿÆŸÑ ÿßŸÑŸÖÿ¨ŸÖŸàÿπÿ©
                    const clusterGrid = document.createElement('div');
                    clusterGrid.style.cssText = `
                        display: grid;
                        grid-template-columns: repeat(${count}, 1fr);
                        gap: 8px;
                        padding: 8px;
                        flex: 1;
                    `;

                    // 3. ÿ±ÿ≥ŸÖ ÿßŸÑŸÉÿ±Ÿàÿ™
                    productsInThisCluster.forEach(product => {
                        const offer = getOffer(product.Code);
                        const original = parseFloat(product["Unit Price"] || product.Price || 0);
                        
                        // üî• ŸÖŸÜÿ∑ŸÇ ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ≥ÿπÿ± ÿßŸÑÿØŸÇŸäŸÇ (ŸÖŸÜ ÿßŸÑŸÉŸàÿØ ÿßŸÑŸÇÿØŸäŸÖ)
                        let isDirectDiscount = offer.offerType.toLowerCase().includes("direct discount") || 
                                               offer.offerType.toLowerCase().includes("direct off") ||
                                               /\d+%/.test(offer.offerType);
                        let finalPrice = original;
                        let showStrikethrough = false;
                        
                        if (isDirectDiscount) {
                            // 1. ŸÑŸà ÿßŸÑÿ≥ÿπÿ± ŸÖŸàÿ¨ŸàÿØ ŸÅŸä ÿßŸÑÿØÿßÿ™ÿß
                            if (offer.offerPrice && typeof offer.offerPrice[product.Code] === "number") {
                                finalPrice = offer.offerPrice[product.Code];
                                showStrikethrough = true;
                            } 
                            // 2. ŸÑŸà ŸÖÿ¥ ŸÖŸàÿ¨ŸàÿØÿå ŸÜÿ≠ÿ≥ÿ®Ÿá ŸÖŸÜ ÿßŸÑŸÜÿ≥ÿ®ÿ©
                            else {
                                const match = offer.offerType.match(/(\d+)%/);
                                if (match) {
                                    const percent = parseInt(match[1]);
                                    finalPrice = original * (1 - percent / 100);
                                    showStrikethrough = true;
                                }
                            }
                        }

                        const productLink = `https://www.al-dawaa.com/en/p/${product.Code}`;
                        const displayOfferType = convertTextNumbersToDigits(offer.offerType); 
                        const shortOfferType = shortenOfferType(offer.offerType);

                        const cardHTML = `
                          <div class="product-card" style="
                              position: relative; 
                              border: 1px solid #f1f5f9; 
                              background: white; 
                              border-radius: 8px; 
                              overflow: hidden; 
                              display: flex; 
                              flex-direction: column;
                              height: 100%;
                              transition: transform 0.2s;
                          " onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'"
                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                            
                            <div class="checkbox-container" style="z-index: 20;">
                                <input type="checkbox" class="product-card-checkbox" data-code="${product.Code}" onchange="updateSelectedCount()" />
                            </div>

                            <div style="position: relative; width: 100%; padding-top: 100%; background: #ffffff;">
                                <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; padding: 15px;">
                                    <img 
                                      data-code="${product.Code}" 
                                      data-brand="${product.Brand || 'Generic'}" 
                                      class="product-image smart-lazy-img" 
                                      style="max-width: 100%; max-height: 100%; object-fit: contain; opacity: 0; transition: opacity 0.5s;" 
                                      alt="${product["Item Description"]}"
                                    />
                                </div>
                                <div style="
                                  position: absolute; top: 8px; left: 8px; 
                                  background: linear-gradient(135deg, #dc2626, #b91c1c); 
                                  color: white; 
                                  font-size: 9px; font-weight: 800; 
                                  padding: 3px 8px; border-radius: 6px;
                                  box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                                  z-index: 10;
                                  border: 1px solid rgba(255,255,255,0.3);
                                ">
                                  ${shortOfferType}
                                </div>
                            </div>

                            <div style="padding: 10px; display: flex; flex-direction: column; flex: 1;">
                                <div style="font-size: 9px; color: #94a3b8; font-family: monospace;">${product.Code}</div>
                                
                                <div style="font-size: 12px; font-weight: 700; color: #1e293b; margin: 5px 0; line-height: 1.4; flex: 1;">
                                    ${product["Item Description"]}
                                </div>
                                
                                <div style="font-size: 11px; font-weight: 900; color: #6d28d9; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">
                                    ${displayOfferType}
                                </div>

                                <div style="margin-top: auto;">
                                    <div class="product-price ${showStrikethrough ? '' : 'no-discount'}" style="display:flex; align-items:baseline; flex-wrap:wrap; gap:6px;">
                                        ${showStrikethrough ? `
                                            <span style="text-decoration: line-through; color: #cbd5e1; font-size: 11px;">
                                                ${original.toFixed(2)}
                                            </span>
                                        ` : ''}
                                        <span style="color: ${showStrikethrough ? '#dc2626' : '#334155'}; font-size: 16px; font-weight: 800; display: inline-flex; align-items: center; gap: 3px;">
                                            ${finalPrice.toFixed(2)} 
                                            <img src="${RIYAL_SVG_URL}" style="width: 12px; height: 12px; vertical-align: middle;" alt="SAR"/>
                                        </span>
                                    </div>
                                    
                                    <a href="${productLink}" target="_blank" style="
                                        display: block; width: 100%; text-align: center;
                                        background: linear-gradient(135deg, #10b981, #059669);
                                        color: white; font-weight: 700; font-size: 12px;
                                        padding: 8px; border-radius: 6px; margin-top: 10px;
                                        text-decoration: none; border: none;
                                        box-shadow: 0 2px 5px rgba(16, 185, 129, 0.3);
                                        transition: all 0.2s;
                                    " onmouseover="this.style.transform='translateY(-1px)'" onmouseout="this.style.transform='translateY(0)'">
                                        üåê Online Offer
                                    </a>
                                </div>
                            </div>
                          </div>
                        `;
                        
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = cardHTML.trim();
                        clusterGrid.appendChild(tempDiv.firstChild);
                    });

                    brandCluster.appendChild(clusterGrid);
                    rowWrapper.appendChild(brandCluster);
                });

                groupContainer.appendChild(rowWrapper);
            }
            
            offerSection.appendChild(groupContainer);
            container.appendChild(offerSection);
        }
        processed++;
    }
    
    if (renderingQueue.length > 0) {
        setTimeout(processRenderQueue, 0);
    } else {
        if(loader) loader.style.display = "none";
        initSmartImageLoader();
        console.log('‚úÖ Rendering complete');
    }
}

// ==========================================
// 2Ô∏è‚É£ ÿØÿßŸÑÿ© ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ∞ŸÉŸä (Smart Loader)
// ==========================================
function initSmartImageLoader() {
  const observer = new IntersectionObserver((entries, obs) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const img = entry.target;
        const code = img.dataset.code;
        const brand = img.dataset.brand;
        
        fetchProductImage(code).then(imageUrl => {
          if (imageUrl) {
            img.src = imageUrl;
            img.onload = () => { img.style.opacity = '1'; };
            img.onerror = () => { tryLoadBrandLogoSmart(brand, img); };
          } else {
            tryLoadBrandLogoSmart(brand, img);
          }
        }).catch(() => {
          tryLoadBrandLogoSmart(brand, img);
        });
        
        obs.unobserve(img);
      }
    });
  }, { rootMargin: '300px' }); 

  document.querySelectorAll('img.smart-lazy-img').forEach(img => observer.observe(img));
}

// ==========================================
// 3Ô∏è‚É£ ÿØÿßŸÑÿ© ŸÖÿ≠ÿßŸàŸÑÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÑŸàÿ¨Ÿà ÿ´ŸÖ ÿßŸÑŸÅŸäŸÉÿ™Ÿàÿ±
// ==========================================
async function tryLoadBrandLogoSmart(brand, imgElement) {
  const cleanBrand = (brand || 'GENERIC').trim();
  
  if (!cleanBrand || cleanBrand === 'GENERIC' || cleanBrand === 'N/A') {
    imgElement.src = getBrandVectorSVG(cleanBrand);
    imgElement.style.opacity = '1';
    return;
  }

  const logoUrls = [
    `https://logo.clearbit.com/${cleanBrand.toLowerCase()}.com`,
    `https://img.logo.dev/${cleanBrand.toLowerCase()}.com?token=pk_X-NOM1TdQVaFy4SSRQoMjQ`,
    `https://cdn.brandfetch.io/${cleanBrand.toLowerCase()}.com/w/400/h/400/fallback/lettermark`
  ];
  
  for (const url of logoUrls) {
    try {
      const isValid = await testImageLoad(url);
      if (isValid) {
        imgElement.src = url;
        imgElement.style.opacity = '1';
        imgElement.style.padding = "25px";
        return; 
      }
    } catch (e) { continue; }
  }

  console.log(`üé® Generating Vector for: ${cleanBrand}`);
  imgElement.src = getBrandVectorSVG(cleanBrand);
  imgElement.style.opacity = '1';
  imgElement.style.padding = "0"; 
}

// ==========================================
// 4Ô∏è‚É£ ŸÖŸàŸÑÿØ ÿßŸÑŸÅŸäŸÉÿ™Ÿàÿ± (SVG Generator)
// ==========================================
function getBrandVectorSVG(brandName) {
  const styles = [
    { bg: '#F3F4F6', text: '#374151' },
    { bg: '#ECFDF5', text: '#059669' },
    { bg: '#EFF6FF', text: '#2563EB' },
    { bg: '#FFF7ED', text: '#EA580C' },
    { bg: '#FDF4FF', text: '#C026D3' },
    { bg: '#FEF2F2', text: '#DC2626' }
  ];
  
  let hash = 0;
  for (let i = 0; i < brandName.length; i++) {
    hash = brandName.charCodeAt(i) + ((hash << 5) - hash);
  }
  const styleIndex = Math.abs(hash) % styles.length;
  const { bg, text } = styles[styleIndex];
  
  const displayName = brandName.length > 12 ? brandName.substring(0, 12) + '.' : brandName;

  const svg = `
    <svg xmlns="http://www.w3.org/2000/svg" width="400" height="400" viewBox="0 0 400 400">
      <rect width="400" height="400" fill="${bg}"/>
      <circle cx="200" cy="180" r="80" fill="${text}" fill-opacity="0.1"/>
      <text x="50%" y="50%" font-family="'Segoe UI', Arial, sans-serif" font-weight="900" font-size="42" fill="${text}" text-anchor="middle" dy=".3em">
        ${displayName.toUpperCase()}
      </text>
      <text x="50%" y="75%" font-family="'Segoe UI', Arial, sans-serif" font-weight="600" font-size="24" fill="${text}" fill-opacity="0.6" text-anchor="middle">
        
      </text>
    </svg>
  `;
  
  return `data:image/svg+xml;charset=UTF-8,${encodeURIComponent(svg)}`;
}

// ÿØÿßŸÑÿ© ŸÖÿ≥ÿßÿπÿØÿ© ŸÑÿßÿÆÿ™ÿ®ÿßÿ± ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿµŸàÿ±ÿ©
function testImageLoad(url) {
  return new Promise((resolve) => {
    const img = new Image();
    img.onload = () => resolve(true);
    img.onerror = () => resolve(false);
    img.src = url;
    setTimeout(() => resolve(false), 2000); 
  });
}
function openCustomPrintModal() {
  const modal = document.getElementById('customPrintModal');
  if(modal) {
    modal.style.display = 'flex';
    restoreCustomModalData(); // ‚úÖ ÿßÿ≥ÿ™ÿ±ÿ¨ÿßÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
  }
}

function closeCustomPrintModal() {
  saveCustomModalData(); // ‚úÖ ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÇÿ®ŸÑ ÿßŸÑÿ•ÿ∫ŸÑÿßŸÇ
  const modal = document.getElementById('customPrintModal');
  if(modal) modal.style.display = 'none';
}

function updateQuantityDisplay() {
    const codes = document.getElementById('customCode').value.trim();
    const quantityContainer = document.getElementById('quantityContainer');
    const label = quantityContainer.querySelector('label');
    
    // Always show quantity container
    quantityContainer.style.display = 'block';
    
    const codesList = codes.split(/[,\s]+/).filter(c => c.length > 0);
    
    // Update label based on codes
    if (label) {
        if (codesList.length === 0) {
            label.textContent = 'üî¢ Number of Cards';
        } else if (codesList.length === 1) {
            label.textContent = 'üî¢ Number of Cards (for single code)';
        } else {
            label.textContent = 'üî¢ Number of Cards (per code)';
        }
    }
}
/**
 * ‚úÖ Dr. Mo Print Edition v31.6 - CUSTOM PRINT (Tight Fit) üéØ
 * - ÿ™ŸÇÿ±Ÿäÿ® ÿßŸÑŸÉÿ≥ÿ± ŸÖŸÜ ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑÿµÿ≠Ÿäÿ≠ (ŸÖÿ≥ÿßŸÅÿ© ÿ£ŸÇŸÑ).
 * - ÿ≤ŸäÿßÿØÿ© ŸÖŸÜÿ∑ŸÇÿ© ÿßŸÑÿ£ŸÖÿßŸÜ (Padding 18%) ŸÑÿ•ÿ®ÿπÿßÿØ ÿßŸÑŸÜÿµ ÿπŸÜ ÿßŸÑÿ≠ŸàÿßŸÅ.
 */

// =====================
// 1) Helper: Inject print CSS once
// =====================
function injectPrintStylesOnce() {
  if (document.getElementById("custom-print-styles")) return;

  const style = document.createElement("style");
  style.id = "custom-print-styles";
  style.textContent = `
    .riyal-symbol-img{
      display:inline-block;
      width: 1.05em;
      height: 1.05em;
      vertical-align: -0.12em;
      margin-left: 0.18em; /* EN: right of number */
      margin-right: 0.18em; /* AR: left of number */
    }

    /* üî• Screen preview */
    .print-price-bold { font-weight: 900 !important; font-size: 2.8em !important; } /* % */
    .print-price-normal { font-weight: 900 !important; font-size: 2.4em !important; } /* ÿ≥ÿπÿ± */
    .print-promo-text { font-weight: 900 !important; font-size: 1.8em !important; } /* ÿπÿ±Ÿàÿ∂ ÿ∫Ÿäÿ± ÿ±ŸÇŸÖŸäÿ© */

    @media print{
      *{
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        color-adjust: exact !important;
      }

      .riyal-symbol-img{
        width: 22pt !important;
        height: 22pt !important;
      }

      .print-card{ page-break-inside: avoid !important; break-inside: avoid !important; }
      img{ image-rendering: auto; }
      
      /* üî• PRINT: % = 48pt | ÿ≥ÿπÿ± = 44pt | ŸÜÿµŸàÿµ ÿßŸÑÿπÿ±Ÿàÿ∂ = 28pt ÿ®ŸàŸÑÿØ */
      .print-price-bold { font-weight: 900 !important; font-size: 48pt !important; }
      .print-price-normal { font-weight: 900 !important; font-size: 44pt !important; }
      .print-promo-text { 
        font-weight: 900 !important; 
        font-size: 28pt !important; 
        line-height: 1.1 !important;
      }
    }
  `;
  document.head.appendChild(style);
}

// =====================
// 2) Helper: Export Riyal SVG => PNG before printing (best effort)
// =====================
const RIYAL_SVG_URL = "https://www.sama.gov.sa/ar-sa/Currency/Documents/Saudi_Riyal_Symbol-2.svg";

function loadImage(url, { crossOrigin } = {}) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    if (crossOrigin) img.crossOrigin = crossOrigin;
    img.onload = () => resolve(img);
    img.onerror = reject;
    img.src = url;
  });
}

async function exportRiyalSymbolsForPrint() {
  const imgs = Array.from(document.querySelectorAll("img.riyal-symbol-img"));
  if (!imgs.length) return;

  try {
    const img = await loadImage(RIYAL_SVG_URL, { crossOrigin: "anonymous" });

    const scale = 3;
    const w = Math.max(64, img.naturalWidth || 64);
    const h = Math.max(64, img.naturalHeight || 64);

    const canvas = document.createElement("canvas");
    canvas.width = w * scale;
    canvas.height = h * scale;
    const ctx = canvas.getContext("2d");

    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

    const pngDataUrl = canvas.toDataURL("image/png");

    imgs.forEach(el => {
      el.dataset.originalSrc = el.dataset.originalSrc || el.src;
      el.src = pngDataUrl;
    });
  } catch (e) {
    // fallback: SVG ÿπÿßÿØŸä
  }
}

function restoreRiyalSymbolsAfterPrint() {
  const imgs = Array.from(document.querySelectorAll("img.riyal-symbol-img"));
  imgs.forEach(el => {
    if (el.dataset.originalSrc) el.src = el.dataset.originalSrc;
  });
}

// =====================
// 3) Main: Print flow
// =====================
async function printCustomCardsDirectly() {
  injectPrintStylesOnce();

  const codes = document.getElementById('customCode').value.trim();
  const selectedOfferTypes = getSelectedOfferTypes();

  if (selectedOfferTypes.length === 0) {
    alert('‚ö†Ô∏è Please select at least one offer type or enter a custom type!');
    return;
  }

  const codesList = codes.split(/[,\s]+/).filter(c => c.length > 0);
  const quantity = parseInt(document.getElementById('customQuantity').value) || 1;

  if (quantity < 1 || quantity > 100) {
    alert('‚ö†Ô∏è Quantity must be between 1 and 100!');
    return;
  }

  const customData = {
    dateRange: document.getElementById('customDateRange').value.trim(),
    productEN: document.getElementById('customProductEN').value.trim(),
    productAR: document.getElementById('customProductAR').value.trim(),
    category: document.getElementById('customCategory').value.trim()
  };

  const customCards = [];

  if (codesList.length === 0) {
    selectedOfferTypes.forEach(offerType => {
      for (let i = 0; i < quantity; i++) {
        customCards.push({
          Code: '',
          customData: { ...customData, offerEN: offerType.en, offerAR: offerType.ar }
        });
      }
    });
  } else {
    selectedOfferTypes.forEach(offerType => {
      codesList.forEach(code => {
        for (let i = 0; i < quantity; i++) {
          customCards.push({
            Code: code,
            customData: { ...customData, offerEN: offerType.en, offerAR: offerType.ar }
          });
        }
      });
    });
  }

  if (customCards.length === 0) {
    alert('‚ö†Ô∏è No cards to print!');
    return;
  }

  const container = document.getElementById('printContainer');
  const loader = document.getElementById('printLoader');

  container.innerHTML = '';
  if (loader) loader.style.display = 'flex';

  setTimeout(async () => {
    renderCustomPrint(customCards);
    await exportRiyalSymbolsForPrint();
    if (loader) loader.style.display = 'none';
    closeCustomPrintModal();
    saveCustomModalData();
    window.print();
  }, 120);
}

window.addEventListener("afterprint", restoreRiyalSymbolsAfterPrint);

// =====================
// 4) Render pages
// =====================
function renderCustomPrint(customCards) {
  const container = document.getElementById("printContainer");
  const itemsPerPage = 6;
  const itemsPerRow = 3;
  const fragment = document.createDocumentFragment();

  for (let i = 0; i < customCards.length; i += itemsPerPage) {
    const page = document.createElement("div");
    page.className = "print-page";

    const header = document.createElement("div");
    header.className = "print-header-space";
    page.appendChild(header);

    const row1 = document.createElement("div");
    row1.className = "print-row";
    for (let j = 0; j < itemsPerRow && (i + j) < customCards.length; j++) {
      row1.appendChild(createCustomPrintCard(customCards[i + j]));
    }
    while (row1.children.length < 3 && row1.children.length > 0) {
      const dummy = document.createElement('div');
      dummy.className = "print-card";
      row1.appendChild(dummy);
    }
    page.appendChild(row1);

    const spacer = document.createElement("div");
    spacer.className = "print-spacer";
    page.appendChild(spacer);

    const row2 = document.createElement("div");
    row2.className = "print-row";
    for (let j = 0; j < itemsPerRow && (i + itemsPerRow + j) < customCards.length; j++) {
      row2.appendChild(createCustomPrintCard(customCards[i + itemsPerRow + j]));
    }
    while (row2.children.length < 3 && row2.children.length > 0) {
      const dummy = document.createElement('div');
      dummy.className = "print-card";
      row2.appendChild(dummy);
    }
    page.appendChild(row2);

    fragment.appendChild(page);
  }

  container.appendChild(fragment);
}

// =====================
// 5) Create card - üî• Final Logic: PERFECT FIT (NO TOUCHING EDGES)
// =====================
function createCustomPrintCard(cardData) {
  const card = document.createElement("div");
  card.className = "print-card";

  const customData = cardData.customData;
  let cardHTML = '';

  const RIYAL_SVG_URL = "https://www.sama.gov.sa/ar-sa/Currency/Documents/Saudi_Riyal_Symbol-2.svg";
  
  // ‚úÖ ÿ™ŸÇŸÑŸäŸÑ ÿ≠ÿ¨ŸÖ ÿßŸÑÿ±ŸÖÿ≤ ŸÇŸÑŸäŸÑÿßŸã Ÿàÿ™ŸÇÿ±Ÿäÿ® ÿßŸÑŸÖÿ≥ÿßŸÅÿ©
  const riyalImg = `<img class="riyal-symbol-img" src="${RIYAL_SVG_URL}" alt="SAR" data-original-src="${RIYAL_SVG_URL}" style="width: 18px; height: 18px; margin-right: 4px; margin-bottom: 8px;" />`;

  function convertArabicNumbersToWestern(text) {
    const arabicNums = ['Ÿ†','Ÿ°','Ÿ¢','Ÿ£','Ÿ§','Ÿ•','Ÿ¶','Ÿß','Ÿ®','Ÿ©'];
    const westernNums = ['0','1','2','3','4','5','6','7','8','9'];
    return text.replace(/[Ÿ†-Ÿ©]/g, m => westernNums[arabicNums.indexOf(m)]);
  }

  // üî• Smart Logic: BALANCED SIZES & SPACING
  function getCircleContent(offerEN, offerAR) {
    const fullText = `${offerEN || ''} ${offerAR || ''}`.trim();
    if (!fullText) return '';

    const safeText = convertArabicNumbersToWestern(fullText.toLowerCase());

    // ‚úÖ (1) ÿ≤ŸäÿßÿØÿ© ÿßŸÑŸÄ padding ŸáŸÜÿß (ŸÉÿßŸÜ 14% ÿ®ŸÇŸâ 18%) ÿπÿ¥ÿßŸÜ Ÿäÿ®ÿπÿØ ÿπŸÜ ÿßŸÑÿ≠ŸàÿßŸÅ
    const colCenter = `display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;height:100%;padding:0 18%;box-sizing:border-box;`;
    
    // ŸÖÿ≠ÿßÿ∞ÿßÿ© ŸÖŸÜ ÿßŸÑÿ£ÿ≥ŸÅŸÑ
    const rowBottom = `display:flex;align-items:baseline;justify-content:center;width:100%;`;

    const isSecondPiece =
      safeText.includes('2nd') || safeText.includes('sec pc') || safeText.includes('second') ||
      safeText.includes('ÿßŸÑÿ´ÿßŸÜŸäÿ©') || safeText.includes('ÿßŸÑÿ≠ÿ®ÿ© ÿßŸÑÿ´ÿßŸÜŸäÿ©') ||
      safeText.includes('buy 1 get 1') || safeText.includes('get 1') || safeText.includes('ÿßÿ≠ÿµŸÑ ÿπŸÑŸâ 1');

    const hasFreeWord = /(?:free|ŸÖÿ¨ÿßŸÜ)/i.test(safeText);

    // --- 1) % DISCOUNT ---
    const percentMatch = safeText.match(/(\d{1,3})\s*%/);
    if (percentMatch) {
      const percent = percentMatch[1] || '';
      
      const percentContent = `
        <div style="display: flex; align-items: baseline; justify-content: center; line-height: 1;">
          <span class="print-price-bold" style="font-family:'Roboto',Arial;font-weight:900;color:#000;font-size:52pt !important; letter-spacing: -3px;">
            ${percent}
          </span>
          <span style="font-size: 22pt; font-weight: 900; margin-left: 2px; color: #000;">%</span>
        </div>
      `;

      if (isSecondPiece) {
        return `
          <div style="${colCenter}">
            <div style="margin-bottom: 0px;">
               <div style="display: flex; align-items: baseline; justify-content: center; line-height: 1;">
                  <span class="print-price-bold" style="font-family:'Roboto',Arial;font-weight:900;color:#000;font-size:42pt !important; letter-spacing: -2px;">
                    ${percent}
                  </span>
                  <span style="font-size: 18pt; font-weight: 900; margin-left: 2px; color: #000;">%</span>
               </div>
            </div>
            <div style="font-family:'Cairo',Tahoma;font-size:11pt;font-weight:800;color:#000;white-space:nowrap; margin-top:-4px;">
              ÿßŸÑÿ≠ÿ®ÿ© ÿßŸÑÿ´ÿßŸÜŸäÿ©
            </div>
          </div>
        `;
      }

      return `
        <div style="${colCenter}">
          ${percentContent}
        </div>
      `;
    }

    // --- 2) PRICE (SAR) - UPDATED FOR DECIMALS ---
    let priceMatch =
      safeText.match(/buy\s*(\d+)\s*@\s*sar\s*(\d+(?:\.\d+)?)/i) ||          
      safeText.match(/buy\s*1\s*get\s*1\s*[-‚Äì‚Äî]\s*(\d+(?:\.\d+)?)\s*sar/i) ||
      safeText.match(/[-‚Äì‚Äî]\s*(\d+(?:\.\d+)?)\s*sar/i) ||                      
      safeText.match(/(\d+(?:\.\d+)?)\s*sar/i) ||                              
      safeText.match(/ÿ®ŸÄ?\s*(\d+(?:\.\d+)?)\s*ÿ±ŸäÿßŸÑ/i);                          

    if (priceMatch) {
      let priceValue;
      if (priceMatch.length > 2 && priceMatch[2]) { priceValue = priceMatch[2]; } else { priceValue = priceMatch[1]; }

      // ‚úÖ ÿßŸÑÿ™ÿπÿØŸäŸÑ ŸáŸÜÿß: ÿπÿØŸÖ ÿßŸÑÿ™ŸÇÿ±Ÿäÿ® + ŸÅÿµŸÑ ÿßŸÑŸÉÿ≥Ÿàÿ±
      const parts = priceValue.split('.');
      const mainPrice = parts[0]; // ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑÿµÿ≠Ÿäÿ≠
      const decimalPart = parts[1] ? parts[1].substring(0, 2) : null; // ÿßŸÑŸÉÿ≥ÿ±

      const digits = mainPrice.length;
      
      // ‚úÖ ÿ™ÿπÿØŸäŸÑ ÿ£ÿ≠ÿ¨ÿßŸÖ ÿßŸÑÿÆÿ∑Ÿàÿ∑
      let fontSize = '52pt'; 
      if(digits >= 3) fontSize = '40pt'; 
      if(digits >= 4) fontSize = '32pt'; 

      let qty = 1;
      const qtyMatch = safeText.match(/buy\s*(\d+)\s*@\s*sar/i) || safeText.match(/buy\s*(\d+)\s*get\s*1\s*[-‚Äì‚Äî]/i) || safeText.match(/ÿßÿ¥ÿ™ÿ±Ÿä\s*(\d+)/i);
      if (qtyMatch) { qty = parseInt(qtyMatch[1], 10); } else if (safeText.includes('ÿ≠ÿ®ÿ™ŸäŸÜ') || safeText.includes('ÿ≠ÿ®ÿ™ÿßŸÜ')) { qty = 2; }

      let arabicLine = '';
      if (isSecondPiece || safeText.includes('ÿßŸÑÿ™ÿßŸÜŸäÿ©')) { arabicLine = 'ÿßŸÑÿ≠ÿ®ÿ© ÿßŸÑÿ´ÿßŸÜŸäÿ©'; }
      else if (qty === 1) { arabicLine = 'ÿßŸÑÿ≠ÿ®ÿ©'; }
      else if (qty === 2) { arabicLine = 'ÿßŸÑÿ≠ÿ®ÿ™ŸäŸÜ'; }
      else { arabicLine = `ÿßŸÑŸÄ ${qty} ÿ≠ÿ®ÿßÿ™`; }

      return `
        <div style="${colCenter}">
          <div style="${rowBottom} margin-bottom: 5px;">
            <div style="font-size: 14pt; display:flex; z-index:2; margin-bottom: 2px;">
                ${riyalImg}
            </div>
            
            <span class="print-price-normal" style="
              font-family:'Roboto',Arial;
              font-weight:900;
              color:#000; 
              font-size: ${fontSize} !important; 
              line-height: 0.85;
              letter-spacing: -2px;
              display: flex;
              align-items: baseline;
              position: relative;
              z-index: 1;
            ">
              ${mainPrice}
              ${decimalPart ? `<span style="font-size: 0.25em; margin-left: -4px; font-weight:800; color:#333; transform: translateY(2px);">.${decimalPart}</span>` : ''}
            </span>
          </div>

          ${arabicLine ? `
            <div style="font-family:'Cairo',Tahoma;font-size:12pt;font-weight:900;color:#059669;white-space:nowrap; margin-top: 0px;">
              ${arabicLine}
            </div>
          ` : ''}
        </div>
      `;
    }

    // --- 3) PURE FREE / BOGO (1+1) ---
    let x = null, y = null;
    const plusFreeMatch = safeText.match(/(\d+)\s*(?:pcs?|pc|ÿ≠ÿ®ÿ©|ÿ≠ÿ®ÿßÿ™?)?\s*(?:\+|Ÿà)\s*(\d+)\s*(?:pcs?|pc|ÿ≠ÿ®ÿ©|ÿ≠ÿ®ÿßÿ™?)?\s*(?:free|ŸÖÿ¨ÿßŸÜ)/i) || safeText.match(/(\d+)\s*\+\s*(\d+)(?:\s*free)?/i);
    const buyGetMatch = safeText.match(/(?:buy|ÿßÿ¥ÿ™ÿ±Ÿä)\s*(\d+)\s*(?:pcs?|pc|ÿ≠ÿ®ÿ©|ÿ≠ÿ®ÿßÿ™?)?\s*(?:get|ÿßÿ≠ÿµŸÑ)\s*(\d+)\s*(?:pcs?|pc|ÿ≠ÿ®ÿ©|ÿ≠ÿ®ÿßÿ™?)?\s*(?:free|ŸÖÿ¨ÿßŸÜ)/i);
    const arTwoThirdFree = /(?:ÿßÿ¥ÿ™ÿ±Ÿä\s*)?(?:ÿ≠ÿ®ÿ™ŸäŸÜ|ÿ≠ÿ®ÿ™ÿßŸÜ|2)\s*(?:Ÿà)?\s*(?:ÿßŸÑ)?(?:ÿ´ÿßŸÑÿ´ÿ©|ÿßŸÑÿ´ÿßŸÑÿ´ÿ©|3)\s*(?:free|ŸÖÿ¨ÿßŸÜ)/i.test(safeText);
    const getOnlyMatch = safeText.match(/(?:get|ÿßÿ≠ÿµŸÑ)\s*(?:ÿπŸÑŸâ\s*)?(\d+)\s*(?:free|ŸÖÿ¨ÿßŸÜ)/i);
    const explicitOnePlusOne = /\b1\s*\+\s*1\b/.test(safeText);

    if (plusFreeMatch) { x = plusFreeMatch[1]; y = plusFreeMatch[2]; } else if (buyGetMatch) { x = buyGetMatch[1]; y = buyGetMatch[2]; } else if (arTwoThirdFree) { x = '2'; y = '1'; } else if (getOnlyMatch && hasFreeWord) { x = '1'; y = getOnlyMatch[1]; } else if (explicitOnePlusOne) { x = '1'; y = '1'; }

    if (x && y) {
      return `
        <div style="${colCenter}">
          <div class="print-price-normal" style="
            font-family:'Cairo',sans-serif;
            font-weight:900;
            color:#000;
            margin-bottom:0px;
            line-height: 0.9;
            display: flex;
            align-items: baseline; 
            justify-content: center;
          ">
            <span style="font-size: 38pt !important; color: #333;">${x}</span>
            <span style="font-size: 28pt !important; margin: 0 4px; color: #666;">+</span>
            <span style="font-size: 55pt !important; color: #000;">${y}</span>
          </div>
          <div style="font-family:'Cairo',Tahoma;font-size:15pt;font-weight:800;color:#dc2626;white-space:nowrap;">
            ŸÖÿ¨ÿßŸÜÿßŸã
          </div>
        </div>
      `;
    }

    // Fallback
    return `
      <div class="print-promo-text" style="font-family:'Cairo',sans-serif;font-weight:900;color:#000;text-align:center;line-height:1.2;font-size:18pt !important;">
        ${(offerAR || offerEN || '').substring(0, 15)}
      </div>
    `;
  }

  // üü¢ RENDER CIRCLE
  if (customData.offerEN || customData.offerAR) {
    const circleContent = getCircleContent(customData.offerEN, customData.offerAR);
    
    cardHTML += `
      <div style="position:relative;width:46mm;height:46mm;margin:0 auto 2mm; overflow:hidden;">
        <svg width="100%" height="100%" viewBox="0 0 120 120" style="position:absolute;top:0;left:0;z-index:1;">
          <circle cx="60" cy="60" r="56" fill="#f8fafc" stroke="#059669" stroke-width="6" stroke-linecap="round"/>
        </svg>
        <div style="
          position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
          z-index:2;width:100%;height:100%;
          display:flex;align-items:center;justify-content:center;
          text-align:center;
        ">
          ${circleContent}
        </div>
      </div>
    `;
  }

  // üü¢ TEXT BELOW
  if (customData.offerEN) { cardHTML += `<div style="text-align:center;font-weight:700;font-size:12pt;margin-bottom:1mm;line-height:1.1;color:#1e3a8a;">${customData.offerEN}</div>`; }
  if (customData.offerAR) { cardHTML += `<div style="text-align:center;font-weight:700;font-size:12pt;margin-bottom:2mm;direction:rtl;font-family:'Cairo',Tahoma,sans-serif;line-height:1.1;color:#1e3a8a;">${customData.offerAR}</div>`; }
  if (customData.dateRange) { cardHTML += `<div class="print-offer-date" style="margin:2mm 0;font-size:10pt;text-align:center;">${customData.dateRange}</div>`; }
  if (customData.productEN) { cardHTML += `<div class="print-product-desc" style="margin-bottom:1mm;line-height:1.2;font-size:11pt;">${customData.productEN}</div>`; }
  if (customData.productAR) { cardHTML += `<div class="print-product-desc" style="font-size:11pt;margin-bottom:2mm;direction:rtl;font-family:Tahoma,sans-serif;line-height:1.2;">${customData.productAR}</div>`; }
  const meta = customData.category ? `${cardData.Code} - ${customData.category}` : cardData.Code;
  cardHTML += `<div class="print-product-meta" style="font-size:9pt;margin-top:2mm;text-align:center;">${meta}</div>`;

  card.innerHTML = cardHTML;
  return card;
}

// ========== üåü EXCLUSIVE OFFERS PRINT (FULL VERSION WITH ALL FIXES) ==========

// ====== üí∞ HELPER: GET ARABIC QUANTITY TEXT (ÿ®ÿØŸàŸÜ ŸÉŸÑŸÖÿ© "ÿ≥ÿπÿ±") ======
function getArabicQuantityTextFromOffer(offerType) {
  if (!offerType) return 'ÿßŸÑÿ≠ÿ®ÿ©';
  
  const offerLower = offerType.toLowerCase();
  
  // üî• 1Ô∏è‚É£ ÿ≠ÿßŸÑÿ© ÿÆÿßÿµÿ©: "Buy X Get Y @ SAR" = ÿßŸÑÿ≠ÿ®ÿ© ÿßŸÑÿ´ÿßŸÜŸäÿ©/ÿßŸÑŸÖÿ¨ÿßŸÜŸäÿ©
  if (offerLower.includes('get') && (offerLower.includes('@') || offerLower.includes('sar'))) {
    return 'ÿßŸÑÿ≠ÿ®ÿ© ÿßŸÑÿ´ÿßŸÜŸäÿ©';
  }
  
  // üî• 2Ô∏è‚É£ ÿ≠ÿßŸÑÿ© ÿÆÿßÿµÿ©: "2nd" ÿ£Ÿà "sec" ÿ£Ÿà "second" = ÿßŸÑÿ≠ÿ®ÿ© ÿßŸÑÿ´ÿßŸÜŸäÿ©
  if (offerLower.includes('2nd') || offerLower.includes('sec') || offerLower.includes('second')) {
    return 'ÿßŸÑÿ≠ÿ®ÿ© ÿßŸÑÿ´ÿßŸÜŸäÿ©';
  }
  
  // üî• 3Ô∏è‚É£ ÿπÿ±Ÿàÿ∂ "Buy X @ SAR" (ÿ®ÿØŸàŸÜ Get) = ÿ≠ÿ≥ÿ® ÿßŸÑÿπÿØÿØ
  const buyMatch = offerType.match(/Buy\s+(\d+)/i) || 
                   offerType.match(/ÿßÿ¥ÿ™ÿ±Ÿä\s+(\d+)/i) ||
                   offerType.match(/^(\d+)\s*@/);
  
  if (buyMatch) {
    const quantity = parseInt(buyMatch[1]);
    
    if (quantity === 1) {
      return 'ÿßŸÑÿ≠ÿ®ÿ©';
    } else if (quantity === 2) {
      return 'ÿßŸÑÿ≠ÿ®ÿ™ŸäŸÜ';
    } else if (quantity >= 3 && quantity <= 10) {
      return `ÿßŸÑŸÄ ${quantity} ÿ≠ÿ®ÿßÿ™`;
    } else {
      return `ÿßŸÑŸÄ ${quantity} ÿ≠ÿ®ÿ©`;
    }
  }
  
  // üî• 4Ô∏è‚É£ Fallback
  return 'ÿßŸÑÿ≠ÿ®ÿ©';
}

// ====== üîß HELPER: CONVERT ARABIC NUMBERS TO ENGLISH ======
function convertTextNumbersToDigits(text) {
  if (!text) return text;
  const arabicNums = ['Ÿ†','Ÿ°','Ÿ¢','Ÿ£','Ÿ§','Ÿ•','Ÿ¶','Ÿß','Ÿ®','Ÿ©'];
  const westernNums = ['0','1','2','3','4','5','6','7','8','9'];
  return text.replace(/[Ÿ†-Ÿ©]/g, (m) => westernNums[arabicNums.indexOf(m)]);
}

// ====== 1Ô∏è‚É£ ŸÅÿ™ÿ≠ ÿßŸÑŸÖŸàÿØÿßŸÑ ŸÖÿπ ÿßŸÑŸÅŸÑÿ™ÿ±ÿ© ŸàÿßŸÑÿ™ÿ≠ÿØŸäÿØ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ======
function openBrandSelectionModal() {
  console.log('üåü Opening Brand Selection Modal...');
  console.log('üìÇ Uploaded brands filter:', uploadedBrandsFilter);
  
  const modal = document.getElementById('brandSelectionModal');
  
  // ŸÑŸà ŸÖÿ¥ ŸÖŸàÿ¨ŸàÿØÿå ÿßŸÜÿ¥ÿ¶Ÿá
  if (!modal) {
    createBrandSelectionModal();
  }
  
  // ‚úÖ ÿ¨ŸÖÿπ ŸÉŸÑ ÿßŸÑÿ®ÿ±ÿßŸÜÿØÿßÿ™ ŸÖŸÜ exclusiveOffersDB
  let allBrands = [];
  if (typeof exclusiveOffersDB !== 'undefined') {
    const brandsSet = new Set();
    exclusiveOffersDB.forEach(offer => {
      if (Array.isArray(offer.codes)) {
        offer.codes.forEach(brand => {
          if (brand && brand.trim()) {
            brandsSet.add(brand.trim());
          }
        });
      }
    });
    allBrands = [...brandsSet].sort();
  }
  
  console.log(`üìã All available brands: ${allBrands.length}`);
  
  // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÄ header
  updateModalHeader(allBrands.length);
  
  // ‚úÖ ÿπÿ®ŸäŸá ÿ®ŸÉŸÑ ÿßŸÑÿ®ÿ±ÿßŸÜÿØÿßÿ™ + ÿπŸÑÿßŸÖÿ© Ÿàÿ™ÿ≠ÿØŸäÿØ ŸÑŸÑÿ®ÿ±ÿßŸÜÿØÿßÿ™ ŸÖŸÜ ÿßŸÑŸÖŸÑŸÅ
  populateBrandsListWithBadges(allBrands, uploadedBrandsFilter);
  
  // ÿßŸÅÿ™ÿ≠ ÿßŸÑŸÖŸàÿØÿßŸÑ
  document.getElementById('brandSelectionModal').style.display = 'flex';
}

// ====== 2Ô∏è‚É£ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÖŸàÿØÿßŸÑ ======
function createBrandSelectionModal() {
  const modal = document.createElement('div');
  modal.id = 'brandSelectionModal';
  
  modal.style.cssText = `
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    z-index: 10000;
    justify-content: center;
    align-items: flex-start;
    padding-top: 50px;
    backdrop-filter: blur(5px);
  `;
  
  modal.innerHTML = `
    <div style="
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 30px;
      border-radius: 20px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      margin: 0 auto;
    ">
      
      <!-- Header -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid rgba(255,255,255,0.3); padding-bottom: 15px;">
        <div id="modalHeaderContent" style="margin: 0; color: white; font-size: 24px; display: flex; align-items: center; gap: 10px;">
          <span style="font-size: 32px;">üè∑Ô∏è</span>
          <div>
            <div style="font-weight: 700;">ÿßÿÆÿ™ÿ± ÿßŸÑÿ®ÿ±ÿßŸÜÿØÿßÿ™</div>
            <div id="modalSubtitle" style="font-size: 12px; color: rgba(255,255,255,0.7); margin-top: 5px; font-weight: 400;"></div>
          </div>
        </div>
        <button onclick="closeBrandSelectionModal()" 
                style="
                  background: rgba(255,255,255,0.2); 
                  border: none; 
                  color: white; 
                  font-size: 24px; 
                  width: 40px; 
                  height: 40px; 
                  border-radius: 50%; 
                  cursor: pointer; 
                  display: flex; 
                  align-items: center; 
                  justify-content: center; 
                  transition: all 0.3s;
                  font-weight: 700;
                "
                onmouseover="this.style.background='rgba(255,0,0,0.6)'; this.style.transform='rotate(90deg)'"
                onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='rotate(0)'">
          ‚úï
        </button>
      </div>
      
      <!-- Search Input -->
      <input type="text" 
             id="brandSearchInput" 
             placeholder="üîç ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿ®ÿ±ÿßŸÜÿØ..." 
             style="
               width: 100%; 
               padding: 12px 15px; 
               border: 2px solid rgba(255,255,255,0.3); 
               border-radius: 10px; 
               background: rgba(255,255,255,0.1); 
               color: white; 
               font-size: 16px; 
               margin-bottom: 20px; 
               outline: none;
               box-sizing: border-box;
             " 
             oninput="filterBrandsList()" 
             onfocus="this.style.background='rgba(255,255,255,0.2)'"
             onblur="this.style.background='rgba(255,255,255,0.1)'"
      />
      
      <!-- Select/Deselect Buttons -->
      <div style="display: flex; gap: 10px; margin-bottom: 20px;">
        <button onclick="selectAllBrands()" 
                style="
                  flex: 1; 
                  padding: 12px; 
                  background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); 
                  border: none; 
                  color: white; 
                  font-weight: 600; 
                  border-radius: 10px; 
                  cursor: pointer; 
                  font-size: 14px; 
                  transition: all 0.3s; 
                  box-shadow: 0 4px 15px rgba(17, 153, 142, 0.4);
                "
                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(17, 153, 142, 0.6)'"
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(17, 153, 142, 0.4)'">
          ‚úÖ ÿßÿÆÿ™ÿ± ÿßŸÑŸÉŸÑ
        </button>
        <button onclick="deselectAllBrands()" 
                style="
                  flex: 1; 
                  padding: 12px; 
                  background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%); 
                  border: none; 
                  color: white; 
                  font-weight: 600; 
                  border-radius: 10px; 
                  cursor: pointer; 
                  font-size: 14px; 
                  transition: all 0.3s; 
                  box-shadow: 0 4px 15px rgba(235, 51, 73, 0.4);
                "
                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(235, 51, 73, 0.6)'"
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(235, 51, 73, 0.4)'">
          ‚ùå ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑŸÉŸÑ
        </button>
        <button onclick="selectUploadedBrandsOnly()" 
                style="
                  flex: 1; 
                  padding: 12px; 
                  background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); 
                  border: none; 
                  color: white; 
                  font-weight: 600; 
                  border-radius: 10px; 
                  cursor: pointer; 
                  font-size: 14px; 
                  transition: all 0.3s; 
                  box-shadow: 0 4px 15px rgba(251, 191, 36, 0.4);
                "
                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(251, 191, 36, 0.6)'"
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(251, 191, 36, 0.4)'">
          ‚≠ê ŸÖŸÜ ÿßŸÑŸÖŸÑŸÅ ŸÅŸÇÿ∑
        </button>
      </div>
      
      <!-- Brands List Container -->
      <div id="brandsListContainer" 
           style="
             background: rgba(0,0,0,0.2); 
             border-radius: 10px; 
             padding: 15px; 
             max-height: 300px; 
             overflow-y: auto; 
             margin-bottom: 20px; 
             border: 2px solid rgba(255,255,255,0.2);
           ">
      </div>
      
      <!-- Print Button -->
      <button onclick="printSelectedBrands()" 
              style="
                width: 100%; 
                padding: 15px; 
                background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); 
                border: none; 
                color: white; 
                font-weight: 700; 
                font-size: 18px; 
                border-radius: 10px; 
                cursor: pointer; 
                transition: all 0.3s; 
                box-shadow: 0 8px 25px rgba(240, 147, 251, 0.5); 
                text-transform: uppercase; 
                letter-spacing: 1px;
              "
              onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 12px 35px rgba(240, 147, 251, 0.7)'"
              onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 25px rgba(240, 147, 251, 0.5)'">
        üñ®Ô∏è ÿ∑ÿ®ÿßÿπÿ© ÿßŸÑÿ®ÿ±ÿßŸÜÿØÿßÿ™ ÿßŸÑŸÖÿÆÿ™ÿßÿ±ÿ©
      </button>
      
    </div>
  `;
  
  document.body.appendChild(modal);
}

// ====== 3Ô∏è‚É£ ÿ™ÿ≠ÿØŸäÿ´ ÿπŸÜŸàÿßŸÜ ÿßŸÑŸÖŸàÿØÿßŸÑ ======
function updateModalHeader(totalBrands) {
  const subtitle = document.getElementById('modalSubtitle');
  if (!subtitle) return;
  
  if (uploadedBrandsFilter && uploadedBrandsFilter.length > 0) {
    subtitle.innerHTML = `‚≠ê ${uploadedBrandsFilter.length} ŸÖŸÜ ${totalBrands} ÿ®ÿ±ÿßŸÜÿØ ŸÖŸÜ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑŸÖÿ±ŸÅŸàÿπ`;
    subtitle.style.display = 'block';
  } else {
    subtitle.innerHTML = `üìã ÿ¨ŸÖŸäÿπ ÿßŸÑÿ®ÿ±ÿßŸÜÿØÿßÿ™ ÿßŸÑŸÖÿ™ÿßÿ≠ÿ© (${totalBrands} ÿ®ÿ±ÿßŸÜÿØ)`;
    subtitle.style.display = 'block';
  }
}
// ====== 4Ô∏è‚É£ ÿ™ÿπÿ®ÿ¶ÿ© ÿßŸÑÿ®ÿ±ÿßŸÜÿØÿßÿ™ ŸÖÿπ ÿπŸÑÿßŸÖÿßÿ™ ‚≠ê (ŸÖŸèÿµŸÑŸéŸëÿ≠ ÿ®ÿßŸÑŸÉÿßŸÖŸÑ + Visual Feedback) ======
function populateBrandsListWithBadges(allBrands, uploadedBrands) {
  const container = document.getElementById('brandsListContainer');
  if (!container) {
    console.error('‚ùå brandsListContainer not found!');
    return;
  }
  
  console.log('üìù Populating brands with badges...');
  console.log('   All brands:', allBrands);
  console.log('   Uploaded brands:', uploadedBrands);
  
  container.innerHTML = '';
  
  if (allBrands.length === 0) {
    container.innerHTML = `
      <div style="
        padding: 30px;
        text-align: center;
        color: rgba(255,255,255,0.7);
      ">
        <div style="font-size: 48px; margin-bottom: 15px;">üì¶</div>
        <div style="font-weight: 700; font-size: 16px; margin-bottom: 8px;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ÿ±ÿßŸÜÿØÿßÿ™ ŸÖÿ™ÿßÿ≠ÿ©</div>
        <div style="font-size: 12px;">ÿ™ÿ£ŸÉÿØ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿπÿ±Ÿàÿ∂ ÿ≠ÿµÿ±Ÿäÿ© ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</div>
      </div>
    `;
    return;
  }
  
  // ‚úÖ ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ uploadedBrands array
  const uploadedSet = new Set(uploadedBrands || []);
  
  // ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿπŸÜÿßÿµÿ±
  allBrands.forEach(brand => {
    const isUploaded = uploadedSet.has(brand);
    
    const item = document.createElement('div');
    item.className = 'brand-item';
    item.setAttribute('data-brand', brand);
    item.setAttribute('data-uploaded', isUploaded ? 'true' : 'false');
    
    // ÿßÿ≥ÿ™ÿßŸäŸÑ ŸÖŸÖŸäÿ≤ ŸÑŸÑÿ®ÿ±ÿßŸÜÿØÿßÿ™ ŸÖŸÜ ÿßŸÑŸÖŸÑŸÅ
    const bgColor = isUploaded ? 'rgba(251, 191, 36, 0.2)' : 'rgba(255, 255, 255, 0.1)';
    const borderColor = isUploaded ? 'rgba(251, 191, 36, 0.5)' : 'rgba(255, 255, 255, 0.2)';
    
    item.style.cssText = `
      padding: 12px 16px;
      margin-bottom: 8px;
      background: ${bgColor};
      border: 2px solid ${borderColor};
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative;
    `;
    
    // ‚úÖ ÿ•ŸÜÿ¥ÿßÿ° checkbox ÿ®ÿ¥ŸÉŸÑ ŸÖŸÜŸÅÿµŸÑ
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.id = `brand_${brand.replace(/\s+/g, '_')}`;
    checkbox.value = brand;
    checkbox.className = 'brand-checkbox';
    checkbox.checked = isUploaded;
    checkbox.style.cssText = `
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: ${isUploaded ? '#fbbf24' : '#10b981'};
      flex-shrink: 0;
    `;
    
    // ‚úÖ ÿ•ŸÜÿ¥ÿßÿ° label ÿ®ÿ¥ŸÉŸÑ ŸÖŸÜŸÅÿµŸÑ
    const label = document.createElement('label');
    label.htmlFor = checkbox.id;
    label.style.cssText = `
      cursor: pointer;
      color: white;
      font-weight: ${isUploaded ? '700' : '600'};
      font-size: 15px;
      flex: 1;
      user-select: none;
      display: flex;
      align-items: center;
      gap: 8px;
    `;
    
    if (isUploaded) {
      const star = document.createElement('span');
      star.style.fontSize = '18px';
      star.textContent = '‚≠ê';
      label.appendChild(star);
    }
    
    const brandText = document.createTextNode(brand);
    label.appendChild(brandText);
    
    // ‚úÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿπŸÜÿßÿµÿ± ŸÑŸÑŸÄ item
    item.appendChild(checkbox);
    item.appendChild(label);
    
    // üî• ÿØÿßŸÑÿ© ŸÑÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ≥ÿ™ÿßŸäŸÑ ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÄ checkbox
    const updateItemStyle = () => {
      if (checkbox.checked) {
        // ‚úÖ ŸÖÿ≠ÿØÿØ: ÿÆŸÑŸÅŸäÿ© ÿÆÿ∂ÿ±ÿßÿ°/ÿ∞Ÿáÿ®Ÿäÿ© + ÿ®Ÿàÿ±ÿØÿ± ŸÇŸàŸä + shadow
        item.style.background = isUploaded ? 'rgba(251, 191, 36, 0.4)' : 'rgba(16, 185, 129, 0.3)';
        item.style.borderColor = isUploaded ? 'rgba(251, 191, 36, 0.9)' : 'rgba(16, 185, 129, 0.7)';
        item.style.boxShadow = '0 4px 12px rgba(16, 185, 129, 0.3)';
      } else {
        // ‚ùå ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ: ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑÿ≥ÿ™ÿßŸäŸÑ ÿßŸÑÿ£ÿµŸÑŸä
        item.style.background = bgColor;
        item.style.borderColor = borderColor;
        item.style.boxShadow = 'none';
      }
    };
    
    // ‚úÖ ÿ™ÿ∑ÿ®ŸäŸÇ ÿßŸÑÿ≥ÿ™ÿßŸäŸÑ ÿßŸÑÿ£ŸàŸÑŸä
    updateItemStyle();
    
    // ‚úÖ Hover effects
    item.addEventListener('mouseenter', () => {
      if (!checkbox.checked) {
        item.style.background = isUploaded ? 'rgba(251, 191, 36, 0.3)' : 'rgba(255, 255, 255, 0.2)';
        item.style.borderColor = isUploaded ? 'rgba(251, 191, 36, 0.7)' : 'rgba(255, 255, 255, 0.4)';
      }
      item.style.transform = 'translateX(5px)';
    });
    
    item.addEventListener('mouseleave', () => {
      if (!checkbox.checked) {
        item.style.background = bgColor;
        item.style.borderColor = borderColor;
      }
      item.style.transform = 'translateX(0)';
    });
    
    // ‚úÖ Click event ÿπŸÑŸâ ÿßŸÑŸÄ item
    item.addEventListener('click', (e) => {
      // ŸÑŸà ÿßŸÑÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ checkbox ÿ£Ÿà labelÿå ŸÖÿ™ÿπŸÖŸÑÿ¥ ÿ≠ÿßÿ¨ÿ© (ŸáŸäÿ≠ÿµŸÑ automatically)
      if (e.target === checkbox || e.target === label || e.target.closest('label')) {
        return;
      }
      // ŸÑŸà ÿßŸÑÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿ£Ÿä ŸÖŸÉÿßŸÜ ÿ™ÿßŸÜŸäÿå toggle ÿßŸÑŸÄ checkbox
      checkbox.checked = !checkbox.checked;
      // ‚úÖ Trigger change event ŸäÿØŸàŸäÿßŸã
      checkbox.dispatchEvent(new Event('change'));
    });
    
    // üî• Event listener ŸÑŸÑŸÄ checkbox change (ÿ£ŸáŸÖ ÿ≠ÿßÿ¨ÿ©!)
    checkbox.addEventListener('change', () => {
      updateItemStyle();
    });
    
    container.appendChild(item);
  });
  
  const uploadedCount = allBrands.filter(b => uploadedSet.has(b)).length;
  console.log(`‚úÖ Populated ${allBrands.length} brands (${uploadedCount} from file, ${allBrands.length - uploadedCount} others)`);
}

// ====== 5Ô∏è‚É£ ŸÅŸÑÿ™ÿ±ÿ© ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿ®ÿßŸÑÿ®ÿ≠ÿ´ ======
function filterBrandsList() {
  const searchInput = document.getElementById('brandSearchInput');
  if (!searchInput) return;
  
  const searchTerm = searchInput.value.trim().toLowerCase();
  const items = document.querySelectorAll('.brand-item');
  
  let visibleCount = 0;
  
  items.forEach(item => {
    const brand = item.getAttribute('data-brand').toLowerCase();
    
    if (brand.includes(searchTerm)) {
      item.style.display = 'flex';
      visibleCount++;
    } else {
      item.style.display = 'none';
    }
  });
  
  console.log(`üîç Search "${searchTerm}": ${visibleCount} brands visible`);
}
// ====== 6Ô∏è‚É£ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÉŸÑ (ŸÖŸèÿπÿØŸéŸëŸÑ) ======
function selectAllBrands() {
  const checkboxes = document.querySelectorAll('.brand-checkbox');
  let selectedCount = 0;
  
  checkboxes.forEach(checkbox => {
    const item = checkbox.closest('.brand-item');
    if (item && item.style.display !== 'none') {
      checkbox.checked = true;
      // üî• Trigger change event ÿπÿ¥ÿßŸÜ ÿßŸÑŸÄ visual update
      checkbox.dispatchEvent(new Event('change'));
      selectedCount++;
    }
  });
  
  console.log(`‚úÖ Selected ${selectedCount} visible brands`);
}

// ====== 7Ô∏è‚É£ ÿ•ŸÑÿ∫ÿßÿ° ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÉŸÑ (ŸÖŸèÿπÿØŸéŸëŸÑ) ======
function deselectAllBrands() {
  const checkboxes = document.querySelectorAll('.brand-checkbox');
  let deselectedCount = 0;
  
  checkboxes.forEach(checkbox => {
    checkbox.checked = false;
    // üî• Trigger change event ÿπÿ¥ÿßŸÜ ÿßŸÑŸÄ visual update
    checkbox.dispatchEvent(new Event('change'));
    deselectedCount++;
  });
  
  console.log(`‚ùå Deselected ${deselectedCount} brands`);
}

// ====== 8Ô∏è‚É£ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑÿ®ÿ±ÿßŸÜÿØÿßÿ™ ŸÖŸÜ ÿßŸÑŸÖŸÑŸÅ ŸÅŸÇÿ∑ (ŸÖŸèÿπÿØŸéŸëŸÑ) ======
function selectUploadedBrandsOnly() {
  const items = document.querySelectorAll('.brand-item');
  let selectedCount = 0;
  
  items.forEach(item => {
    const checkbox = item.querySelector('.brand-checkbox');
    const isUploaded = item.getAttribute('data-uploaded') === 'true';
    
    if (isUploaded && item.style.display !== 'none') {
      checkbox.checked = true;
      selectedCount++;
    } else {
      checkbox.checked = false;
    }
    
    // üî• Trigger change event ÿπÿ¥ÿßŸÜ ÿßŸÑŸÄ visual update
    checkbox.dispatchEvent(new Event('change'));
  });
  
  console.log(`‚≠ê Selected ${selectedCount} uploaded brands only`);
}

// ====== 9Ô∏è‚É£ ÿ∑ÿ®ÿßÿπÿ© ÿßŸÑÿ®ÿ±ÿßŸÜÿØÿßÿ™ ÿßŸÑŸÖÿÆÿ™ÿßÿ±ÿ© ======
function printSelectedBrands() {
  const checkboxes = document.querySelectorAll('.brand-checkbox:checked');
  const selectedBrands = Array.from(checkboxes).map(cb => cb.value);
  
  if (selectedBrands.length === 0) {
    alert('‚ö†Ô∏è ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßÿÆÿ™Ÿäÿßÿ± ÿ®ÿ±ÿßŸÜÿØ Ÿàÿßÿ≠ÿØ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ!');
    return;
  }
  
  console.log('üñ®Ô∏è Printing brands:', selectedBrands);
  
  // ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÖŸàÿØÿßŸÑ
  closeBrandSelectionModal();
  
  // ÿ∑ÿ®ÿßÿπÿ© ÿßŸÑÿπÿ±Ÿàÿ∂ ÿßŸÑÿ≠ÿµÿ±Ÿäÿ© ŸÑŸÑÿ®ÿ±ÿßŸÜÿØÿßÿ™ ÿßŸÑŸÖÿÆÿ™ÿßÿ±ÿ©
  printExclusiveBrandOffersForSelectedBrands(selectedBrands);
}

// ====== üîü ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÖŸàÿØÿßŸÑ ======
function closeBrandSelectionModal() {
  const modal = document.getElementById('brandSelectionModal');
  if (modal) {
    modal.style.display = 'none';
    
    // ŸÖÿ≥ÿ≠ ÿßŸÑÿ®ÿ≠ÿ´
    const searchInput = document.getElementById('brandSearchInput');
    if (searchInput) searchInput.value = '';
    
    // ÿ•ÿ∏Ÿáÿßÿ± ŸÉŸÑ ÿßŸÑÿπŸÜÿßÿµÿ±
    const items = document.querySelectorAll('.brand-item');
    items.forEach(item => item.style.display = 'flex');
  }
  console.log('‚ùå Modal closed');
}

// ====== 1Ô∏è‚É£1Ô∏è‚É£ ÿ∑ÿ®ÿßÿπÿ© ÿßŸÑÿπÿ±Ÿàÿ∂ ÿßŸÑÿ≠ÿµÿ±Ÿäÿ© ŸÑŸÑÿ®ÿ±ÿßŸÜÿØÿßÿ™ ÿßŸÑŸÖÿÆÿ™ÿßÿ±ÿ© (ŸÉÿßŸÖŸÑ) ======
function printExclusiveBrandOffersForSelectedBrands(selectedBrands) {
  console.log('üñ®Ô∏è Starting exclusive brand offers print for:', selectedBrands);
  
  if (typeof exclusiveOffersDB === 'undefined') {
    alert('‚ö†Ô∏è ŸÇÿßÿπÿØÿ© ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿπÿ±Ÿàÿ∂ ÿßŸÑÿ≠ÿµÿ±Ÿäÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©!');
    return;
  }
  
  // ‚úÖ ŸÅŸÑÿ™ÿ± ÿßŸÑÿπÿ±Ÿàÿ∂ ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿßŸÑÿ®ÿ±ÿßŸÜÿØÿßÿ™ ÿßŸÑŸÖÿÆÿ™ÿßÿ±ÿ©
  const filteredOffers = exclusiveOffersDB.filter(offer => {
    if (Array.isArray(offer.codes)) {
      return offer.codes.some(brand => selectedBrands.includes(brand));
    }
    return false;
  });
  
  console.log(`‚úÖ Found ${filteredOffers.length} offers for selected brands`);
  
  if (filteredOffers.length === 0) {
    alert('‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿπÿ±Ÿàÿ∂ ŸÑŸÑÿ®ÿ±ÿßŸÜÿØÿßÿ™ ÿßŸÑŸÖÿÆÿ™ÿßÿ±ÿ©!');
    return;
  }
  
  // ÿπÿ±ÿ∂ ÿßŸÑŸÄ loader
  const container = document.getElementById("printContainer");
  const loader = document.getElementById("printLoader");
  
  if (!container) {
    console.error('‚ùå Print container not found!');
    return;
  }
  
  container.innerHTML = "";
  
  if (loader) {
    loader.style.display = "flex";
    const loaderText = loader.querySelector('div:last-child');
    if (loaderText) {
      loaderText.textContent = `‚ö° ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ÿ∂Ÿäÿ± ${filteredOffers.length} ÿπÿ±ÿ∂...`;
    }
  }
  
  // ÿ™ÿ£ÿÆŸäÿ± ÿ®ÿ≥Ÿäÿ∑ ÿπÿ¥ÿßŸÜ ÿßŸÑŸÄ UI
  setTimeout(() => {
    renderExclusivePrintFiltered(filteredOffers);
    if (loader) loader.style.display = "none";
    setTimeout(() => window.print(), 500);
  }, 100);
}
// ==========================================
// 1Ô∏è‚É£2Ô∏è‚É£ ÿØÿßŸÑÿ© ÿßŸÑÿ±ŸäŸÜÿØÿ± ŸÑŸÑÿπÿ±Ÿàÿ∂ ÿßŸÑÿ≠ÿµÿ±Ÿäÿ© (Updated for 32mm)
// ==========================================
function renderExclusivePrintFiltered(offers) {
  const container = document.getElementById("printContainer");
  const fragment = document.createDocumentFragment();
  
  // ÿ≠ÿ≥ÿßÿ® ÿßŸÑÿ™ÿßÿ±ŸäÿÆ
  const options = { month: 'short', day: 'numeric' };
  let dateRange = '';
  
  if (typeof CURRENT_OFFER_START !== 'undefined' && typeof CURRENT_OFFER_END !== 'undefined') {
    const startStr = CURRENT_OFFER_START.toLocaleDateString('en-US', options);
    const endStr = CURRENT_OFFER_END.toLocaleDateString('en-US', options);
    dateRange = `${startStr} - ${endStr}`;
  } else {
    dateRange = 'Jan 19 - Feb 02';
  }
  
  if (!Array.isArray(offers)) return;

  offers.forEach((offer) => {
    const brandName = (offer.codes && offer.codes[0]) ? offer.codes[0] : "Brand";
    const type = offer.offerType || "";
    const typeAR = offer.offerTypeAR || "";

    const page = document.createElement("div");
    page.className = "print-page";
    
    const header = document.createElement("div");
    header.className = "print-header-space";
    page.appendChild(header);
    
    const row1 = document.createElement("div");
    row1.className = "print-row";
    for (let i = 0; i < 3; i++) {
      row1.appendChild(createSmartExclusiveCard(type, typeAR, brandName, dateRange));
    }
    page.appendChild(row1);
    
    const spacer = document.createElement("div");
    spacer.className = "print-spacer";
    page.appendChild(spacer);
    
    const row2 = document.createElement("div");
    row2.className = "print-row";
    for (let i = 0; i < 3; i++) {
      row2.appendChild(createSmartExclusiveCard(type, typeAR, brandName, dateRange));
    }
    page.appendChild(row2);
    
    fragment.appendChild(page);
  });
  
  container.innerHTML = '';
  container.appendChild(fragment);
}

// ==========================================
// 1Ô∏è‚É£3Ô∏è‚É£ ÿØÿßŸÑÿ© ÿ•ŸÜÿ¥ÿßÿ° ŸÉÿßÿ±ÿ™ ÿßŸÑÿπÿ±Ÿàÿ∂ ÿßŸÑÿ≠ÿµÿ±Ÿäÿ© (üî• 32mm Fixed)
// ==========================================
function createSmartExclusiveCard(offerType, offerTypeAR, brandName, dateRange) {
  const card = document.createElement("div");
  card.className = "print-card";
  
  const offerText = String(offerType || "").trim();
  
  const RIYAL_SVG_URL = "https://www.sama.gov.sa/ar-sa/Currency/Documents/Saudi_Riyal_Symbol-2.svg";
  
  // ‚úÖ ÿßŸÑÿ±ŸÖÿ≤: ÿ≠ÿ¨ŸÖ ŸÖŸÜÿßÿ≥ÿ® ŸÖÿπ ŸáŸàÿßŸÖÿ¥
  const riyalImg = `<img class="riyal-symbol-img" src="${RIYAL_SVG_URL}" alt="SAR" data-original-src="${RIYAL_SVG_URL}" style="width: 14px; height: 14px; margin-right: 3px; margin-bottom: 5px;" />`;

  function convertArabicNumbersToWestern(text) {
    if(!text) return "";
    const arabicNums = ['Ÿ†','Ÿ°','Ÿ¢','Ÿ£','Ÿ§','Ÿ•','Ÿ¶','Ÿß','Ÿ®','Ÿ©'];
    const westernNums = ['0','1','2','3','4','5','6','7','8','9'];
    return text.replace(/[Ÿ†-Ÿ©]/g, m => westernNums[arabicNums.indexOf(m)]);
  }

  // üî• ÿØÿßŸÑÿ© ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ
  function getCircleContent(textEN) {
    if (!textEN) return null;

    const safeText = convertArabicNumbersToWestern(textEN.toLowerCase());

    // ‚úÖ Layout: ÿ≤ŸäÿßÿØÿ© ÿßŸÑŸÄ Padding ŸÑŸÄ 12% ŸÑÿ∂ŸÖÿßŸÜ ÿπÿØŸÖ ŸÑŸÖÿ≥ ÿßŸÑÿ≠ŸàÿßŸÅ
    const colCenter = `display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;height:100%;padding:0 12%;box-sizing:border-box;`;
    const rowBottom = `display:flex;align-items:baseline;justify-content:center;width:100%;`;

    const isSecondPiece = safeText.includes("2nd") || safeText.includes("second") || safeText.includes("sec") || safeText.includes("buy 1 get 1") || safeText.includes("get 1");
    
    const percentMatch = safeText.match(/(\d{1,3})\s*%/);
    const priceMatch = safeText.match(/(?:@|sar|rs|ÿ±ŸäÿßŸÑ)\s*(\d+(?:\.\d+)?)/i) || 
                       safeText.match(/(\d+(?:\.\d+)?)\s*(?:sar|rs|ÿ±ŸäÿßŸÑ)/i) ||
                       (!safeText.includes("%") && !safeText.includes("+") && safeText.match(/^(\d+)$/));

    // üÖ∞Ô∏è Price Offer (ÿßŸÑÿ≥ÿπÿ±)
    if (priceMatch && !safeText.includes("%")) {
      const priceVal = priceMatch[1] || priceMatch[2] || priceMatch[0];
      
      // ‚úÖ ŸÅÿµŸÑ ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑÿµÿ≠Ÿäÿ≠ ÿπŸÜ ÿßŸÑŸÉÿ≥ÿ±
      const parts = priceVal.split('.');
      const mainPrice = parts[0]; 
      const decimalPart = parts[1] ? parts[1].substring(0, 2) : null;
      
      const digits = mainPrice.length;

      // üìè ÿ™ÿπÿØŸäŸÑ ÿ£ÿ≠ÿ¨ÿßŸÖ ÿßŸÑÿÆÿ∑Ÿàÿ∑
      let fontSize = '36pt'; 
      if(digits >= 3) fontSize = '26pt';
      if(digits >= 4) fontSize = '20pt';

      let arabicLine = "";
      if (isSecondPiece) arabicLine = "ÿßŸÑÿ≠ÿ®ÿ© ÿßŸÑÿ´ÿßŸÜŸäÿ©";
      else if (safeText.includes("buy 2") || safeText.includes("2 pcs")) arabicLine = "ÿßŸÑÿ≠ÿ®ÿ™ŸäŸÜ";
      else arabicLine = "ÿßŸÑÿ≠ÿ®ÿ©";

      return `
        <div style="${colCenter}">
          <div style="${rowBottom} margin-bottom: 2px;">
            <div style="display:flex; z-index:2; margin-bottom: 2px;">
                ${riyalImg}
            </div>
            <span class="print-price-normal" style="
              font-family:'Roboto',Arial;
              font-weight:900;
              color:#000; 
              font-size: ${fontSize} !important; 
              line-height: 0.85;
              letter-spacing: -2px;
              display: flex;
              align-items: baseline;
              position: relative;
              z-index: 1;
            ">
              ${mainPrice}
              ${decimalPart ? `<span style="font-size: 0.3em; margin-left: 0.5px; font-weight:800; color:#333; transform: translateY(2px);">.${decimalPart}</span>` : ''}
            </span>
          </div>
          ${arabicLine ? `
            <div style="font-family:'Cairo',Tahoma;font-size:8pt;font-weight:800;color:#059669;white-space:nowrap; margin-top: 0px;">
              ${arabicLine}
            </div>
          ` : ''}
        </div>
      `;
    }

    // üÖ±Ô∏è Percent Offer (%)
    else if (percentMatch) {
      const percent = percentMatch[1];
      
      const percentContent = `
        <div style="display: flex; align-items: baseline; justify-content: center; line-height: 1;">
          <span class="print-price-bold" style="font-family:'Roboto',Arial;font-weight:900;color:#000;font-size:36pt !important; letter-spacing: -2px;">
            ${percent}
          </span>
          <span style="font-size: 14pt; font-weight: 900; margin-left: 2px; color: #000;">%</span>
        </div>
      `;

      if (isSecondPiece) {
        return `
          <div style="${colCenter}">
            <div style="margin-bottom: 0px;">
               <div style="display: flex; align-items: baseline; justify-content: center; line-height: 1;">
                  <span class="print-price-bold" style="font-family:'Roboto',Arial;font-weight:900;color:#000;font-size:30pt !important; letter-spacing: -2px;">
                    ${percent}
                  </span>
                  <span style="font-size: 12pt; font-weight: 900; margin-left: 1px; color: #000;">%</span>
               </div>
            </div>
            <div style="font-family:'Cairo',Tahoma;font-size:8pt;font-weight:800;color:#000;white-space:nowrap; margin-top:-2px;">
              ÿßŸÑÿ≠ÿ®ÿ© ÿßŸÑÿ´ÿßŸÜŸäÿ©
            </div>
          </div>
        `;
      } else {
        return `
          <div style="${colCenter}">
            ${percentContent}
          </div>
        `;
      }
    }

    // üÜé BOGO / 1+1
    else if (
      safeText.match(/(\d+)\s*(?:\+|plus)\s*(\d+)/) || 
      safeText.match(/buy\s*(\d+)\s*get\s*(\d+)/) || 
      safeText.includes("free")
    ) {
        let x = '1', y = '1';
        
        const plusM = safeText.match(/(\d+)\s*(?:\+|plus)\s*(\d+)/);
        const buyM = safeText.match(/buy\s*(\d+)\s*get\s*(\d+)/);
        const getM = safeText.match(/get\s*(\d+)/);

        if (plusM) { x = plusM[1]; y = plusM[2]; }
        else if (buyM) { x = buyM[1]; y = buyM[2]; }
        else if (getM) { y = getM[1]; }

        return `
        <div style="${colCenter}">
          <div class="print-price-normal" style="
            font-family:'Cairo',sans-serif;
            font-weight:900;
            color:#000;
            margin-bottom:0px;
            line-height: 0.9;
            display: flex;
            align-items: baseline; 
            justify-content: center;
          ">
            <span style="font-size: 20pt !important; color: #333;">${x}</span>
            
            <span style="font-size: 16pt !important; margin: 0 2px; color: #666;">+</span>
            
            <span style="font-size: 34pt !important; color: #000;">${y}</span>
          </div>
          <div style="font-family:'Cairo',Tahoma;font-size:10pt;font-weight:800;color:#dc2626;white-space:nowrap;">
            ŸÖÿ¨ÿßŸÜÿßŸã
          </div>
        </div>
      `;
    }

    // Fallback
    return `
      <div class="print-promo-text" style="font-family:'Cairo',sans-serif;font-weight:900;color:#000;text-align:center;line-height:1.2;font-size:11pt !important;">
        ${(textEN || '').substring(0, 12)}
      </div>
    `;
  }

  // ÿßÿ≥ÿ™ÿØÿπÿßÿ° ÿßŸÑÿØÿßŸÑÿ©
  const circleContent = getCircleContent(offerText) || `<text>Offer</text>`;

  // ÿ®ŸÜÿßÿ° ÿßŸÑŸÉÿßÿ±ÿ™ HTML
  card.innerHTML = `
    <div style="display:flex;justify-content:center;margin-bottom:2mm;">
      <div style="position:relative; width:32mm; height:32mm; overflow:hidden;">
        <svg width="100%" height="100%" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" style="position:absolute; top:0; left:0; z-index:1;">
          <circle cx="50" cy="50" r="46" fill="none" stroke="#059669" stroke-width="8" stroke-opacity="1" paint-order="stroke"/>
        </svg>
        
        <div style="
          position:absolute; 
          top:50%; left:50%; 
          transform: translate(-50%, -50%);
          z-index:2; 
          width:90%; height:90%;
          display:flex; align-items:center; justify-content:center;
        ">
           ${circleContent}
        </div>
      </div>
    </div>

    <div style="text-align:center; padding:0 2mm;">
      <div style="font-size:11pt; margin-bottom:1mm; font-family:Tahoma, sans-serif; font-weight:900; color:#000; direction:rtl; unicode-bidi:plaintext; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
        ${offerTypeAR}
      </div>
      <div style="margin-bottom:0mm; font-size:8pt; color:#666;">${dateRange}</div>
      <div style="height:0.5px; background:#ddd; margin:1.5mm auto; width:80%;"></div>
      <div style="margin-bottom:0.4mm; font-weight:700; font-size:10pt; color:#000; line-height:1.2; white-space:normal; overflow-wrap:anywhere; word-break:break-word;">
        ${offerText}
      </div>
      <div style="margin-bottom:0.4mm; font-weight:700; font-size:11pt; color:#2c3e50;">Brand: ${brandName}</div>
      <div style="font-size:10pt; margin-bottom:1.5mm; direction:rtl; font-family:Tahoma, sans-serif; font-weight:600; color:#34495e;">ÿ®ÿ±ÿßŸÜÿØ: ${brandName}</div>
      <div style="font-size:7pt; color:#888;">Exclusive Offer - ÿπÿ±ÿ∂ ÿ≠ÿµÿ±Ÿä</div>
    </div>
  `;
  
  return card;
}
// ====== 1Ô∏è‚É£4Ô∏è‚É£ ÿØÿßŸÑÿ© ÿßÿ≥ÿ™ÿØÿπÿßÿ° ÿßŸÑŸÖŸàÿØÿßŸÑ ======
function printExclusiveOffers() {
  openBrandSelectionModal();
}

// ========== PRINT LOGIC ==========
// üî• ÿØÿßŸÑÿ© ŸÖÿ≥ÿßÿπÿØÿ© ŸÑÿßŸÜÿ™ÿ∏ÿßÿ± ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸàÿ±
function waitForImagesToLoad(images) {
    return Promise.all(
        Array.from(images).map(img => {
            if (img.complete) return Promise.resolve();
            return new Promise(resolve => {
                img.onload = resolve;
                img.onerror = resolve; // ŸÉŸÖŸÑ ÿ≠ÿ™Ÿâ ŸÑŸà ÿµŸàÿ±ÿ© ŸÅÿ¥ŸÑÿ™ ÿπÿ¥ÿßŸÜ ŸÖÿß ŸÜÿπÿ∑ŸÑÿ¥ ÿßŸÑÿ∑ÿ®ÿßÿπÿ©
            });
        })
    );
}

function startPrintProcess() {
    const container = document.getElementById("printContainer");
    const loader = document.getElementById("printLoader");
    
    // ÿ™ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ŸÉŸàÿßÿØ ÿßŸÑŸÖÿÆÿ™ÿßÿ±ÿ©
    const selectedCheckboxes = document.querySelectorAll('.product-card-checkbox:checked');
    const selectedCodes = Array.from(selectedCheckboxes).map(cb => cb.dataset.code);
    
    let productsToPrint;
    
    if(selectedCodes.length > 0) {
      productsToPrint = (window.currentFilteredProducts || productsDB).filter(p => 
        selectedCodes.includes(p.Code.toString())
      );
      console.log(`üñ®Ô∏è Printing ${productsToPrint.length} selected products`);
    } else {
      productsToPrint = window.currentFilteredProducts || productsDB;
      console.log(`üñ®Ô∏è Printing all ${productsToPrint.length} products`);
    }
    
    container.innerHTML = ""; 
    if(loader) loader.style.display = "flex";
    
    // 1Ô∏è‚É£ ÿ£ŸàŸÑ ÿÆÿ∑Ÿàÿ©: ŸÜŸÜÿ¥ÿ¶ ÿπŸÜÿßÿµÿ± HTML ŸÅŸä ÿßŸÑÿµŸÅÿ≠ÿ©
    renderPrint(productsToPrint);

    // 2Ô∏è‚É£ ÿ™ÿßŸÜŸä ÿÆÿ∑Ÿàÿ©: ŸÜŸÖÿ≥ŸÉ ŸÉŸÑ ÿµŸàÿ± ÿßŸÑŸÄ QR ÿßŸÑŸÑŸä ŸÑÿ≥Ÿá ŸÖÿ≠ÿ∑Ÿàÿ∑ÿ© ÿ≠ÿßŸÑÿß
    const qrImages = container.querySelectorAll('.qr-code-img');

    // 3Ô∏è‚É£ ÿ™ÿßŸÑÿ™ ÿÆÿ∑Ÿàÿ©: ŸÜÿ≥ÿ™ŸÜŸâ ŸÑŸÖÿß ŸÉŸÑŸáŸÖ Ÿäÿ™ÿ≠ŸÖŸÑŸàÿßÿå Ÿàÿ®ÿπÿØŸäŸÜ ŸÜÿ∑ÿ®ÿπ
    waitForImagesToLoad(qrImages).then(() => {
        if(loader) loader.style.display = "none";
        // ÿ™ÿ£ÿÆŸäÿ± ÿ£ÿÆŸäÿ± ÿµÿ∫Ÿäÿ± ÿ¨ÿØÿßŸã (50ms) ŸÑÿ∂ŸÖÿßŸÜ ÿ•ŸÜ ÿßŸÑÿ±ŸÜÿØÿ± ÿÆŸÑÿµ
        setTimeout(() => window.print(), 50);
    });
}
/**
 * ‚úÖ Dr. Mo Print Edition v31.3 - FINAL REFINED VERSION üéØ
 * - ÿßŸÑÿ≠ŸÅÿßÿ∏ ÿπŸÑŸâ ŸÉÿßŸÅÿ© ÿ•ÿ≤ÿßÿ≠ÿßÿ™ ÿßŸÑÿµŸÅŸàŸÅ ŸàÿßŸÑŸÄ QR ŸàŸÉÿßŸÅÿ© ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ.
 * - ÿßŸÑÿ≥ÿπÿ± ŸÑÿß ŸäŸèŸÇÿ±ÿ®: ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑÿµÿ≠Ÿäÿ≠ ŸÉÿ®Ÿäÿ±ÿå ŸàÿßŸÑŸÉÿ≥Ÿàÿ± ÿµÿ∫Ÿäÿ±ÿ© ÿ¨ÿØÿßŸã ÿ®ÿßŸÑÿ£ÿ≥ŸÅŸÑ.
 * - ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ∑ŸÇÿ© ÿ£ŸÖÿßŸÜ (Padding) ŸÑŸÖŸÜÿπ ÿ™ŸÑÿßŸÖÿ≥ ÿ≠ŸàÿßŸÅ ÿßŸÑÿØÿßÿ¶ÿ±ÿ©.
 */

// ==========================================
// 1Ô∏è‚É£ ÿØÿßŸÑÿ© ÿßŸÑÿ±ŸäŸÜÿØÿ± ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ© (Mixed Positioning)
// ==========================================
function renderPrint(filteredProducts) {
  const container = document.getElementById("printContainer");
  const itemsPerPage = 6; 
  const itemsPerRow = 3;
  const fragment = document.createDocumentFragment();
  
  for (let i = 0; i < filteredProducts.length; i += itemsPerPage) {
    const page = document.createElement("div");
    page.className = "print-page";
    
    // ‚úÖ ÿ∂ÿ®ÿ∑ ÿßŸÑÿµŸÅÿ≠ÿ©
    page.style.cssText = "position: relative; height: 296mm; width: 100%; page-break-after: always; overflow: hidden;";
    
    // --- Header ---
    const header = document.createElement("div");
    header.className = "print-header-space";
    page.appendChild(header);
    
    // --- Row 1 (Standard) ---
    const row1 = document.createElement("div");
    row1.className = "print-row";
    // ‚úÖ ÿ•ÿ≤ÿßÿ≠ÿ© ÿßŸÑÿµŸÅ ŸÉÿßŸÖŸÑ ŸÜÿßÿ≠Ÿäÿ© ÿßŸÑŸäŸÖŸäŸÜ ÿ®ŸÄ 4mm (2mm + 2mm ÿ•ÿ∂ÿßŸÅŸäÿ©)
    row1.style.cssText = "display: flex; justify-content: flex-start; gap: 12px; margin-top: -2mm; margin-left: 4mm;"; 

    for (let j = 0; j < itemsPerRow && (i + j) < filteredProducts.length; j++) {
      const card = createPrintCard(filteredProducts[i + j]);
      // ‚úÖ ÿ•ÿ≤ÿßÿ≠ÿ© ÿßŸÑŸÉÿßÿ±ÿ™ ÿßŸÑÿ£ŸàŸÑ ŸÅŸÇÿ∑ ŸÜÿßÿ≠Ÿäÿ© ÿßŸÑŸäŸÖŸäŸÜ ÿ®ŸÄ 2mm ÿ•ÿ∂ÿßŸÅŸäÿ©
      if (j === 0) {
        card.style.marginLeft = "2mm";
      }
      row1.appendChild(card);
    }
    while (row1.children.length < 3) {
      const dummy = document.createElement('div');
      dummy.className = "print-card"; 
      dummy.style.visibility = "hidden";
      row1.appendChild(dummy);
    }
    page.appendChild(row1);
    
    // --- Row 2 (Absolute Bottom) ---
    const row2 = document.createElement("div");
    row2.className = "print-row";
    // ‚úÖ ÿ•ÿ≤ÿßÿ≠ÿ© ÿßŸÑÿµŸÅ ŸÉÿßŸÖŸÑ ŸÜÿßÿ≠Ÿäÿ© ÿßŸÑŸäŸÖŸäŸÜ ÿ®ŸÄ 4mm + ÿ±ŸÅÿπ ŸÑŸÅŸàŸÇ 2mm (ŸÖŸÜ 3mm ÿ•ŸÑŸâ 5mm)
    row2.style.cssText = "position: absolute; bottom: 5mm; left: 0; width: 100%; display: flex; justify-content: flex-start; gap: 12px; z-index: 2; margin-left: 4mm;"; 

    for (let j = 0; j < itemsPerRow && (i + itemsPerRow + j) < filteredProducts.length; j++) {
      const card = createPrintCard(filteredProducts[i + itemsPerRow + j]);
      // ‚úÖ ÿ•ÿ≤ÿßÿ≠ÿ© ÿßŸÑŸÉÿßÿ±ÿ™ ÿßŸÑÿ£ŸàŸÑ ŸÅŸÇÿ∑ ŸÜÿßÿ≠Ÿäÿ© ÿßŸÑŸäŸÖŸäŸÜ ÿ®ŸÄ 2mm ÿ•ÿ∂ÿßŸÅŸäÿ©
      if (j === 0) {
        card.style.marginLeft = "2mm";
      }
      row2.appendChild(card);
    }
    while (row2.children.length < 3) {
      const dummy = document.createElement('div');
      dummy.className = "print-card"; 
      dummy.style.visibility = "hidden";
      row2.appendChild(dummy);
    }
    page.appendChild(row2);
    
    fragment.appendChild(page);
  }
  
  container.innerHTML = '';
  container.appendChild(fragment);
}

// ==========================================
// 2Ô∏è‚É£ ÿØÿßŸÑÿ© ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÉÿßÿ±ÿ™ (Comfortable Spacing)
// ==========================================
function createPrintCard(product) {
  const offer = getOffer(product.Code);
  
  let offerTypeEN = ""; 
  let offerAr = "";
  
  if (offer) {
    offerTypeEN = offer.offerTypeEN || offer.offerType || "";
    offerAr = offer.offerTypeAR || "";
  }
  
  offerAr = offerAr.replace(/(\d+)\s*ÿ±ŸäÿßŸÑ/g, '$1 Ô∑º');

  const options = { month: 'short', day: 'numeric' };
  const startStr = typeof CURRENT_OFFER_START !== 'undefined' ? CURRENT_OFFER_START.toLocaleDateString('en-US', options) : '';
  const endStr = typeof CURRENT_OFFER_END !== 'undefined' ? CURRENT_OFFER_END.toLocaleDateString('en-US', options) : '';
  const dateRange = `${startStr} - ${endStr}`;

  let categoryName = product["Category Level D"] || "";
  let nameAr = product["ÿ£ÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ™ÿ¨"] || ""; 

  const RIYAL_SVG_URL = "https://www.sama.gov.sa/ar-sa/Currency/Documents/Saudi_Riyal_Symbol-2.svg";
  const riyalImg = `<img class="riyal-symbol-img" src="${RIYAL_SVG_URL}" alt="SAR" style="width: 14px; height: 14px; margin-right: 3px; margin-bottom: 2px;" />`;

  function convertArabicNumbersToWestern(text) {
    if(!text) return "";
    const arabicNums = ['Ÿ†','Ÿ°','Ÿ¢','Ÿ£','Ÿ§','Ÿ•','Ÿ¶','Ÿß','Ÿ®','Ÿ©'];
    const westernNums = ['0','1','2','3','4','5','6','7','8','9'];
    return text.replace(/[Ÿ†-Ÿ©]/g, m => westernNums[arabicNums.indexOf(m)]);
  }

  function getCircleContent(offerEN, offerAR) {
    const fullText = `${offerEN || ''} ${offerAR || ''}`.trim();
    if (!fullText) return null;

    const safeText = convertArabicNumbersToWestern(fullText.toLowerCase());
    // ‚úÖ ÿ≤ŸäÿßÿØÿ© ÿßŸÑŸÄ padding ŸÑÿ∂ŸÖÿßŸÜ ÿπÿØŸÖ ŸÖŸÑÿßŸÖÿ≥ÿ© ÿßŸÑÿ≠ŸàÿßŸÅ
    const colCenter = `display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;height:100%;padding:14%;box-sizing:border-box;`;
    const rowBottom = `display:flex;align-items:baseline;justify-content:center;width:100%;`;

    const isSecondPiece = safeText.includes("buy 1 get 1") || safeText.includes("2nd") || safeText.includes("sec") || safeText.includes("second") || safeText.includes("ÿßŸÑÿ´ÿßŸÜŸäÿ©") || safeText.includes("get 1");
    const hasFreeWord = /(?:free|ŸÖÿ¨ÿßŸÜ)/i.test(safeText);

    const percentMatch = safeText.match(/(\d{1,3})\s*%/);
    const priceMatch = safeText.match(/(?:@|sar|rs|ÿ±ŸäÿßŸÑ)\s*(\d+(?:\.\d+)?)/i) || safeText.match(/(\d+(?:\.\d+)?)\s*(?:sar|rs|ÿ±ŸäÿßŸÑ)/i);

    // --- ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ≥ÿπÿ± (Price) ---
    if (priceMatch && !safeText.includes("%")) {
      const priceRaw = priceMatch[1]; 
      const parts = priceRaw.split('.');
      const mainPrice = parts[0]; 
      const decimalPart = parts[1] ? parts[1].substring(0, 2) : null; 

      let fontSize = '34pt'; 
      if(mainPrice.length >= 3) fontSize = '24pt';
      if(mainPrice.length >= 4) fontSize = '18pt';

      let arabicLine = "";
      if (isSecondPiece) arabicLine = "ÿßŸÑÿ≠ÿ®ÿ© ÿßŸÑÿ´ÿßŸÜŸäÿ©";
      else if (safeText.includes("buy 2") || safeText.includes("2 pcs")) arabicLine = "ÿßŸÑÿ≠ÿ®ÿ™ŸäŸÜ";
      else arabicLine = "ÿßŸÑÿ≠ÿ®ÿ©";

      return `
        <div style="${colCenter}">
          <div style="${rowBottom}">
            <div style="display:flex; margin-bottom: 2px;">${riyalImg}</div>
            <span style="font-family:'Roboto',Arial; font-weight:900; color:#000; font-size:${fontSize} !important; line-height:0.8; letter-spacing:-1px; display:flex; align-items:baseline;">
              ${mainPrice}
              ${decimalPart ? `<span style="font-size: 0.25em; margin-left: 0.5px; font-weight:800; color:#333;">.${decimalPart}</span>` : ''}
            </span>
          </div>
          ${arabicLine ? `<div style="font-family:'Cairo',Tahoma;font-size:8pt;font-weight:800;color:#059669;white-space:nowrap; margin-top: 4px;">${arabicLine}</div>` : ''}
        </div>
      `;
    }
    // --- ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑŸÜÿ≥ÿ®ÿ© ÿßŸÑŸÖÿ¶ŸàŸäÿ© (Percent) ---
    else if (percentMatch) {
      const percent = percentMatch[1];
      const percentContent = `
        <div style="display: flex; align-items: baseline; justify-content: center; line-height: 1;">
          <span class="print-price-bold" style="font-family:'Roboto',Arial;font-weight:900;color:#000;font-size:32pt !important; letter-spacing: -1px;">${percent}</span>
          <span style="font-size: 14pt; font-weight: 900; margin-left: 2px; color: #000;">%</span>
        </div>
      `;
      return `
        <div style="${colCenter}">
          ${percentContent}
          ${isSecondPiece ? `<div style="font-family:'Cairo',Tahoma;font-size:8pt;font-weight:800;color:#000;white-space:nowrap; margin-top:2px;">ÿßŸÑÿ≠ÿ®ÿ© ÿßŸÑÿ´ÿßŸÜŸäÿ©</div>` : ''}
        </div>
      `;
    } 
    // --- ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑŸÄ BOGO ŸàÿßŸÑÿπÿ±Ÿàÿ∂ ÿßŸÑÿ£ÿÆÿ±Ÿâ ---
    else if (safeText.match(/(\d+)\s*(?:pcs?|pc)?\s*(?:\+|plus)\s*(\d+)/) || safeText.match(/buy\s*(\d+)\s*get\s*(\d+)/) || safeText.includes("free") || hasFreeWord) {
        let x = '1', y = '1';
        const plusM = safeText.match(/(\d+)\s*(?:pcs?|pc)?\s*(?:\+|plus)\s*(\d+)/);
        const buyM = safeText.match(/buy\s*(\d+)\s*get\s*(\d+)/);
        const getM = safeText.match(/get\s*(\d+)/);
        if (plusM) { x = plusM[1]; y = plusM[2]; } else if (buyM) { x = buyM[1]; y = buyM[2]; } else if (getM) { y = getM[1]; }

        return `
        <div style="${colCenter}">
          <div class="print-price-normal" style="font-family:'Cairo',sans-serif;font-weight:900;color:#000;margin-bottom:0px;line-height: 0.9;display: flex;align-items: baseline; justify-content: center;">
            <span style="font-size: 20pt !important; color: #333;">${x}</span>
            <span style="font-size: 16pt !important; margin: 0 2px; color: #666;">+</span>
            <span style="font-size: 34pt !important; color: #000;">${y}</span>
          </div>
          <div style="font-family:'Cairo',Tahoma;font-size:10pt;font-weight:800;color:#dc2626;white-space:nowrap;">ŸÖÿ¨ÿßŸÜÿßŸã</div>
        </div>
      `;
    }
    return `<div class="print-promo-text" style="font-family:'Cairo',sans-serif;font-weight:900;color:#000;text-align:center;line-height:1.2;font-size:11pt !important;">${(offerAr || offerTypeEN).substring(0, 12)}</div>`;
  }

  const circleContent = getCircleContent(offerTypeEN, offerAr) || `<text>Offer</text>`;

  const productUrl = `https://www.al-dawaa.com/en/p/${product.Code}`;
  const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(productUrl)}`;

  const card = document.createElement("div");
  card.className = "print-card";
  
  card.innerHTML = `
    <div style="display:flex;justify-content:center;margin-bottom:1mm;">
      <div style="position:relative; width:32mm; height:32mm; overflow:hidden;">
        <svg width="100%" height="100%" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" style="position:absolute;top:0;left:0;z-index:1;">
          <circle cx="50" cy="50" r="46" fill="none" stroke="#059669" stroke-width="8" stroke-opacity="1" paint-order="stroke"/>
        </svg>
        <div style="position:absolute; top:50%; left:50%; transform: translate(-50%, -50%); z-index:2; width:100%; height:100%; display:flex; align-items:center; justify-content:center;">
           ${circleContent}
        </div>
      </div>
    </div>

    <div style="text-align:center; padding:0 2px; width: 100%; box-sizing: border-box;">
      <div style="font-size:11pt; margin-bottom:5px; font-family:Tahoma,sans-serif; font-weight:900; color:#000; direction:rtl; unicode-bidi:plaintext; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; line-height: 1.2;">
        ${offerAr}
      </div>
      <div style="font-size:8pt; margin-bottom:5px; color:#0284c7; font-weight:600; letter-spacing:0.5px; line-height: 1.2;">
        ${offerTypeEN}
      </div>
      <div style="margin-bottom:5px; font-size:8pt; color:#666; line-height: 1.2;">
        ${dateRange}
      </div>
      <div style="height:0.5px; background:#ddd; margin:4px auto; width:80%;"></div>
      <div style="margin: 0 auto; margin-bottom: 5px; font-weight: 700; font-size: 9pt; color: #000; line-height: 1.2; width: 100%; white-space: nowrap !important; overflow: hidden !important; text-overflow: ellipsis; display: block;">
        ${product["Item Description"]}
      </div>
      <div style="margin: 0 auto; margin-bottom: 5px; font-size: 9pt; direction: rtl; font-family: Tahoma, sans-serif; font-weight: 500; color: #333; line-height: 1.2; width: 100%; white-space: nowrap !important; overflow: hidden !important; text-overflow: ellipsis; display: block;">
        ${nameAr}
      </div>
      <div style="font-size:7pt; color:#888; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-top:4px; line-height: 1.2;">
        ${product.Code} - ${categoryName}
      </div>
      <div style="display:flex; justify-content:center; align-items:center; margin-top:5px;">
        <img src="${qrCodeUrl}" class="qr-code-img" alt="QR Code" style="width:32px; height:32px; display:block;" />
      </div>
    </div>
  `;
  
  return card;
}

// ========== FILTERS - FIXED VERSION ==========
function initializeFilters() {
  const productsWithOffers = productsDB.filter(p => getOffer(p.Code) !== undefined);
  
  const brands = new Set();
  const manufactures = new Set();
  const catAs = new Set();
  const catBs = new Set();
  const classes = new Set();
  const catCs = new Set();
  const catDs = new Set();
  const types = new Set(offersDB.map(o => o.offerType));
  
  productsWithOffers.forEach(p => {
    if(p.Brand) brands.add(p.Brand);
    if(p.Manufacture) manufactures.add(p.Manufacture);
    if(p["Category Level A"]) catAs.add(p["Category Level A"]);
    if(p["Category Level B"]) catBs.add(p["Category Level B"]);
    if(p["Item Class"]) classes.add(p["Item Class"]);
    if(p["Category Level C"]) catCs.add(p["Category Level C"]);
    if(p["Category Level D"]) catDs.add(p["Category Level D"]);
  });
  
  function fill(name, set) {
    const customSelect = document.querySelector(`.custom-select[data-filter="${name}"]`);
    const el = customSelect ? customSelect.querySelector('.custom-options-list') : null;
    if(!el) return;
    
    const parentContainer = customSelect ? customSelect.parentElement : null;
    
    if(set.size === 0) {
      if(parentContainer) {
        parentContainer.style.display = 'none';
      } else if(customSelect) {
        customSelect.style.display = 'none';
      }
      return;
    } else {
      if(parentContainer) {
        parentContainer.style.display = '';
      } else if(customSelect) {
        customSelect.style.display = '';
      }
    }
    
    const items = Array.from(set).sort();
    const fragment = document.createDocumentFragment();
    items.forEach(i => {
      const div = document.createElement('div');
      div.className = 'custom-option';
      div.innerHTML = `<input type="checkbox" value="${i}"><span>${i}</span>`;
      fragment.appendChild(div);
    });
    el.appendChild(fragment);
  }
  
  fill('brandFilter', brands);
  fill('manufactureFilter', manufactures);
  fill('offerFilter', types);
  fill('categoryAFilter', catAs);
  fill('categoryBFilter', catBs);
  fill('itemClassFilter', classes);
  fill('categoryCFilter', catCs);
  fill('categoryDFilter', catDs);
  
  // ‚úÖ Activate search for all filters
  FILTER_CONFIGS.forEach(cfg => {
    activateExistingSearch(cfg.dataFilter);
  });
  
  console.log('‚úÖ Filters initialized');
}

// ====== üîç FILTER SEARCH - FIXED & SIMPLE ======
function activateExistingSearch(filterName) {
  const customSelect = document.querySelector(`.custom-select[data-filter="${filterName}"]`);
  if (!customSelect) return;
  
  const searchInput = customSelect.querySelector('input[type="text"]');
  const optionsList = customSelect.querySelector('.custom-options-list');
  
  if (!searchInput || !optionsList) return;
  
  // ‚úÖ Clone to remove old listeners
  const newInput = searchInput.cloneNode(true);
  searchInput.parentNode.replaceChild(newInput, searchInput);
  
  // ‚úÖ Prevent dropdown close
  newInput.addEventListener('click', e => e.stopPropagation());
  newInput.addEventListener('mousedown', e => e.stopPropagation());
  
  // ‚úÖ SEARCH - Force display with !important
  newInput.addEventListener('input', function(e) {
    const searchTerm = this.value.toLowerCase().trim();
    const allOptions = optionsList.querySelectorAll('.custom-option');
    
    let visibleCount = 0;
    
    allOptions.forEach(option => {
      const text = option.textContent.toLowerCase();
      
      if (searchTerm === '' || text.includes(searchTerm)) {
        // ‚úÖ SHOW - Force with cssText
        option.style.cssText = 'display: flex !important; visibility: visible !important; opacity: 1 !important;';
        visibleCount++;
      } else {
        // ‚úÖ HIDE - Force with cssText
        option.style.cssText = 'display: none !important;';
      }
    });
    
    console.log(`üîç "${searchTerm}" in ${filterName}: ${visibleCount} visible`);
  });
  
  // ‚úÖ Reset on close
  customSelect.addEventListener('filterClosed', () => {
    newInput.value = '';
    optionsList.querySelectorAll('.custom-option').forEach(opt => {
      opt.style.cssText = 'display: flex !important; visibility: visible !important; opacity: 1 !important;';
    });
  }, { once: false });
}

// ====== üîÑ RESET SINGLE FILTER ======
function resetFilter(filterName) {
  console.log('üîÑ Resetting:', filterName);
  
  const filterEl = document.querySelector(`.custom-select[data-filter="${filterName}"]`);
  if (!filterEl) {
    console.warn('‚ùå Filter not found:', filterName);
    return;
  }

  // ‚úÖ Uncheck all
  const checkboxes = filterEl.querySelectorAll('.custom-options-list input[type="checkbox"]');
  checkboxes.forEach(cb => {
    cb.checked = false;
  });

  // ‚úÖ Update display text
  const textEl = filterEl.querySelector('.selected-text');
  const defaults = {
    offerFilter: 'All Offers',
    brandFilter: 'All Brands',
    manufactureFilter: 'All Manufactures',
    categoryAFilter: 'All Cat A',
    categoryBFilter: 'All Cat B',
    itemClassFilter: 'All Classes',
    categoryCFilter: 'All C',
    categoryDFilter: 'All D'
  };
  
  if (textEl) {
    textEl.textContent = defaults[filterName] || 'All';
  }

  // ‚úÖ Refresh
  applyFilters();
  
  console.log('‚úÖ Reset done:', filterName);
}

// ====== üóëÔ∏è CLEAR ALL FILTERS ======
function clearAllFilters() {
  // ‚úÖ Uncheck all checkboxes
  document.querySelectorAll('.custom-select input[type="checkbox"]').forEach(checkbox => {
    checkbox.checked = false;
  });
  
  // ‚úÖ Clear global search
  const globalSearch = document.getElementById('globalSearch');
  if(globalSearch) globalSearch.value = '';
  
  // ‚úÖ Clear filter searches
  document.querySelectorAll('.filter-search-input, .custom-select input[type="text"]').forEach(input => {
    if(input.id !== 'globalSearch') {
      input.value = '';
    }
  });
  
  // ‚úÖ Show all options
  document.querySelectorAll('.custom-option').forEach(option => {
    option.style.cssText = 'display: flex !important; visibility: visible !important;';
  });
  
  hideSuggestions();
  applyFilters();
  
  console.log('‚úÖ All filters cleared');
}

// ====== üñ±Ô∏è DROPDOWN CLICK HANDLERS ======
document.addEventListener('click', function(e) {
  if (e.target.closest('.custom-select-trigger')) {
    e.stopPropagation();
    const sel = e.target.closest('.custom-select');
    const open = sel.classList.contains('open');
    
    // ‚úÖ Close all dropdowns
    document.querySelectorAll('.custom-select').forEach(s => {
      if(s.classList.contains('open')) {
        s.dispatchEvent(new Event('filterClosed'));
      }
      s.classList.remove('open');
    });
    
    // ‚úÖ Open clicked dropdown
    if (!open) sel.classList.add('open');
    
  } else if (!e.target.closest('.custom-select-options')) {
    // ‚úÖ Click outside - close all
    const hadOpen = document.querySelector('.custom-select.open');
    
    document.querySelectorAll('.custom-select').forEach(s => {
      if(s.classList.contains('open')) {
        s.dispatchEvent(new Event('filterClosed'));
      }
      s.classList.remove('open');
    });
    
    // ‚úÖ Apply filters if something was open
    if (hadOpen) {
      applyFilters();
    }
  }
});

// ====== ‚úÖ CHECKBOX TOGGLE ======
document.querySelectorAll('.custom-select').forEach(sel => {
  const list = sel.querySelector('.custom-options-list');
  if(list) {
    list.addEventListener('click', e => {
      e.stopPropagation();
      const opt = e.target.closest('.custom-option');
      if(!opt) return;
      
      const chk = opt.querySelector('input[type="checkbox"]');
      if(chk) {
        chk.checked = !chk.checked;
        console.log('‚úÖ Toggled:', chk.value, '‚Üí', chk.checked);
      }
    });
  }
});

// ====== üîç APPLY FILTERS (30 ITEMS INITIAL LOAD) ======
function applyFilters() {
  const globalSearchEl = document.getElementById('globalSearch');
  
  const filters = {
    offerType: getSelectedValues('offerFilter'),
    brand: getSelectedValues('brandFilter'),
    manufacture: getSelectedValues('manufactureFilter'),
    categoryA: getSelectedValues('categoryAFilter'),
    categoryB: getSelectedValues('categoryBFilter'),
    itemClass: getSelectedValues('itemClassFilter'),
    categoryC: getSelectedValues('categoryCFilter'),
    categoryD: getSelectedValues('categoryDFilter'),
    searchTerm: globalSearchEl ? globalSearchEl.value.trim() : ''
  };
  
  console.log('üîç Applying filters:', filters);
  
  // üî• CHECK IF INITIAL LOAD (NO FILTERS)
  const isInitialLoad = !filters.searchTerm && 
                       !filters.offerType?.length && 
                       !filters.brand?.length && 
                       !filters.manufacture?.length && 
                       !filters.categoryA?.length && 
                       !filters.categoryB?.length && 
                       !filters.itemClass?.length && 
                       !filters.categoryC?.length && 
                       !filters.categoryD?.length;

  if (isInitialLoad) {
    // üöÄ INITIAL: 30 ITEMS ONLY + Load All Button
    console.log('üöÄ Initial Load: 30 items FAST!');
    
    // ŸÖÿ±ÿ± flag ŸÑŸÑŸÄ renderProducts ÿπÿ¥ÿßŸÜ Ÿäÿπÿ±ŸÅ ÿ•ŸÜŸá initial
    renderProducts({...filters, limit: 30, isInitial: true});
    return;
  } else {
    // ‚úÖ FILTERED: Full results
    console.log('‚úÖ Filter Applied: Full results');
    renderProducts(filters);
  }
}

// ========== COUNTDOWN TIMER ==========
function updateCountdown() {
  const now = Date.now();
  const startTime = CURRENT_OFFER_START.getTime();
  const endTime = CURRENT_OFFER_END.getTime();
  
  // 1. ŸáŸÜÿß ÿ®ŸÜŸÖÿ≥ŸÉ ÿßŸÑÿπŸÜÿßÿµÿ±
  const containerEl = document.querySelector('.countdown-container'); // ÿ™ÿ£ŸÉÿØ ÿ•ŸÜ ÿØŸá ÿßŸÑŸÉŸÑÿßÿ≥ ÿ®ÿ™ÿßÿπ ÿßŸÑÿµŸÜÿØŸàŸÇ ÿßŸÑŸÉÿ®Ÿäÿ±
  const titleEl = document.getElementById('countdownTitle');
  const daysEl = document.getElementById('days');
  const hoursEl = document.getElementById('hours');
  const minutesEl = document.getElementById('minutes');
  const secondsEl = document.getElementById('seconds');
  
  if (!titleEl || !daysEl || !hoursEl || !minutesEl || !secondsEl) {
    return;
  }
  
  // ÿØÿßŸÑÿ© ŸÖÿ≥ÿßÿπÿØÿ© ŸÑŸÑÿ™ÿ≠ŸÉŸÖ ŸÅŸä ÿßŸÑÿ∏ŸáŸàÿ±
  const setVisibility = (element, visible) => {
    if (element && element.parentElement) {
      element.parentElement.style.display = visible ? '' : 'none';
    }
  };

  // ============================================
  // ÿßŸÑÿ≠ÿßŸÑÿ© ÿßŸÑÿ£ŸàŸÑŸâ: ÿßŸÑÿπÿ±ÿ∂ ŸÑŸÖ Ÿäÿ®ÿØÿ£ ÿ®ÿπÿØ (ÿ£ŸäÿßŸÖ ŸÅŸÇÿ∑ + ÿÆŸÑŸÅŸäÿ© ÿ≠ŸÖÿ±ÿßÿ°)
  // ============================================
  if (now < startTime) {
    const diff = startTime - now;
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    
    const options = { month: 'long', day: 'numeric', year: 'numeric' };
    const startDateStr = CURRENT_OFFER_START.toLocaleDateString('ar-EG', options);
    
    titleEl.innerHTML = `‚è∞ ÿßŸÑÿπÿ±ÿ∂ ŸÑŸÖ Ÿäÿ®ÿØÿ£ ÿ®ÿπÿØ<br><span style="font-size: 0.7em; color: #ffd700;">üéØ Ÿäÿ®ÿØÿ£ ŸÅŸä: ${startDateStr}</span>`;
    
    daysEl.textContent = String(days).padStart(2, '0');
    
    // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑÿ≥ÿßÿπÿßÿ™ ŸàÿßŸÑÿØŸÇÿßÿ¶ŸÇ ŸàÿßŸÑÿ´ŸàÿßŸÜŸä
    setVisibility(daysEl, true);
    setVisibility(hoursEl, false);
    setVisibility(minutesEl, false);
    setVisibility(secondsEl, false);
    
    // >> ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿÆŸÑŸÅŸäÿ© ŸÑŸÑŸàŸÜ ÿ£ÿ≠ŸÖÿ± ŸÖŸÖŸäÿ≤ <<
    if (containerEl) {
        // ŸÑŸàŸÜ ÿ£ÿ≠ŸÖÿ± ÿ∫ÿßŸÖŸÇ ŸäŸÑŸäŸÇ ÿ®ÿßŸÑÿ´ŸäŸÖ ÿßŸÑÿØÿßÿ±ŸÉ
        containerEl.style.backgroundColor = '#4a0f0f'; 
        // ÿ£Ÿà ŸÖŸÖŸÉŸÜ ÿ™ÿπŸÖŸÑ ÿ≠ÿØŸàÿØ ÿ≠ŸÖÿ±ÿßÿ° ŸÑŸà ÿ≠ÿßÿ®ÿ®:
        // containerEl.style.border = '2px solid #ff4444';
    }
    
    return;
  }
  
  // ============================================
  // ÿßŸÑÿ≠ÿßŸÑÿ© ÿßŸÑÿ´ÿßŸÜŸäÿ©: ÿßŸÑÿπÿ±ÿ∂ ÿ¥ÿ∫ÿßŸÑ (ÿßŸÑÿπÿØÿßÿØ ŸÉÿßŸÖŸÑ + ÿÆŸÑŸÅŸäÿ© ÿ∑ÿ®ŸäÿπŸäÿ©)
  // ============================================
  if (now >= startTime && now < endTime) {
    const diff = endTime - now;
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
    
    titleEl.innerHTML = 'üî• ÿ®ÿßŸÇŸä ÿπŸÑŸâ ÿßŸÜÿ™Ÿáÿßÿ° ÿßŸÑÿπÿ±ÿ∂ <span style="font-size: 0.8em; color: #ffd700;">‚è∞ Hurry Up!</span>';
    
    // ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑŸÉŸÑ
    setVisibility(daysEl, true);
    setVisibility(hoursEl, true);
    setVisibility(minutesEl, true);
    setVisibility(secondsEl, true);

    daysEl.textContent = String(days).padStart(2, '0');
    hoursEl.textContent = String(hours).padStart(2, '0');
    minutesEl.textContent = String(minutes).padStart(2, '0');
    secondsEl.textContent = String(seconds).padStart(2, '0');

    // >> ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑÿÆŸÑŸÅŸäÿ© ÿßŸÑÿ≠ŸÖÿ±ÿßÿ° (ÿ•ÿ±ÿ¨ÿßÿπŸáÿß ŸÑŸÑÿ¥ŸÅÿßŸÅ ÿ£Ÿà ÿßŸÑÿ£ÿµŸÑ) <<
    if (containerEl) {
        containerEl.style.backgroundColor = ''; 
        // containerEl.style.border = '';
    }

    return;
  }
  
  // ============================================
  // ÿßŸÑÿ≠ÿßŸÑÿ© ÿßŸÑÿ´ÿßŸÑÿ´ÿ©: ÿßŸÜÿ™ŸáŸâ ÿßŸÑÿπÿ±ÿ∂
  // ============================================
  titleEl.innerHTML = '‚è∞ ÿßŸÜÿ™ŸáŸâ ÿßŸÑÿπÿ±ÿ∂ <span style="font-size: 0.8em; color: #999;">Offer Ended</span>';
  
  setVisibility(daysEl, true);
  setVisibility(hoursEl, true);
  setVisibility(minutesEl, true);
  setVisibility(secondsEl, true);
  
  // ŸÜÿ™ÿ£ŸÉÿØ ÿ•ŸÜ ÿßŸÑÿÆŸÑŸÅŸäÿ© ÿ∑ÿ®ŸäÿπŸäÿ© ÿ®ÿ±ÿ∂Ÿà ŸáŸÜÿß
  if (containerEl) {
      containerEl.style.backgroundColor = ''; 
  }

  daysEl.textContent = '00';
  hoursEl.textContent = '00';
  minutesEl.textContent = '00';
  secondsEl.textContent = '00';
}
function updateDatesInHTML() {
  const options = { month: 'short', day: 'numeric', year: 'numeric' };
  
  const dateBoxes = document.querySelectorAll('.date-box .date-value');
  if(dateBoxes.length >= 2) {
    dateBoxes[0].textContent = CURRENT_OFFER_START.toLocaleDateString('en-US', options);
    dateBoxes[1].textContent = CURRENT_OFFER_END.toLocaleDateString('en-US', options);
  }
  
  const nextOffersBox = document.querySelector('.next-offers-box');
  if(nextOffersBox) {
    nextOffersBox.onclick = function() { 
      window.location.href = NEXT_OFFER_LINK; 
    };
  }
}

// ========== THEME SWITCHER ==========
const toggleSwitch = document.querySelector('.theme-switch input[type="checkbox"]');
if(toggleSwitch) {
  function switchTheme(e) {
    const theme = e.target.checked ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', light);
    localStorage.setItem('theme', theme);
    console.log(`üé® Theme: ${theme}`);
  }
  toggleSwitch.addEventListener('change', switchTheme);
  const currentTheme = localStorage.getItem('theme') || 'light';
  document.documentElement.setAttribute('data-theme', currentTheme);
  toggleSwitch.checked = (currentTheme === 'light');
}

// ====== üçé IOS DETECTION ======
const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

if (isIOS || isSafari) {
  console.log('üçé iOS/Safari detected - applying fixes');
  document.body.classList.add('ios-device');
}
// ====== üîº BACK TO TOP FUNCTIONALITY ======
const backToTopBtn = document.getElementById('backToTopBtn');

// ÿ•ÿ∏Ÿáÿßÿ±/ÿ•ÿÆŸÅÿßÿ° ÿßŸÑÿ≤ÿ±ÿßÿ± ÿπŸÜÿØ ÿßŸÑÿ≥ŸÉÿ±ŸàŸÑ
window.addEventListener('scroll', () => {
  if (window.pageYOffset > 300) {
    backToTopBtn.classList.add('show');
  } else {
    backToTopBtn.classList.remove('show');
  }
});

// Ÿàÿ∏ŸäŸÅÿ© ÿßŸÑÿ±ÿ¨Ÿàÿπ ŸÑÿ£ÿπŸÑŸâ ÿßŸÑÿµŸÅÿ≠ÿ©
function scrollToTop() {
  window.scrollTo({
    top: 0,
    behavior: 'smooth'
  });
  console.log('üîº Scrolled to top');
}

// Alternative: Smooth scroll with animation
function scrollToTopAnimated() {
  const scrollStep = -window.scrollY / (500 / 15);
  const scrollInterval = setInterval(() => {
    if (window.scrollY !== 0) {
      window.scrollBy(0, scrollStep);
    } else {
      clearInterval(scrollInterval);
    }
  }, 15);
}
// ====== üåô FORCE DARK MODE TEXT FIX - ULTIMATE SOLUTION ======
function applyDarkModeTextFix() {
  const isDark = document.body.classList.contains('dark-mode') || 
                 document.body.getAttribute('data-theme') === 'dark';
  
  if (isDark) {
    // Fix ALL labels in checkboxes
    const allLabels = document.querySelectorAll(
      '.checkbox-item label, ' +
      '.filter-checkbox-label, ' +
      '.brand-checkbox-list label, ' +
      '.manufacture-checkbox-list label, ' +
      '.custom-option span'
    );
    
    allLabels.forEach(label => {
      label.style.setProperty('color', '#f9fafb', 'important');
      label.style.setProperty('font-weight', '500', 'important');
      label.style.setProperty('text-shadow', '0 1px 3px rgba(0,0,0,0.5)', 'important');
    });
    
    // Fix search inputs
    const inputs = document.querySelectorAll(
      'input[type="text"], ' +
      '.brand-search-input, ' +
      '.manufacture-search-input'
    );
    
    inputs.forEach(input => {
      input.style.setProperty('background', '#374151', 'important');
      input.style.setProperty('color', '#f9fafb', 'important');
      input.style.setProperty('border-color', '#4b5563', 'important');
    });
    
    // Fix checkbox items
    const checkboxItems = document.querySelectorAll('.checkbox-item');
    checkboxItems.forEach(item => {
      item.style.setProperty('background', 'rgba(55, 65, 81, 0.2)', 'important');
    });
    
    console.log('üåô Dark mode text forced: ' + allLabels.length + ' labels fixed');
  }
}

// Apply on page load
window.addEventListener('DOMContentLoaded', function() {
  setTimeout(applyDarkModeTextFix, 500);
});

// Apply on theme change - UPDATE YOUR toggleTheme function
function toggleTheme() {
  isDarkMode = !isDarkMode;
  document.body.classList.toggle('dark-mode', isDarkMode);
  
  if (isDarkMode) {
    document.body.setAttribute('data-theme', 'dark');
  } else {
    document.body.setAttribute('data-theme', 'light');
  }
  
  updateThemeIcon();
  localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
  
  // Force fix after theme change
  setTimeout(applyDarkModeTextFix, 200);
  
  console.log('üé® Theme:', isDarkMode ? 'Dark Mode üåô' : 'Light Mode ‚òÄÔ∏è');
}

// Apply when filters update - UPDATE YOUR populateBrandCheckboxes
function populateBrandCheckboxes(brands) {
  const container = document.getElementById('brandCheckboxList');
  if(!container) return;
  
  container.innerHTML = '';
  brands.forEach(brand => {
    const div = document.createElement('div');
    div.className = 'checkbox-item';
    
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.id = `brand-${brand}`;
    checkbox.value = brand;
    checkbox.checked = selectedBrands.includes(brand);
    checkbox.addEventListener('change', handleBrandChange);
    
    const label = document.createElement('label');
    label.htmlFor = `brand-${brand}`;
    label.className = 'filter-checkbox-label';
    label.textContent = brand;
    
    div.appendChild(checkbox);
    div.appendChild(label);
    container.appendChild(div);
  });
  
  // Force fix
  setTimeout(applyDarkModeTextFix, 100);
}

// Apply when manufacture filters update - UPDATE YOUR populateManufactureCheckboxes
function populateManufactureCheckboxes(manufactures) {
  const container = document.getElementById('manufactureCheckboxList');
  if(!container) return;
  
  container.innerHTML = '';
  manufactures.forEach(manufacture => {
    const div = document.createElement('div');
    div.className = 'checkbox-item';
    
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.id = `manufacture-${manufacture}`;
    checkbox.value = manufacture;
    checkbox.checked = selectedManufactures.includes(manufacture);
    checkbox.addEventListener('change', handleManufactureChange);
    
    const label = document.createElement('label');
    label.htmlFor = `manufacture-${manufacture}`;
    label.className = 'filter-checkbox-label';
    label.textContent = manufacture;
    
    div.appendChild(checkbox);
    div.appendChild(label);
    container.appendChild(div);
  });
  
  // Force fix
  setTimeout(applyDarkModeTextFix, 100);
}

// Watch for DOM changes
const observer = new MutationObserver(function(mutations) {
  mutations.forEach(function(mutation) {
    if (mutation.addedNodes.length > 0) {
      setTimeout(applyDarkModeTextFix, 50);
    }
  });
});

// Start observing
document.addEventListener('DOMContentLoaded', function() {
  const brandList = document.getElementById('brandCheckboxList');
  const manufactureList = document.getElementById('manufactureCheckboxList');
  
  if (brandList) {
    observer.observe(brandList, { childList: true, subtree: true });
  }
  
  if (manufactureList) {
    observer.observe(manufactureList, { childList: true, subtree: true });
  }
  
  console.log('üëÄ DOM observer started for filter lists');
});
// ====== üåô ULTIMATE FIX - FORCE WHITE TEXT ON DARK MODE ======
function forceFixDarkModeLabels() {
  const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
  
  if (isDark) {
    // Get ALL labels in checkbox containers
    const allLabels = document.querySelectorAll(
      '.checkbox-item label, ' +
      '.brand-checkbox-list label, ' +
      '.manufacture-checkbox-list label, ' +
      'label.filter-checkbox-label'
    );
    
    allLabels.forEach(label => {
      label.style.color = '#ffffff';
      label.style.fontWeight = '500';
      label.style.textShadow = '0 2px 4px rgba(0,0,0,0.8)';
      label.style.webkitTextFillColor = '#ffffff';
    });
    
    console.log(`üåô Fixed ${allLabels.length} labels in dark mode`);
  }
}

// Run immediately
forceFixDarkModeLabels();

// Run after 500ms (for dynamic content)
setTimeout(forceFixDarkModeLabels, 500);

// Run whenever brand/manufacture list is populated
const originalPopulateBrands = populateBrandCheckboxes;
populateBrandCheckboxes = function(brands) {
  originalPopulateBrands.call(this, brands);
  setTimeout(forceFixDarkModeLabels, 100);
};

const originalPopulateManufactures = populateManufactureCheckboxes;
populateManufactureCheckboxes = function(manufactures) {
  originalPopulateManufactures.call(this, manufactures);
  setTimeout(forceFixDarkModeLabels, 100);
};

// Watch for theme changes
const themeObserver = new MutationObserver((mutations) => {
  mutations.forEach((mutation) => {
    if (mutation.attributeName === 'data-theme') {
      setTimeout(forceFixDarkModeLabels, 100);
    }
  });
});

themeObserver.observe(document.documentElement, {
  attributes: true,
  attributeFilter: ['data-theme']
});

// Watch for new checkboxes added
const checkboxObserver = new MutationObserver(() => {
  if (document.documentElement.getAttribute('data-theme') === 'dark') {
    forceFixDarkModeLabels();
  }
});

document.addEventListener('DOMContentLoaded', function() {
  const brandList = document.getElementById('brandCheckboxList');
  const manufactureList = document.getElementById('manufactureCheckboxList');
  
  if (brandList) {
    checkboxObserver.observe(brandList, { 
      childList: true, 
      subtree: true 
    });
  }
  
  if (manufactureList) {
    checkboxObserver.observe(manufactureList, { 
      childList: true, 
      subtree: true 
    });
  }
  
  // Force fix on load
  setTimeout(forceFixDarkModeLabels, 300);
});
// ====== üî• HIDE BRIEF MODE BUTTON ======
document.addEventListener('DOMContentLoaded', function() {
  const briefBtn = document.getElementById('briefModeBtn');
  if (briefBtn) {
    briefBtn.style.display = 'none';
    console.log('‚úÖ Brief Mode button hidden');
  }
  
  // ÿ£Ÿà ŸÑŸà ÿßŸÑÿ≤ÿ±ÿßÿ± ŸÑŸäŸá text ŸÖÿπŸäŸÜ
  const allButtons = document.querySelectorAll('button');
  allButtons.forEach(btn => {
    if (btn.textContent.includes('BRIEF MODE')) {
      btn.style.display = 'none';
    }
  });
});
// ====== üîÑ RENDER MAGAZINE MODE - CLEANED (NO BOTTOM PAGINATION) ======
async function renderMagazineMode(filteredProducts) {
  const container = document.getElementById('productsContainer');
  const loader = document.getElementById('loadingIndicator');

  if (loader) loader.style.display = 'flex';
  if (container) container.innerHTML = '';

  const IS_IOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

  setTimeout(async () => {
    try {
      const productsWithOffers = filteredProducts.filter(p => getOffer(p.Code) !== null);

      if (productsWithOffers.length === 0) {
        container.innerHTML = '<div style="padding:40px;text-align:center;font-size:20px;color:#666">No offers available</div>';
        if (loader) loader.style.display = 'none';
        return;
      }

      // üî• iOS Badge Simplification
      if (IS_IOS && typeof getMagazineOfferHTML === 'function') {
        window.getMagazineOfferHTML = function(offer, product, cls) {
          if (!offer) return '';
          const offerText = offer.offerType || '';
          const pct = offerText.includes('%') ? offerText.split('%')[0] : '‚ú®';
          
          return `<div style="position:absolute;top:8px;left:8px;background:#111827;color:#fff;
                  padding:6px 12px;border-radius:10px;font-weight:700;font-size:14px;
                  border:1px solid rgba(255,255,255,0.1);z-index:20;line-height:1.1;">
                    <div style="font-size:18px;">${pct}${offerText.includes('%') ? '%' : ''}</div>
                    <div style="font-size:9px;opacity:0.85;">${offerText.slice(0,12)}</div>
                  </div>`;
        };
      }

      // üî• Build Stack Index with CATEGORY FILTER
      const stackIndex = {};
      
      if (!IS_IOS && typeof buildiOSStackData === 'function') {
        const stackData = buildiOSStackData(productsWithOffers);
        Object.assign(stackIndex, stackData);
      } else {
        productsWithOffers.forEach(product => {
          const brand = product.Brand || 'GENERIC';
          const catA = product["Category Level A"] || product["Category A"] || 'Uncategorized';
          const offer = getOffer(product.Code);
          const offerType = offer?.offerType || offer?.type;
          if (!offerType) return;
          
          const key = `${catA}_${brand}_${offerType}`;
          
          if (!stackIndex[key]) {
            stackIndex[key] = [];
          }
          if (stackIndex[key].length < 3) {
            stackIndex[key].push(product);
          }
        });
      }

      // Build group structure (CHUNKED for iOS)
      const groupStructure = {};
      const CHUNK_SIZE = 100;
      
      for (let i = 0; i < productsWithOffers.length; i += CHUNK_SIZE) {
        const chunk = productsWithOffers.slice(i, i + CHUNK_SIZE);
        
        chunk.forEach(product => {
          const catA = product["Category Level A"] || product["Category A"] || "Uncategorized";
          const catD = product["Category Level D"] || product["Category D"] || "Uncategorized";
          const brand = product.Brand || "GENERIC";
          const offer = getOffer(product.Code);
          const offerType = offer ? (offer.offerType || offer.type) : null;
          
          if (!offerType) return;
          
          if (!groupStructure[catA]) groupStructure[catA] = {};
          if (!groupStructure[catA][catD]) groupStructure[catA][catD] = {};
          if (!groupStructure[catA][catD][brand]) groupStructure[catA][catD][brand] = {};
          if (!groupStructure[catA][catD][brand][offerType]) {
            groupStructure[catA][catD][brand][offerType] = [];
          }
          
          groupStructure[catA][catD][brand][offerType].push(product);
        });
        
        if (IS_IOS && i % 200 === 0 && i > 0) {
          await new Promise(r => setTimeout(r, 5));
        }
      }

      // Build SORTED array
      const allProducts = [];
      const sortedCatAs = Object.keys(groupStructure).sort((a, b) => {
        if (a === "HEALTH & WELLNESS") return -1;
        if (b === "HEALTH & WELLNESS") return 1;
        return a > b ? 1 : -1;
      });

      for (const catA of sortedCatAs) {
        const catDsInCategory = groupStructure[catA];
        const classes = getMagazineCategoryClasses(catA);
        const sortedCatDs = Object.keys(catDsInCategory).sort();
        
        for (const catD of sortedCatDs) {
          const brandsInCatD = catDsInCategory[catD];
          const sortedBrands = Object.keys(brandsInCatD).sort();
          
          for (const brand of sortedBrands) {
            const offersForBrand = brandsInCatD[brand];
            const sortedOfferTypes = Object.keys(offersForBrand).sort();
            
            for (const offerType of sortedOfferTypes) {
              const productsWithThisOffer = offersForBrand[offerType];
              const representative = productsWithThisOffer[0];
              const key = `${catA}_${brand}_${offerType}`;
              
              allProducts.push({
                product: representative,
                brand: brand,
                catA: catA,
                catD: catD,
                classes: classes,
                productsCount: productsWithThisOffer.length,
                stackImages: stackIndex[key] || [],
                offerProducts: productsWithThisOffer.slice(0, 3)
              });
            }
          }
        }
        
        if (IS_IOS) await new Promise(r => setTimeout(r, 2));
      }

      magazineSettings.allProducts = allProducts;
      magazineSettings.currentPage = 1;
      
      if (IS_IOS) {
        magazineSettings.rowsPerPage = 3;
        magazineSettings.itemsPerRow = 3;
      } else {
        magazineSettings.rowsPerPage = magazineSettings.rowsPerPage || 4;
        magazineSettings.itemsPerRow = magazineSettings.itemsPerRow || 4;
      }
      
      magazineSettings.totalPages = Math.ceil(
        allProducts.length / (magazineSettings.rowsPerPage * magazineSettings.itemsPerRow)
      );

      // iOS CSS Injection
      if (IS_IOS) {
        if (!document.getElementById('ios-perf-css-v2')) {
          const style = document.createElement('style');
          style.id = 'ios-perf-css-v2';
          style.innerHTML = `
            .magazine-card, .magazine-item { 
              transform: translate3d(0,0,0);
              backface-visibility: hidden;
              -webkit-backface-visibility: hidden;
            }
            .magazine-card img {
              image-rendering: -webkit-optimize-contrast;
            }
            .ios-device .magazine-card {
              box-shadow: 0 1px 3px rgba(0,0,0,0.1) !important;
            }
          `;
          document.head.appendChild(style);
        }
        
        if (typeof injectiOSPerfCSS === 'function') {
          try { injectiOSPerfCSS(); } catch(e) {}
        }
      }

      // ‚úÖ CLEANED: Settings ŸÅŸàŸÇ + Pages (ÿßŸÑŸÄ navigation ÿ¨ŸàÿßŸáÿß ÿØŸÑŸàŸÇÿ™Ÿä)
      container.innerHTML = `
        <div class="magazine-settings-wrapper">
          <div class="magazine-settings">
            <div class="magazine-setting-item">
              <label>Rows:</label>
              <input type="number" id="magazineRowsPerPage" value="${magazineSettings.rowsPerPage}" min="1" max="10">
            </div>
            <div class="magazine-setting-item">
              <label>Items/Row:</label>
              <input type="number" id="magazineItemsPerRow" value="${magazineSettings.itemsPerRow}" min="1" max="8">
            </div>
            <button class="magazine-apply-btn" onclick="applyMagazineSettings()">Apply</button>
          </div>
        </div>
        
        <div class="magazine-pages-container" id="magazinePagesContainer"></div>
        
        <div id="magazineSwipeHint" class="magazine-swipe-hint">
          <div class="hand-icon">üëÜ</div>
          <div>Swipe to browse</div>
        </div>
      `;

      renderMagazinePage(1);
      
      setTimeout(() => {
        if (typeof initMagazineTouchEvents === 'function') initMagazineTouchEvents();
        if (typeof showSwipeHint === 'function') showSwipeHint();
        if (typeof buildCategoryNavigation === 'function') buildCategoryNavigation();
      }, 150);
      
      if (loader) loader.style.display = 'none';
      
      console.log(`‚úÖ Magazine Mode! ${allProducts.length} products | ${magazineSettings.totalPages} pages`);

    } catch (error) {
      console.error('‚ùå Magazine Error:', error);
      container.innerHTML = `<div style="padding:20px;color:red;">Error: ${error.message}</div>`;
      if (loader) loader.style.display = 'none';
    }
  }, 10);
}

// üî• iOS Stack Data Builder (ONE TIME ONLY)
function buildiOSStackData(productsWithOffers) {
  const stackData = {};
  const processed = new Set();
  
  productsWithOffers.forEach(product => {
    const brand = product.Brand;
    const offerType = getOffer(product.Code)?.offerType;
    const key = `${brand}_${offerType}`;
    
    if (!processed.has(key)) {
      processed.add(key);
      let brandProducts = [];
      const uniqueCodes = new Set();
      
      productsWithOffers.forEach(p => {
        if (p.Brand === brand && getOffer(p.Code)?.offerType === offerType) {
          if (!uniqueCodes.has(p.Code)) {
            uniqueCodes.add(p.Code);
            brandProducts.push(p);
          }
        }
      });
      
      stackData[key] = brandProducts.slice(0, 3);
    }
  });
  
  return stackData;
}

// üî• iOS Performance CSS
function injectiOSPerfCSS() {
  if (document.getElementById('ios-perf-css')) return;
  
  const style = document.createElement('style');
  style.id = 'ios-perf-css';
  style.textContent = `
    @supports (-webkit-overflow-scrolling: touch) {
      .magazine-page-grid {
        display: grid !important;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        padding: 16px;
        /* üî• Grid Lite - No JS row logic */
      }
      
      .magazine-product-card {
        will-change: transform;
        transform: translateZ(0);
        backface-visibility: hidden;
        /* üî• Hardware acceleration */
      }
      
      .magazine-images-stack {
        position: relative !important;
        height: 140px !important;
        overflow: hidden;
        /* üî• Fixed height - no reflow */
      }
      
      .magazine-lazy-img {
        content-visibility: auto;
        contain-intrinsic-size: 140px 140px;
        /* üî• Modern iOS perf */
      }
      
      .magazine-page {
        contain: layout style paint;
        /* üî• Paint isolation */
      }
    }
  `;
  document.head.appendChild(style);
}
// ====== üìÑ RENDER SINGLE PAGE - ROW-BASED GROUPING + BLOBS ======
function renderMagazinePage(pageNumber) {
  const pagesContainer = document.getElementById('magazinePagesContainer');
  if (!pagesContainer) return;
  
  const { rowsPerPage, itemsPerRow, allProducts, totalPages } = magazineSettings;
  const itemsPerPage = rowsPerPage * itemsPerRow;
  const startIndex = (pageNumber - 1) * itemsPerPage;
  const endIndex = Math.min(startIndex + itemsPerPage, allProducts.length);
  const pageProducts = allProducts.slice(startIndex, endIndex);
  
  if (pageProducts.length === 0) return;
  
  const firstCat = pageProducts[0]?.catA || 'Uncategorized';
  const firstCatD = pageProducts[0]?.catD || 'Uncategorized';
  const classes = getMagazineCategoryClasses(firstCat);
  const icon = getMagazineCategoryIcon(firstCat);
  
  let categoryClassName = 'health';
  if (firstCat.includes('BABY')) categoryClassName = 'baby';
  else if (firstCat.includes('BEAUTY')) categoryClassName = 'beauty';
  else if (firstCat.includes('PERSONAL')) categoryClassName = 'personal';
  
  const pageDiv = document.createElement('div');
  pageDiv.className = `magazine-page active`;
  pageDiv.id = `magazine-page-${pageNumber}`;
  
  let pageHTML = `
    <div class="magazine-category-header ${classes.headerClass}">
      ${icon}<div class="magazine-category-title-text">${firstCat} ‚Üí ${firstCatD}</div>${icon}
    </div>
    <div class="magazine-page-container">
  `;
  
  // üî• ŸÜŸÖÿ¥Ÿä ÿπŸÑŸâ ÿßŸÑÿµŸÅŸàŸÅ
  for (let i = 0; i < pageProducts.length; i += itemsPerRow) {
    const rowProducts = pageProducts.slice(i, Math.min(i + itemsPerRow, pageProducts.length));
    
    // ŸÜŸÅÿ≥ ÿ™ÿ¨ŸÖŸäÿπ Category D
    const groupedByCatD = [];
    let currentGroup = null;
    
    rowProducts.forEach(item => {
      const catD = item.catD || (item.product && item.product["Category Level D"]) || 'OTHER';
      
      if (!currentGroup || currentGroup.catD !== catD) {
        currentGroup = { catD, items: [] };
        groupedByCatD.push(currentGroup);
      }
      currentGroup.items.push(item);
    });
    
    // ÿµŸÅ Ÿàÿßÿ≠ÿØ ŸÅŸäŸá ŸÉŸÑ ÿßŸÑŸÖÿ¨ŸÖŸàÿπÿßÿ™
    pageHTML += '<div class="magazine-row-wrapper">';
    
    // ŸÜÿπÿ±ÿ∂ ŸÉŸÑ group ÿ¨ŸÜÿ® ÿ®ÿπÿ∂ ŸÅŸä blob
    groupedByCatD.forEach((group, idx) => {
      const categoryDColor = getCategoryDColor(group.catD);
      const blobShapes = [
        '40% 60% 65% 35% / 55% 45% 60% 40%',
        '58% 42% 75% 25% / 76% 46% 54% 24%',
        '50% 50% 33% 67% / 55% 27% 73% 45%',
        '33% 67% 58% 42% / 63% 68% 32% 37%',
        '45% 55% 62% 38% / 42% 58% 42% 58%'
      ];
      const randomBlob = blobShapes[idx % blobShapes.length];
      
      pageHTML += `
        <div class="magazine-blob-group" style="flex: 0 0 calc(${(group.items.length / itemsPerRow) * 100}% - 10px);">
          <div class="magazine-blob-bg"
               style="background:${categoryDColor}15; border-radius:${randomBlob};"></div>
          <div class="magazine-blob-header"
               style="background:linear-gradient(135deg, ${categoryDColor} 0%, ${categoryDColor}dd 100%);">
            ${group.catD}
          </div>
          <div class="magazine-blob-grid">
      `;
      
      // ŸÉÿ±Ÿàÿ™ ÿßŸÑŸÖÿ¨ŸÖŸàÿπÿ©
      group.items.forEach(item => {
        const { product, brand, classes: itemClasses, productsCount, offerProducts } = item;
        const offer = getOffer(product.Code);
        
        let offerBadge = '';
        if (offer) {
          const offerPrice = offer.offerPrice ? offer.offerPrice[product.Code] : null;
          offerBadge = getMagazineOfferHTML(
            { type: offer.offerType, offerType: offer.offerType, newPrice: offerPrice }, 
            product, itemClasses.badgeClass, productsCount
          );
        }
        
        const bestSellerBadge = product.isSelected
          ? '<div class="magazine-best-seller-badge">‚òÖ BEST</div>'
          : '';
        
        let imageHTML = '';
        if (productsCount > 1 && offerProducts?.length > 0) {
          // üîÅ ÿ≥ÿ™ÿßŸäŸÑ ŸÖÿ¨ŸÑÿ©: ÿµŸàÿ± ŸÖÿ™ÿØÿßÿÆŸÑÿ© ŸÇÿ±Ÿäÿ® ŸÖŸÜ ÿ®ÿπÿ∂
          imageHTML = `<div class="magazine-images-stack" data-count="${offerProducts.length}">`;
          offerProducts.forEach((p, idx) => {
            imageHTML += `
              <img 
                data-code="${p.Code}" 
                data-brand="${brand}" 
                class="magazine-lazy-img stack-img stack-item-${idx+1}" 
                alt="${brand} ${idx + 1}" 
              />`;
          });
          imageHTML += '</div>';
        } else {
          imageHTML = `
            <div class="magazine-product-image-wrapper">
              <img data-code="${product.Code}" data-brand="${brand}" class="magazine-lazy-img" alt="${brand}"/>
            </div>`;
        }
        
        pageHTML += `
          <div class="magazine-product-card ${categoryClassName}"
               onclick="window.open('https://www.al-dawaa.com/en/p/${product.Code}', '_blank')">
            ${offerBadge}
            ${bestSellerBadge}
            ${imageHTML}
            <div class="magazine-product-info">
              <div class="magazine-brand-name">${brand}</div>
              <div class="magazine-item-name">
                ${productsCount > 1
                  ? `${productsCount} products`
                  : (product["Item Description"] || product["Item Desc"] || '')}
              </div>
            </div>
          </div>
        `;
      });
      
      pageHTML += `
          </div>
        </div>
      `;
    });
    
    pageHTML += '</div>'; // End row
  }
  
  pageHTML += '</div>'; // End container
  
  // Navigation
  pageHTML += `
    <div class="magazine-page-navigation">
      <button id="magazinePrevBtn" class="magazine-nav-btn" onclick="magazinePrevPage()" ${pageNumber === 1 ? 'disabled' : ''}>
        ‚ùÆ Previous
      </button>
      <div class="magazine-page-info">
        Page <span id="magazinePageNumber">${pageNumber}</span> of <span id="magazineTotalPages">${totalPages}</span>
      </div>
      <button id="magazineNextBtn" class="magazine-nav-btn" onclick="magazineNextPage()" ${pageNumber === totalPages ? 'disabled' : ''}>
        Next ‚ùØ
      </button>
    </div>
  `;
  
  pageDiv.innerHTML = pageHTML;
  pagesContainer.innerHTML = '';
  pagesContainer.appendChild(pageDiv);
  setTimeout(() => initMagazineLazyLoader(), 100);
}

// ŸÅŸÜŸÉÿ¥ŸÜ goToCategoryPage ÿ™ŸÅÿ∂ŸÑ ÿ≤Ÿä ŸÖÿß ŸáŸä
function goToCategoryPage(catName) {
  const categoryBlocks = magazineSettings.categoryBlocks || [];
  const catIndex = categoryBlocks.findIndex(block => 
    block.catA.toLowerCase().includes(catName.toLowerCase())
  );
  
  if (catIndex !== -1) {
    const blocksPerPage = magazineSettings.rowsPerPage * magazineSettings.itemsPerRow || 12;
    const targetPage = Math.floor(catIndex / blocksPerPage) + 1;
    
    magazineSettings.currentPage = targetPage;
    renderMagazinePage(targetPage);
    updateMagazineNav();
    
    document.querySelectorAll('.magazine-cat-btn').forEach(btn => {
      btn.style.transform = 'scale(1)';
      btn.style.boxShadow = '0 4px 15px rgba(102,126,234,0.4)';
    });
    event.target.style.transform = 'scale(1.05)';
    event.target.style.boxShadow = '0 6px 20px rgba(102,126,234,0.6)';
    
    console.log(`üöÄ Navigated to ${catName} - Page ${targetPage}`);
  } else {
    console.log(`‚ùå Category ${catName} not found`);
  }
}


function goToCategoryPage(catName) {
  // ÿßÿ®ÿ≠ÿ´ ÿπŸÜ index ÿßŸÑŸÄ category block ÿßŸÑÿ£ŸàŸÑŸâ ÿ®ÿ™ÿßÿπÿ™ ÿßŸÑŸÄ catName ÿØŸä
  const categoryBlocks = magazineSettings.categoryBlocks || []; // ŸÖŸÜ ÿßŸÑŸÄ render logic [file:2]
  const catIndex = categoryBlocks.findIndex(block => 
    block.catA.toLowerCase().includes(catName.toLowerCase())
  );
  
  if (catIndex !== -1) {
    // ÿßÿ≠ÿ≥ÿ® ÿ±ŸÇŸÖ ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑŸÑŸä ŸÅŸäŸáÿß ÿßŸÑŸÄ block ÿØŸä
    const blocksPerPage = magazineSettings.rowsPerPage * magazineSettings.itemsPerRow || 12;
    const targetPage = Math.floor(catIndex / blocksPerPage) + 1;
    
    magazineSettings.currentPage = targetPage;
    renderMagazinePage(targetPage);
    updateMagazineNav();
    
    // Animate ÿßŸÑŸÄ button ÿßŸÑŸÑŸä ÿßÿ™ÿ∂ÿ∫ÿ∑ÿ™
    document.querySelectorAll('.magazine-cat-btn').forEach(btn => {
      btn.style.transform = 'scale(1)';
      btn.style.boxShadow = '0 4px 15px rgba(102,126,234,0.4)';
    });
    event.target.style.transform = 'scale(1.05)';
    event.target.style.boxShadow = '0 6px 20px rgba(102,126,234,0.6)';
    
    console.log(`üöÄ Navigated to ${catName} - Page ${targetPage}`);
  } else {
    console.log(`‚ùå Category ${catName} not found`);
  }
}

/**
 * ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿ£ŸÉŸàÿßÿØ ÿ®ÿØŸäŸÑÿ© ŸÑŸÜŸÅÿ≥ ÿßŸÑÿ®ÿ±ÿßŸÜÿØ ŸàŸÜŸÅÿ≥ ÿßŸÑÿπÿ±ÿ∂
 */
function findAlternativeCodesForSameOffer(brand, offerType, currentCode) {
  const alternatives = [];
  
  if (typeof offersDB !== 'undefined') {
    offersDB.forEach(offer => {
      if (offer.offerType === offerType && offer.codes) {
        offer.codes.forEach(code => {
          const codeStr = code.toString();
          if (codeStr !== currentCode.toString()) {
            const product = productsDB.find(p => p.Code.toString() === codeStr);
            if (product && product.Brand === brand) {
              alternatives.push(codeStr);
            }
          }
        });
      }
    });
  }
  
  console.log(`üîç Found ${alternatives.length} alternative codes for ${brand} with ${offerType}`);
  return alternatives;
}
// Populate Custom Offer Types Dropdown
function populateCustomOfferTypesDropdown() {
    if (typeof offersDB === 'undefined' || !offersDB.length) return;
    
    const container = document.getElementById('customOfferTypesList');
    if (!container) return;
    
    // Get unique offer types
    const offerTypesSet = new Set();
    offersDB.forEach(offer => {
        if (offer.offerType) {
            offerTypesSet.add(JSON.stringify({
                en: offer.offerType,
                ar: offer.offerTypeAR || offer.offerType
            }));
        }
    });
    
    const offerTypes = Array.from(offerTypesSet)
        .map(str => JSON.parse(str))
        .sort((a, b) => a.en.localeCompare(b.en));
    
    container.innerHTML = '';
    
    offerTypes.forEach(type => {
        const option = document.createElement('div');
        option.className = 'custom-option';
        option.innerHTML = `
            <input type="checkbox" value="${type.en}" data-ar="${type.ar}" id="offer-${type.en.replace(/\s+/g, '-')}">
            <span>${type.en} | ${type.ar}</span>
        `;
        container.appendChild(option);
    });
    
    console.log(`‚úÖ Loaded ${offerTypes.length} offer types`);
}

// Get Selected Offer Types
function getSelectedOfferTypes() {
    const customInput = document.getElementById('customOfferTypeInput');
    if (customInput && customInput.value.trim()) {
        return [{
            en: customInput.value.trim(),
            ar: customInput.value.trim()
        }];
    }
    
    const checkboxes = document.querySelectorAll('#customOfferTypesList input[type="checkbox"]:checked');
    return Array.from(checkboxes).map(cb => ({
        en: cb.value,
        ar: cb.getAttribute('data-ar')
    }));
}

// Update trigger text when selection changes
function updateCustomOfferTypesTrigger() {
    const selected = getSelectedOfferTypes();
    const trigger = document.querySelector('#customOfferTypeSelect .selected-text');
    if (!trigger) return;
    
    if (selected.length === 0) {
        trigger.textContent = 'Select Offer Types';
    } else if (selected.length === 1) {
        trigger.textContent = selected[0].en;
    } else {
        trigger.innerHTML = `${selected[0].en} <span class="selected-count">+${selected.length - 1}</span>`;
    }
}

// Initialize on modal open
function openCustomPrintModal() {
    const modal = document.getElementById('customPrintModal');
    if (modal) {
        modal.style.display = 'flex';
        populateCustomOfferTypesDropdown();
        restoreCustomModalData();
    }
}
// Add event listeners for custom offer types
document.addEventListener('DOMContentLoaded', () => {
    const customOfferTypesList = document.getElementById('customOfferTypesList');
    if (customOfferTypesList) {
        customOfferTypesList.addEventListener('change', updateCustomOfferTypesTrigger);
    }
    
    const customInput = document.getElementById('customOfferTypeInput');
    if (customInput) {
        customInput.addEventListener('input', () => {
            // Disable checkboxes when custom input has text
            const hasCustom = customInput.value.trim().length > 0;
            const checkboxes = document.querySelectorAll('#customOfferTypesList input[type="checkbox"]');
            checkboxes.forEach(cb => cb.disabled = hasCustom);
            updateCustomOfferTypesTrigger();
        });
    }
});
// ====== üìÇ UPLOADED CODES FILTER (Global Variables) ======
let uploadedCodesFilter = null;
let uploadedBrandsFilter = null;
let uploadedPrintData = { 
  codes: '', quantity: 1, offerEN: '', offerAR: '', 
  dateRange: '', productEN: '', productAR: '', category: '' 
};

// ====== üîç CHECK IF BRAND HAS EXCLUSIVE OFFER ======
function getBrandExclusiveOffer(brandName) {
  if (!brandName || typeof exclusiveOffersDB === 'undefined') return null;
  const cleanBrand = brandName.trim().toUpperCase();
  const offer = exclusiveOffersDB.find(offer => {
    if (Array.isArray(offer.codes)) {
      return offer.codes.some(brand => String(brand).trim().toUpperCase() === cleanBrand);
    }
    return false;
  });
  return offer || null;
}

// ====== üîç IMPROVED CODE MATCHING ======
function findProductByCode(code) {
  const cleanCode = String(code).trim().replace(/\s+/g, '');
  let product = productsDB.find(p => String(p.Code).trim() === cleanCode);
  if (!product && /^\d+$/.test(cleanCode)) {
    const numCode = parseInt(cleanCode, 10);
    product = productsDB.find(p => parseInt(p.Code) === numCode);
  }
  return product;
}

// ====== üîç CHECK IF CODE HAS OFFER ======
function codeHasOffer(code) {
  const cleanCode = String(code).trim().replace(/\s+/g, '');
  if (typeof offersMap !== 'undefined' && offersMap.has(cleanCode)) return true;
  const offer = getOffer(cleanCode);
  if (offer !== null && offer !== undefined) return true;
  if (typeof offersDB !== 'undefined') {
    const offerFound = offersDB.some(offer => {
      if (Array.isArray(offer.codes)) return offer.codes.some(c => String(c).trim() === cleanCode);
      return false;
    });
    if (offerFound) return true;
  }
  const product = findProductByCode(cleanCode);
  if (product) {
    const productOffer = getOffer(product.Code);
    if (productOffer !== null && productOffer !== undefined) return true;
    const brandOffer = getBrandExclusiveOffer(product.Brand);
    if (brandOffer) return true;
  }
  return false;
}

// ====== üîç GET OFFER TYPE FOR CODE ======
function getOfferTypeForCode(code) {
  const cleanCode = String(code).trim().replace(/\s+/g, '');
  const regularOffer = getOffer(cleanCode);
  if (regularOffer) {
    return {
      type: 'regular',
      offerEN: regularOffer.offerEN || regularOffer.offerType || regularOffer.name || '',
      offerAR: regularOffer.offerTypeAR || regularOffer.offerAR || regularOffer.nameAR || '',
      dateRange: regularOffer.dateRange || '',
      data: regularOffer
    };
  }
  const product = findProductByCode(cleanCode);
  if (product && product.Brand) {
    const exclusiveOffer = getBrandExclusiveOffer(product.Brand);
    if (exclusiveOffer) {
      return {
        type: 'exclusive',
        offerEN: exclusiveOffer.offerEN || exclusiveOffer.offerType || exclusiveOffer.name || '',
        offerAR: exclusiveOffer.offerAR || exclusiveOffer.offerTypeAR || exclusiveOffer.nameAR || '',
        dateRange: exclusiveOffer.dateRange || '',
        data: exclusiveOffer
      };
    }
  }
  return null;
}

// ====== üñ®Ô∏è ÿ∑ÿ®ÿßÿπÿ© ÿßŸÑÿπÿ±Ÿàÿ∂ ŸÅŸÇÿ∑ FOR UPLOADED CODES (Fixed: 6 Cards per Offer) ======
async function openUploadedPrintModal() {
  if (!uploadedCodesFilter || uploadedCodesFilter.length === 0) {
    alert('‚ö†Ô∏è ÿ≠ŸÖŸëŸÑ ÿ£ŸÉŸàÿßÿØ ÿßŸÑÿ£ŸàŸÑ! üì§');
    return;
  }
  
  // Group codes by offer type
  const offerTypesMap = new Map();
  uploadedCodesFilter.forEach(code => {
    const offerInfo = getOfferTypeForCode(code);
    if (!offerInfo) return;
    const key = `${offerInfo.offerEN}|${offerInfo.offerAR}|${offerInfo.dateRange}`;
    if (!offerTypesMap.has(key)) {
      offerTypesMap.set(key, {
        offerEN: offerInfo.offerEN,
        offerAR: offerInfo.offerAR,
        dateRange: offerInfo.dateRange,
        codes: []
      });
    }
    offerTypesMap.get(key).codes.push(code);
  });
  
  console.log(`üéØ Found ${offerTypesMap.size} offer types for printing`);
  
  const customCards = [];
  
  offerTypesMap.forEach((offerGroup) => {
    // ‚úÖ ÿßŸÑÿ™ÿπÿØŸäŸÑ ŸáŸÜÿß: ÿ•ÿ∂ÿßŸÅÿ© 6 ŸÉÿ±Ÿàÿ™ ŸÑŸÉŸÑ ŸÜŸàÿπ ÿπÿ±ÿ∂
    for(let i = 0; i < 6; i++) {
        customCards.push({
          Code: '', // ŸÅÿßÿ∂Ÿä = ÿ∑ÿ®ÿßÿπÿ© ŸÜŸàÿπ ÿßŸÑÿπÿ±ÿ∂ ŸÅŸÇÿ∑
          customData: {
            offerEN: offerGroup.offerEN,
            offerAR: offerGroup.offerAR,
            dateRange: offerGroup.dateRange || '',
            productEN: '',
            productAR: '',
            category: ''
          }
        });
    }
  });
  
  if (customCards.length === 0) {
    alert('‚ö†Ô∏è ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿπÿ±Ÿàÿ∂!');
    return;
  }
  
  console.log(`üñ®Ô∏è Printing ${customCards.length} cards (${offerTypesMap.size} offers x 6)`);
  
  const container = document.getElementById('printContainer');
  const loader = document.getElementById('printLoader');
  container.innerHTML = '';
  if (loader) loader.style.display = 'flex';
  
  setTimeout(async () => {
    renderCustomPrint(customCards);
    if (loader) loader.style.display = 'none';
    setTimeout(() => window.print(), 200);
  }, 200);
  
  console.log('üñ®Ô∏è CUSTOMER OFFER PRINT ready!');
}

// ====== üìÇ READ CODES FROM FILE & SHOW DASHBOARD ======
async function handleCodesFileUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const fileName = file.name.toLowerCase();
  const statusDiv = document.getElementById('codesFileStatus');
  statusDiv.innerHTML = `<span style="color: #3b82f6; font-weight:bold;">‚è≥ ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖŸÑŸÅ...</span>`;
  
  try {
    let rawCodes = [];
    
    if (fileName.endsWith('.txt') || fileName.endsWith('.csv')) {
      const text = await file.text();
      rawCodes = extractCodesFromText(text);
    } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
      await loadExcelLibrary();
      const data = await file.arrayBuffer();
      const workbook = XLSX.read(data, { type: 'array' });
      const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
      const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
      rawCodes = extractCodesFromExcel(jsonData);
    }
    
    if (rawCodes.length === 0) {
      statusDiv.innerHTML = `<div style="padding:15px; background:#fee2e2; color:#ef4444; border-radius:8px; text-align:center; font-weight:bold;">‚ùå ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ£Ÿä ÿ£ŸÉŸàÿßÿØ ÿµÿßŸÑÿ≠ÿ© ŸÅŸä ÿßŸÑŸÖŸÑŸÅ!</div>`;
      return;
    }
    
    // Filter codes + collect brands
    const codesWithOffers = [];
    const codesWithoutOffers = [];
    const brandsSet = new Set();
    const brandsWithExclusiveOffers = new Set();
    
    for (const code of rawCodes) {
      const cleanCode = String(code).trim().replace(/\s+/g, '');
      if (!/^\d+$/.test(cleanCode)) continue;
      
      const product = findProductByCode(cleanCode);
      if (product && product.Brand) {
        brandsSet.add(product.Brand);
        const brandOffer = getBrandExclusiveOffer(product.Brand);
        if (brandOffer) brandsWithExclusiveOffers.add(product.Brand);
      }
      
      if (codeHasOffer(cleanCode)) {
        codesWithOffers.push(cleanCode);
      } else {
        codesWithoutOffers.push(cleanCode);
      }
    }
    
    uploadedCodesFilter = codesWithOffers;
    uploadedBrandsFilter = [...brandsWithExclusiveOffers];
    
    // üî•üî• Attractive Dashboard HTML üî•üî•
    statusDiv.innerHTML = `
      <div style="
        display: grid; 
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); 
        gap: 15px; 
        margin-bottom: 20px; 
        width: 100%;
      ">
        <div style="background: linear-gradient(135deg, #f3f4f6, #e5e7eb); padding: 15px; border-radius: 12px; text-align: center; border-bottom: 4px solid #6b7280; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
          <div style="font-size: 24px; margin-bottom: 5px;">üìÇ</div>
          <div style="font-size: 20px; font-weight: 800; color: #1f2937;">${rawCodes.length}</div>
          <div style="font-size: 11px; font-weight: 600; color: #4b5563; text-transform: uppercase;">Total Codes</div>
        </div>

        <div style="background: linear-gradient(135deg, #d1fae5, #a7f3d0); padding: 15px; border-radius: 12px; text-align: center; border-bottom: 4px solid #10b981; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
          <div style="font-size: 24px; margin-bottom: 5px;">‚úÖ</div>
          <div style="font-size: 20px; font-weight: 800; color: #065f46;">${codesWithOffers.length}</div>
          <div style="font-size: 11px; font-weight: 600; color: #047857; text-transform: uppercase;">Active Offers</div>
        </div>

        <div style="background: linear-gradient(135deg, #fee2e2, #fecaca); padding: 15px; border-radius: 12px; text-align: center; border-bottom: 4px solid #ef4444; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
          <div style="font-size: 24px; margin-bottom: 5px;">‚ùå</div>
          <div style="font-size: 20px; font-weight: 800; color: #991b1b;">${codesWithoutOffers.length}</div>
          <div style="font-size: 11px; font-weight: 600; color: #b91c1c; text-transform: uppercase;">No Offers</div>
        </div>

        <div style="background: linear-gradient(135deg, #fef3c7, #fde68a); padding: 15px; border-radius: 12px; text-align: center; border-bottom: 4px solid #f59e0b; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
          <div style="font-size: 24px; margin-bottom: 5px;">‚≠ê</div>
          <div style="font-size: 20px; font-weight: 800; color: #92400e;">${brandsWithExclusiveOffers.size}</div>
          <div style="font-size: 11px; font-weight: 600; color: #b45309; text-transform: uppercase;">Exclusive Brands</div>
        </div>
      </div>

      <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
        <button onclick="applyUploadedCodesFilter()" style="flex: 1; min-width: 120px; padding: 10px; background: #3b82f6; color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 6px rgba(59,130,246,0.3); transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
          üîç Show Products
        </button>
        <button onclick="printFromUploadedCodes()" style="flex: 1; min-width: 120px; padding: 10px; background: #10b981; color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 6px rgba(16,185,129,0.3); transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
          üñ®Ô∏è Print Cards
        </button>
        <button onclick="openUploadedPrintModal()" style="flex: 1; min-width: 120px; padding: 10px; background: #f59e0b; color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 6px rgba(245,158,11,0.3); transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
          ‚ú® Print Offers Only (6x)
        </button>
        <button onclick="clearUploadedCodesFilter()" style="flex: 0 0 auto; padding: 10px 15px; background: #ef4444; color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 6px rgba(239,68,68,0.3); transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
          ‚úï Clear
        </button>
      </div>
    `;
    
    console.log('‚úÖ File processed successfully with Dashboard!');
    
  } catch (error) {
    console.error('‚ùå Error:', error);
    statusDiv.innerHTML = `<div style="padding:15px; background:#fee2e2; color:#ef4444; border-radius:8px; text-align:center; font-weight:bold;">‚ùå ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸÖŸÑŸÅ!</div>`;
  }
}

// ====== ÿ®ÿßŸÇŸä ÿßŸÑÿØŸàÿßŸÑ (ŸÉŸÖÿß ŸáŸä ÿ£Ÿà ÿ™ÿ≠ÿØŸäÿ´ ÿ®ÿ≥Ÿäÿ∑) ======
function applyUploadedCodesFilter() {
  if (!uploadedCodesFilter || uploadedCodesFilter.length === 0) {
    alert('‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ£ŸÉŸàÿßÿØ ŸÖÿ≠ŸÖŸÑÿ©!');
    return;
  }
  applyFilters();
}

function clearUploadedCodesFilter() {
  uploadedCodesFilter = null;
  uploadedBrandsFilter = null;
  uploadedPrintData = { codes: '', quantity: 1, offerEN: '', offerAR: '', dateRange: '', productEN: '', productAR: '', category: '' };
  const statusDiv = document.getElementById('codesFileStatus');
  if (statusDiv) statusDiv.innerHTML = `<span style="color: #9ca3af; font-style: italic;">No file loaded</span>`;
  const fileInput = document.getElementById('codesFileInput');
  if (fileInput) fileInput.value = '';
  applyFilters();
}

async function printFromUploadedCodes() {
  if (!uploadedCodesFilter || uploadedCodesFilter.length === 0) {
    alert('‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ£ŸÉŸàÿßÿØ ŸÖÿ≠ŸÖŸÑÿ©!');
    return;
  }
  const container = document.getElementById('printContainer');
  const loader = document.getElementById('printLoader');
  const productsToPrint = [];
  uploadedCodesFilter.forEach(code => {
    const product = findProductByCode(code);
    if (product) productsToPrint.push(product);
  });
  if (productsToPrint.length === 0) {
    alert('‚ö†Ô∏è ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™!');
    return;
  }
  container.innerHTML = '';
  if (loader) loader.style.display = 'flex';
  setTimeout(async () => {
    renderPrint(productsToPrint);
    const qrImages = container.querySelectorAll('.qr-code-img');
    if (qrImages.length > 0) await waitForImagesToLoad(qrImages);
    if (loader) loader.style.display = 'none';
    setTimeout(() => window.print(), 50);
  }, 100);
}

function extractCodesFromText(text) {
  const cleanText = text.replace(/[\u200B-\u200D\uFEFF]/g, '').replace(/[^\d\n\r,\s\t]/g, ' ');
  const codes = cleanText.split(/[\n\r,\s\t]+/).map(code => code.trim()).filter(code => code.length > 0 && /^\d+$/.test(code));
  return [...new Set(codes)];
}

function extractCodesFromExcel(jsonData) {
  const codes = new Set();
  jsonData.forEach(row => {
    if (!Array.isArray(row)) return;
    row.forEach(cell => {
      if (cell === null || cell === undefined || cell === '') return;
      let cellStr = String(cell).trim().replace(/[^\d]/g, '');
      if (cellStr.length > 0 && /^\d+$/.test(cellStr)) codes.add(cellStr);
    });
  });
  return [...codes];
}

function loadExcelLibrary() {
  return new Promise((resolve, reject) => {
    if (typeof XLSX !== 'undefined') {
      resolve();
      return;
    }
    const script = document.createElement('script');
    script.src = 'https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js';
    script.onload = resolve;
    script.onerror = reject;
    document.head.appendChild(script);
  });
}

console.log('‚úÖ Upload codes module loaded successfully!');
console.log('‚úÖ Navigation fix script loaded');

console.log('üî• Dark mode label fixer installed!');

// ====== INITIALIZATION ======
console.log('üé¨ Initializing...');
updateDatesInHTML();
updateCountdown();
setInterval(updateCountdown, 1000);
initializeFilters();
initFuzzySearch();
createBriefModeToggle();
applyFilters();
createMagazineModeToggle();

console.log('‚úÖ Ready!');

</script>

</script>
